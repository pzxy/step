# ç›®å½•

* [1. Introduction](æ­£æ–‡/1.introduction/åºè¨€.md)
  * [1.1 å¸¸è§„çº¦å®š](æ­£æ–‡/1.introduction/1.1å¸¸è§„çº¦å®š.md)
  * [1.2 å‡†å¤‡å·¥ä½œ](æ­£æ–‡/1.introduction/1.2å‡†å¤‡å·¥ä½œ.md)
* [2. æ–°æ‰‹å…¥é—¨](æ­£æ–‡/2.æ–°æ‰‹å…¥é—¨/å¼€å§‹.md)
  * [2.1 é¡¹ç›®é…åˆ¶å’Œç›®å½•ç»“æ„](æ­£æ–‡/2.æ–°æ‰‹å…¥é—¨/2.1.é¡¹ç›®é…åˆ¶å’Œç›®å½•ç»“æ„.md)
  * [2.2 HTTPæœåŠ¡åŸºç¡€](æ­£æ–‡/2.æ–°æ‰‹å…¥é—¨/2.2.HttpæœåŠ¡å™¨åŸºç¡€.md)
  * [2.3 APIæ¥å£å’ŒRESTfulè·¯ç”±](æ­£æ–‡/2.æ–°æ‰‹å…¥é—¨/2.3.APIæ¥å£å’ŒRESTfulè·¯ç”±.md)
* [3. å‘é€JSONå“åº”](æ­£æ–‡/3.å‘é€JSONå“åº”/ç« èŠ‚ä»‹ç».md)
  * [3.1 æ ¼å¼å›ºå®šçš„JSON](æ­£æ–‡/3.å‘é€JSONå“åº”/3.1.æ ¼å¼å›ºå®šçš„JSON.md)
  * [3.2 JSONç¼–ç ](æ­£æ–‡/3.å‘é€JSONå“åº”/3.2.JSONç¼–ç .md)
  * [3.3 ç»“æ„ä½“åºåˆ—åŒ–](æ­£æ–‡/3.å‘é€JSONå“åº”/3.3.ç»“æ„ä½“ç¼–ç .md)
  * [3.4 æ ¼å¼åŒ–å’Œå°è£…å“åº”](æ­£æ–‡/3.å‘é€JSONå“åº”/3.4.æ ¼å¼åŒ–å’Œå°è£…å“åº”.md)
  * [3.5 é«˜çº§JSONå®šåˆ¶åŒ–](æ­£æ–‡/3.å‘é€JSONå“åº”/3.5.é«˜çº§JSONå®šåˆ¶åŒ–.md)
  * [3.6 å‘é€é”™è¯¯å“åº”](æ­£æ–‡/3.å‘é€JSONå“åº”/3.6.å‘é€é”™è¯¯å“åº”.md)
* [4. è§£æJSONè¯·æ±‚](æ­£æ–‡/4.è§£æJSONè¯·æ±‚/ç« èŠ‚ä»‹ç».md)
  * [4.1 JSONè§£ç ](æ­£æ–‡/4.è§£æJSONè¯·æ±‚/4.1.JSONè§£ç .md)
  * [4.2 ç®¡ç†é”™è¯¯è¯·æ±‚](æ­£æ–‡/4.è§£æJSONè¯·æ±‚/4.2.ç®¡ç†é”™è¯¯è¯·æ±‚.md)
  * [4.3 é™åˆ¶HTTPè¯·æ±‚body](æ­£æ–‡/4.è§£æJSONè¯·æ±‚/4.3.é™åˆ¶HTTPè¯·æ±‚body.md)
  * [4.4 é™åˆ¶HTTPè¯·æ±‚body](æ­£æ–‡/4.è§£æJSONè¯·æ±‚/4.4.è‡ªå®šä¹‰JSONè§£ç .md)
  * [4.5 æ ¡éªŒJSONè¾“å…¥](æ­£æ–‡/4.è§£æJSONè¯·æ±‚/4.5.æ ¡éªŒJSONè¾“å…¥.md)
* [5. æ•°æ®åº“å®‰è£…ä¸é…åˆ¶](æ­£æ–‡/5.æ•°æ®åº“å®‰è£…ä¸é…ç½®/ç« èŠ‚ä»‹ç».md)
  * [5.1 é…ç½®PostgreSQL](æ­£æ–‡/5.æ•°æ®åº“å®‰è£…ä¸é…ç½®/5.1.é…ç½®PostgreSQLæ•°æ®åº“.md)
  * [5.2 è¿æ¥PostgreSQL](æ­£æ–‡/5.æ•°æ®åº“å®‰è£…ä¸é…ç½®/5.2.è¿æ¥PostgreSQLæ•°æ®åº“.md)
  * [5.3 é…ç½®æ•°æ®åº“è¿æ¥æ± ](æ­£æ–‡/5.æ•°æ®åº“å®‰è£…ä¸é…ç½®/5.3.é…ç½®æ•°æ®åº“è¿æ¥æ± .md)
* [6. SQLè¿ç§»](æ­£æ–‡/6.SQLè¿ç§»/ç« èŠ‚ä»‹ç».md)
  * [6.1 SQLè¿ç§»æ¦‚è¿°](æ­£æ–‡/6.SQLè¿ç§»/6.1.SQLè¿ç§»æ¦‚è¿°.md)
  * [6.2 ä½¿ç”¨SQLè¿ç§»](æ­£æ–‡/6.SQLè¿ç§»/6.2.ä½¿ç”¨SQLè¿ç§».md)
* [7. æ•°æ®åº“CRUDæ“ä½œ](æ­£æ–‡/7.CRUDæ“ä½œ/ç« èŠ‚ä»‹ç».md)
  * [7.1 å»ºç«‹movieæ¨¡å‹](æ­£æ–‡/7.CRUDæ“ä½œ/7.1.å»ºç«‹movieæ¨¡å‹.md)
  * [7.2 åˆ›å»ºmovieæ¥å£](æ­£æ–‡/7.CRUDæ“ä½œ/7.2.åˆ›å»ºæ–°çš„movieæ¥å£.md)
  * [7.3 æŸ¥è¯¢movieæ¥å£](æ­£æ–‡/7.CRUDæ“ä½œ/7.3.æŸ¥è¯¢movieæ¥å£.md)
  * [7.4 æ›´æ–°movieæ¥å£](æ­£æ–‡/7.CRUDæ“ä½œ/7.4.æ›´æ–°movieæ¥å£.md)
  * [7.5 åˆ é™¤movieæ¥å£](æ­£æ–‡/7.CRUDæ“ä½œ/7.5.åˆ é™¤movieæ¥å£.md)

##æ–‡ç« æ ¼å¼çº¦å®š

åœ¨æœ¬ä¹¦ï¼Œä»£ç å—ä»¥Markdownæ ¼å¼æ˜¾ç¤ºï¼Œå¦‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ‰€ç¤ºã€‚å¦‚æœä»£ç å—ç‰¹åˆ«é•¿ï¼Œä¸ç›¸å…³çš„éƒ¨åˆ†å¯ä»¥ç”¨çœç•¥å·æ›¿æ¢ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œå¤§å¤šæ•°ä»£ç å—åœ¨é¡¶éƒ¨éƒ½æœ‰ä¸€ä¸ªè¡Œæ–‡ä»¶åç§°ï¼ŒæŒ‡ç¤ºæˆ‘ä»¬æ­£åœ¨å¤„ç†çš„æ–‡ä»¶ã€‚

> File: hello.go

```go
package main
... // Indicates that some existing code has been omitted.
func sayHello() { fmt.Println("Hello world!")
}
```

ç»ˆç«¯(å‘½ä»¤è¡Œ)æŒ‡ä»¤ä»¥é»‘è‰²èƒŒæ™¯æ˜¾ç¤ºï¼Œé€šå¸¸ä»¥ç¾å…ƒç¬¦å·å¼€å§‹ã€‚è¿™äº›å‘½ä»¤åº”è¯¥å¯ä»¥åœ¨ä»»ä½•åŸºäºunixçš„æ“ä½œç³»ç»Ÿä¸Šæ‰§è¡Œï¼ŒåŒ…æ‹¬macOSå’ŒLinuxã€‚å‘½ä»¤æ‰§è¡Œç»“æœä»¥ç™½è‰²æ˜¾ç¤ºåœ¨å‘½ä»¤ä¸‹é¢ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```shell
 $ echo "Hello world!"
Hello world
```

å¦‚æœä½ ä½¿ç”¨Windowsï¼Œä½ åº”è¯¥ç”¨DOSç­‰ä»·çš„å‘½ä»¤æ›¿æ¢è¿™äº›å‘½ä»¤ï¼Œæˆ–è€…é€šè¿‡æ­£å¸¸çš„Windows GUIæ‰§è¡Œæ“ä½œã€‚

è¿™æœ¬ä¹¦çš„ä¸€äº›ç« èŠ‚ä»¥é™„éƒ¨åˆ†ç»“æŸã€‚è¿™äº›éƒ¨åˆ†åŒ…å«çš„ä¿¡æ¯ä¸æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ„å»ºæ— å…³ï¼Œä½†ä»ç„¶å¾ˆé‡è¦(æœ‰æ—¶åªæ˜¯æœ‰è¶£)ã€‚
## èƒŒæ™¯çŸ¥è¯†

æœ¬ä¹¦æ˜¯æ¥ç€Let's Goè¿™æœ¬ä¹¦æ¥å†™çš„ï¼Œå°†ä¼šæ²¿ç”¨å¾ˆå¤šå…¶ä¸­ä½¿ç”¨ä¿¡æ¯å’Œä»£ç æ¨¡å¼ã€‚

å¦‚æœä½ å·²ç»è¯»è¿‡å¹¶å–œæ¬¢ã€ŠLetâ€™s Goã€‹ï¼Œé‚£ä¹ˆè¿™æœ¬ä¹¦åº”è¯¥å¾ˆé€‚åˆä½ ï¼Œæ˜¯ä½ ä¸‹ä¸€æ­¥å­¦ä¹ çš„ç†æƒ³è¯»ç‰©ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰è¯»ï¼Œé‚£ä¹ˆæˆ‘å¼ºçƒˆå»ºè®®ä½ å…ˆä»Let's Goå¼€å§‹â€”â€”ç‰¹åˆ«æ˜¯å¦‚æœä½ æ˜¯ä¸€ä¸ªæ–°æ‰‹ã€‚

æ‚¨å¯ä»¥å•ç‹¬é˜…è¯»è¿™æœ¬ä¹¦ï¼Œä½†è¯·æ³¨æ„å®ƒçš„éš¾åº¦æ›´é«˜â€”â€”å®ƒæ²¡æœ‰è¯¦ç»†è§£é‡ŠåŸºç¡€çŸ¥è¯†ï¼Œä¸€äº›å†…å®¹(å¦‚æµ‹è¯•)æ ¹æœ¬æ²¡æœ‰å‡ºç°ï¼Œå› ä¸ºå®ƒä»¬åœ¨å‰ä¸€æœ¬ä¹¦ä¸­å·²ç»æœ‰å¤§é‡ä»‹ç»ã€‚ä½†å¦‚æœä½ å·²ä¹ æƒ¯ä½¿ç”¨Goï¼Œå¹¶ä¸”å·²ç»æœ‰äº†ç›¸å½“å¤šçš„ç»éªŒï¼Œé‚£ä¹ˆè¿™æœ¬ä¹¦å¯èƒ½ä¹Ÿå¾ˆé€‚åˆä½ ã€‚è¯·éšæ„ç›´å¥”ä¸»é¢˜ã€‚

## GO 1.16

æœ¬ä¹¦ä¸­çš„ä»£ç ä½¿ç”¨æœ€æ–°çš„Go 1.16ç‰ˆæœ¬éªŒè¯è¿‡ï¼Œå¦‚æœæ‚¨æƒ³è¦è·Ÿéšæ„å»ºåº”ç”¨ç¨‹åºçš„è¯ï¼Œå°±åº”è¯¥å®‰è£…è¯¥ç‰ˆæœ¬ã€‚

å¦‚æœä½ å·²ç»æŒ‰ç…§æ¥Goï¼Œä½ é€šè¿‡åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œgo versionæ¥æ£€æŸ¥ç‰ˆæœ¬ã€‚è¿”å›ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
$ go version
go version go1.16 linux/amd64
```

å¦‚æœä½ éœ€è¦å‡çº§Goï¼Œè¯·é©¬ä¸Šå¼€å§‹ã€‚æ ¹æ®ä½ çš„æ“ä½œç³»ç»Ÿå‡çº§æ‰‹å†Œåœ¨[è¿™é‡Œ](https://golang.org/doc/manage-install#uninstalling)ã€‚

## å…¶ä»–è½¯ä»¶

å¦‚æœä½ æƒ³è¦å®Œå…¨éµå¾ªæœ¬ä¹¦ï¼Œä½ åº”è¯¥ç¡®ä¿ä½ çš„ç”µè„‘ä¸Šæœ‰å…¶ä»–ä¸€äº›è½¯ä»¶ã€‚å®ƒä»¬æ˜¯:

* curlå·¥å…·ï¼šå¤„ç†æ¥è‡ªç»ˆç«¯çš„HTTPè¯·æ±‚å’Œå“åº”ã€‚åœ¨MacOSå’ŒLinuxæœºå™¨ä¸Šï¼Œå®ƒåº”è¯¥æ˜¯é¢„å…ˆå®‰è£…çš„ï¼Œæˆ–è€…åœ¨æ‚¨çš„è½¯ä»¶ä»“åº“ä¸­å¯ç”¨ã€‚å¦åˆ™ï¼Œæ‚¨å¯ä»¥ä»[è¿™é‡Œ](https://curl.haxx.se/download.html)ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ã€‚
* heyï¼šç”¨äºè¿›è¡Œä¸€äº›åŸºæœ¬è´Ÿè½½æµ‹è¯•çš„å·¥å…·ã€‚å¦‚æœä½ çš„ç”µè„‘ä¸Šæœ‰Go 1.16ï¼Œä½ å¯ä»¥ä½¿ç”¨Go installå‘½ä»¤å®‰è£…hey:

  ```shell
   $ go install github.com/rakyll/hey@latest
  ```
* gitç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿã€‚æ‰€æœ‰æ“ä½œç³»ç»Ÿçš„å®‰è£…è¯´æ˜éƒ½å¯ä»¥åœ¨[è¿™é‡Œ](https://git-scm.com/downloads)æ‰¾åˆ°ã€‚
* æµè§ˆå™¨ï¼šåŒ…å«ä¸€äº›å¼€å‘è€…å·¥å…·ã€‚å¯ä»¥ä½¿ç”¨firefoxã€Chromiumã€Chromeæˆ–è€…Microsof Edgeä¹Ÿå¯ä»¥ã€‚
* æ–‡æœ¬ç¼–è¾‘å™¨ğŸ˜„
## åºè¨€

æœ¬ä¹¦æˆ‘ä»¬å°†ä»å¤´åˆ°å°¾æ„å»ºä¸€ä¸ªåä¸ºGreenlightçš„åº”ç”¨ç¨‹åº-ç”¨äºæ£€ç´¢å’Œç®¡ç†æœ‰å…³ç”µå½±çš„ä¿¡æ¯çš„JSONAPIã€‚

ä½ å¯ä»¥æ€è€ƒä¸‹å®ƒæ ¸å¿ƒåŠŸèƒ½æœ‰ç‚¹ç±»ä¼¼äº[å¼€æ”¾ç”µå½±æ•°æ®åº“API](http://www.omdbapi.com/)ã€‚

æœ€åæˆ‘ä»¬çš„Greenlight APIå°†æ”¯æŒä»¥ä¸‹APIå’Œæ“ä½œï¼š


| Method | URL                           | åŠ¨ä½œ                           |
| -------- | ------------------------------- | -------------------------------- |
| GET    | /v1/healthcheck               | æ˜¾ç¤ºåº”ç”¨ç¨‹åºè¿è¡ŒçŠ¶å†µå’Œç‰ˆæœ¬ä¿¡æ¯ |
| GET    | /v1/movies                    | æ˜¾ç¤ºæ‰€æœ‰ç”µå½±çš„è¯¦æƒ…             |
| POST   | /v1/movies                    | æ·»åŠ æ–°çš„ç”µå½±                   |
| GET    | /v1/movies/:id                | æ ¹æ®idæŸ¥è¯¢ç‰¹å®šç”µå½±             |
| PATCH  | /v1/movies/:id                | æ›´æ–°ç‰¹å®šç”µå½±                   |
| DELETE | /v1/movies/:id                | åˆ é™¤ç‰¹å®šç”µå½±                   |
| POST   | /v1/users                     | æ³¨å†Œç”¨æˆ·                       |
| PUT    | /v1/users/activated           | æ¿€æ´»ç”¨æˆ·                       |
| PUT    | /v1/users/password            | æ›´æ–°ç”¨æˆ·å¯†ç                    |
| POST   | /v1/tokens/authentication     | ç”Ÿæˆæ–°çš„èº«ä»½éªŒè¯token          |
| POST   | /v1/tokens/password-reset     | ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯†ç é‡ç½®ä»¤ç‰Œ       |
| GET    | /debug/vars/ æ˜¾ç¤ºåº”ç”¨æ€§èƒ½å‚æ•° |                                |

ä¸ºäº†èƒ½å¤Ÿä»å®¢æˆ·è§’åº¦æ¥çœ‹ä¸‹APIæ˜¯æ€æ ·çš„ï¼Œåœ¨æœ¬ä¹¦æœ«å°¾GET /v1/movies/:idç«¯ç‚¹å°†è¿”å›å¦‚ä¸‹å“åº”å†…å®¹ï¼š

```shell
curl -H "Authorization: Bearer RIDBIAE3AMMK57T6IAEBUGA7ZQ" localhost:4000/v1/movies/1
```

```json
{
"movie": {
"id": 1,
"title": "Moana", "year": 2016, "runtime": "107 mins", "genres": [
"animation",
"adventure" ],
"version": 1 }
}
```

åœ¨åç«¯æˆ‘ä»¬å°†ä½¿ç”¨PostgreSQLä½œä¸ºæ•°æ®åº“æ¥æŒä¹…åŒ–æ‰€æœ‰çš„æ•°æ®ã€‚å¹¶åœ¨æœ¬ä¹¦çš„ç»“å°¾ï¼Œæˆ‘ä»¬å°†åœ¨ä¸€å°LinuxæœåŠ¡å™¨ä¸­éƒ¨ç½²å®Œæˆåçš„APIåº”ç”¨ç¨‹åºã€‚
## é¡¹ç›®é…åˆ¶å’Œä»£ç ç»“æ„

é¦–å…ˆåˆ›å»ºä¸€ä¸ªgreenlightç›®å½•ï¼Œä½œä¸ºè¿™ä¸ªé¡¹ç›®çš„å®¶ç›®å½•ã€‚æˆ‘å°†åœ¨$HOME/Projects/greenlightä¸Šåˆ›å»ºæˆ‘çš„é¡¹ç›®ç›®å½•ï¼Œä½†å¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥è‡ªç”±é€‰æ‹©ä¸åŒçš„ä½ç½®ã€‚

```shell
 $ mkdir -p $HOME/Projects/greenlight
```

ç„¶ååˆ‡æ¢åˆ°è¿™ä¸ªç›®å½•ï¼Œä½¿ç”¨go mod initå‘½ä»¤ä¸ºé¡¹ç›®å¯ç”¨æ¨¡å—ã€‚

è¿è¡Œæ­¤å‘½ä»¤æ—¶ï¼Œæ‚¨éœ€è¦æŒ‡å®šæ¨¡å—è·¯å¾„ï¼Œè¿™å®é™…ä¸Šæ˜¯é¡¹ç›®çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚åœ¨æœ¬ä¹¦ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨greenlight.alexedwards.netä½œä¸ºæˆ‘çš„æ¨¡å—è·¯å¾„ï¼Œå¦‚æœä½ è·Ÿéšæ“ä½œçš„è¯ï¼Œä½ åº”è¯¥æŠŠå®ƒæ›¿æ¢æˆä½ è‡ªå·±çš„è·¯å¾„ã€‚

```shell
$ cd $HOME/Projects/greenlight
$ go mod init greenlight.alexedwards.net
go: creating new go.mod: module greenlight.alexedwards.net
```

æ­¤æ—¶ä½ å°†åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹çœ‹åˆ°go.modæ–‡ä»¶è¢«åˆ›å»ºäº†ã€‚å¦‚æœä½ æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œå†…å®¹ç±»ä¼¼å¦‚ä¸‹æ‰€ç¤ºï¼š

> File: go.mod

```shell
module greenlight.alexedwards.net

go 1.16
```

åœ¨ç¬¬ä¸€æœ¬Letâ€™s Goä¹¦ä¸­è¯¦ç»†è®¨è®ºäº†Go moduleï¼Œä½†ä½œä¸ºå¿«é€Ÿå¤ä¹ ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå›é¡¾ä¸€ä¸‹è¦ç‚¹ã€‚

* å½“åœ¨ä½ é¡¹ç›®çš„æ ¹è·¯å¾„ä¸‹é¢æœ‰ä¸€ä¸ªåˆæ³•çš„go.modæ–‡ä»¶çš„è¯ï¼Œè¯´æ˜ä½ çš„é¡¹ç›®æ˜¯ä¸€ä¸ªæ¨¡å—ã€‚
* å½“ä½ åœ¨é¡¹ç›®ä¸­å·¥ä½œæ—¶ï¼Œä½¿ç”¨go getå»ä¸‹è½½ä¾èµ–åŒ…ï¼Œç„¶åå¯¹åº”ç‰¹å®šç‰ˆæœ¬çš„ä¾èµ–åŒ…å°†åœ¨go.modä¸­è®°å½•ã€‚å› ä¸ºç‰ˆæœ¬æ˜¯ç¡®å®šçš„ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“åœ¨å…¶ä»–çš„æœºå™¨æˆ–ç¯å¢ƒä¸­æ‰§è¡Œä»£ç ã€‚
* å½“ä½ åœ¨é¡¹ç›®ä¸­è¿è¡Œæˆ–æ„å»ºä»£ç ï¼ŒGoå°†ä½¿ç”¨go.modä¸­è®°å½•çš„ç‰¹å®šä¾èµ–ã€‚å¦‚æœéœ€è¦çš„ä¾èµ–å¹¶ä¸åœ¨å½“å‰æœºå™¨ä¸­ï¼ŒGoå°†è‡ªåŠ¨ä¸ºä½ ä¸‹è½½ï¼Œä»¥åŠä»»ä½•é€’å½’ä¾èµ–ã€‚
* go.modæ–‡ä»¶è¿˜å®šä¹‰äº†æ¨¡å—è·¯å¾„ï¼ˆå°±æ˜¯å‰é¢è¯´çš„greenlight.alexedwards.net)ã€‚è¿™å°†ç”¨ä½œé¡¹ç›®ä¸­åŒ…å¯¼å…¥çš„æ ¹è·¯å¾„æ ‡è¯†ç¬¦ã€‚
* è®©æ¨¡å—æ ¹è·¯å¾„ä¿æŒå”¯ä¸€æ€§ï¼Œæ˜¯ä¸€ä¸ªå¥½çš„ç¼–ç ä¹ æƒ¯ã€‚Goç¤¾åŒºçš„å¸¸è§çº¦å®šæ˜¯ä½¿ç”¨ä½ çš„URLä½œä¸ºæ¨¡å—æ ¹è·¯å¾„ã€‚

> å¦‚æœä½ ä¸ç¡®å®šgo moduleçš„å·¥ä½œåŸç†ï¼Œå¯ä»¥æŸ¥çœ‹Go module [wiki](https://github.com/golang/go/wiki/Modules)ï¼ŒåŒ…å«å¾ˆå¤šFAQ-æ³¨æ„å¯èƒ½æœ‰äº›å†…å®¹å·²ç»è¿‡æ—¶ã€‚

## ç”Ÿæˆç›®å½•ç»“æ„

ç°åœ¨projectç›®å½•å·²ç»åˆ›å»ºå¥½äº†å¹¶åŒ…å«go.modæ–‡ä»¶ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºé¡¹ç›®ç»“æ„ï¼š

```shell
$ mkdir -p bin cmd/api internal migrations remote 
$ touch Makefile
$ touch cmd/api/main.go
```

æ­¤æ—¶é¡¹ç›®çš„ç›®å½•ç»“æ„åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºçš„æ ·å­ï¼š

```shell
.
|____cmd
| |____api
|      |____main.go
|____migrations
|____go.mod
|____bin
|____Makefile
|____internal
|____remote
```

æˆ‘ä»¬èŠ±ç‚¹æ—¶é—´æ¥è®¨è®ºè¿™äº›æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼Œå¹¶è§£é‡Šå®ƒä»¬åœ¨é¡¹ç›®ä¸­æ‰€èµ·çš„ä½œç”¨ã€‚

* binç›®å½•åŒ…å«åº”ç”¨ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ç›´æ¥éƒ¨ç½²åˆ°ç”Ÿæˆç¯å¢ƒä¸­ã€‚
* cmd/apiç›®å½•åŒ…å«Greenlighté¡¹ç›®çš„APIä»£ç æ–‡ä»¶ã€‚åŒ…æ‹¬è¿è¡ŒHTTPæœåŠ¡å™¨ã€è¯»å†™HTTPè¯·æ±‚ä»¥åŠè®¤è¯ç®¡ç†ç­‰ä»£ç ã€‚
* internalç›®å½•åŒ…å«APIä½¿ç”¨çš„å„ç§è¾…åŠ©åŒ…ã€‚åŒ…æ‹¬ä¸æ•°æ®åº“äº¤äº’ã€æ•°æ®æ ¡éªŒã€å‘é€é‚®ä»¶ç­‰ã€‚åŸºæœ¬ä¸Šä»»ä½•éåº”ç”¨ç‰¹å®šä½†å¯å¤ç”¨çš„ä»£ç éƒ½æ”¾åœ¨è¿™é‡Œã€‚åœ¨cmd/apiä¸­çš„ä»£ç ä¼šå¯¼å…¥internalç›®å½•çš„ä»£ç ï¼ˆä½†ä»æ¥æ²¡æœ‰åè¿‡æ¥å¯¼å…¥çš„ï¼‰
* imgrationsç›®å½•åŒ…å«æ•°æ®åº“SQLè¿ç§»æ–‡ä»¶ã€‚
* remoteç›®å½•åŒ…å«é…åˆ¶æ–‡ä»¶å’Œè®¾ç½®è„šæœ¬ã€‚
* go.modæ–‡ä»¶ç”³æ˜é¡¹ç›®ä¾èµ–ï¼Œç‰ˆæœ¬å’Œmoduleè·¯å¾„ã€‚
* Makefileæ–‡ä»¶åŒ…å«å¸¸è§è‡ªåŠ¨æ‰§è¡Œç®¡ç†ä»»åŠ¡çš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼šä»£ç å®¡è®¡ã€æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶å’Œæ‰§è¡Œæ•°æ®åº“è¿ç§»ã€‚

è¦é‡ç‚¹æŒ‡å‡ºçš„æ˜¯internalç›®å½•åœ¨Goä¸­æœ‰ç‰¹æ®Šçš„å«ä¹‰ï¼šåœ¨è¿™ä¸ªç›®å½•ä¸­çš„ä»»ä½•åŒ…ï¼Œåªèƒ½è¢«è¯¥ç›®å½•çš„çˆ¶ç›®å½•å¯¼å…¥ä½¿ç”¨ã€‚åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œè¿™æ„å‘³ç€internalä¸­çš„æ‰€æœ‰åŒ…åªèƒ½è¢«greenlighté¡¹ç›®ä¸­ä»£ç æ‰€å¼•ç”¨ã€‚æˆ–è€…ï¼Œä»å¦ä¸€ä¸ªè§’åº¦æ¥è¯´ï¼Œè¿™æ„å‘³ç€internalçš„ä»»ä½•åŒ…éƒ½ä¸èƒ½é€šè¿‡é¡¹ç›®å¤–éƒ¨çš„ä»£ç å¯¼å…¥ã€‚è¿™æ˜¯æœ‰ç”¨çš„ï¼Œå› ä¸ºå®ƒå¯ä»¥é˜²æ­¢å…¶ä»–ä»£ç åº“å¯¼å…¥å’Œä¾èµ–æˆ‘ä»¬internalç›®å½•ä¸­çš„(å¯èƒ½æœªç‰ˆæœ¬åŒ–å’Œä¸æ”¯æŒçš„)åŒ…â€”â€”å³ä½¿é¡¹ç›®ä»£ç åœ¨GitHubä¸­å…¬å¼€å¯ç”¨ã€‚

## hello world

åœ¨ç»§ç»­ä¸‹ä¸€æ­¥ä¹‹å‰ï¼Œæˆ‘ä»¬å¿«é€Ÿæ£€æŸ¥ä¸‹æ‰€æœ‰è®¾ç½®æ˜¯å¦æ­£ç¡®ã€‚ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€cmd/api/main.goæ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```go
package main

import "fmt"

func main() { fmt.Println("Hello world!")
}
```

ä¿å­˜æ–‡ä»¶ï¼Œå¹¶åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨go runå‘½ä»¤ç¼–è¯‘å’Œæ‰§è¡Œcmd/apiåŒ…ä¸­çš„ä»£ç ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæ‚¨å°†çœ‹åˆ°ä»¥ä¸‹è¾“å‡º:

```shell
$ go run ./cmd/api
Hello world!
```
## ç®€å•çš„HTTPæœåŠ¡å™¨

ç°åœ¨é¡¹ç›®çš„æ¡†æ¶ç»“æ„å·²ç»å°±ç»ªï¼Œè®©æˆ‘ä»¬å°†æ³¨æ„åŠ›é›†ä¸­åœ¨å¯åŠ¨å’Œè¿è¡ŒHTTPæœåŠ¡å™¨ä¸Šã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å°†æœåŠ¡å™¨é…ç½®ä¸ºåªæœ‰ä¸€ä¸ªè·¯ç”±:/v1/healthcheckã€‚è¿™æ¡è·¯ç”±å°†è¿”å›æœ‰å…³APIçš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬å…¶å½“å‰ç‰ˆæœ¬å·å’Œæ“ä½œç¯å¢ƒ(å¼€å‘ã€è¿›åº¦ã€ç”Ÿäº§ç­‰)ã€‚


| URLæ¨¡å¼         | Handler            | æ“ä½œ         |
| ----------------- | -------------------- | -------------- |
| /v1/healthcheck | healthcheckHandler | æ˜¾ç¤ºåº”ç”¨ä¿¡æ¯ |

å¦‚æœä½ è·Ÿç€æœ¬ä¹¦æ“ä½œçš„ï¼Œä¸‹é¢æ‰“å¼€cmd/api/main.goæ–‡ä»¶ç”¨ä»¥ä¸‹ä»£ç æ›¿æ¢â€™hello worldâ€˜åº”ç”¨ï¼š

File:main.go

```go
package main

import (
	"flag"
	"fmt"
	"log"
	"net/http"
	"os"
	"time"
)

// å£°æ˜ä¸€ä¸ªåŒ…å«åº”ç”¨ç¨‹åºç‰ˆæœ¬å·çš„å­—ç¬¦ä¸². åœ¨æœ¬ä¹¦çš„åé¢ï¼Œæˆ‘ä»¬å°†åœ¨æ„å»ºæ—¶è‡ªåŠ¨ç”Ÿæˆå®ƒ
//ä½†æ˜¯ç°åœ¨æˆ‘ä»¬åªå°†ç‰ˆæœ¬å·å­˜å‚¨ä¸ºä¸€ä¸ªç¡¬ç¼–ç çš„å…¨å±€å¸¸é‡.
const version = "1.0.0"

// å®šä¹‰ä¸€ä¸ªé…ç½®ç»“æ„ä½“æ¥ä¿å­˜åº”ç”¨ç¨‹åºçš„æ‰€æœ‰é…ç½®è®¾ç½®.
//ç›®å‰ï¼Œå”¯ä¸€çš„é…ç½®æ˜¯æœåŠ¡å™¨ç›‘å¬çš„ç«¯å£å’Œåº”ç”¨ç¨‹åºçš„ç¯å¢ƒåç§° (å¼€å‘, é¢„å‘, ç”Ÿæˆç­‰ç­‰)
//å°†ä»å‘½ä»¤è¡Œå‚æ•°ä¸­è¯»å–è¿™äº›é…åˆ¶ä¿¡æ¯
type config struct {
	port int
	env  string
}

// å®šä¹‰ä¸€ä¸ªapplicationç»“æ„ä½“æ¥ä¿å­˜HTTPå¤„ç†ç¨‹åºçš„ä¾èµ–é¡¹
//ç›®å‰ï¼Œè¿™åªåŒ…å«é…ç½®å®ä¾‹çš„ä¸€ä¸ªå‰¯æœ¬å’Œæ—¥å¿—å¯¹è±¡ï¼Œä½†éšç€é¡¹ç›®æ·±å…¥ä¼šå¢åŠ æ›´å¤šå†…å®¹
type application struct {
	config config
	logger *log.Logger
}

func main() {
	// å£°æ˜ä¸€ä¸ªé…ç½®ç»“æ„ä½“å®ä¾‹
	var cfg config

	// ä»å‘½ä»¤è¡Œå‚æ•°ä¸­å°†portå’Œenvè¯»å–åˆ°é…åˆ¶ç»“æ„ä½“å®ä¾‹å½“ä¸­ã€‚
	//é»˜è®¤ç«¯å£ä½¿ç”¨4000ä»¥åŠç¯å¢ƒä¿¡æ¯ä½¿ç”¨å¼€å‘ç¯å¢ƒdevelopment
	flag.IntVar(&cfg.port, "port", 4000, "API server port")
	flag.StringVar(&cfg.env, "env", "development", "Environment (development|staging|production)")
	flag.Parse()

	// åˆå§‹åŒ–æ—¥å¿—å¯¹è±¡ï¼Œå°†æ¶ˆæ¯å†™å…¥åˆ°æ ‡å‡†è¾“å‡ºã€‚ ä»¥å½“å‰æ—¥æœŸå’Œæ—¶é—´ä¸ºå‰ç¼€
	logger := log.New(os.Stdout, "", log.Ldate|log.Ltime)

	// å£°æ˜åº”ç”¨ç¨‹åºç»“æ„çš„å®ä¾‹, åŒ…å«é…åˆ¶å¯¹è±¡å®ä¾‹å’Œæ—¥å¿—å¯¹è±¡ã€‚
	app := &application{
		config: cfg,
		logger: logger}

	// ç”³æ˜ä¸€ä¸ªæ–°çš„servemuxå¹¶æ·»åŠ /v1/healthcheckè·¯ç”±ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°å³å°†å®ç°çš„handlerå¤„ç†ç¨‹åºä¸­å»
	mux := http.NewServeMux()
	mux.HandleFunc("/v1/healthcheck", app.healthcheckHandler)

	// ä½¿ç”¨ä¸€äº›åˆç†çš„è¶…æ—¶è®¾ç½®å£°æ˜HTTPæœåŠ¡å™¨
	//ä½¿ç”¨é…åˆ¶å¯¹è±¡ä¸­çš„ç«¯å£å¥½ä»¥åŠåˆ›å»ºçš„servemuxä½œä¸ºhandler
	srv := &http.Server{
		Addr:         fmt.Sprintf(":%d", cfg.port),
		Handler:      mux,
		IdleTimeout:  time.Minute,
		ReadTimeout:  10 * time.Second,
		WriteTimeout: 30 * time.Second,
	}

	// å¯åŠ¨HTTPæœåŠ¡
	logger.Printf("starting %s server on %s", cfg.env, srv.Addr)
	err := srv.ListenAndServe()
	logger.Fatal(err)
}

```

## åˆ›å»ºhealthcheckå¤„ç†ç¨‹åº

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åˆ›å»ºç”¨äºå“åº”HTTPè¯·æ±‚çš„healthcheckHandleræ–¹æ³•ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä¿æŒè¿™ä¸ªå¤„ç†ç¨‹åºä¸­çš„é€»è¾‘éå¸¸ç®€å•ï¼Œåªè®©å®ƒè¿”å›ä¸€ä¸ªåŒ…å«ä¸‰æ®µä¿¡æ¯çš„çº¯æ–‡æœ¬å“åº”:

* ä¸€ä¸ªå›ºå®šçš„â€œstatus: availableâ€å­—ç¬¦ä¸²
* APIç‰ˆæœ¬ä»ç¡¬ç¼–ç versionå¸¸é‡è·å–
* æ“ä½œç¯å¢ƒåä»å‘½ä»¤è¡Œå‚æ•°è¯»å–å­˜åœ¨envä¸­

ç»§ç»­åˆ›å»ºcmd/api/healthcheck.goæ–‡ä»¶ï¼š

```shell
$ touch cmd/api/healthcheck.go
```

æ·»åŠ å¦‚ä¸‹ä»£ç åˆ°æ–‡ä»¶ä¸­ï¼š

Fileï¼šcmd/api/healthcheck.go

```go
package main

import (
	"fmt"
	"net/http"
)

//ç”³æ˜ä¸€ä¸ªhandlerè¿”å›åº”ç”¨ç¨‹åºçŠ¶æ€ï¼Œæ“ä½œç¯å¢ƒå’Œç‰ˆæœ¬
func (app *application) healthcheck(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintln(w, "status: available")
	fmt.Fprintf(w, "environment %s\n", app.config.env)
	fmt.Fprintf(w, "version: %s\n", version)
}

```

è¿™é‡Œéœ€è¦æŒ‡å‡ºçš„é‡è¦ä¸€ç‚¹æ˜¯ï¼ŒhealthcheckHandleræ˜¯ä½œä¸ºapplicationç»“æ„ä½“ä¸Šçš„ä¸€ä¸ªæ–¹æ³•å®ç°çš„.

è¿™æ˜¯ä¸€ç§æœ‰æ•ˆä¸”æƒ¯ç”¨çš„æ–¹æ³•ï¼Œä½¿æˆ‘ä»¬çš„å¤„ç†ç¨‹åºå¯ä»¥ä½¿ç”¨ä¾èµ–é¡¹ï¼Œè€Œä¸éœ€è¦å€ŸåŠ©å…¨å±€å˜é‡æˆ–é—­åŒ…â€”â€”å½“æˆ‘ä»¬åœ¨main()ä¸­åˆå§‹åŒ–healthcheckHandleræ—¶ï¼Œä»»ä½•ä¾èµ–é¡¹éƒ½å¯ä»¥ç®€å•åœ°ä½œä¸ºä¸€ä¸ªå­—æ®µåŒ…å«åœ¨åº”ç”¨ç¨‹åºç»“æ„ä¸­ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä»£ç ä¸­å·²ç»ä½¿ç”¨äº†è¿™ä¸ªæ¨¡å¼ï¼Œå…¶ä¸­é€šè¿‡è°ƒç”¨app.config.envä»åº”ç”¨ç¨‹åºç»“æ„ä¸­æ£€ç´¢æ“ä½œç¯å¢ƒåç§°ã€‚

## æ¼”ç¤º

ä»£ç æˆ‘ä»¬æ¥è¯•è¯•æ¥å£ï¼Œè¯·ç¡®ä¿ä½ çš„æ‰€æœ‰æ›´æ”¹éƒ½å·²ä¿å­˜ï¼Œç„¶åå†æ¬¡ä½¿ç”¨go runå‘½ä»¤æ¥æ‰§è¡Œcmd/apiåŒ…ä¸­çš„ä»£ç ã€‚æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸€æ¡æ—¥å¿—æ¶ˆæ¯ï¼Œç¡®è®¤HTTPæœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œç±»ä¼¼å¦‚ä¸‹:

```shell
 $ go run ./cmd/api
2021/11/15 19:42:50 starting development server on :4000
```

å½“æœåŠ¡å™¨è¿è¡Œæ—¶ï¼Œç»§ç»­å°è¯•åœ¨webæµè§ˆå™¨ä¸­è®¿é—®localhost:4000/v1/healthcheckã€‚ä½ åº”è¯¥ä»healthcheckHandlerå¾—åˆ°å¦‚ä¸‹å“åº”:
![](../../images/2.2/env1.png)

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨curlä»æ‚¨çš„ç»ˆç«¯å‘å‡ºè¯·æ±‚:

```shell
$ curl -i localhost:4000/v1/healthcheck
HTTP/1.1 200 OK
Date: Mon, 05 Apr 2021 17:46:14 GMT Content-Length: 58
Content-Type: text/plain; charset=utf-8
status: available environment: development version: 1.0.0
```

> æ³¨æ„:ä¸Šé¢å‘½ä»¤ä¸­çš„-iæ ‡å¿—è¡¨ç¤ºcurlæ˜¾ç¤ºHTTPå“åº”å¤´å’Œå“åº”ä½“ã€‚

å¦‚æœä½ æƒ³éªŒè¯åœ¨å‘½ä»¤è¡Œå‚æ•°æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œé€šè¿‡æŒ‡å®športå’Œenvå€¼ç„¶ååœ¨å¯åŠ¨æœåŠ¡å™¨ã€‚ä½ åº”è¯¥å¯ä»¥çœ‹åˆ°æ—¥å¿—ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š

```shell
 $ go run ./cmd/api -port=3030 -env=production
2021/04/05 19:48:34 starting production server on :3030
```

## é™„åŠ è¯´æ˜

### APIç‰ˆæœ¬

æ”¯æŒçœŸå®ä¸šåŠ¡å’Œç”¨æˆ·çš„apiç»å¸¸éœ€è¦éšç€æ—¶é—´çš„æ¨ç§»è€Œæ›´æ”¹å…¶åŠŸèƒ½å’ŒAPIâ€”â€”æœ‰æ—¶æ˜¯ä»¥ä¸€ç§å‘åä¸å…¼å®¹çš„æ–¹å¼ã€‚å› æ­¤ï¼Œä¸ºäº†é¿å…å®¢æˆ·ç«¯å‡ºç°é—®é¢˜å’Œå›°æƒ‘ï¼Œæœ€å¥½å®ç°æŸç§å½¢å¼çš„APIç‰ˆæœ¬æ§åˆ¶ã€‚

é€šå¸¸æœ‰ä¸¤ç§æ–¹æ³•æ¥å®ç°ï¼š

1ã€é€šè¿‡ç»™æ‰€æœ‰urlåŠ ä¸ŠAPIç‰ˆæœ¬çš„å‰ç¼€ï¼Œæ¯”å¦‚/v1/healthcheckæˆ–/v2/healthcheckã€‚

2ã€é€šè¿‡åœ¨è¯·æ±‚å’Œå“åº”ä¸­ä½¿ç”¨è‡ªå®šä¹‰çš„Acceptå’ŒContent-Typeå¤´æ¥ä¼ é€’APIç‰ˆæœ¬ï¼Œæ¯”å¦‚Accept: application/vnd.greenlight-v1ã€‚

ä»HTTPè¯­ä¹‰çš„è§’åº¦æ¥çœ‹ï¼Œä½¿ç”¨å¤´æ¥ä¼ é€’APIç‰ˆæœ¬æ˜¯ä¸€ç§â€œæ›´çº¯ç²¹â€çš„æ–¹æ³•ã€‚ä½†ä»ç”¨æˆ·ä½“éªŒçš„è§’åº¦æ¥çœ‹ï¼Œä½¿ç”¨URLå‰ç¼€å¯èƒ½æ›´å¥½ã€‚å¼€å‘è€…ä¸€çœ¼å°±èƒ½çœ‹å‡ºAPIçš„ç‰ˆæœ¬ï¼Œä¹Ÿæ„å‘³ç€å¯ä»¥ä½¿ç”¨å¸¸è§„çš„webæµè§ˆå™¨æ¥è®¿é—®APIï¼ˆå¦‚æœæ”¾åœ¨è¯·æ±‚å¤´å°±æ›´ä¸æ–¹ä¾¿ï¼‰ã€‚


åœ¨æ•´æœ¬ä¹¦ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡åœ¨æ‰€æœ‰URLè·¯å¾„å‰åŠ ä¸Š/v1/æ¥å¯¹APIè¿›è¡Œç‰ˆæœ¬åŒ–ï¼Œå°±åƒæˆ‘ä»¬åœ¨æœ¬ç« ä¸­å¯¹/v1/healthcheckæ¥å£æ‰€åšçš„é‚£æ ·ã€‚
## APIæ¥å£å’ŒRESTfulè·¯ç”±

åœ¨æœ¬ä¹¦æ¥ä¸‹æ¥çš„å‡ èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†é€æ­¥æ„å»ºæˆ‘ä»¬çš„APIï¼Œä½¿æ¥å£çœ‹èµ·æ¥åƒè¿™æ ·:


| Method | URL             | åŠ¨ä½œ                           |
| -------- | ----------------- | -------------------------------- |
| GET    | /v1/healthcheck | æ˜¾ç¤ºåº”ç”¨ç¨‹åºè¿è¡ŒçŠ¶å†µå’Œç‰ˆæœ¬ä¿¡æ¯ |
| GET    | /v1/movies      | æ˜¾ç¤ºæ‰€æœ‰ç”µå½±çš„è¯¦æƒ…             |
| POST   | /v1/movies      | æ·»åŠ æ–°çš„ç”µå½±                   |
| GET    | /v1/movies/:id  | æ ¹æ®idæŸ¥è¯¢ç‰¹å®šç”µå½±             |
| PATCH  | /v1/movies/:id  | æ›´æ–°ç‰¹å®šç”µå½±                   |
| DELETE | /v1/movies/:id  | åˆ é™¤ç‰¹å®šç”µå½±                   |

å¦‚æœæ‚¨ä»¥å‰ç”¨RESTé£æ ¼æ„å»ºè¿‡APIsï¼Œé‚£ä¹ˆä¸Šé¢çš„è¡¨å¯èƒ½å¯¹æ‚¨éå¸¸ç†Ÿæ‚‰ï¼Œä¸éœ€è¦å¤ªå¤šè§£é‡Šã€‚ä½†å¦‚æœä½ æ˜¯æ–°æ‰‹ï¼Œé‚£ä¹ˆæœ‰å‡ ä»¶é‡è¦çš„äº‹æƒ…éœ€è¦æŒ‡å‡ºã€‚

é¦–å…ˆï¼Œå…·æœ‰ç›¸åŒURLæ¨¡å¼çš„è¯·æ±‚å°†åŸºäºHTTPè¯·æ±‚æ–¹æ³•è·¯ç”±åˆ°ä¸åŒçš„å¤„ç†ç¨‹åºã€‚ä¸ºäº†å®‰å…¨æ€§å’Œè¯­ä¹‰çš„æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬ä¸ºå¤„ç†ç¨‹åºæ‰§è¡Œçš„æ“ä½œä½¿ç”¨é€‚å½“çš„HTTPæ–¹æ³•æ˜¯å¾ˆé‡è¦çš„ã€‚

æ€»ä¹‹ï¼š


| Method | ç”¨é€”                                                                                             |
| -------- | -------------------------------------------------------------------------------------------------- |
| GET    | ç”¨äºåªæ£€ç´¢ä¿¡æ¯è€Œä¸æ›´æ”¹åº”ç”¨ç¨‹åºæˆ–ä»»ä½•æ•°æ®çŠ¶æ€çš„æ“ä½œã€‚                                             |
| POST   | ç”¨äºä¿®æ”¹çŠ¶æ€çš„éå¹‚ç­‰æ“ä½œã€‚åœ¨REST APIä¸Šä¸‹æ–‡ä¸­ï¼ŒPOSTé€šå¸¸ç”¨äºåˆ›å»ºæ–°èµ„æºçš„æ“ä½œã€‚                     |
| PUT    | ç”¨äºä¿®æ”¹ç‰¹å®šURLä¸Šèµ„æºçš„çŠ¶æ€çš„å¹‚ç­‰æ“ä½œã€‚åœ¨REST APIä¸Šä¸‹æ–‡ä¸­ï¼ŒPUTé€šå¸¸ç”¨äºæ›¿æ¢æˆ–æ›´æ–°ç°æœ‰èµ„æºçš„æ“ä½œã€‚ |
| PATCH  | ç”¨äºå¯¹ç‰¹å®šURLä¸Šçš„èµ„æºéƒ¨åˆ†æ›´æ–°æ“ä½œã€‚ä¸ç®¡æ˜¯å¹‚ç­‰çš„è¿˜æ˜¯éå¹‚ç­‰çš„éƒ½æ˜¯å¯ä»¥çš„ã€‚                          |
| DELETE | ç”¨äºåˆ é™¤ç‰¹å®šURLä¸Šçš„èµ„æºçš„æ“ä½œã€‚                                                                  |

å¦ä¸€ä»¶é‡è¦çš„äº‹æƒ…éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œæˆ‘ä»¬çš„APIæ¥å£å°†ä½¿ç”¨ç®€æ´URLsï¼Œåœ¨URLè·¯å¾„ä¸­æ’å…¥å‚æ•°ã€‚ä¾‹å¦‚ï¼Œè¦è·å–ç‰¹å®šçš„ç”µå½±ä¿¡æ¯å®¢æˆ·ç«¯å°†å‘é€è¯·æ±‚ä¸ºï¼š/v1/movies/1ï¼Œè€Œä¸æ˜¯æ·»åŠ ç”µå½±IDåˆ°æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°ä¸­ä¾‹å¦‚ï¼šGET /v1/movies?id=1ã€‚

## é€‰æ‹©è·¯ç”±

å½“ä½ åœ¨Goä¸­ä½¿ç”¨è¿™ç§æ¥å£æ„å»ºAPIæ—¶ï¼Œä½ å°†é‡åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯http.ServeMuxâ€”â€”Goæ ‡å‡†åº“ä¸­çš„è·¯ç”±å™¨â€”â€”åœ¨åŠŸèƒ½ä¸Šéå¸¸æœ‰é™ã€‚ç‰¹åˆ«æ˜¯ï¼Œå®ƒä¸å…è®¸åŸºäºè¯·æ±‚æ–¹æ³•(GETã€POSTç­‰)å°†è¯·æ±‚è·¯ç”±åˆ°ä¸åŒçš„å¤„ç†ç¨‹åºï¼Œä¹Ÿä¸æ”¯æŒå¸¦æœ‰urlä¸­æ’å…¥å‚æ•°å€¼ã€‚

å°½ç®¡æ‚¨å¯ä»¥è§£å†³è¿™äº›é™åˆ¶ï¼Œæˆ–è€…å®ç°æ‚¨è‡ªå·±çš„è·¯ç”±å™¨ï¼Œä½†é€šå¸¸ä½¿ç”¨è®¸å¤šå¯ç”¨çš„ç¬¬ä¸‰æ–¹è·¯ç”±å™¨ä¼šæ›´å®¹æ˜“ã€‚

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†httprouteråŒ…é›†æˆåˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ã€‚æœ€é‡è¦çš„æ˜¯httprouterç¨³å®šã€ç»è¿‡è‰¯å¥½æµ‹è¯•ï¼Œå¹¶æä¾›äº†æˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½â€”â€”å¦å¤–ï¼Œç”±äºä½¿ç”¨äº†radixæ ‘æ¥è¿›è¡ŒURLåŒ¹é…ï¼Œé€Ÿåº¦éå¸¸å¿«ã€‚å¦‚æœæ‚¨æ­£åœ¨æ„å»ºä¸€ä¸ªä¾›å…¬ä¼—ä½¿ç”¨çš„REST APIï¼Œé‚£ä¹ˆhttprouteræ˜¯ä¸€ä¸ªå¯é çš„é€‰æ‹©ã€‚

å¦‚æœä½ æ­£è·Ÿéšæœ¬ä¹¦æ“ä½œï¼Œè¯·ä½¿ç”¨httpprouterçš„1.3.0ç‰ˆæœ¬ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```shell
$ go get github.com/julienschmidt/httprouter@v1.3.0
go: downloading github.com/julienschmidt/httprouter v1.3.0 go get: added github.com/julienschmidt/httprouter v1.3.0
```

> æ³¨æ„ï¼šå¦‚æœä½ ç”µè„‘ä¸Šå·²ç»å…¶ä»–é¡¹ç›®ä½¿ç”¨httprouter v1.3.0åŒ…ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨å·²ç»å­˜åœ¨çš„ç‰ˆæœ¬å°†ä¸ä¼šçœ‹åˆ°go: downloading...è¿™äº›ä¿¡æ¯

ä¸ºäº†æ¼”ç¤ºhttprouteræ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæˆ‘ä»¬é¦–å…ˆå°†ä¸¤ä¸ªæ¥å£æ·»åŠ åˆ°ä»£ç åº“ä¸­ï¼Œç”¨äºåˆ›å»ºæ–°ç”µå½±å¹¶æŸ¥è¯¢ç‰¹å®šç”µå½±çš„è¯¦æƒ…ã€‚åœ¨æœ¬ç« ç»“æŸæ—¶ï¼Œæˆ‘ä»¬çš„APIæ¥å£å°†çœ‹èµ·æ¥åƒè¿™æ ·:


| Method | URL             | åŠ¨ä½œ                           |
| -------- | ----------------- | -------------------------------- |
| GET    | /v1/healthcheck | æ˜¾ç¤ºåº”ç”¨ç¨‹åºè¿è¡ŒçŠ¶å†µå’Œç‰ˆæœ¬ä¿¡æ¯ |
| GET    | /v1/movies      | æ˜¾ç¤ºæ‰€æœ‰ç”µå½±çš„è¯¦æƒ…             |
| POST   | /v1/movies      | æ·»åŠ æ–°çš„ç”µå½±                   |

## å°è£…APIè·¯ç”±

ä¸ºäº†é˜²æ­¢main()å‡½æ•°éšç€APIçš„å¢é•¿è€Œå˜å¾—æ··ä¹±ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰çš„è·¯ç”±è§„åˆ™å°è£…åœ¨ä¸€ä¸ªæ–°çš„cmd/api/routes.goæ–‡ä»¶ä¸­ã€‚

å¦‚æœæ‚¨æŒ‰ç…§å‰é¢çš„æ­¥éª¤æ“ä½œï¼Œè¯·åˆ›å»ºè¿™ä¸ªæ–°æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹ä»£ç :

```shell
$ touch cmd/api/routes.go
```

```go
package main

import (
	"github.com/julienschmidt/httprouter"
	"net/http"
)

func (app *application) routes() http.Handler {
        //åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„httprouterè·¯ç”±å™¨å®ä¾‹
	router := httprouter.New()

        //ä½¿ç”¨HandlerFunc()å‡½æ•°ä¸ºæ¥å£æ³¨å†Œç›¸å…³æ–¹æ³•ï¼ŒURLæ¨¡å¼å’Œå¤„ç†å‡½æ•°ã€‚
        //æ³¨æ„http.MethodGetå’Œhttp.MethodPostæ˜¯å¸¸é‡ï¼Œç­‰ä»·äºå­—ç¬¦ä¸²"GET"å’Œ"POST"
	router.HandlerFunc(http.MethodGet, "/v1/healthcheck", app.healthcheckHandler)
	router.HandlerFunc(http.MethodPost, "/v1/movies", app.createMovieHandler)
	router.HandlerFunc(http.MethodGet, "/v1/movies/:id", app.showMovieHandler)

        //è¿”å›httprouterå®ä¾‹
        return router
}

```

> æç¤º:httprouteråŒ…è¿˜æä¾›äº†ä¸€ä¸ªrouter.Handler()æ–¹æ³•ï¼Œå½“ä½ æƒ³æ³¨å†Œä¸€ä¸ªå¸¸è§„çš„http.handler(è€Œä¸æ˜¯å¤„ç†ç¨‹åºå‡½æ•°ï¼Œå°±åƒæˆ‘ä»¬åœ¨ä¸Šé¢çš„ä»£ç )ã€‚

ä»¥è¿™ç§æ–¹å¼å°è£…è·¯ç”±è§„åˆ™æœ‰å‡ ä¸ªå¥½å¤„ã€‚ç¬¬ä¸€ä¸ªå¥½å¤„æ˜¯å®ƒä½¿main()å‡½æ•°ä¿æŒç®€æ´ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰è·¯ç”±éƒ½åœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰ã€‚å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆå§‹åŒ–applicationå®ä¾‹å¹¶åœ¨å…¶ä¸Šè°ƒç”¨routes()æ–¹æ³•ï¼Œè½»æ¾åœ°åœ¨ä»»ä½•æµ‹è¯•ä»£ç ä¸­è®¿é—®è·¯ç”±å™¨ã€‚j

æ¥ä¸‹æ¥éœ€è¦æ›´æ–°main()å‡½æ•°æ¥åˆ é™¤http.ServeMuxå£°æ˜ï¼Œå¹¶ä½¿ç”¨app.routes()è¿”å›çš„httprouterå®ä¾‹ä½œä¸ºæœåŠ¡å™¨å¤„ç†ç¨‹åºã€‚åƒè¿™æ ·:

File: cmd/api/main.go

---

```go
package main
...
func main() {
	var cfg config

	flag.IntVar(&cfg.port, "port", 4000, "API server port")
	flag.StringVar(&cfg.env, "env", "development", "Environment (development|staging|production)") flag.Parse()
	logger := log.New(os.Stdout, "", log.Ldate|log.Ltime)
	app := &application{ config: cfg,
		logger: logger }

	// ä½¿ç”¨http.routerå®ä¾‹åšæœåŠ¡å™¨çš„å¤„ç†ç¨‹åºhandler
	srv := &http.Server{
		Addr: fmt.Sprintf(":%d", cfg.port), Handler: app.routes(),
		IdleTimeout: time.Minute,
		ReadTimeout: 10 * time.Second, WriteTimeout: 30 * time.Second,
	}

	logger.Printf("starting %s server on %s", cfg.env, srv.Addr)
	err := srv.ListenAndServe()
	logger.Fatal(err)
}
```

## æ·»åŠ æ–°çš„handlerå‡½æ•°

æ—¢ç„¶è·¯ç”±è§„åˆ™å·²ç»è®¾ç½®å¥½äº†ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ–°å¢çš„æ¥å£åˆ›å»ºcreateMovieHandlerå’ŒshowMovieHandleræ–¹æ³•ã€‚è¿™é‡Œçš„showMovieHandleræ¯”è¾ƒç‰¹æ®Šï¼Œå› ä¸ºä½œä¸ºURLçš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¸Œæœ›ä»URLä¸­æå–ç”µå½±IDå‚æ•°ï¼Œå¹¶åœ¨HTTPå“åº”ä¸­ä½¿ç”¨å®ƒã€‚

ç»§ç»­å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„cmd/api/movies.goæ–‡ä»¶ä¿å­˜è¿™ä¸¤ä¸ªæ–°çš„å¤„ç†ç¨‹åº:

```shell
 $ touch cmd/api/movies.go
```

æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```go
package main
import ( "fmt"
"net/http" "strconv"
"github.com/julienschmidt/httprouter"
)
// ä¸º"POST /v1/movies"æ¥å£æ·»åŠ createMovieHandleræ–¹æ³•ï¼Œè¿™é‡Œç®€å•çš„è¿”å›æ–‡æœ¬
func (app *application) createMovieHandler(w http.ResponseWriter, r *http.Request) {
fmt.Fprintln(w, "create a new movie") }

// ä¸º "GET /v1/movies/:id" æ¥å£æ·»åŠ showMovieHandleræ–¹æ³•. è¿™é‡Œæˆ‘ä»¬ä»è¯·æ±‚urlä¸­è§£æå‡ºç”µå½±idï¼Œå¹¶åœ¨å“åº”ä¸­è¿”å›ã€‚
func (app *application) showMovieHandler(w http.ResponseWriter, r *http.Request) {
// å½“httprouterè§£æè¯·æ±‚æ—¶ï¼Œä»»ä½•å†…ç½®çš„URLå‚æ•°éƒ½å°†å­˜å‚¨åœ¨è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­ã€‚ 
//å¯ä»¥ä½¿ç”¨ParamsFromContext()å‡½æ•°æ£€ç´¢åŒ…å«è¿™äº›å‚æ•°åç§°å’Œå€¼çš„åˆ‡ç‰‡ã€‚
params := httprouter.ParamsFromContext(r.Context())

// ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ByName()æ–¹æ³•ä»åˆ‡ç‰‡ä¸­è·å–â€œidâ€å‚æ•°çš„å€¼ã€‚åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œæ‰€æœ‰çš„ç”µå½±éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ­£æ•´æ•°ID
//ä½†æ˜¯ByName()è¿”å›çš„å€¼æ€»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚æ‰€ä»¥æˆ‘ä»¬å°è¯•å°†å®ƒè½¬æ¢ä¸ºä¸€ä¸ªä»¥10ä¸ºåŸºæ•°çš„æ•´æ•°(bit sizeä¸º64)ã€‚
//å¦‚æœå‚æ•°ä¸èƒ½è¢«è½¬æ¢æˆ–è€…å°äº1ï¼Œæˆ‘ä»¬çŸ¥é“IDæ— æ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨http.NotFound()è¿”å›404 Not Foundå“åº”ã€‚
id, err := strconv.ParseInt(params.ByName("id"), 10, 64) if err != nil || id < 1 {
http.NotFound(w, r)
return
}

// å¦åˆ™ï¼Œåœ¨å“åº”ä¸­æ’å…¥ç”µå½±ID
fmt.Fprintf(w, "show the details of movie %d\n", id) }
```

æœ‰äº†è¿™äº›ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥è¯•ä¸€ä¸‹äº†!é‡æ–°å¯åŠ¨APIåº”ç”¨ç¨‹åºâ€¦

```shell
 $ go run ./cmd/api
2021/04/06 08:57:25 starting development server on :4000
```

ç„¶åï¼Œåœ¨æœåŠ¡å™¨è¿è¡Œæ—¶ï¼Œæ‰“å¼€ç¬¬äºŒä¸ªç»ˆç«¯çª—å£ï¼Œå¹¶ä½¿ç”¨curlå‘ä¸åŒçš„æ¥å£å‘å‡ºè¯·æ±‚ã€‚å¦‚æœä¸€åˆ‡è®¾ç½®æ­£ç¡®ï¼Œä½ ä¼šçœ‹åˆ°ä¸€äº›ç±»ä¼¼è¿™æ ·çš„å“åº”:

```shell
$ curl localhost:4000/v1/healthcheck
status: available environment: development version: 1.0.0

$ curl -X POST localhost:4000/v1/movies
create a new movie

$ curl localhost:4000/v1/movies/123
show the details of movie 123
```

æ³¨æ„ï¼Œåœ¨æœ€åä¸€ä¸ªä¾‹å­ä¸­ï¼Œç”µå½±idå‚æ•°123çš„å€¼æ˜¯å¦‚ä½•ä»URLä¸­æˆåŠŸæ£€ç´¢åˆ°å¹¶åŒ…å«åœ¨å“åº”ä¸­çš„?

æ‚¨å¯èƒ½è¿˜æƒ³å°è¯•ä½¿ç”¨ä¸æ”¯æŒçš„HTTPæ–¹æ³•å¯¹ç‰¹å®šçš„URLå‘å‡ºä¸€äº›è¯·æ±‚ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å°è¯•å‘/v1/healthcheckå‘é€ä¸€ä¸ªPOSTè¯·æ±‚:

```shell
$ curl -i -X POST localhost:4000/v1/healthcheck
HTTP/1.1 405 Method Not Allowed
Allow: GET, OPTIONS
Content-Type: text/plain; charset=utf-8 X-Content-Type-Options: nosniff
Date: Tue, 06 Apr 2021 06:59:04 GMT Content-Length: 19

Method Not Allowed
```

çœ‹èµ·æ¥å¾ˆä¸é”™ã€‚httprouteråŒ…è‡ªåŠ¨å‘é€äº†ä¸€ä¸ª405 Method Not Allowedå“åº”ï¼ŒåŒ…æ‹¬ä¸€ä¸ªAllowæŠ¥å¤´ï¼Œå®ƒåˆ—å‡ºäº†ç«¯ç‚¹æ”¯æŒçš„HTTPæ–¹æ³•ã€‚

åŒæ ·åœ°ï¼Œä½ å¯ä»¥å‘ä¸€ä¸ªç‰¹å®šçš„URLå‘å‡ºä¸€ä¸ªOPTIONSè¯·æ±‚ï¼Œhttprouterä¼šè¿”å›ä¸€ä¸ªå¸¦æœ‰AllowæŠ¥å¤´çš„å“åº”ï¼Œå…¶ä¸­è¯¦ç»†è¯´æ˜äº†æ‰€æ”¯æŒçš„HTTPæ–¹æ³•ã€‚åƒè¿™æ ·:

```shell
$ curl -i -X OPTIONS localhost:4000/v1/healthcheck
HTTP/1.1 200 OK
Allow: GET, OPTIONS
Date: Tue, 06 Apr 2021 07:01:29 GMT Content-Length: 0
```

æœ€åï¼Œæ‚¨å¯èƒ½æƒ³å°è¯•åœ¨URLä¸­ä½¿ç”¨è´Ÿæ•°æˆ–éæ•°å­—idå€¼å‘GET /v1/movies/:idæ¥å£å‘å‡ºè¯·æ±‚ã€‚è¿™åº”è¯¥ä¼šå¾—åˆ° 404 Not Foundå“åº”ï¼Œç±»ä¼¼äº:

```shell
$ curl -i localhost:4000/v1/movies/abc
HTTP/1.1 404 Not Found
Content-Type: text/plain; charset=utf-8 X-Content-Type-Options: nosniff
Date: Tue, 06 Apr 2021 07:02:01 GMT Content-Length: 19

404 page not found
```

## ä¸ºè¯»å–è¯·æ±‚å‚æ•°IDåˆ›å»ºè¾…åŠ©å‡½æ•°

ä»URL(å¦‚/v1/movies/:id)ä¸­æå–idå‚æ•°çš„ä»£ç æ˜¯æˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºä¸­éœ€è¦åå¤ä½¿ç”¨çš„ï¼Œå› æ­¤æˆ‘ä»¬å°†æ­¤é€»è¾‘æŠ½è±¡ä¸ºä¸€ä¸ªå¯é‡ç”¨çš„è¾…åŠ©æ–¹æ³•ã€‚

åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼šcmd/api/helper.go

```shell
$ touch cmd/api/helpers.go
```

å¹¶å‘applicationç»“æ„ä½“æ·»åŠ ä¸€ä¸ªæ–°çš„readdparam()æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤º:

File: cmd/api/helpers.go

---

```go
package main
import ( "errors"
"net/http" "strconv"

"github.com/julienschmidt/httprouter"
)

// ä»å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡æ£€ç´¢â€œidâ€URLå‚æ•°, ç„¶åå°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªæ•´æ•°å¹¶è¿”å›ã€‚å¦‚æœæ“ä½œä¸æˆåŠŸï¼Œåˆ™è¿”å›0å’Œä¸€ä¸ªé”™è¯¯. 
func (app *application) readIDParam(r *http.Request) (int64, error) {
    params := httprouter.ParamsFromContext(r.Context())

    id, err := strconv.ParseInt(params.ByName("id"), 10, 64) 
    if err != nil || id < 1 {
        return 0, errors.New("invalid id parameter") 
    }

    return id, nil 
}
```

> readadidparam()æ–¹æ³•ä¸ä½¿ç”¨æ¥è‡ªapplicationç»“æ„ä½“çš„ä»»ä½•ä¾èµ–é¡¹ï¼Œå› æ­¤å®ƒå¯èƒ½åªæ˜¯ä¸€ä¸ªå¸¸è§„å‡½æ•°ï¼Œè€Œä¸æ˜¯applicationä¸Šçš„æ–¹æ³•ã€‚ä½†ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘å»ºè®®è®¾ç½®æ‰€æœ‰ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„å¤„ç†ç¨‹åºå’Œå¸®åŠ©å‡½æ•°ï¼Œä»¥ä¾¿å®ƒä»¬æ˜¯applicationä¸Šçš„æ–¹æ³•ã€‚å®ƒæœ‰åŠ©äºä¿æŒä»£ç ç»“æ„çš„ä¸€è‡´æ€§ï¼Œå¹¶ä¸”åœ¨é‚£äº›å¤„ç†ç¨‹åºå’Œå¸®åŠ©å‡½æ•°ç¨åæ›´æ”¹å¹¶ä¸”å®ƒä»¬ç¡®å®éœ€è¦è®¿é—®ä¾èµ–é¡¹æ—¶ä»£ç ä¸ä¼šè¿‡æ—¶ã€‚

æœ‰äº†è¿™ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œæˆ‘ä»¬çš„showMovieHandlerä¸­çš„ä»£ç ç°åœ¨å¯ä»¥å˜å¾—ç®€å•å¾—å¤š:

File: cmd/api/movies.go

---

```go
package main
    import ( "fmt"
    "net/http"
)

...

func (app *application) showMovieHandler(w http.ResponseWriter, r *http.Request) { 
    id, err := app.readIDParam(r)
    if err != nil {
        http.NotFound(w, r) 
    return
    }

    fmt.Fprintf(w, "show the details of movie %d\n", id) 
}
```

## é™„åŠ è¯´æ˜

#### è·¯å¾„å†²çª

è¦æ„è¯†åˆ°httprouterä¸å…è®¸å¯èƒ½åŒ¹é…ç›¸åŒè¯·æ±‚çš„å†²çªè·¯ç”±ã€‚å› æ­¤ï¼Œä½ ä¸èƒ½æ³¨å†Œä¸€ä¸ªåƒGET /foo/newè¿™æ ·çš„è·¯ç”±å’Œå¦ä¸€ä¸ªå¸¦æœ‰ä¸ä¹‹å†²çªçš„å‚æ•°çš„è·¯ç”±ï¼Œæ¯”å¦‚GET /foo/:idã€‚

å¦‚æœä½ ä½¿ç”¨æ ‡å‡†RESTç»“æ„æ¥è®¾è®¡APIçš„è¯ï¼Œå°±ä¸ä¼šæœ‰è¿™ç§é—®é¢˜å‡ºç°ã€‚å› ä¸ºä¸å…è®¸æœ‰å†²çªçš„è·¯ç”±ï¼Œæ‰€ä»¥ä¸éœ€è¦æ‹…å¿ƒè·¯ç”±ä¼˜å…ˆçº§è§„åˆ™ï¼Œè¿™å°±å‡å°‘äº†åº”ç”¨ç¨‹åºä¸­å‡ºç°é”™è¯¯å’Œæ„å¤–è¡Œä¸ºçš„é£é™©ã€‚ä½†æ˜¯å¦‚æœä½ éœ€è¦æ”¯æŒè¿™ç§å†²çªè·¯ç”±çš„è¯ï¼ˆä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½éœ€è¦å®Œå…¨å¤åˆ¶ç°æœ‰APIçš„æ¥å£ä»¥å®ç°å‘åå…¼å®¹æ€§ï¼‰é‚£ä¹ˆæˆ‘å»ºè®®ä½ çœ‹çœ‹pat, chiæˆ–è€…Gorilla muxã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯å¾ˆå¥½çš„ç¬¬ä¸‰æ–¹è·¯ç”±å™¨åŒ…ï¼Œå®ƒä»¬å…è®¸å†²çªçš„è·¯ç”±ã€‚

## å®šåˆ¶httprouterè¡Œä¸º

httprouteråŒ…æä¾›äº†ä¸€äº›é…ç½®é€‰é¡¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™äº›é€‰é¡¹è¿›ä¸€æ­¥å®šåˆ¶åº”ç”¨ç¨‹åºçš„è¡Œä¸ºï¼ŒåŒ…æ‹¬å¯ç”¨å°¾éƒ¨æ–œæ é‡å®šå‘å’Œå¯ç”¨è‡ªåŠ¨URLè·¯å¾„æ¸…ç†ã€‚æ›´å¤šå¯è®¾ç½®çš„ä¿¡æ¯å¯ä»¥å‚è€ƒ[è¿™é‡Œ](https://pkg.go.dev/github.com/julienschmidt/httprouter?tab=doc#Router)ã€‚
## å¼€å§‹

åœ¨æœ¬ä¹¦çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å»ºä¸€ä¸ªé¡¹ç›®æ¡†æ¶ï¼Œå¹¶ä¸ºæ„å»ºæˆ‘ä»¬çš„Greenlight APIæ‰“ä¸‹åŸºç¡€ã€‚æˆ‘ä»¬å°†:

* ä¸ºé¡¹ç›®åˆ›å»ºä¸€ä¸ªæ¡†æ¶ç›®å½•ç»“æ„ï¼Œå¹¶ä»å®è§‚ä¸Šè§£é‡Šæˆ‘ä»¬çš„Goä»£ç å’Œå…¶ä»–æ–‡ä»¶å°†å¦‚ä½•ç»„ç»‡ã€‚
* å»ºç«‹HTTPæœåŠ¡å™¨æ¥ç›‘å¬ä¼ å…¥çš„HTTPè¯·æ±‚ã€‚
* ä»‹ç»ä¸€ä¸ªåˆé€‚çš„ç®¡ç†é…ç½®æ¨¡å¼ï¼ˆé€šè¿‡å‘½ä»¤è¡Œflagsï¼‰å¹¶ä½¿ç”¨ä¾èµ–é¡¹æ³¨å…¥ä½¿ä¾èµ–é¡¹åœ¨æˆ‘ä»¬çš„å¤„ç†ç¨‹åºå¯ç”¨ã€‚
* ä½¿ç”¨httprouteråŒ…å®ç°APIè·¯ç”±ï¼Œè¾¾åˆ°æ ‡å‡†RESTfulç»“æ„ã€‚
## æ ¼å¼å›ºå®šçš„JSON

æˆ‘ä»¬ä»æ›´æ–°healthcheckHandlerå‡½æ•°å‘é€ä¸€ä¸ªæ ¼å¼è‰¯å¥½çš„JSONå“åº”å¼€å§‹ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```go
{"status": "available", "environment": "development", "version": "1.0.0"}
```

åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘æƒ³å¼ºè°ƒçš„æ˜¯JSONåªæ˜¯æ–‡æœ¬ã€‚å½“ç„¶ï¼Œå®ƒæœ‰ä¸€äº›æ§åˆ¶å­—ç¬¦æ¥èµ‹äºˆæ–‡æœ¬ç»“æ„å’Œæ„ä¹‰ï¼Œä½†ä»æ ¹æœ¬ä¸Šè¯´ï¼Œå®ƒåªæ˜¯æ–‡æœ¬ã€‚

è¿™æ„å‘³ç€ä½ å¯ä»¥ä»Goå¤„ç†ç¨‹åºä¸­ç¼–å†™JSONå“åº”ï¼Œå°±åƒä½ ç¼–å†™ä»»ä½•å…¶ä»–æ–‡æœ¬å“åº”ä¸€æ ·:ä½¿ç”¨w.Write()ï¼Œio.WriteString()æˆ–fmt.Fprintå‡½æ•°ä¸­ä¸€ä¸ªã€‚

å®é™…ä¸Šï¼Œæˆ‘ä»¬éœ€è¦åšçš„å”¯ä¸€ç‰¹æ®Šçš„äº‹æƒ…æ˜¯åœ¨å“åº”ä¸Šè®¾ç½®Content-Type: application/jsonå¤´ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯çŸ¥é“å®ƒæ­£åœ¨æ¥æ”¶jsonï¼Œå¹¶ç›¸åº”åœ°è§£æå®ƒã€‚

ä¸‹é¢æˆ‘å°±å¼€å§‹è¿™ä¹ˆåšã€‚

æ‰“å¼€cmd/api/healthcheck.goæ–‡ä»¶å¹¶æŒ‰å¦‚ä¸‹æ–¹å¼æ›´æ–°healthcheckHandler:

File: cmd/api/healthcheck.go

---

```go

package main

import (
    "fmt"
    "net/http"
)

func (app *application) healthcheckHandler(w http.ResponseWriter, r *http.Request) {
    //ä»å­—ç¬¦ä¸²ä¸­åˆ›å»ºä¸€ä¸ªå›ºå®šæ ¼å¼çš„JSONã€‚æ³¨æ„æˆ‘ä»¬æ˜¯å¦‚ä½•ä»å­—ç¬¦ä¸²å¸¸é‡çš„ï¼Œè¿™æ ·å¯ä»¥JSONå¯ä»¥åŒ…å«åŒå¼•å·å­—ç¬¦
    //ä½¿ç”¨å ä½ç¬¦
    js := `{"status": "available", "environment": %q, "version": %q}`
    js = fmt.Sprintf(js, app.config.env, version)

    //è®¾ç½®å“åº”å¤´â€œContentType: application/jsonâ€ã€‚å¦‚æœä½ å¿˜è®°è®¾ç½®ï¼ŒGoå°†é»˜è®¤å‘é€
    //"Content-Type: text/plain; charset=utf-8"å“åº”å¤´
    w.Header().Set("ContentType", "application/json")

   //å°†JSONå†™å…¥HTTPå“åº”bodyä¸­
   w.Write([]byte(js))
}
```

å®Œæˆè¿™äº›æ›´æ”¹åï¼Œé‡æ–°å¯åŠ¨APIï¼Œæ‰“å¼€ç¬¬äºŒä¸ªç»ˆç«¯ï¼Œå¹¶ä½¿ç”¨curlå‘GET /v1/healthcheckæ¥å£å‘å‡ºè¯·æ±‚ã€‚ä½ ç°åœ¨åº”è¯¥å¾—åˆ°ä¸€ä¸ªåƒè¿™æ ·çš„å“åº”:

```shell
$ curl -i localhost:4000/v1/healthcheck
HTTP/1.1 200 OK
Content-Type: application/json 
Date: Tue, 06 Apr 2021 08:38:12 GMT 
Content-Length: 73

{"status": "available", "environment": "development", "version": "1.0.0"}
```

æ‚¨å¯èƒ½è¿˜æƒ³å°è¯•åœ¨æµè§ˆå™¨ä¸­è®¿é—®localhost:4000/v1/healthcheckã€‚

å¦‚æœè¿è¡Œè¾ƒæ–°ç‰ˆæœ¬çš„Firefoxï¼Œä¼šå‘ç°æµè§ˆå™¨çŸ¥é“å“åº”åŒ…å«JSON(ç”±äºContent-TypeæŠ¥å¤´)ï¼Œå®ƒå°†ä½¿ç”¨å†…ç½®çš„JSONæŸ¥çœ‹å™¨æ˜¾ç¤ºå“åº”ã€‚åƒè¿™æ ·:

![](../../images/3.1/å›ºå®šJSON.png)

å¦‚æœä½ ç‚¹å‡»Raw Dataé€‰é¡¹å¡ï¼Œä½ åº”è¯¥çœ‹åˆ°åŸå§‹çš„æœªæ ¼å¼åŒ–JSONå“åº”:
![](../../images/3.1/rawData.png)

å½“ç„¶ï¼Œä½¿ç”¨å›ºå®šæ ¼å¼çš„å­—ç¬¦ä¸²(å°±åƒæˆ‘ä»¬åœ¨æœ¬ç« ä¸­çœ‹åˆ°çš„é‚£æ ·)æ˜¯ç”ŸæˆJSONå“åº”çš„ä¸€ç§éå¸¸ç®€å•å’Œä½ä¿çœŸçš„æ–¹æ³•ã€‚ä½†å€¼å¾—è®°ä½çš„æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é€‰æ‹©ã€‚å®ƒå¯¹æ€»æ˜¯è¿”å›ç›¸åŒé™æ€JSONçš„APIæ¥å£å¾ˆæœ‰ç”¨ï¼Œæˆ–è€…ä½œä¸ºä¸€ç§å¿«é€Ÿè€Œç®€å•çš„æ–¹æ³•æ¥ç”ŸæˆåŠ¨æ€å“åº”ã€‚

## é™„åŠ å†…å®¹

#### JSONå­—ç¬¦é›†

åœ¨ä½ çš„ç¼–ç¨‹ç”Ÿæ¶¯å½“ä¸­å¯èƒ½é‡åˆ°è¿‡å…¶ä»–çš„JSON APIsï¼Œä¼šå‘é€å¸¦æœ‰ContentType: application/json; charset=utf-8çš„å“åº”headerã€‚é€šå¸¸ä¸éœ€è¦åŒ…å«è¿™æ ·çš„å­—ç¬¦é›†å‚æ•°ã€‚[JSON RFC](https://tools.ietf.org/html/rfc8259#section-8.1)ä¸­æè¿°ï¼š

> åœ¨ä¸å±äºå°é—­ç”Ÿæ€ç³»ç»Ÿä¹‹é—´äº¤æ¢çš„JSONæ–‡æœ¬å¿…é¡»ä½¿ç”¨utf-8ç¼–ç ã€‚

è¿™é‡Œå…³é”®è¯æ˜¯â€œå¿…é¡»â€ã€‚å› ä¸ºæˆ‘ä»¬çš„APIå°†æ˜¯ä¸€ä¸ªé¢å‘å…¬ä¼—çš„åº”ç”¨ç¨‹åºï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„JSONå“åº”å¿…é¡»å§‹ç»ˆæ˜¯UTF-8ç¼–ç çš„ã€‚è¿™ä¹Ÿæ„å‘³ç€å®¢æˆ·ç«¯å‡è®¾å®ƒå¾—åˆ°çš„å“åº”æ€»æ˜¯UTF-8ç¼–ç æ˜¯å®‰å…¨çš„ã€‚å› æ­¤ï¼ŒåŒ…å«charset=utf-8å‚æ•°å°±å¤šä½™äº†ã€‚

RFCè¿˜æè¿°äº†application/jsonåª’ä½“ç±»å‹æ²¡æœ‰charsetå‚æ•°å®šä¹‰ï¼Œè¿™æ„å‘³ç€ä»æŠ€æœ¯ä¸Šè®²ï¼ŒåŒ…å«ä¸€ä¸ªå­—ç¬¦æ˜¯ä¸æ­£ç¡®çš„ã€‚

åŸºæœ¬ä¸Šï¼Œåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ï¼Œcharsetå‚æ•°æ²¡æœ‰ä»»ä½•ä½œç”¨ï¼Œåœ¨Content-Type: application/jsonå¤´æ–‡ä»¶ä¸­ä¸åŒ…å«å­—ç¬¦é›†å‚æ•°æ˜¯å®‰å…¨çš„(ä¹Ÿæ˜¯æ­£ç¡®çš„)ã€‚
## JSONç¼–ç 

æˆ‘ä»¬ç»§ç»­çœ‹ä¸€äº›æ›´ä»¤äººå…´å¥‹çš„å†…å®¹ï¼Œçœ‹çœ‹å¦‚ä½•å°†Goå¯¹è±¡(å¦‚mapã€ç»“æ„ä½“å’Œåˆ‡ç‰‡)ç¼–ç ä¸ºJSONã€‚

ä»ä¸Šå±‚è§’åº¦çœ‹ï¼ŒGoçš„encoding/jsonåŒ…æä¾›äº†ä¸¤ä¸ªé€‰æ‹©æ¥å°†å†…å®¹ç¼–ç ä¸ºjsonã€‚ä½ å¯ä»¥è°ƒç”¨json.marshal()å‡½æ•°ï¼Œæˆ–è€…ä½ å¯ä»¥å£°æ˜å¹¶ä½¿ç”¨json.Encoderç±»å‹ã€‚

æˆ‘ä»¬å°†åœ¨æœ¬ç« ä¸­è§£é‡Šè¿™ä¸¤ç§æ–¹æ³•æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä½†æ˜¯ä¸ºäº†åœ¨HTTPå“åº”ä¸­å‘é€JSON,ä½¿ç”¨JSON.marshal()é€šå¸¸æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚æ‰€ä»¥æˆ‘ä»¬ä»è¿™é‡Œå¼€å§‹ã€‚

JSON.marshal()çš„å·¥ä½œæ–¹å¼åœ¨æ¦‚å¿µä¸Šéå¸¸ç®€å•â€”â€”æ‚¨å°†ä¸€ä¸ªGoå¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒï¼Œå®ƒå°†ä»¥å­—èŠ‚æ•°ç»„å½¢å¼è¿”å›è¯¥å¯¹è±¡çš„JSONè¡¨ç¤ºã€‚å‡½æ•°ç­¾åçœ‹èµ·æ¥åƒè¿™æ ·:

```go
func Marshal(v interface{}) ([]byte, error)
```

> æ³¨æ„:ä¸Šè¿°æ–¹æ³•ä¸­çš„vå‚æ•°çš„ç±»å‹ä¸ºinterface{}(ç§°ä¸ºç©ºæ¥å£)ã€‚è¿™å®é™…ä¸Šæ„å‘³ç€æˆ‘ä»¬èƒ½å¤Ÿå°†ä»»ä½•Goç±»å‹ä½œä¸ºvå‚æ•°ä¼ é€’ç»™Marshal()ã€‚

æˆ‘ä»¬å¼€å§‹å¹¶æ›´æ–°healthcheckHandleræ–¹æ³•ï¼Œä»¥ä¾¿å®ƒä½¿ç”¨JSON.marshal()ç›´æ¥ä»Go mapç”ŸæˆJSONå“åº”â€”â€”è€Œä¸æ˜¯åƒä¹‹å‰é‚£æ ·ä½¿ç”¨å›ºå®šæ ¼å¼çš„å­—ç¬¦ä¸²ã€‚åƒè¿™æ ·:

File: cmd/api/healthcheck.go

---

```go
package main

import(
    "encoding/json"
    "net/http"
)

func (app *application)healthcheckHandler(w http.ResponseWriter, r *http.Request) {
    //åˆ›å»ºä¸€ä¸ªmapåŒ…å«æˆ‘ä»¬æƒ³å‘é€çš„å“åº”å†…å®¹
    data := map[string]string{
        "status": "available",
        "environment": app.config.env,
        "version": version,
    }
    //å°†mapå¯¹è±¡ä¼ ç»™json.Marshal()å‡½æ•°ã€‚åºåˆ—å·æˆbyteæ•°ç»„åŒ…å«ç¼–ç åçš„JSONå†…å®¹ã€‚å¦‚æœæœ‰é”™è¯¯å°±æ‰“å°åˆ°æ—¥å¿—
    //å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯
    js, err := json.Marshal(data)
    if err != nil {
         app.logger.Println(err)
         http.Error(w, "the server encountered a problem and could not process request", http.StatusInternalServerError)
         return
    }
    //å‘JSONä¸­æ·»åŠ æ¢è¡Œç¬¦ã€‚è¿™ä¸»è¦æ˜¯æœ‰åŠ©äºåœ¨ç»ˆç«¯ä¸Šçœ‹èµ·æ¥æ–¹ä¾¿
    js = append(js, '\n')
  
    //æ­¤æ—¶ç¼–ç å·²ç»å®Œæˆäº†ï¼Œå› æ­¤éœ€è¦HTTPæ·»åŠ å“åº”headerï¼Œé€šçŸ¥å®¢æˆ·ç«¯æ¥æ”¶JSONæ ¼å¼å†…å®¹
    w.Header().Set("ContentType", "application/json")
  
    //ä½¿ç”¨w.Write()å‘é€åŒ…å«JSONå†…å®¹çš„å­—èŠ‚æ•°ç»„
    w.Write(js)
}
```

å¦‚æœä½ é‡æ–°å¯åŠ¨APIå¹¶åœ¨æµè§ˆå™¨ä¸­è®¿é—®localhost:4000/v1/healthcheckï¼Œä½ ç°åœ¨åº”è¯¥ä¼šå¾—åˆ°ç±»ä¼¼è¿™æ ·çš„å“åº”:

![](../../images/3.1/å›ºå®šJSON.png)

è¿™çœ‹èµ·æ¥å¾ˆä¸é”™â€”â€”æˆ‘ä»¬å¯ä»¥çœ‹åˆ°mapå¯¹è±¡å·²ç»è‡ªåŠ¨ç¼–ç ä¸ºJSONå¯¹è±¡ï¼Œmapä¸­çš„é”®/å€¼å¯¹åœ¨JSONå¯¹è±¡ä¸­æŒ‰å­—æ¯é¡ºåºæ’åºçš„ã€‚

## åˆ›å»ºä¸€ä¸ªwriteJSONå¸®åŠ©æ–¹æ³•

éšç€APIçš„å¢é•¿ï¼Œæˆ‘ä»¬å°†å‘é€å¤§é‡JSONå“åº”ï¼Œå› æ­¤æœ‰å¿…è¦å°†å…¶ä¸­ä¸€äº›é€»è¾‘è½¬ç§»åˆ°å¯é‡ç”¨çš„writeJSON()å¸®åŠ©æ–¹æ³•ä¸­ã€‚

é™¤äº†åˆ›å»ºå’Œå‘é€JSONå¤–ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›é€šè¿‡è¿™ä¸ªå¸®åŠ©å‡½æ•°ï¼Œåœ¨ä»¥åçš„æˆåŠŸå“åº”ä¸­å¯ä»¥åŒ…å«ä»»æ„å“åº”å¤´ä¿¡æ¯ï¼Œæ¯”å¦‚åœ¨ç³»ç»Ÿä¸­åˆ›å»ºæ–°ç”µå½±åçš„Locationå¤´ä¿¡æ¯ã€‚

å¦‚æœä½ è·Ÿéšæ–‡ç« ç¼–ç çš„è¯ï¼Œæ‰“å¼€cmd/api/helpers.goæ–‡ä»¶å¹¶åˆ›å»ºä»¥ä¸‹writeJSON()æ–¹æ³•:

File: cmd/api/helper.go

---

```go
 import (
    "encoding/json"
    "errors"
    "net/http"
    "strconv"

    "github.com/julienschmidt/httprouter"
)

    //å®šä¹‰writeJSON()å¸®ç»„å‡½æ•°æ¥å‘é€å“åº”ã€‚æ–¹æ³•ä»¥http.ResponseWriteä½œä¸ºå“åº”å†™å…¥åœ°æ–¹ï¼Œ
    //HTTPçŠ¶æ€ç statusï¼Œéœ€è¦ç¼–ç ä¸ºJSONçš„æ•°æ®dataå’Œä¸€ä¸ªå“åº”å¤´mapå¯¹è±¡
    func (app *application) writeJSON(w http.ResponseWriter, status int, data interface{}, headers http.Header) error {
    //å°†dataç¼–ç ä¸ºJSONï¼Œå¦‚æœæœ‰é”™è¯¯å°±è¿”å›
    js, err := json.Marshal(data)
    if err != nil {
        return err
    }
    //é™„åŠ ä¸€ä¸ªæ¢è¡Œç¬¦ä»¥ä½¿å®ƒæ›´å®¹æ˜“åœ¨ç»ˆç«¯åº”ç”¨ç¨‹åºä¸­æŸ¥çœ‹ã€‚
    js = append(js, '\n')

    //æ­¤æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨å‘é€å“åº”ä¹‹å‰ä¸ä¼šå†é‡åˆ°ä»»ä½•é”™è¯¯ï¼Œæ‰€ä»¥æ·»åŠ ä»»ä½•æˆ‘ä»¬æƒ³è¦åŒ…å«çš„å“åº”å¤´éƒ½æ˜¯å®‰å…¨çš„ã€‚
    //å¾ªç¯è¿­ä»£header mapå°†å¯¹åº”çš„headeræ·»åŠ åˆ°http.ResponseWriterå“åº”å¤´ã€‚æ³¨æ„mapæ˜¯nilä¹Ÿä¸ä¼šæŠ¥é”™
    for key, value := range headers {
        w.Header().Set(k) = value
    }
    //æ·»åŠ "ContentType"å“åº”å¤´ï¼Œç„¶åå†™å…¥çŠ¶æ€ç å’ŒJSONå†…å®¹
    w.Header().Set("ContentType", "application/json")
    w.WriteHeader(status)
    w.Write(js)

    return nil
}
```

ç°åœ¨writeJSON()å¸®åŠ©å‡½æ•°å·²ç»å°±ä½ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾è‘—åœ°ç®€åŒ–healthcheckHandlerä¸­çš„ä»£ç ï¼š

File: cmd/api/healthcheck.go

---

```go
package main

import (
    "net/http"
)

func (app *application) healthcheckHandler(w http.ResponseWriter, r *http.Request) {
    data := map[string]string{
        "status": "available",
        "environment": app.config.env,
        "version": version,
    }
  
    err := app.writeJSON(w, http.StatusOK, data, nil)
    if err != nil {
        app.logger.Println(err)
        http.Error(w, "The server encountered a problem and could not process you request", http.StatusInternalServerError)
    }
}
```

å¦‚æœç°åœ¨å†æ¬¡è¿è¡Œåº”ç”¨ç¨‹åºï¼Œä¸€åˆ‡éƒ½ç¼–è¯‘æ­£ç¡®ï¼Œå¯¹GET /v1/healthcheckæ¥å£çš„è¯·æ±‚åº”è¯¥ä¼šå¾—åˆ°ä¸ä¹‹å‰ç›¸åŒçš„HTTPå“åº”ã€‚

## é™„åŠ å†…å®¹

#### ä¸åŒçš„Goç±»å‹æ˜¯å¦‚ä½•ç¼–ç çš„

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»å°†ä¸€ä¸ªmap[string]stringç±»å‹ç¼–ç ä¸ºJSONï¼Œå…¶é”®/å€¼å¯¹ä¸­çš„å€¼ä¸ºJSONå­—ç¬¦ä¸²ã€‚ä½†æ˜¯Goä¹Ÿæ”¯æŒç¼–ç å…¶ä»–åŸºæœ¬ç±»å‹ã€‚

ä¸‹è¡¨æ€»ç»“äº†ä¸åŒçš„Goç±»å‹åœ¨ç¼–ç è¿‡ç¨‹ä¸­æ˜¯å¦‚ä½•æ˜ å°„åˆ°JSONæ•°æ®ç±»å‹çš„:


| Go ç±»å‹                                           | jSON ç±»å‹              |
| --------------------------------------------------- | ------------------------ |
| bool                                              | JSON boolean           |
| string                                            | JSON string            |
| int*,Â uint*, float*, rune                        | JSON number            |
| array, slice                                      | JSON array             |
| struct, map                                       | JSON object            |
| nil pointers, interface values, slices, maps, etc | JSON null              |
| chan, func, complex*                              | ä¸æ”¯æŒ                 |
| time.Time                                         | RRC3339æ ¼å¼å­—ç¬¦ä¸²      |
| []byte                                            | Base64ç¼–ç çš„JSONå­—ç¬¦ä¸² |

æœ€åä¸¤ä¸ªæ˜¯ç‰¹æ®Šæƒ…å†µï¼Œéœ€è¦æ›´å¤šçš„è§£é‡Š:

* time.Timeå€¼(è¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªç»“æ„ä½“)å°†æ ¹æ®RFC3339æ ¼å¼æ¥ç¼–ç æˆJSONå­—ç¬¦ä¸²ç±»ä¼¼â€œ2020-11-08T06:27:59+01:00â€ï¼Œè€Œä¸æ˜¯JSONå¯¹è±¡ã€‚
* []byteå­—èŠ‚æ•°ç»„å°†ç¼–ç ä¸ºbase64ç±»å‹çš„JSONå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªJSONæ•°ç»„ã€‚å› æ­¤[]byte{'h','e','l','l','o'}å°†ç¼–ç ä¸º"aGVsbG8="ã€‚base64ç¼–ç ä½¿ç”¨å¡«å……å’Œæ ‡å‡†å­—ç¬¦é›†ã€‚

å…¶ä»–éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼š

* æ”¯æŒåµŒå¥—å¯¹è±¡çš„ç¼–ç ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªç»“æ„ä½“åˆ‡ç‰‡Goå°†ç¼–ç æˆJSONå¯¹è±¡æ•°ç»„ã€‚
* ä¸èƒ½å¯¹channelã€å‡½æ•°å’Œå¤æ•°ç±»å‹è¿›è¡Œç¼–ç ã€‚å¦‚æœä½ æƒ³è¿™ä¹ˆåšï¼Œ ä½ ä¼šå¾—åˆ°ä¸€ä¸ªjson.UnsupportedTypeErrorã€‚
* ä»»ä½•æŒ‡é’ˆå€¼éƒ½å°†è¢«ç¼–ç ä¸ºæ‰€æŒ‡å‘çš„å€¼ã€‚åŒæ ·ï¼Œinterface{}å€¼ä¹Ÿä¼šç¼–ç ä¸ºæ¥å£ä¸­åŒ…å«çš„å€¼ã€‚

## ä½¿ç”¨json.Encoder

åœ¨æœ¬ç« çš„å¼€å¤´ï¼Œæˆ‘æåˆ°è¿‡ä¹Ÿå¯ä»¥ä½¿ç”¨Goçš„json.Encoderç±»å‹æ¥ç¼–ç ã€‚å®ƒæ”¯æŒå°†å¯¹è±¡ç¼–ç ä¸ºJSONå¯¹è±¡å¹¶å°†JSONå†™å…¥åˆ°ä¸€ä¸ªè¾“å‡ºæµä¸­ï¼Œè€Œä¸”ä¸¤ä¸ªæ“ä½œä¸€æ­¥åˆ°ä½ã€‚

ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨å¤„ç†ç¨‹åºä¸­è¿™æ ·ä½¿ç”¨ï¼š

```go
func (app *application) exampleHandler(w http.ResponseWrite, r *http.Request){
    data := map[string]string{
        "hello": "world",
    }
    //è®¾ç½®â€œContentTypeâ€å“åº”å¤´
    w.Header().Set("ContentType", "application/json")

    //ä½¿ç”¨json.NewEncoder()å‡½æ•°åˆå§‹åŒ–json.Encoderå®ä¾‹ï¼Œå°†å†…å®¹æ¥å…¥http.ResponseWriterã€‚
    //ç„¶åè°ƒç”¨Encode()æ–¹æ³•ï¼Œå°†å¸Œæœ›ç¼–ç ä¸ºJSONçš„dataä¼ å…¥ï¼Œå¦‚æœdataå¯ä»¥æˆåŠŸç¼–ç ä¸ºJSONï¼Œå®ƒå°†
    //ç¼–ç åå†™å…¥åˆ°http.ResponseWriterã€‚
    err := json.NewEncoder(w).Encode(data)
    if err != nil {
        app.logger.Println(err)
        http.Error(w, "The server encountered a problem and could not process your request", http.StatusInternalServerError)
    }
}
```

è¿™ç§æ–¹å¼æ˜¯å¯è¡Œçš„ï¼Œéå¸¸æ•´æ´å’Œä¼˜é›…ï¼Œä½†å¦‚æœä½ ä»”ç»†è€ƒè™‘å®ƒï¼Œä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸€ä¸ªå°é—®é¢˜â€¦â€¦

å½“æˆ‘ä»¬è°ƒç”¨JSON.NewEncoder(w).Encode(data)æ—¶ï¼Œåœ¨ä¸€è¡Œä»£ç ä¸­JSONè¢«åˆ›å»ºå¹¶å†™å…¥http.ResponseWriterä¸­ï¼Œè¿™æ„å‘³ç€æ²¡æœ‰æœºä¼šæ ¹æ®Encode()æ–¹æ³•æ˜¯å¦è¿”å›é”™è¯¯æ¥è®¾ç½®HTTPå“åº”å¤´ã€‚

å‡è®¾æ‚¨æƒ³åœ¨ä¸€ä¸ªæˆåŠŸçš„å“åº”ä¸Šè®¾ç½®ä¸€ä¸ªCache-ControlæŠ¥å¤´ï¼Œä½†å¦‚æœJSONç¼–ç å¤±è´¥ï¼Œåˆ™ä¸è®¾ç½®Cache-ControlæŠ¥å¤´è€Œå¿…é¡»è¿”å›ä¸€ä¸ªé”™è¯¯å“åº”ã€‚ä½¿ç”¨json.Encoderæ¨¡å¼å°±æ¯”è¾ƒéš¾å®ç°ã€‚

ä½ å¯ä»¥è®¾ç½®Cache-Controlå“åº”å¤´ï¼Œå¦‚æœå‡ºç°é”™è¯¯å¯ä»¥ä»å“åº”å¤´åˆ é™¤ï¼Œä½†è¿™éƒ½æ˜¯å¾ˆè€å¥—çš„ã€‚

å¦ä¸€ä¸ªé€‰æ‹©æ˜¯å°†JSONå†™å…¥bytes.Bufferç¼“å­˜ï¼Œè€Œä¸æ˜¯ç›´æ¥å†™å…¥http.ResponseWriterã€‚åœ¨è®¾ç½®Cache-Controlå“åº”å¤´ä¹‹å‰ï¼Œæ£€æŸ¥ä»»ä½•é”™è¯¯ã€‚ç„¶åå°†JSONå†…å®¹ä»bytes.Bufferç¼“å­˜æ‹·è´åˆ°http.ResponseWriterã€‚ä½†ä½ çœŸæ­£é‚£ä¹ˆå¤„ç†çš„è¯ï¼Œç›¸æ¯”è¾ƒè€Œå·²ä½¿ç”¨json.Marshal()æ–¹æ³•æ›´ç®€å•ã€‚

#### json.Encoderå’Œjson.Marshalæ€§èƒ½

è°ˆåˆ°é€Ÿåº¦ï¼Œæ‚¨å¯èƒ½æƒ³çŸ¥é“json.Encoderå’Œjson.Marshal()ä¹‹é—´æ˜¯å¦æœ‰å·®å¼‚ã€‚ç®€å•æ¥è®²æ˜¯è‚¯å®šçš„â€¦â€¦ä½†æ˜¯å·®åˆ«å¾ˆå°ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä½ ä¸éœ€è¦æ‹…å¿ƒã€‚

ä¸‹é¢çš„åŸºå‡†æµ‹è¯•ä½¿ç”¨æœ¬[gist](https://gist.github.com/alexedwards/8f11d0dc57fc119cbc791def783d8492)ä¸­çš„ä»£ç æ¼”ç¤ºäº†è¿™ä¸¤ç§æ–¹æ³•çš„æ€§èƒ½(æ³¨æ„æ¯ä¸ªåŸºå‡†æµ‹è¯•é‡å¤ä¸‰æ¬¡):

![image.png](./assets/image.png)

åœ¨è¿™äº›ç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°json.marshal()è¦æ¯”json.Encoderç¨å¾®å¤šä¸€ç‚¹çš„å†…å­˜(B/op)ï¼Œå¹¶ä½¿ç”¨æ›´å¤šçš„å †å†…å­˜åˆ†é…(allocs/op)ã€‚

è¿™ä¸¤ç§æ–¹æ³•åœ¨å¹³å‡è¿è¡Œæ—¶(ns/op)ä¸Šæ²¡æœ‰æ˜æ˜¾å¯è§‚å¯Ÿåˆ°çš„å·®å¼‚ã€‚ä¹Ÿè®¸åœ¨æ›´å¤§çš„åŸºå‡†æµ‹è¯•æ ·æœ¬æˆ–æ›´å¤§çš„æ•°æ®é›†ï¼Œå·®å¼‚å¯èƒ½ä¼šå˜å¾—æ˜æ˜¾ï¼Œä½†å®ƒå¯èƒ½ä¹Ÿæ˜¯å¾®ç§’çº§çš„ï¼Œè€Œä¸æ˜¯æ›´å¤§ã€‚
## ç»“æ„ä½“ç¼–ç 

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å›åˆ°ä¹‹å‰åšçš„showMovieHandleræ–¹æ³•ï¼Œå¹¶æ›´æ–°å®ƒä»¥è¿”å›ä¸€ä¸ªJSONå“åº”ï¼Œè¡¨ç¤ºç³»ç»Ÿä¸­çš„å•ä¸ªç”µå½±ã€‚ç±»ä¼¼äº:

```json
{
    "id": 123,
    "title": "Casablanca", 
    "runtime": 102, 
    "genres": [
        "drama", 
        "romance", 
        "war"
    ],
    "version": 1 
}
```

æˆ‘ä»¬ä¸ä½¿ç”¨mapåºåˆ—åŒ–æ¥åˆ›å»ºè¿™ä¸ªJSONå¯¹è±¡(å°±åƒæˆ‘ä»¬åœ¨ä¸Šä¸€ç« ä¸­æ‰€åšçš„é‚£æ ·)ï¼Œè¿™æ¬¡æˆ‘ä»¬å°†ç¼–ç ä¸€ä¸ªè‡ªå®šä¹‰çš„Movieç»“æ„ã€‚

é¦–å…ˆï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰çš„Movieç»“æ„ä½“ã€‚æˆ‘ä»¬å°†åœ¨ä¸€ä¸ªæ–°internal/dataåŒ…ä¸­å®Œæˆæ­¤æ“ä½œï¼Œè¯¥åŒ…ç¨åå°†æ‰©å±•ç”¨æ¥å°è£…é¡¹ç›®ä¸­æ‰€æœ‰è‡ªå®šä¹‰æ•°æ®ç±»å‹ä»¥åŠä¸æ•°æ®åº“äº¤äº’çš„é€»è¾‘ã€‚

å¦‚æœæ‚¨æŒ‰ç…§æ–‡ç« æ­¥éª¤æ“ä½œï¼Œè¯·ç»§ç»­åˆ›å»ºä¸€ä¸ªæ–°çš„internal/dataç›®å½•ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªmovies.goæ–‡ä»¶:

```shell
$ mkdir internal/data
$ touch internal/data/movies.go
```

åœ¨è¿™ä¸ªæ–°æ–‡ä»¶ä¸­ï¼Œå®šä¹‰Movieç»“æ„ï¼Œåƒè¿™æ ·:

File: internal/data/movies.go

---

```go
package main

import (
    "time"
)

type Movie struct {
    ID             int64      //å”¯ä¸€æ•´æ•°ID
    CreatedAt      time.Time  //åˆ›å»ºç”µå½±åˆ°æ•°æ®åº“çš„æ—¶é—´
    Title          string     //ç”µå½±æ ‡é¢˜
    Year           int32      //ç”µå½±å‘å¸ƒå¹´ä»½
    Runtime        int32      //ç”µå½±æ—¶é•¿
    Genres         []string   //ç”µå½±ç±»å‹(çˆ±æƒ…ç‰‡ã€å–œå‰§ç‰‡ç­‰)
    Version        int32      //ç‰ˆæœ¬å·ä»1å¼€å§‹ï¼Œæ¯æ›´æ–°ä¸€æ¬¡é€’å¢
}
```

> è¿™é‡Œéœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼ŒMovieç»“æ„ä½“ä¸­çš„æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯å¯¼å‡ºçš„(å³ä»¥å¤§å†™å­—æ¯å¼€å¤´)ï¼Œè¿™å¯¹äºGoçš„encoding/jsonåŒ…å¯è§æ˜¯å¿…è¦çš„ã€‚åœ¨å°†ç»“æ„ä½“ç¼–ç ä¸ºJSONæ—¶ï¼Œä¸ä¼šåŒ…å«ä»»ä½•æœªå¯¼å‡ºçš„å­—æ®µã€‚

ç°åœ¨ç»“æ„ä½“å·²ç»å®šä¹‰å®Œæˆï¼Œè®©æˆ‘ä»¬æ›´æ–°showMovieHandlerå¤„ç†ç¨‹åºæ¥åˆå§‹åŒ–ä¸€ä¸ªMovieç»“æ„ä½“å®ä¾‹ï¼Œç„¶åä½¿ç”¨writeJSON()å¸®ç»„å‡½æ•°å°†å…¶ä½œä¸ºJSONå“åº”å‘é€ç»™å®¢æˆ·ç«¯ã€‚

å®ç°å¾ˆç®€å•ï¼š

Fileï¼š cmd/api/movies.go

---

```go
package main

import (
    "fmt"
    "net/http"
    "time"

    "greenlight.alexedwards.net/internal/data"
)

func (app *application) showMovieHandler(w http.ResponseWriter, r *http.Request) {
    id, err := app.readIDParam(r)
    if err != nil {
        http.NotFound(w, r)
        return
    }

    //åˆ›å»ºä¸€ä¸ªMoveç»“æ„ä½“å®ä¾‹ï¼ŒåŒ…å«ä»è¯·æ±‚URLä¸­è§£æçš„IDè™šæ„çš„æ•°æ®ã€‚æ³¨æ„è¿™é‡Œæ•…æ„æ²¡æœ‰è®¾ç½®Yearå­—æ®µ
    movie := date.Movie{
        ID: id,
        CreateAt: time.now(),
        Title: "Casablanca",
        Runtime: 102,
        Genres: []string{"drama", "romance", "war"},
        Version: 1,
    }

    //å°†ç»“æ„ä½“åºåˆ—åŒ–ä¸ºJSONå¹¶ä»¥HTTPå“åº”å‘é€ç»™å®¢æˆ·ç«¯
    err = app.writeJSON(w, http.StatusOK, movie, nil)
    if err != nil {
         app.logger.Println(err)
         http.Error(w, "The server encountered a problem and could not process your request", http.StatusInternalServerError)
    }
}
```

okï¼Œä¸‹é¢è¯•è¯•ï¼

é‡å¯APIï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸­è®¿é—®localhost:4000/v1/movies/123ã€‚ä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªç±»ä¼¼è¿™æ ·çš„JSONå“åº”:

![image.png](../../images/3.1/3.3ç»“æ„ä½“.png)

åœ¨è¿™ä¸ªå›åº”ä¸­ï¼Œæœ‰å‡ ä»¶æœ‰è¶£çš„äº‹æƒ…éœ€è¦æŒ‡å‡º:

* Movieç»“æ„ä½“è¢«ç¼–ç æˆä¸€ä¸ªJSONå¯¹è±¡ï¼Œå­—æ®µåå’Œå€¼ä½œä¸ºé”®/å€¼å¯¹ã€‚
* é»˜è®¤æƒ…å†µä¸‹ï¼ŒJSONå¯¹è±¡ä¸­çš„é”®ç­‰äºç»“æ„ä¸­çš„å­—æ®µå(IDã€CreatedAtã€Titleç­‰ç­‰)ã€‚æˆ‘ä»¬ç¨åå°†è®¨è®ºå¦‚ä½•è‡ªå®šä¹‰é”®å€¼ã€‚
* å¦‚æœç»“æ„å­—æ®µæ²¡æœ‰æ˜¾å¼çš„å€¼é›†ï¼Œé‚£ä¹ˆå­—æ®µé›¶å€¼å°†è¢«jsonç¼–ç ã€‚å¯ä»¥åœ¨ä¸Šé¢çš„å“åº”ä¸­çœ‹åˆ°ä¸€ä¸ªä¾‹å­â€”â€”æˆ‘ä»¬æ²¡æœ‰åœ¨Goä»£ç ä¸­ä¸ºYearå­—æ®µè®¾ç½®å€¼ï¼Œä½†å®ƒä»ç„¶ä»¥0å€¼å‡ºç°åœ¨JSONè¾“å‡ºä¸­ã€‚

#### æ›´æ”¹JSONå¯¹è±¡ä¸­çš„é”®

åœ¨Goä¸­åºåˆ—åŒ–ç»“æ„ä½“çš„ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨structæ ‡ç­¾æ³¨é‡Šå­—æ®µæ¥å®šåˆ¶JSONã€‚

structæ ‡ç­¾æœ€å¸¸è§çš„ç”¨é€”å¯èƒ½æ˜¯æ›´æ”¹JSONå¯¹è±¡ä¸­å‡ºç°çš„é”®åã€‚å½“ä½ çš„ç»“æ„ä½“å­—æ®µåä¸é€‚åˆé¢å‘å…¬ä¼—å±•ç¤ºï¼Œæˆ–è€…ä½ æƒ³åœ¨JSONè¾“å‡ºä¸­ä½¿ç”¨å¦ä¸€ç§å¤§å°å†™æ ·å¼æ—¶ï¼Œè¿™æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚

ä¸ºäº†è¯´æ˜å¦‚ä½•å®ç°ï¼Œå¯¹Moviesç»“æ„ä½“å­—æ®µæ‰“æ ‡ç­¾ï¼Œä½¿ç”¨è›‡å½¢æ ¼å¼ï¼š

File: internal/data/movies.go

---

```go
//ä½¿ç”¨æ ‡è®°å¯¹Movieç»“æ„è¿›è¡Œæ³¨é‡Šï¼Œä»¥æ§åˆ¶jsonç¼–ç çš„keyæ˜¾ç¤ºæ–¹å¼ã€‚
type Movie struct {
	ID       int64     `json:"id"`
	CreateAt time.Time `json:"created_at"`
	Title    string    `json:"title"`
	Year     int32     `json:"year"`
	Runtime  int32     `json:"runtime"`
	Genres   []string  `json:"genres"`
	Version  int32     `json:"version"`
}
```

å¦‚æœä½ é‡å¯æœåŠ¡å™¨å¹¶å†æ¬¡è®¿é—®localhost:4000/v1/movies/123ï¼Œåº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªç±»ä¼¼äºè¿™æ ·çš„å¸¦æœ‰è›‡å½¢é”®çš„å“åº”:

![image.png](../../images/3.1/movie.png)

## åœ¨JSONå¯¹è±¡ä¸­éšè—ç»“æ„ä½“å­—æ®µ

åœ¨å®šä¹‰ç»“æ„ä½“æ—¶å€™ï¼Œé€šè¿‡ä½¿ç”¨omitemptyå¯ä»¥æ§åˆ¶å¯¹åº”å­—æ®µåœ¨JSONä¸­çš„å¯è§æ€§ã€‚å½“æ‚¨ä¸å¸Œæœ›JSONè¾“å‡ºä¸­å‡ºç°ç‰¹å®šçš„ç»“æ„ä½“å­—æ®µæ—¶ï¼Œå¯ä»¥ä½¿ç”¨-(è¿å­—ç¬¦)æŒ‡ä»¤ã€‚è¿™å¯¹åŒ…å«å’Œç”¨æˆ·ä¸ç›¸å…³çš„å†…éƒ¨ç³»ç»Ÿä¿¡æ¯çš„å­—æ®µæˆ–ä¸æƒ³å…¬å¼€çš„æ•æ„Ÿä¿¡æ¯(å¦‚å¯†ç çš„æ•£åˆ—)éå¸¸æœ‰ç”¨ã€‚

ç›¸åï¼Œå½“ä¸”ä»…å½“structå­—æ®µå€¼ä¸ºç©ºæ—¶ï¼ŒomitemptyæŒ‡ä»¤ä¼šåœ¨JSONè¾“å‡ºä¸­éšè—å­—æ®µï¼Œå…¶ä¸­emptyè¢«å®šä¹‰ä¸º:

* ç­‰äºfalseï¼Œ0æˆ–â€œâ€
* ç©ºæ•°ç»„ï¼Œåˆ‡ç‰‡æˆ–map
* nilæŒ‡é’ˆæˆ–æ¥å£å€¼ä¸ºnil

ä¸ºäº†æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨è¿™äº›æŒ‡ä»¤ï¼Œæˆ‘ä»¬å¯¹Movieç»“æ„è¿›è¡Œæ›´å¤šçš„æ”¹é€ ã€‚CreatedAtå­—æ®µä¸æˆ‘ä»¬çš„æœ€ç»ˆç”¨æˆ·æ— å…³ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨-æŒ‡ä»¤åœ¨è¾“å‡ºä¸­å°†å…¶éšè—ã€‚æˆ‘ä»¬è¿˜å°†ä½¿ç”¨omitemptyæŒ‡ä»¤åœ¨è¾“å‡ºä¸­éšè—Yearã€Runtimeå’Œtypeså­—æ®µï¼Œå½“ä¸”ä»…å½“å®ƒä»¬ä¸ºç©ºæ—¶æƒ…å†µä¸‹ç”Ÿæ•ˆã€‚

ç»§ç»­å¹¶åƒä¸‹é¢è¿™æ ·æ›´æ–°structæ ‡ç­¾:

Fileï¼šinterface/data/movies.go

---

```go
package data

....

type Movie struct {
	ID       int64     `json:"id"`
	CreateAt time.Time `json:"-"`       //ä½¿ç”¨-æŒ‡ä»¤
	Title    string    `json:"title"`
	Year     int32     `json:"year,omitempty"`            //æ·»åŠ omitempty
	Runtime  int32     `json:"runtime,omitempty"`         //æ·»åŠ omitempty
	Genres   []string  `json:"genres,omitempty"`          //æ·»åŠ omitempty
	Version  int32     `json:"version"`
}
```

> å¦‚æœä½ æƒ³ä½¿ç”¨omitemptyè€Œä¸æ”¹å˜é”®åï¼Œé‚£ä¹ˆä½ å¯ä»¥åœ¨structæ ‡ç­¾ä¸­ä¿ç•™å®ƒä¸ºç©º-å¦‚:json:"ï¼Œomitempty"ã€‚æ³¨æ„ï¼Œé€—å·æ˜¯å¿…è¦çš„ã€‚

ç°åœ¨ï¼Œå½“ä½ é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºå¹¶åˆ·æ–°ä½ çš„webæµè§ˆå™¨æ—¶ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°å¦‚ä¸‹å“åº”:

![image.png](../../images/3.1/omitempty.png)

æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°ï¼ŒCreatedAtç»“æ„å­—æ®µä¸å†å‡ºç°åœ¨JSONä¸­ï¼Œè€Œä¸”Yearå­—æ®µ(å€¼ä¸º0)ä¹Ÿæ²¡æœ‰å‡ºç°ï¼Œè¿™è¦æ„Ÿè°¢omitemptyæŒ‡ä»¤ã€‚å…¶ä»–å­—æ®µä½¿ç”¨äº†omitemptyä¸å—å½±å“(ä¾‹å¦‚Runtimeå’ŒGenres)ã€‚

> æ³¨æ„:æ‚¨è¿˜å¯ä»¥é€šè¿‡ç®€å•åœ°å°†ç»“æ„ä½“å­—æ®µè®¾ç½®ä¸ºä¸å¯å¯¼å‡ºæ¥é˜²æ­¢å®ƒå‡ºç°åœ¨JSONåºåˆ—åŒ–ä¸­ã€‚ä½†ä½¿ç”¨json:â€œâ€”â€œæ ‡è®°é€šå¸¸æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©:æ˜ç¡®å‘ŠçŸ¥é˜…è¯»ä»£ç çš„äººï¼Œä½ ä¸å¸Œæœ›è¯¥å­—æ®µåŒ…å«åœ¨jsonã€‚
>
> æ—§ç‰ˆæœ¬çš„go vetå¦‚æœä½ è¯•å›¾åœ¨æœªå¯¼å‡ºçš„å­—æ®µä¸Šä½¿ç”¨structæ ‡è®°ä¼šå¼•å‘é”™è¯¯ï¼Œä½†ç°åœ¨åœ¨go 1.16ä¸­å·²ç»ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ã€‚

## é™„åŠ å†…å®¹

#### ç»“æ„ä½“æ ‡ç­¾stringæŒ‡ä»¤

æœ€åä¸€ä¸ªä¸å¤ªå¸¸ç”¨çš„structæ ‡è®°æŒ‡ä»¤æ˜¯stringã€‚å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ ‡ç­¾æ˜ç¡®è¡¨ç¤ºå­—æ®µå€¼åºåˆ—åŒ–æˆJSONå­—ç¬¦ä¸²ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›Runtimeå­—æ®µçš„å€¼è¡¨ç¤ºä¸ºä¸€ä¸ªJSONå­—ç¬¦ä¸² (è€Œä¸æ˜¯æ•°å­—)æˆ‘ä»¬å¯ä»¥åƒè¿™æ ·ä½¿ç”¨stringæŒ‡ä»¤:

```go
type Movie struct {
	ID       int64     `json:"id"`
	CreateAt time.Time `json:"-"`       //ä½¿ç”¨-æŒ‡ä»¤
	Title    string    `json:"title"`
	Year     int32     `json:"year,omitempty"`   
	Runtime  Runtime   `json:"runtime,omitempty,string"` 
	Genres   []string  `json:"genres,omitempty"`       
	Version  int32     `json:"version"`
}
```

JSONåºåˆ—åŒ–ç»“æœå¦‚ä¸‹æ‰€ç¤º:

```shell
{
"id": 123,
"title": "Casablanca",
"runtime": "102",   //è¿™æ˜¯å­—ç¬¦ä¸²
"genres": [
    "drama", 
    "romance", 
    "war"
    ],
"version": 1 
}
```

æ³¨æ„stringæŒ‡ä»¤åªå¯¹int*ï¼Œ uint*ï¼Œ float*æˆ–boolç±»å‹çš„å­—æ®µæœ‰æ•ˆã€‚å¯¹äºä»»ä½•å…¶ä»–ç±»å‹çš„ç»“æ„ä½“å­—æ®µæ²¡æœ‰ä½œç”¨ã€‚
## æ ¼å¼åŒ–å’Œå°è£…å“åº”

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨ä½¿ç”¨Firefoxå‘APIå‘é€è¯·æ±‚ï¼Œç”±äºå†…ç½®çš„JSONæŸ¥çœ‹å™¨æä¾›äº†â€œè¾“å‡ºæ ¼å¼åŒ–â€ï¼Œè¿™ä½¿å¾—JSONå“åº”æ˜“äºé˜…è¯»ã€‚

ä½†æ˜¯å¦‚æœæ‚¨å°è¯•ä½¿ç”¨curlå‘èµ·è¯·æ±‚ï¼Œå°†çœ‹åˆ°å®é™…çš„JSONå“åº”æ•°æ®éƒ½åœ¨ä¸€è¡Œä¸­ï¼Œæ²¡æœ‰ç©ºæ ¼ã€‚

```shell
$ curl localhost:4000/v1/healthcheck
{"environment":"development","status":"available","version":"1.0.0"}

$ curl localhost:4000/v1/movies/123
{"id":123,"title":"Casablanca","runtime":102,"genres":["drama","romance","war"],"version":1}
```

é€šè¿‡ä½¿ç”¨json.MarshalIndent()å‡½æ•°æ¥ç¼–ç å“åº”æ•°æ®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å¸¸è§„çš„json.Marshal()å‡½æ•°ï¼Œå¯ä»¥ä½¿è¿™äº›å†…å®¹æ›´å®¹æ˜“åœ¨ç»ˆç«¯ä¸­æŸ¥çœ‹ã€‚è‡ªåŠ¨å°†ç©ºæ ¼ç¬¦æ·»åŠ åˆ°JSONè¾“å‡ºä¸­ï¼Œæ¯ä¸ªå…ƒç´ æ”¾åœ¨å•ç‹¬çš„è¡Œï¼Œå¹¶åœ¨æ¯ä¸ªè¡Œå‰é¢åŠ ä¸Šå¯é€‰çš„å‰ç¼€å’Œç¼©è¿›å­—ç¬¦ã€‚

æˆ‘ä»¬æ›´æ–°writeJSON()åŠ©æ‰‹æ¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç :

File: cmd/api/helpers.go

---

```go
package main

...

func (app *application) writeJSON(w http.ResponseWriter, status int, data interface{}, headers http.header) error {
    //ä½¿ç”¨json.MarshalIndent()å‡½æ•°ï¼Œå¯ä»¥åœ¨JSONè¾“å‡ºä¸­æ·»åŠ ç©ºæ ¼ã€‚è¿™é‡Œä½¿ç”¨""ä½œä¸ºå‰ç¼€ï¼Œ"\t"æ ¼å¼åŒ–å…ƒç´ 
    js, err := json.MarshalIndent(data, "", "\t")
    if err != nil {
        return err
    }
    js = append(js, '\n')

    for key, value := range headers {
        w.Header()[key] = value
    }
  
    w.Header.Set("ContentType", "application/json")
    w.WriteHeader(status)
    w.Write(js)

    return nil
}
```

å¦‚æœä½ é‡æ–°å¯åŠ¨APIæœåŠ¡å™¨å¹¶å°è¯•ä»ä½ çš„ç»ˆç«¯å†æ¬¡å‘å‡ºç›¸åŒçš„è¯·æ±‚ï¼Œå°†ä¼šæ”¶åˆ°ä¸€äº›ç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼ŒåŒ…å«æ ¼å¼åŒ–ç©ºæ ¼çš„JSONå“åº”:

```shell
$ curl -i localhost:4000/v1/healthcheck
{
    "environment": "development",
    "status": "available",
    "version": "1.0.0",
}

$ curl localhost:4000/v1/movies/123
{
    "id": 123,
    "title": "casablanca",
    "runtime": 102,
    "genres": [
        "drama",
        "romance",
        "war"
    ],
    "version": 1
}
```

## æ€§èƒ½æ¯”ä»·

è™½ç„¶ä»å¯è¯»æ€§å’Œç”¨æˆ·ä½“éªŒçš„è§’åº¦æ¥çœ‹ï¼Œä½¿ç”¨json.MarshalIndent()æ˜¯æ›´é€‚åˆï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼Œå®ƒä¸æ˜¯å…è´¹çš„ã€‚é™¤äº†å“åº”çš„æ€»å­—èŠ‚æ•°ç¨å¾®å¤§ä¸€ç‚¹ä¹‹å¤–ï¼ŒGoä¸ºæ·»åŠ ç©ºæ ¼æ‰€åšçš„é¢å¤–å·¥ä½œå¯¹æ€§èƒ½æœ‰æ˜¾è‘—çš„å½±å“ã€‚

ä¸‹é¢çš„åŸºå‡†æµ‹è¯•ä½¿ç”¨[gist](https://gist.github.com/alexedwards/809db1839a062c4f92a65f40359e18b7)ä¸­çš„ä»£ç æ¼”ç¤ºjson.Marshal()å’Œjson.MarshalIndent()çš„ç›¸å¯¹æ€§èƒ½ã€‚
![img_1.png](assets/img_1.png)

åœ¨è¿™äº›åŸºå‡†æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°json.MarshalIndent()çš„è¿è¡Œæ—¶é—´æ¯”json.Marshal()é•¿65%ï¼Œä½¿ç”¨çš„å†…å­˜æ¯”json.Marshal()å¤š30%ï¼Œè¿˜å¤šä¸¤æ¬¡å †åˆ†é…ã€‚è¿™äº›æ•°æ®ä¼šæ ¹æ®ç¼–ç å†…å®¹è€Œå˜åŒ–ï¼Œä½†æ ¹æ®æˆ‘çš„ç»éªŒï¼Œå®ƒä»¬åæ˜ äº†æ€§èƒ½å½±å“ã€‚

ä½†åœ¨å¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸­è¿™ç‚¹æ€§èƒ½ä¸ä¼šé€ æˆæ‹…å¿ƒã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬è°ˆè®ºçš„åªæ˜¯åƒåˆ†ä¹‹ä¸€æ¯«ç§’çš„æ—¶é—´â€”â€”ä¸ºæé«˜å“åº”çš„å¯è¯»æ€§å¯èƒ½å€¼å¾—è¿™æ ·åšã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ çš„APIåœ¨èµ„æºéå¸¸å—é™çš„ç¯å¢ƒä¸­è¿è¡Œï¼Œæˆ–è€…éœ€è¦ç®¡ç†å¤§çº§åˆ«çš„æµé‡ï¼Œé‚£ä¹ˆè¿™æ˜¯å€¼å¾—æ³¨æ„çš„ï¼Œæ‚¨å¯èƒ½æ›´å–œæ¬¢ä½¿ç”¨json.Marshal()ã€‚

> æ³¨æ„:JSON.marshalindent()çš„å·¥ä½œåŸç†æ˜¯åƒè°ƒç”¨JSON.marshal()ä¸€æ ·ï¼Œç„¶åé€šè¿‡ç‹¬ç«‹çš„JSON.indent()å‡½æ•°ä¸ºJSONæ·»åŠ ç©ºæ ¼ã€‚è¿˜æœ‰ä¸€ä¸ªåå‘å‡½æ•°JSON.compact()ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒä»JSONä¸­åˆ é™¤ç©ºæ ¼ã€‚

#### å°è£…å“åº”

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ›´æ–°å“åº”ï¼Œä½¿JSONæ•°æ®å§‹ç»ˆåŒ…å«åœ¨çˆ¶JSONå¯¹è±¡ä¸­ã€‚ç±»ä¼¼äº:

```json
{
    "movie":
    {
        "id": 123,
        "title": "Casablanca",
        "runtime": 102,
        "genres":
        [
            "drama",
            "romance",
            "war"
        ],
        "version": 1
    }
}
```

æ³¨æ„åˆ°ç”µå½±å¯¹è±¡æ˜¯å¦‚ä½•åµŒå¥—åœ¨é”®â€œmovieâ€ä¸‹é¢çš„ï¼Œè€Œä¸æ˜¯æœ¬èº«ä½œä¸ºé¡¶å±‚JSONå¯¹è±¡ã€‚

ä¸¥æ ¼æ¥è¯´ï¼Œè¿™æ ·å°è£…å“åº”æ•°æ®æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œæ˜¯å¦é€‰æ‹©è¿™æ ·åšåœ¨ä¸€å®šç¨‹åº¦ä¸Šå–å†³äºé£æ ¼å’Œå“å‘³ã€‚ä½†ä¹Ÿæœ‰ä¸€äº›åˆ‡å®çš„å¥½å¤„:

1ã€åœ¨JSONçš„é¡¶å±‚åŒ…å«ä¸€ä¸ªé”®å(å¦‚â€œmovieâ€)æœ‰åŠ©äºä½¿å“åº”æ›´å…·æ–‡æ¡£åŒ–ã€‚å¯¹äºä»»ä½•ä»ä¸Šä¸‹æ–‡ä¸­çœ‹åˆ°å“åº”çš„äººæ¥è¯´ï¼Œç†è§£å“åº”æ•°æ®ä¸ä»€ä¹ˆç›¸å…³æ›´å®¹æ˜“ä¸€äº›ã€‚

2ã€å®ƒé™ä½äº†å®¢æˆ·ç«¯å‡ºé”™çš„é£é™©ï¼Œå› ä¸ºè¿™æ ·åšä¼šé¿å…æŠŠä¸€ä¸ªå“åº”å½“ä½œå…¶ä»–å†…å®¹æ¥å¤„ç†ã€‚ä¸ºäº†è·å¾—æ•°æ®ï¼Œå®¢æˆ·ç«¯å¿…é¡»é€šè¿‡â€œmovieâ€é”®æ˜¾å¼åœ°å¼•ç”¨å®ƒã€‚

3ã€å¦‚æœæˆ‘ä»¬æ€»æ˜¯å°è£…APIè¿”å›çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å‡è½»äº†åœ¨æ—§æµè§ˆå™¨ä¸­è¿”å›JSONæ•°ç»„ä½œä¸ºå“åº”å¯èƒ½å‡ºç°çš„å®‰å…¨æ¼æ´ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›æŠ€æœ¯æ¥å°è£…APIå“åº”ï¼Œä½†å°†ä¿æŒäº‹æƒ…ç®€å•ï¼Œé€šè¿‡åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„envelope mapä¸åº•å±‚ç±»å‹map[string]interface{}æ¥å®ç°ã€‚

æ¥ä¸‹æ¥å°†è¯´æ˜æ€ä¹ˆå°è£…å“åº”ï¼š

ä»æ›´æ–°cmd/api/helper.goå¼€å§‹ï¼Œå¦‚ä¸‹æ‰€ç¤º:

File: cmd/api/helpers.go

---

```go
package main

...

//å®šä¹‰envelopç±»å‹
type envelope map[string]interface{}

//å°†dataå‚æ•°ç±»å‹æ”¹ä¸ºenvelope
func (app *application) writeJSON(w http.ResponseWriter, status int, data envelope, headers http.header) error {
    js, err := json.MarshalIndent(data, "", "\t")
    if err != nil {
        return err
    }

    js = append(js, '\n')

    for key, value := range headers {
        w.Header()[key] = value
    }

    w.Header.Set("ContentType", "application/json")
    w.WriteHeader(status)
    w.write(js)

    return nil
}
```

ç„¶åï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°showMovieHandlerï¼Œä»¥åˆ›å»ºåŒ…å«ç”µå½±æ•°æ®çš„envelopeå®ä¾‹ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™writeJSON()å‡½æ•°ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¼ é€’ç”µå½±ç»“æ„ä½“å®ä¾‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

File: cmd/api/movies.go

---

```go
package main

...

func (app *application) showMovieHandler(w http.ResponseWriter, r http.Request) {
    id, err := app.readIDParam(r)
    if err != nil {
        http.NotFound(w, r)
        return
    }

    movie := data.Movie{
        ID:        id,
        CreateAt:  time.Now(),
        Title:     "Casablanca",
        Runtime:   102,
        Genres:    []string{"drama", "romance", "war"},
        Version:   1,
    }

    //åˆ›å»ºenvelope{"movie": movie}å®ä¾‹ï¼Œç„¶åä¼ ç»™writeJSONå‡½æ•°ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¼ movieç»“æ„ä½“å®ä¾‹
    err = app.writeJSON(w, http.StatusOK, envelope{"movie": movie}, nil)
    if err != nil {
        app.logger.Println(err)
        http.Error(w, "the server encountered a problem and could not process your request", http.StatusInternalServerError)
    }
}
```

è¿˜éœ€è¦æ›´æ–°healthcheckHandlerä¸­çš„ä»£ç ï¼Œä»¥ä¾¿å®ƒä¹Ÿå°†envelopeç±»å‹ä¼ é€’ç»™writeJSON()å‡½æ•°:

File: cmd/api/healthcheck.go

---

```go
package main

...

func (app *application) healthcheckHandler(w http.ResponseWriter, r *http.Request) {
    //ç”³æ˜envelopeç±»å‹åŒ…å«å“åº”æ•°æ®ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬æ„é€ å®ƒçš„æ–¹å¼æ„å‘³ç€ç¯å¢ƒå’Œç‰ˆæœ¬æ•°æ®ç°åœ¨å°†åµŒå¥—åœ¨JSONå“åº”çš„system_infoé”®ä¸‹ã€‚
    env := envelope{
        "status": "available",
        "system_info": map[string]string{
            "environment": app.config.env,
            "version": version,
        },
    }
    err := app.writeJSON(w, http.StatusOK, env, nil)
    if err != nil {
        app.logger.Println(err)
        http.Error(w, "The server encountered a problem and could not process your request", http.StatusInternalServerError)
    }
}
```

å¥½äº†ï¼Œæˆ‘ä»¬æ¥è¯•è¯•è¿™äº›ä¿®æ”¹ã€‚é‡æ–°å¯åŠ¨æœåŠ¡å™¨ï¼Œç„¶åä½¿ç”¨curlå‘APIæ¥å£å‘å‡ºè¯·æ±‚ã€‚æ‚¨ç°åœ¨åº”è¯¥å¾—åˆ°å¦‚ä¸‹æ ¼å¼çš„å“åº”ã€‚

```shell
$ curl localhost:4000/v1/movies/123
{
    "movie":
    {
        "id": 123,
        "title": "Casablanca",
        "runtime": 102,
        "genres":
        [
            "drama",
            "romance",
            "war"
        ],
        "version": 1
    }
}

$ curl localhost:4000/v1/healthcheck
{
    "status": "available",
    "system_info":
    {
        "environment": "development",
        "version": "1.0.0"
    }
}
```

## é™„åŠ å†…å®¹

#### HTTPå“åº”ç»“æ„

è¦å¼ºè°ƒä¸‹æ„é€ JSONå“åº”æ²¡æœ‰å”¯ä¸€æ­£ç¡®æˆ–é”™è¯¯æ–¹æ³•ã€‚æœ‰ä¸€äº›æµè¡Œçš„æ ¼å¼ï¼Œå¦‚JSON:APIå’Œjsendï¼Œæ‚¨å¯èƒ½å¸Œæœ›éµå¾ªæˆ–ä½¿ç”¨å®ƒä»¬æ¥è·å¾—çµæ„Ÿï¼Œä½†è¿™å½“ç„¶ä¸æ˜¯å¿…éœ€çš„ï¼Œå¤§å¤šæ•°APIä¸éµå¾ªè¿™äº›æ ¼å¼ã€‚

ä½†æ˜¯æ— è®ºä½ åšä»€ä¹ˆï¼Œè€ƒè™‘æ ¼å¼åŒ–å’Œåœ¨ä¸åŒçš„APIæ¥å£ä¹‹é—´ä¿æŒæ¸…æ™°å’Œä¸€è‡´çš„å“åº”ç»“æ„éƒ½æ˜¯å¾ˆæœ‰ä»·å€¼çš„â€”â€”ç‰¹åˆ«æ˜¯å½“å®ƒä»¬å¯ä¾›å…¬ä¼—ä½¿ç”¨ã€‚
## é«˜çº§JSONå®šåˆ¶åŒ–

é€šè¿‡ä½¿ç”¨ç»“æ„ä½“æ ‡ç­¾ã€æ·»åŠ ç©ºç™½å’Œå°è£…å“åº”æ•°æ®ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿä¸ºJSONå“åº”æ·»åŠ å¤§é‡å®šåˆ¶ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œå½“è¿™äº›å†…å®¹è¿˜ä¸å¤Ÿæ—¶ï¼Œæ‚¨éœ€è¦æ›´è‡ªç”±åœ°å®šåˆ¶JSONæ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢?

è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è°ˆè°ˆGoå¦‚ä½•å¤„ç†JSONåºåˆ—åŒ–çš„ä¸€äº›ç†è®ºã€‚è¦ç†è§£çš„å…³é”®æ˜¯:

Goæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™å°†ç‰¹æ®Šç±»å‹åºåˆ—åŒ–ä¸ºJSONï¼Œå®ƒé¦–å…ˆæŸ¥çœ‹å¯¹åº”çš„ç±»å‹æ˜¯å¦å®ç°äº†MarshalJSON()æ–¹æ³•ã€‚å¦‚æœå®ç°äº†ï¼ŒGOå°†è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥å†³å®šJSONç¼–ç æ ¼å¼ã€‚

è¿™ä¹ˆå°†æœ‰ç‚¹æ¨¡ç³Šï¼Œæˆ‘ä»¬æ›´ç²¾ç¡®ç‚¹ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œå½“Goå°†ç‰¹å®šç±»å‹ç¼–ç ä¸ºJSONæ—¶ï¼Œå®ƒä¼šæŸ¥çœ‹è¯¥ç±»å‹æ˜¯å¦æ»¡è¶³json.Marshaleræ¥å£ï¼Œè¯¥æ¥å£å¦‚ä¸‹æ‰€ç¤º:

```go
type Marshaler interface {
    MarshalJSON() ([]byte, error)
}
```

å¦‚æœç±»å‹ç¡®å®æ»¡è¶³æ¥å£ï¼Œé‚£ä¹ˆGoå°†è°ƒç”¨å®ƒçš„MarshalJSON()æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨å®ƒè¿”å›çš„[]byteåˆ‡ç‰‡ä½œä¸ºJSONç¼–ç çš„å€¼ã€‚

å¦‚æœè¯¥ç±»å‹æ²¡æœ‰MarshalJSON()æ–¹æ³•ï¼Œé‚£ä¹ˆGoå°†è¿”å›å°è¯•æ ¹æ®è‡ªå·±çš„å†…éƒ¨è§„åˆ™å°†å…¶ç¼–ç ä¸ºJSONã€‚

å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å®šåˆ¶æŸäº›ç±»å‹çš„ç¼–ç æ–¹å¼ï¼Œåªéœ€è¦åœ¨å…¶ä¸Šå®ç°MarshalJSON()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä»¥[]byteç±»å‹è¿”å›è‡ªå®šä¹‰çš„JSONå†…å®¹ã€‚

> æç¤ºï¼šå¦‚æœæ‚¨æŸ¥çœ‹time.Timeç±»å‹æºä»£ç ï¼Œå°±å¯ä»¥çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚time.Timeå®é™…ä¸Šæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªMarshalJSON()æ–¹æ³•ï¼Œè¾“å‡ºRFC3339æ ¼å¼JSONå¯¹è±¡ã€‚å½“time.Timeå€¼è¢«åºåˆ—åŒ–ä¸ºJSONå¯¹è±¡æ—¶ï¼Œå°±ä¼šè°ƒç”¨MarshalJSON()æ–¹æ³•ã€‚

## å®šåˆ¶Runtimeå­—æ®µJSONåºåˆ—åŒ–

ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹åº”ç”¨ç¨‹åºä¸­çš„ä¸€ä¸ªå…·ä½“ç¤ºä¾‹ã€‚

å½“æˆ‘ä»¬çš„Movieç»“æ„è¢«ç¼–ç ä¸ºJSONæ—¶ï¼ŒRuntimeå­—æ®µ(å®ƒæ˜¯ä¸€ä¸ªint32ç±»å‹)ç¼–ç ä¸ºJSONæ•°å­—ã€‚ç°åœ¨æˆ‘ä»¬æ¥æ›´æ”¹å®ƒï¼Œå°†å…¶ç¼–ç ä¸º"<<runtime>runtime> minsâ€œçš„å­—ç¬¦ä¸²ã€‚åƒè¿™æ ·:

```json
{
    "id": 123,
    "title": "Casablanca",
    "runtime": "102 mins",
    "genres":
    [
        "drama",
        "romance",
        "war"
    ],
    "version": 1
}
```

æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å®ç°è¿™ä¸€ç‚¹ï¼Œä½†ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ä¸ºRuntimeå­—æ®µåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ç±»å‹ï¼Œå¹¶åœ¨è¿™ä¸ªç±»å‹ä¸Šå®ç°MarshalJSON()æ–¹æ³•ã€‚

ä¸ºäº†é˜²æ­¢internal/data/movie.goæ–‡ä»¶ä¸ä¼šå¤ªä¹±ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æ¥å¤„ç†runtimeç±»å‹åºåˆ—åŒ–é€»è¾‘ï¼š

```shell
 $ touch internal/data/runtime.go
```

ç„¶åç»§ç»­æ·»åŠ ä»¥ä¸‹ä»£ç :

```go
package data

import (
    "fmt"
    "strconv"
)

//ç”³æ˜Runtimeç±»å‹ï¼Œå…¶åº•å±‚æ˜¯int32ç±»å‹ï¼ˆå’Œmovieä¸­çš„å­—æ®µä¸€æ ·ï¼‰
type Runtime int32

//å®ç°MarshalJSON()æ–¹æ³•ï¼Œè¿™æ ·å°±æ»¡è¶³æ¥json.Marshaleræ¥å£ã€‚
func (r Runtime) MarshalJSON() ([]byte, error) {
    //ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²åŒ…å«ç”µå½±æ—¶é•¿
    jsonValue := fmt.Sprintf("%d mins", r)

    //ä½¿ç”¨strconv.Quote()å‡½æ•°å°è£…åŒå¼•å·ã€‚ä¸ºäº†åœ¨JSONä¸­ä»¥å­—ç¬¦ä¸²å¯¹è±¡è¾“å‡ºï¼Œéœ€è¦ç”¨åŒå¼•å·ã€‚
    quotedJSONValue := strconv.Quote(jsonValue)
    //å°†å­—ç¬¦ä¸²è½¬ä¸º[]byteè¿”å›
    return []byte(quotedJSONValue)
}
```

è¿™é‡Œæˆ‘æƒ³å¼ºè°ƒä¸¤ç‚¹:

* å¦‚æœæ‚¨çš„MarshalJSON()æ–¹æ³•åƒæˆ‘ä»¬çš„æ–¹æ³•ä¸€æ ·è¿”å›ä¸€ä¸ªJSONå­—ç¬¦ä¸²å€¼ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»åœ¨è¿”å›å­—ç¬¦ä¸²ä¹‹å‰ç”¨åŒå¼•å·åŒ…è£…å®ƒã€‚å¦åˆ™å®ƒå°†ä¸ä¼šè¢«è§£é‡Šä¸ºJSONå­—ç¬¦ä¸²ï¼Œä½ å°†æ”¶åˆ°ç±»ä¼¼äºè¿™æ ·çš„è¿è¡Œæ—¶é”™è¯¯:
  ```shell
  json: error calling MarshalJSON for type data.Runtime: invalid character 'm' after top-level value
  ```
* æˆ‘ä»¬æ•…æ„ä¸ºMarshalJSON()æ–¹æ³•ä½¿ç”¨å€¼æ¥æ”¶å™¨ï¼Œè€Œä¸æ˜¯æŒ‡é’ˆæ¥æ”¶å™¨func (r *Runtime) MarshalJSON()ã€‚è¿™ç»™äº†æˆ‘ä»¬æ›´å¤šçš„çµæ´»æ€§ï¼Œå› ä¸ºè¿™æ„å‘³ç€å®šåˆ¶JSONç¼–ç å°†å¯¹Runtimeå€¼å¯¹è±¡å’ŒæŒ‡é’ˆå¯¹è±¡éƒ½æœ‰æ•ˆã€‚æ­£å¦‚Effective Goæåˆ°çš„:

> å¦‚æœä½ ä¸ç¡®å®šæŒ‡é’ˆå’Œå€¼æ¥æ”¶å™¨ä¹‹é—´çš„åŒºåˆ«ï¼Œé‚£ä¹ˆè¿™ç¯‡[åšå®¢](https://medium.com/globant/go-method-receiver-pointer-vs-value-ffc5ab7acdb)æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„æ€»ç»“ã€‚

å¥½çš„ï¼Œç°åœ¨æœ‰äº†è‡ªå®šä¹‰Runtimeç±»å‹ï¼Œæ‰“å¼€internal/data/movies.goæ–‡ä»¶å¹¶æ›´æ–°Movieç»“æ„:

File: internal/data/movies.go

---

```go
package data

import (
    "time"
)

type Movie struct {
	ID       int64     `json:"id"`
	CreateAt time.Time `json:"-"`
	Title    string    `json:"title"`
	Year     int32     `json:"year,omitempty"`
        //ä½¿ç”¨Runtimeç±»å‹å–ä»£int32ï¼Œæ³¨æ„omitemptyè¿˜æ˜¯èƒ½ç”Ÿæ•ˆçš„
	Runtime  Runtime   `json:"runtime,omitempty,string"`
	Genres   []string  `json:"genres,omitempty"`
	Version  int32     `json:"version"`
}
```

é‡å¯æœåŠ¡ç„¶åå¯¹GET /v1/movies/:idæ¥å£å‘èµ·è¯·æ±‚ã€‚ä½ åº”è¯¥çœ‹åˆ°ä¸€ä¸ªåŒ…å«è‡ªå®šä¹‰è¿è¡Œæ—¶å€¼çš„å“åº”ï¼Œæ ¼å¼ä¸º"xx mins"ï¼Œç±»ä¼¼å¦‚ä¸‹:

```shell
$ curl localhost:4000/v1/movies/123
{
    "movie":
    {
        "id": 123,
        "title": "Casablanca",
        "runtime": "102 mins",
        "genres":
        [
            "drama",
            "romance",
            "war"
        ],
        "version": 1
    }
}
```

æ€»ä¹‹ï¼Œè¿™æ˜¯ç”Ÿæˆå®šåˆ¶JSONçš„ä¸€ç§å¾ˆå¥½çš„æ–¹æ³•ã€‚æˆ‘ä»¬çš„ä»£ç ç®€æ´æ˜äº†ï¼Œå¹¶ä¸”æˆ‘ä»¬æœ‰ä¸€ä¸ªè‡ªå®šä¹‰çš„Runtimeç±»å‹ï¼Œå¯ä»¥éšæ—¶éšåœ°ä½¿ç”¨å®ƒã€‚

ä½†ä¹Ÿæœ‰ä¸åˆ©çš„ä¸€é¢ã€‚åœ¨å°†ä»£ç ä¸å…¶ä»–åŒ…é›†æˆæ—¶ï¼Œä½¿ç”¨è‡ªå®šä¹‰ç±»å‹æœ‰æ—¶ä¼šå¾ˆå°´å°¬ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‰§è¡Œç±»å‹è½¬æ¢ï¼Œå°†è‡ªå®šä¹‰ç±»å‹è½¬æ¢ä¸ºå…¶ä»–åŒ…ç†è§£å’Œå¯æ¥å—çš„å€¼ã€‚
## å‘é€é”™è¯¯å“åº”æ¶ˆæ¯

æ­¤æ—¶ï¼Œæˆ‘ä»¬çš„APIæ­£åœ¨ä¸ºæˆåŠŸçš„è¯·æ±‚å‘é€æ ¼å¼åŒ–è‰¯å¥½çš„JSONå“åº”ï¼Œä½†å¦‚æœå®¢æˆ·ç«¯å‘å‡ºä¸€ä¸ªé”™è¯¯è¯·æ±‚â€”â€”æˆ–è€…åº”ç”¨ç¨‹åºä¸­å‡ºç°äº†é—®é¢˜â€”â€”æˆ‘ä»¬ä»ç„¶ä¼šä»http.Error()å’Œhttp.NotFound()å‡½æ•°å‘ä»–ä»¬å‘é€çº¯æ–‡æœ¬çš„é”™è¯¯æ¶ˆæ¯ã€‚

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡åˆ›å»ºä¸€äº›é¢å¤–çš„å¸®åŠ©å‡½æ•°æ¥ç®¡ç†é”™è¯¯å¹¶å‘å®¢æˆ·ç«¯å‘é€é€‚å½“çš„JSONå“åº”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

å¦‚æœä½ è·Ÿéšæœ¬ä¹¦çš„ç¼–ç æ“ä½œï¼Œä¸‹é¢åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶cmd/api/errors.goï¼š

```shell
$ touch cmd/api/errors.go
```

åœ¨æ–‡ä»¶ä¸­æ·»åŠ ä¸€äº›å¸®åŠ©å‡½æ•°ï¼š

```go
package main

import (
    "fmt"
    "net/http"
)

//logErroræ–¹æ³•æ˜¯ä¸€ä¸ªé€šç”¨å¸®åŠ©å‡½æ•°ç”¨äºè®°å½•é”™è¯¯ä¿¡æ¯ã€‚åé¢ä¼šå‡çº§è¯¥å‡½æ•°ä½¿ç”¨ç»“æ„åŒ–çš„æ—¥å¿—å®ä¾‹æ¥è®°å½•HTTPè¯·æ±‚é¢å¤–ä¿¡æ¯ã€‚
func (app *application) logError(r *http.Request, err error) {
    app.logger.Println(err)
}

//errorResponseæ–¹æ³•ï¼šå‘å®¢æˆ·ç«¯å‘é€ç»™å®šé”™è¯¯ç å“åº”ã€‚ä½¿ç”¨interface{}ç±»å‹è¡¨ç¤ºè¦è¿”å›ç»™å®¢æˆ·ç«¯çš„æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯stringç±»å‹
//è¿™æ ·åšæ›´çµæ´»
func (app *application) errorResponse(w http.ResponseWriter, r *http.Request, status int, message interface{}){
    env := envelope{"error": message}
    //ä½¿ç”¨writeJSONå°†é”™è¯¯ä¿¡æ¯å†™å…¥httpå“åº”ã€‚å¦‚æœå‡½æ•°æ‰§è¡Œé”™è¯¯ï¼Œéœ€è¦è®°å½•é”™è¯¯æ—¥å¿—ï¼Œå¹¶è¿”å›500é”™è¯¯ç»™å®¢æˆ·ç«¯
    err := app.writeJSON(w, status, env, nil)
    if err != nil {
        app.logError(r, err)
        w.WriteHeader(500)
    }
}

//serverErrorResponse()æ–¹æ³•ï¼šå½“åº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶ç¢°åˆ°éé¢„æœŸçš„é—®é¢˜ä½¿ç”¨ã€‚ä¼šè®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—ï¼Œå¹¶ä½¿ç”¨errorResponse()å‡½æ•°
//å‘é€500å†…éƒ¨æœåŠ¡å™¨é”™è¯¯çŠ¶æ€ç 
func (app *application) serverErrorResponse(w http.ResponseWriter, r *http.Request, err error) {
    app.logError(r, err)

    message := "the server encountered a problem and could not process your request"
    app.errorResponse(w, r, http.StatusInternalServerError, message)
}

//notFoundResponse()æ–¹æ³•ï¼šå‘é€404 not foundçŠ¶æ€ç å’ŒJSONå“åº”ç»™å®¢æˆ·ç«¯
func (app *application) notFoundResponse(w http.ResponseWriter, r *http.Request) {
    message := "the requested resource could not be found"
    app.errorResponse(w, r, http.StatusNotFound, message)
}

//methodNotAllowedResponse()æ–¹æ³•ï¼šå‘é€405è¯·æ±‚æ–¹æ³•ä¸å…è®¸çŠ¶æ€ç å’ŒJSONæ ¼å¼å“åº”ç»™å®¢æˆ·ç«¯
func (app *application) methodNotAllowedResponse(w http.ResponseWriter, r *http.Request) {
    message := fmt.Sprintf("the %s method is not supported for this resource", r.Method)
    app.errorResponse(w, r, http.StatusMethodNotAllowed, message)
}

```

ç°åœ¨è¿™äº›å¸®åŠ©å‡½æ•°éƒ½å°±ç»ªäº†ï¼Œæˆ‘ä»¬æ›´æ–°APIå¤„ç†ç¨‹åºï¼Œä½¿ç”¨è¿™äº›æ–°çš„å¸®åŠ©å‡½æ•°è€Œä¸æ˜¯http.Error()å’Œhttp.NotFound()å‡½æ•°ã€‚åƒè¿™æ ·:

File: cmd/api/healthcheck.go

---

```go
package main

...

func (app *application) healthcheckHandler(w http.ResponseWriter, r *http.Request) {
	env := envelope{
		"status": "available",
		"system_info": map[string]string{
			"environment": app.config.env,
			"version":     version,
		},
	}

	err := app.writeJSON(w, http.StatusOK, env, nil)
	if err != nil {
                //ä½¿ç”¨æ–°çš„serverErrorResponse()å¸®åŠ©å‡½æ•°
		app.serverErrorResponse(w, r, err)
	}
}
```

File: cmd/api/movies.go

---

```go
func (app *application) showMovieHandler(w http.ResponseWriter, r *http.Request) {
	id, err := app.readIDParam(r)
	if err != nil {
                //ä½¿ç”¨notFoundResponseå¸®åŠ©å‡½æ•°
		app.notFoundResponse(w, r)
		return
	}
	movie := data.Movie{
		ID:       id,
		CreateAt: time.Now(),
		Title:    "Casablanca",
		Runtime:  102,
		Genres:   []string{"drama", "romance", "war"},
		Version:  1,
	}
	err = app.writeJSON(w, http.StatusOK, envelope{"movie": movie}, nil)
	if err != nil {
                //ä½¿ç”¨serverErrorResponseå¸®åŠ©å‡½æ•°
		app.serverErrorResponse(w, r, err)
	}
}

```

## è·¯ç”±é”™è¯¯

æˆ‘ä»¬è‡ªå·±çš„APIå¤„ç†ç¨‹åºå‘é€çš„ä»»ä½•é”™è¯¯æ¶ˆæ¯ç°åœ¨éƒ½å°†æ˜¯æ ¼å¼è‰¯å¥½çš„JSONå“åº”ã€‚æ•ˆæœéå¸¸å¥½!

ä½†æ˜¯å½“httprouteræ‰¾ä¸åˆ°åŒ¹é…çš„è·¯ç”±æ—¶ï¼Œå®ƒè‡ªåŠ¨å‘é€é”™è¯¯æ¶ˆæ¯æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›å“åº”ä»ç„¶æ˜¯æˆ‘ä»¬åœ¨æœ¬ä¹¦å‰é¢çœ‹åˆ°çš„çº¯æ–‡æœ¬(éjson)å“åº”ã€‚

å¹¸è¿çš„æ˜¯ï¼Œhttprouterå…è®¸æˆ‘ä»¬åœ¨åˆå§‹åŒ–è·¯ç”±å™¨æ—¶è®¾ç½®è‡ªå·±çš„è‡ªå®šä¹‰é”™è¯¯å¤„ç†ç¨‹åºã€‚è¿™äº›è‡ªå®šä¹‰å¤„ç†ç¨‹åºå¿…é¡»æ»¡è¶³http.handleræ¥å£ï¼Œè¿™å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ä¸ªå¥½æ¶ˆæ¯ï¼Œå› ä¸ºè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°é‡ç”¨æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„notFoundResponse()å’Œmethodnotallowdresponse()å¸®åŠ©å‡½æ•°ã€‚

æ‰“å¼€cmd/api/routes.goæ–‡ä»¶å¹¶é…ç½®httprouterå®ä¾‹ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```go
func (app *application) routes() http.Handler {
	router := httprouter.New()
   
        //http.HandlerFuncå‡½æ•°å°†notFoundResponse()å¸®åŠ©å‡½æ•°è½¬ä¸ºhttp.Handlerï¼Œå°†è‡ªå®šä¹‰é”™è¯¯å¤„ç†ç¨‹åºæ›¿æ¢é»˜è®¤çš„
	router.NotFound = http.HandlerFunc(app.notFoundResponse)
        //åŒç†ï¼ŒmethodNotAllowedResponseä¹ŸåŒæ ·è½¬æ¢å¹¶èµ‹å€¼
	router.MethodNotAllowed = http.HandlerFunc(app.methodNotAllowedResponse)

	router.HandlerFunc(http.MethodGet, "/v1/healthcheck", app.healthcheckHandler)
	router.HandlerFunc(http.MethodPost, "/v1/movies", app.createMovieHandler)
	router.HandlerFunc(http.MethodGet, "/v1/movies/:id", app.showMovieHandler)
	return app.recoverPanic(app.rateLimit(router))
}
```

æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹è¿™äº›æ›´æ”¹ã€‚é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œç„¶åå°è¯•å¯¹ä¸å­˜åœ¨çš„æ¥å£æˆ–ä½¿ç”¨ä¸æ”¯æŒçš„HTTPæ–¹æ³•å‘èµ·ä¸€äº›è¯·æ±‚ã€‚ç°åœ¨ä½ åº”è¯¥ä¼šå¾—åˆ°ä¸€äº›ç±»ä¼¼çš„JSONé”™è¯¯å“åº”:

```shell
$ curl -i localhost:4000/foo
HTTP/1.1 404 Not Found 
Content-Type: application/json 
Date: Tue, 06 Apr 2021 15:13:42 GMT 
Content-Length: 58

{
    "error": "the requested resource could not be found"
}

$ curl -i localhost:4000/v1/movies/abc
HTTP/1.1 404 Not Found 
Content-Type: application/json 
Date: Tue, 06 Apr 2021 15:14:01 GMT 
Content-Length: 58

{
    "error": "the requested resource could not be found"
}

$ curl -i -X PUT localhost:4000/v1/healthcheck
HTTP/1.1 405 Method Not Allowed 
Allow: GET, OPTIONS
Content-Type: application/json 
Date: Tue, 06 Apr 2021 15:14:21 GMT 
Content-Length: 66

{
    "error": "the PUT method is not supported for this resource"
}
```

åœ¨æœ€åä¸€ä¸ªä¾‹å­ä¸­ï¼Œè¯·æ³¨æ„httprouterä»ç„¶è‡ªåŠ¨ä¸ºæˆ‘ä»¬è®¾ç½®æ­£ç¡®çš„Allowå¤´ï¼Œå³ä½¿å®ƒç°åœ¨ä½¿ç”¨æˆ‘ä»¬çš„è‡ªå®šä¹‰é”™è¯¯å¤„ç†ç¨‹åºçš„å“åº”ã€‚

## é™„åŠ å†…å®¹

#### ç³»ç»Ÿç”Ÿæˆçš„é”™è¯¯å“åº”

å½“æˆ‘ä»¬è°ˆåˆ°é”™è¯¯çš„è¯é¢˜æ—¶ï¼Œæˆ‘æƒ³æä¸€ä¸‹åœ¨æŸäº›æƒ…å†µä¸‹Goçš„http.Serverä»ç„¶å¯ä»¥è‡ªåŠ¨ç”Ÿæˆå’Œå‘é€æ–‡æœ¬ç±»å‹çš„HTTPå“åº”ã€‚è¿™äº›åœºæ™¯åŒ…æ‹¬:

* HTTPè¯·æ±‚æŒ‡å®šä¸æ”¯æŒçš„HTTPåè®®ç‰ˆæœ¬
* HTTPè¯·æ±‚ç¼ºå°‘æˆ–åŒ…å«æ— æ•ˆçš„hostè¯·æ±‚å¤´ï¼Œæˆ–å¤šä¸ªhostè¯·æ±‚å¤´ã€‚
* HTTPè¯·æ±‚åŒ…å«æ— æ•ˆçš„è¯·æ±‚å¤´nameå’Œvalue
* HTTPè¯·æ±‚åŒ…å«ä¸æ”¯æŒçš„Transfer-Encodingå¤´ä¿¡æ¯
* HTTPè¯·æ±‚å¤´å¤§å°è¶…å‡ºæœåŠ¡å™¨çš„æœ€å¤§è®¾ç½®MaxHeaderBytes
* å®¢æˆ·ç«¯æƒ³HTTPSæœåŠ¡å™¨å‘é€HTTPè¯·æ±‚

ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•å‘é€ä¸€ä¸ªå¸¦æœ‰æ— æ•ˆHostå¤´å€¼çš„è¯·æ±‚ï¼Œæˆ‘ä»¬å°†å¾—åˆ°è¿™æ ·çš„å“åº”:

```shell
$ curl -i -H "Host: ã“ã‚“ã«ã¡ã¯" http://localhost:4000/v1/healthcheck 
HTTP/1.1 400 Bad Request: malformed Host header
Content-Type: text/plain; charset=utf-8
Connection: close

400 Bad Request: malformed Host header
```

ä¸å¹¸çš„æ˜¯ï¼Œè¿™äº›å“åº”è¢«ç¡¬ç¼–ç åˆ°Goæ ‡å‡†åº“ä¸­ï¼Œæˆ‘ä»¬æ— æ³•å¯¹å®ƒä»¬è¿›è¡Œå®šåˆ¶ä»¥ä½¿ç”¨JSONè¿”å›ã€‚

ä½†æ˜¯ï¼Œè™½ç„¶è¿™æ˜¯éœ€è¦æ³¨æ„çš„äº‹æƒ…ï¼Œä½†æˆ‘ä»¬ä¸ä¸€å®šéœ€è¦æ‹…å¿ƒã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¡Œä¸ºè‰¯å¥½çš„ã€éæ¶æ„çš„å®¢æˆ·ç«¯è§¦å‘è¿™äº›å“åº”çš„å¯èƒ½æ€§ç›¸å¯¹è¾ƒå°ã€‚
## å‘é€JSONå“åº”

åœ¨æœ¬ä¹¦çš„è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†æ›´æ–°APIå¤„ç†ç¨‹åºï¼Œä½¿å®ƒä»¬è¿”å›JSONå“åº”ï¼Œè€Œä¸æ˜¯çº¯æ–‡æœ¬ã€‚

JSON (JavaScript Object Notationçš„é¦–å­—æ¯ç¼©å†™)æ˜¯ä¸€ç§äººç±»å¯è¯»çš„æ–‡æœ¬æ ¼å¼ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºç»“æ„åŒ–æ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œä¸€ä¸ªç”µå½±å¯ä»¥ç”¨ä»¥ä¸‹JSONè¡¨ç¤º:

```json
{
    "id": 123,
    "title": "Casablanca",
    "runtime": 102,
    "genres":
    [
        "drama",
        "romance",
        "war"
    ],
    "version": 1
}
```

ä¸ºäº†è®©æ‚¨å¿«é€Ÿäº†è§£JSONè¯­æ³•â€¦â€¦

* æ‹¬å·{}å®šä¹‰ä¸€ä¸ªJSONå¯¹è±¡ï¼Œç”±é€—å·åˆ†éš”é”®/å€¼å¯¹ã€‚
* é”®å¿…é¡»æ˜¯å­—ç¬¦ä¸²ï¼Œå€¼å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€æ•°å­—ã€å¸ƒå°”å€¼ã€å…¶ä»–JSONå¯¹è±¡æˆ–è¿™äº›ç±»å‹ç»„æˆçš„æ•°ç»„ï¼ˆç”¨æ–¹æ‹¬å·ï¼‰
* å­—ç¬¦ä¸²å¿…é¡»ä½¿ç”¨åŒå¼•å·è€Œä¸æ˜¯å•å¼•å·ï¼Œå¸ƒå°”å€¼ä¸æ˜¯trueå°±æ˜¯falseã€‚
* ç©ºæ ¼ç¬¦åœ¨jsoné‡Œé¢æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œå¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œç”¨ä¸‹é¢çš„JSONæ¥è¡¨ç¤ºåŒä¸€ä¸ªç”µå½±æ˜¯å®Œå…¨æ­£ç¡®çš„:

```json
  {"id":123,"title":"Casablanca","runtime":102,"genres":["drama","romance","war"],"version":1}
```

å¦‚æœä½ ä»¥å‰æ²¡ä½¿ç”¨JSONï¼Œè¿™ä¸ª[æ–°æ‰‹æŒ‡å—](https://towardsdatascience.com/an-introduction-to-json-c9acb464f43e)æä¾›äº†å®Œæ•´çš„ä»‹ç»ï¼Œå»ºè®®ä½ åœ¨ç»§ç»­ä¹‹å‰å¯ä»¥å…ˆé˜…è¯»é‡Œé¢çš„å†…å®¹ã€‚

æœ¬ä¹¦çš„è¿™éƒ¨åˆ†ï¼Œä½ å°†å­¦ä¹ åˆ°ä»¥ä¸‹å†…å®¹ï¼š

* å¦‚ä½•ä»REST APIå‘é€JSONå“åº”(åŒ…æ‹¬é”™è¯¯å“åº”)ã€‚
* å¦‚ä½•ä½¿ç”¨encoding/JSONåŒ…å°†åŸç”ŸGoå¯¹è±¡ç¼–ç ä¸ºJSONã€‚
* ä¸åŒçš„æ–¹æ³•å°†Goå¯¹è±¡ç¼–ç ä¸ºJSON-é¦–å…ˆä½¿ç”¨ç»“æ„ä½“æ ‡ç­¾ï¼Œç„¶ååˆ©ç”¨json.Marshaleræ¥å£ã€‚
* å¦‚ä½•åˆ›å»ºå‘é€JSONå“åº”çš„å¯é‡ç”¨å¸®åŠ©å‡½æ•°ï¼Œè¿™å°†ç¡®ä¿æ‰€æœ‰APIå“åº”å…·æœ‰åˆç†å’Œä¸€è‡´çš„ç»“æ„ã€‚
## JSONè§£ç ï¼ˆååºåˆ—åŒ–ï¼‰

å’ŒJSONç¼–ç ä¸€æ ·ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥ç”¨äºå°†JSONè§£ç ä¸ºGoå¯¹è±¡ï¼šä½¿ç”¨json.Decoderç±»å‹å’Œjson.Unmarshal()å‡½æ•°ã€‚

è¿™ä¸¤ç§æ–¹æ³•å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œä½†ä¸ºäº†ä»HTTPè¯·æ±‚ä½“è§£ç JSONï¼Œä½¿ç”¨JSON.Decoderé€šå¸¸æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚å®ƒæ¯”json.Unmarshal()æ›´é«˜æ•ˆï¼Œéœ€è¦æ›´å°‘çš„ä»£ç ï¼Œå¹¶æä¾›äº†ä¸€äº›æœ‰ç”¨çš„è®¾ç½®ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™äº›è®¾ç½®æ¥è°ƒæ•´å…¶è¡Œä¸ºã€‚

ç”¨ä»£ç è€Œä¸æ˜¯æ–‡å­—æ¥è¯´æ˜json.Decoderæ˜¯å¦‚ä½•å·¥ä½œä¼šæ›´ç®€å•ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç›´æ¥è¿›å…¥ä»£ç æ›´æ–°createMovieHandlerå¤„ç†å‡½æ•°:

File: cmd/api/movies.go

---

```go
package main

import (
    "encoding/json"
    "fmt"
    "net/http"
    "time"

    "greenlight.alexedwards.net/internal/data"
)

func (app *application) createMovieHandler(w http.ResponseWriter, r *http.Request) {
    //ç”³æ˜ä¸€ä¸ªåŒ¿åç»“æ„ä½“æ¥æ¥æ”¶HTTPè¯·æ±‚ä½“ä¸­å¯¹JSONå†…å®¹ï¼Œæ³¨æ„ç»“æ„ä½“ä¸­å­—æ®µå’Œç±»å‹ä¸ä¹‹å‰åˆ›å»ºmovieç»“æ„ä½“åªåŒ…å«éƒ¨åˆ†å­—æ®µ
    //è¯¥ç»“æ„ä½“å®šä¹‰ç±»å‹ç”¨äºæ¥æ”¶httpè¯·æ±‚ï¼Œå¹¶è§£ç ä¸ºGoå¯¹è±¡ã€‚
    var input struct {
        Title     string   `json:"title"`
        Year      int32    `json:"year"`
        Runtime   int32    `json:"runtime"`
        Genres    []string `json:"genres"`
    }

    //åˆå§‹åŒ–json.Decoderå®ä¾‹ï¼Œä»httpè¯·æ±‚bodyä¸­è¯»å–è¯·æ±‚å†…å®¹ï¼Œç„¶åä½¿ç”¨Decode()æ–¹æ³•å°†å†…å®¹è§£æä¸ºinputç»“æ„ä½“ã€‚
    //æ³¨æ„Decoderå‡½æ•°æ¥æ”¶å¯¹æ˜¯æŒ‡é’ˆç±»å‹ï¼Œå¦‚æœè§£æé”™è¯¯å°±è°ƒç”¨errorResponse()å¸®åŠ©å‡½æ•°è¿”å›400é”™è¯¯ç»™å®¢æˆ·ç«¯ã€‚
    err := json.NewDecoder(r.Body).Decode(&input)
    if err != nil {
        app.errorResponse(w, r, http.StatusBadRequest, err.Error())
        return
    }

    //å°†è§£æåå¯¹inputç»“æ„ä½“å†™å…¥HTTPå“åº”ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯
    fmt.Fprintf(w, "%+v\n", input)
  
   ...
}
```

å…³äºè¿™æ®µä»£ç ï¼Œæœ‰ä¸€äº›é‡è¦çš„åœ°æ–¹éœ€è¦æŒ‡å‡º:

* å½“è°ƒç”¨Decoder()å¿…é¡»ä¼ å…¥ä¸€ä¸ªénilæŒ‡é’ˆä½œä¸ºè§£æå¯¹å­˜å‚¨ç›®æ ‡ã€‚å¦‚æœä¼ å…¥å¯¹ä¸æ˜¯æŒ‡é’ˆï¼Œè¿è¡Œæ—¶å°†è¿”å›json.InvalidUnmarshalErroré”™è¯¯ã€‚
* å¦‚æœä¼ å…¥å¯¹æ˜¯ç»“æ„ä½“ï¼Œæƒ³ä¸Šé¢ä»£ç ä¸­å¯¹é‚£æ ·ï¼Œç»“æ„ä½“å­—æ®µå¿…é¡»é¦–å­—æ¯å¤§å†™ã€‚å’Œç¼–ç ä¸€æ ·ï¼Œå®ƒä»¬éœ€è¦è¢«å¯¼å‡ºï¼Œè¿™æ ·å®ƒä»¬å¯¹encoding/jsonåŒ…æ˜¯å¯è§çš„ã€‚
* å½“å°†JSONå¯¹è±¡è§£ç ä¸ºç»“æ„ä½“æ—¶ï¼ŒJSONä¸­çš„é”®/å€¼å¯¹å°†åŸºäºç»“æ„ä½“æ ‡ç­¾åæ˜ å°„åˆ°ç»“æ„ä½“å­—æ®µã€‚å¦‚æœæ²¡æœ‰åŒ¹é…çš„ç»“æ„ä½“æ ‡ç­¾ï¼ŒGoå°†è¯•å›¾å°†å¯¹åº”å¯¹JSONå€¼ç¼–ç åˆ°åŒ¹é…å¯¹ç»“æ„ä½“å­—æ®µä¸­ï¼Œä¸åŒºåˆ†å¤§å°å†™çš„åŒ¹é…)ã€‚ä»»ä½•ä¸èƒ½æˆåŠŸæ˜ å°„åˆ°ç»“æ„ä½“å­—æ®µçš„JSONé”®/å€¼å¯¹éƒ½å°†è¢«å¿½ç•¥ã€‚
* åœ¨r.Bodyè¢«è¯»å–ä¹‹åï¼Œæ²¡æœ‰å¿…è¦å…³é—­å®ƒã€‚è¿™å°†ç”±Goçš„http.Serverè‡ªåŠ¨å¤„ç†ã€‚

å¥½å§ï¼Œæˆ‘ä»¬æ¥è¯•è¯•ã€‚

å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œç„¶åæ‰“å¼€ç¬¬äºŒä¸ªç»ˆç«¯çª—å£ï¼Œå‘POST /v1/ moviesendpointwithavalidjsonrequestbodyå‘å‡ºè¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«ä¸€äº›movieæ•°æ®ã€‚ä½ åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å“åº”:

```shell
#åˆ›å»ºä¸€BODYå˜é‡ï¼ŒåŒ…å«è¦å‘é€å¯¹JSONå†…å®¹
$ BODY='{"title":"Moana","year":2016,"runtime":107, "genres":["animation","adventure"]}'

#ä½¿ç”¨-då‘½ä»¤è¡Œå‚æ•°å°†BODYå†…å®¹å‘é€ç»™æœåŠ¡ç«¯
$ curl -i -d "$BODY" localhost:4000/v1/movies
HTTP/1.1 200 OK
Date: Tue, 06 Apr 2021 17:13:46 GMT Content-Length: 65
Content-Type: text/plain; charset=utf-8

{Title:Moana Year:2016 Runtime:107 Genres:[animation adventure]}
```

å¤ªæ£’äº†!ä¼¼ä¹å¾ˆæœ‰æ•ˆã€‚ä»å“åº”ä¸­æ•°æ®å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬åœ¨è¯·æ±‚ä½“ä¸­æä¾›çš„å€¼å·²ç»è¢«è§£ç åˆ°inputç»“æ„ä½“çš„å¯¹åº”å­—æ®µä¸­ã€‚

## é›¶å€¼

è®©æˆ‘ä»¬å¿«é€Ÿçœ‹ä¸€ä¸‹å¦‚æœæˆ‘ä»¬åœ¨JSONè¯·æ±‚ä½“ä¸­å¿½ç•¥ç‰¹å®šçš„é”®/å€¼å¯¹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œåœ¨JSONä¸­åˆ›å»ºä¸€ä¸ªæ²¡æœ‰yearå­—æ®µçš„è¯·æ±‚ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```shell
$ BODY='{"title":"Moana","runtime":107, "genres":["animation","adventure"]}' 
$ curl -d "$BODY" localhost:4000/v1/movies
{Title:Moana Year:0 Runtime:107 Genres:[animation
```

æ­£å¦‚æ‚¨å¯èƒ½å·²ç»çŒœåˆ°çš„ï¼Œå½“æˆ‘ä»¬è¿™æ ·åšæ—¶ï¼Œè¾“å…¥ç»“æ„ä¸­çš„Yearå­—æ®µå°†ä¿ç•™å…¶é›¶å€¼(ç¢°å·§æ˜¯0ï¼Œå› ä¸ºYearå­—æ®µæ˜¯ä¸€ä¸ªint32ç±»å‹)ã€‚

è¿™å°±å¼•å‡ºäº†ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜:å¦‚ä½•åŒºåˆ†å®¢æˆ·ç«¯ä¸æä¾›é”®/å€¼å¯¹å’Œæä¾›é”®/å€¼å¯¹ä½†æ•…æ„å°†å…¶è®¾ç½®ä¸ºé›¶çš„æƒ…å†µï¼Ÿä¾‹å¦‚:

```shell
$ BODY='{"title":"Moana","year":0,"runtime":107, "genres":["animation","adventure"]}' 
$ curl -d "$BODY" localhost:4000/v1/movies
{Title:Moana Year:0 Runtime:107 Genres:[animation adventure]}
```

å°½ç®¡HTTPè¯·æ±‚ä¸åŒï¼Œä½†æœ€ç»ˆç»“æœæ˜¯ç›¸åŒçš„ï¼Œå¹¶ä¸”å¦‚ä½•åŒºåˆ†è¿™ä¸¤ç§åœºæ™¯å¹¶ä¸æ˜¯å¾ˆæ˜æ˜¾ã€‚æˆ‘ä»¬å°†åœ¨æœ¬ä¹¦çš„åé¢å†å›åˆ°è¿™ä¸ªè¯é¢˜ï¼Œä½†ç°åœ¨ï¼Œåªéœ€è¦äº†è§£è¿™ç‰¹æ®Šæƒ…å†µä¸ºå°±å¤Ÿäº†ã€‚

## é™„åŠ å†…å®¹

#### æ”¯æŒå¯¹ç›®æ ‡ç±»å‹

å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒæŸäº›JSONç±»å‹åªèƒ½æˆåŠŸè§£ç ä¸ºæŸäº›Goç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰JSONå­—ç¬¦ä¸²â€œfooâ€ï¼Œå®ƒå¯ä»¥è¢«è§£ç æˆä¸€ä¸ªGoå­—ç¬¦ä¸²ï¼Œä½†è¯•å›¾å°†å…¶è§£ç æˆä¸€ä¸ªGo intæˆ–boolå°†å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯(æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« ä¸­æ¼”ç¤º)ã€‚

ä¸‹è¡¨æä¾›äº†ä¸åŒJSONç±»å‹æ”¯æŒçš„ç›®æ ‡è§£ç GOç±»å‹:


| JSON ç±»å‹    | æ”¯æŒçš„Goç±»å‹              |
| -------------- | --------------------------- |
| JSON boolean | bool                      |
| JSON string  | string                    |
| JSON number  | int*, uint*, float*, rune |
| JSON array   | array, slice              |
| JSON object  | struct, map               |

#### ä½¿ç”¨json.Unmarshalå‡½æ•°

æ­£å¦‚æˆ‘ä»¬åœ¨æœ¬ç« å¼€å§‹æ—¶æåˆ°çš„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨json.Unmarshal()å‡½æ•°æ¥è§£ç HTTPè¯·æ±‚ä½“ã€‚

ä¾‹å¦‚ï¼Œä½ å¯ä»¥åƒè¿™æ ·åœ¨å¤„ç†å™¨ä¸­ä½¿ç”¨å®ƒ:

```go
func (app *application) exampleHandler(w http.ResponseWriter, r *http.Request) {
    var input struct {
        Foo string `json:"foo"`
    }

    //ä½¿ç”¨io.ReadAll()è¯»å–æ•´ä¸ªHTTPè¯·æ±‚bodyå†…å®¹åˆ°[]byteåˆ‡ç‰‡ä¸­
    body, err := io.ReadAll(r.Body)
    if err != nil {
        app.serverErrorResponse(w, r, err)
        return
    }
  
    //ä½¿ç”¨json.Unmarshal()å‡½æ•°å°†åˆ‡ç‰‡ä¸­çš„JSONè§£ç åˆ°inputç»“æ„ä½“ã€‚å†æ¬¡è¯´æ˜ä½¿ç”¨çš„å‚æ•°æ˜¯æŒ‡é’ˆã€‚
    err = json.Unmarshal(body, &input)
    if err != nil {
        app.errorResponse(w, r, http.StatusBadRequest, err.Error())
    }

    fmt.Fprintf(w, "%+v\n", input)

    ...
}
```

ä½¿ç”¨è¿™ç§æ–¹æ³•å¾ˆç®€å•ã€‚ä½†æ²¡æœ‰æˆ‘ä»¬ä¹‹å‰æåˆ°çš„json.Decoderæ–¹æ³•ä¸­çš„æœ‰ç‚¹ã€‚

ä¸ä»…ä»£ç ç¨å¾®æ›´å†—é•¿ï¼Œè€Œä¸”æ•ˆç‡ä¹Ÿæ›´ä½ã€‚å¦‚æœæˆ‘ä»¬å¯¹è¿™ä¸ªç‰¹å®šç”¨ä¾‹çš„ç›¸å¯¹æ€§èƒ½è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨json. unmarshal()æ¯”json.Decoderå¤šæŸè€—80%çš„å†…å­˜(B/op)ã€‚ä»¥åŠç¨å¾®æ…¢ä¸€ç‚¹(ns/op)ã€‚

![image.png](./assets/image.png)
## ç®¡ç†é”™è¯¯è¯·æ±‚

ç°åœ¨ï¼Œå½“createMovieHandleræ¥æ”¶åˆ°å¸¦æœ‰é€‚å½“æ•°æ®çš„æœ‰æ•ˆJSONè¯·æ±‚ä½“æ—¶ï¼Œå®ƒå¯ä»¥æ­£å¸¸å·¥ä½œã€‚ä½†åœ¨è¿™ä¸€ç‚¹ä¸Šä½ å¯èƒ½ä¼šæƒ³:

* å¦‚æœå®¢æˆ·ç«¯å‘é€çš„ä¸æ˜¯JSONï¼Œæ¯”å¦‚XMLæˆ–ä¸€äº›éšæœºå­—èŠ‚ï¼Œè¯¥æ€ä¹ˆåŠ?
* å¦‚æœJSONæ ¼å¼ä¸æ­£ç¡®æˆ–åŒ…å«é”™è¯¯ä¼šå‘ç”Ÿä»€ä¹ˆ?
* å¦‚æœJSONç±»å‹ä¸æˆ‘ä»¬è¯•å›¾è§£ç çš„ç±»å‹ä¸åŒ¹é…æ€ä¹ˆåŠ?
* å¦‚æœè¯·æ±‚ç”šè‡³ä¸åŒ…å«bodyå‘¢?

ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹ï¼

```shell
# å‘é€ä¸€äº›XMLä½œä¸ºè¯·æ±‚ä½“
$ curl -d '<?xml version="1.0" encoding="UTF-8"?><note><to>Alice</to></note>' localhost:4000/v1/movies
{
    "error": "invalid character '\u003c' looking for beginning of value"
}

# å‘é€ä¸€äº›æ ¼å¼é”™è¯¯çš„JSON(æ³¨æ„æœ«å°¾çš„é€—å·)
$ curl -d '{"title": "Moana", }' localhost:4000/v1/movies
{
    "error": "invalid character '}' looking for beginning of object key string"
}

# é€ä¸€ä¸ªJSONæ•°ç»„è€Œä¸æ˜¯ä¸€ä¸ªå¯¹è±¡
$ curl -d '["foo", "bar"]' localhost:4000/v1/movies
{
    "error": "json: cannot unmarshal array into Go value of type struct { Title string    \"json:\\\"title\\\"\"; Year int32 \"json:\\\"year\\\"\"; Runtime int32 \"json:\\ \"runtime\\\"\"; Genres []string \"json:\\\"genres\\\"\" }"
}

# å‘é€ä¸€ä¸ªæ•°å€¼'title'å€¼(è€Œä¸æ˜¯å­—ç¬¦ä¸²)
$ curl -d '{"title": 123}' localhost:4000/v1/movies
{
    "error": "json: cannot unmarshal number into Go struct field .title of type string"
}

# å‘é€ä¸€ä¸ªç©ºçš„è¯·æ±‚ä½“
$ curl -X POST localhost:4000/v1/movies
{
    "error": "EOF"
}
```

åœ¨æ‰€æœ‰è¿™äº›æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°createMovieHandleréƒ½åœ¨æŒ‰æ­£ç¡®è¯·æ±‚å¤„ç†ã€‚å½“å®ƒæ¥æ”¶åˆ°ä¸€ä¸ªæ— æ³•è§£ç åˆ°æˆ‘ä»¬çš„inputç»“æ„ä¸­çš„æ— æ•ˆè¯·æ±‚æ—¶ï¼Œä¸ä¼šåšè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œå®¢æˆ·ç«¯ä¼šæ”¶åˆ°ä¸€ä¸ªJSONå“åº”ï¼Œå…¶ä¸­åŒ…å«Decode()æ–¹æ³•è¿”å›çš„é”™è¯¯æ¶ˆæ¯ã€‚

å¯¹äºä¸€ä¸ªç§æœ‰APIï¼Œå®ƒä¸ä¼šè¢«å…¬å…±çš„æˆå‘˜ä½¿ç”¨ï¼Œé‚£ä¹ˆè¿™ç§è¿”å›æ²¡ä»€ä¹ˆå½±å“ï¼Œä½ ä¸éœ€è¦åšä»»ä½•å…¶ä»–çš„äº‹æƒ…ã€‚

ä½†æ˜¯å¯¹äºé¢å‘å…¬ä¼—çš„APIï¼Œé”™è¯¯æ¶ˆæ¯æœ¬èº«å¹¶ä¸ç†æƒ³ã€‚æœ‰äº›è¿‡äºè¯¦ç»†ï¼Œæ˜¾ç¤ºæ¥æœ‰å…³åº•å±‚APIå®ç°çš„ä¿¡æ¯ã€‚å…¶ä»–é”™è¯¯ä¿¡æ¯æ²¡æœ‰è¶³å¤Ÿçš„æè¿°æ€§(å¦‚â€œEOFâ€)ï¼Œè¿˜æœ‰ä¸€äº›éš¾ä»¥ç†è§£é”™è¯¯ã€‚ä½¿ç”¨çš„æ ¼å¼æˆ–è¯­è¨€ä¹Ÿä¸ä¸€è‡´ã€‚

ä¸ºäº†æ”¹è¿›è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†è§£é‡Šå¦‚ä½•å¯¹Decode()è¿”å›çš„é”™è¯¯è¿›è¡Œåˆ†ç±»ï¼Œå¹¶å°†å®ƒä»¬æ›¿æ¢ä¸ºæ›´æ¸…æ™°ã€æ˜“äºæ“ä½œçš„é”™è¯¯æ¶ˆæ¯ï¼Œä»¥å¸®åŠ©å®¢æˆ·ç«¯å‡†ç¡®åœ°è°ƒè¯•JSONçš„é”™è¯¯ã€‚

## å¯¹è§£ç é”™è¯¯è¿›è¡Œåˆ†ç±»

æ­¤æ—¶ï¼Œåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ„å»ºä¸­ï¼ŒDecode()æ–¹æ³•å¯èƒ½ä¼šè¿”å›ä»¥ä¸‹äº”ç§ç±»å‹çš„é”™è¯¯:


| é”™è¯¯ç±»å‹                   | åŸå›                                                                                          |
| ---------------------------- | ---------------------------------------------------------------------------------------------- |
| json.SyntaxError           | æ­£åœ¨è§£ç çš„JSONå­˜åœ¨è¯­æ³•é—®é¢˜ã€‚                                                                 |
| io.ErrUnexpectedEOF        | æ­£åœ¨è§£ç çš„JSONå­˜åœ¨è¯­æ³•é—®é¢˜ã€‚                                                                 |
| json.InvalidUnmarshalError | è§£ç ç›®æ ‡æ— æ•ˆ(é€šå¸¸æ˜¯å› ä¸ºå®ƒä¸æ˜¯æŒ‡é’ˆ)ã€‚è¿™å®é™…ä¸Šæ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºä»£ç çš„é—®é¢˜ï¼Œè€Œä¸æ˜¯JSONæœ¬èº«çš„é—®é¢˜ã€‚ |
| io.EOF                     | æ­£åœ¨è§£ç çš„JSONæ˜¯ç©ºçš„ã€‚                                                                       |

å¯¹è¿™äº›æ½œåœ¨é”™è¯¯è¿›è¡Œåˆ†ç±»(æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Goçš„errors.is()å’Œerrors.as()å‡½æ•°æ¥å®Œæˆ)å°†ä½¿createMovieHandlerä¸­çš„ä»£ç æ›´é•¿æ›´å¤æ‚ã€‚è¿™ä¸ªé€»è¾‘æˆ‘ä»¬ä¹Ÿéœ€è¦åœ¨æ•´ä¸ªé¡¹ç›®çš„å…¶ä»–å¤„ç†ç¨‹åºä¸­é‡å¤å¤„ç†ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨cmd/api/helpers.goä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„readJSON()å¸®åŠ©å‡½æ•°ã€‚å°†ä»è¯·æ±‚ä½“ä¸­æ­£å¸¸è§£ç JSONï¼Œç„¶åå¯¹é”™è¯¯è¿›è¡Œåˆ†ç±»ï¼Œå¹¶åœ¨å¿…è¦æ—¶ç”¨æˆ‘ä»¬è‡ªå·±çš„å®šåˆ¶æ¶ˆæ¯æ›¿æ¢å®ƒä»¬ã€‚

å¦‚æœä½ è·Ÿéšæœ¬ä¹¦æ“ä½œï¼Œè¯·ç»§ç»­å¹¶å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°cmd/api/helper.goæ–‡ä»¶:

File: cmd/api/helpers.go

---

```go
package main

import (
    "encoding/json"
    "errrors"
    "fmt"
    "io"
    "net/http"
    "strconv"

    "github.com/julienschmidt/httprouter"
)

func (app *application) readJSON(w http.ResponseWriter, r *http.Request, dst interface{}) error {
    //å°†è¯·æ±‚bodyè§£æåˆ°dstä¸­
    err := json.NewDecoder(r.Body).Decode(dst)
    if err != nil {
        //å¦‚æœåœ¨è§£æçš„è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œå¼€å§‹åˆ†ç±»...
        var syntaxError *json.SyntaxError
        var unmarshalTypeError * json.UnmarshalTypeError
        var invalidUnmarshalError *json.InvalidUnmarshalError

        switch {
        //ä½¿ç”¨errors.As()å‡½æ•°æ£€æŸ¥é”™è¯¯ç±»å‹æ˜¯å¦ä¸º*json.SyntaxErrorã€‚å¦‚æœæ˜¯ï¼Œè¿”å›é”™è¯¯
        case errors.As(err, &syntaxError):
            return fmt.Errorf("body contain badly-formed JSON (at charcter %d)", syntaxErr.Offset)
        //æŸäº›æƒ…å†µä¸‹ï¼Œå› ä¸ºè¯­æ³•é”™è¯¯Decode()å‡½æ•°å¯èƒ½è¿”å›io.ErrUnexpectedEOFé”™è¯¯ã€‚
        case errors.Is(err, io.ErrUnexpectedEOF):
            return errors.New("body contain badly-formed JSON")
        //åŒæ ·æ•è·*json.UnmarshalTypeErroré”™è¯¯ï¼Œè¿™äº›é”™è¯¯æ˜¯å› ä¸ºJSONå€¼å’Œæ¥æ”¶å¯¹è±¡ä¸åŒ¹é…ã€‚å¦‚æœé”™è¯¯å¯¹åº”åˆ°ç‰¹å®šåˆ°å­—æ®µï¼Œ
        //æˆ‘ä»¬å¯ä»¥æŒ‡å‡ºå“ªä¸ªå­—æ®µé”™è¯¯æ–¹ä¾¿å®¢æˆ·ç«¯debug
        case errors.As(err, &unmarshalTypeError):
            if unmarshalTypeError.Field != "" {
                return fmt.Errorf(body contains incorrect JSON type for field %q", unmarshalTypeError.Field)
            }
            return fmt.Errorf(body contains incorrect JSON type (at character %d)", unmarshalTypeError.Offset)
         //å¦‚æœè§£ç åˆ°å†…å®¹æ˜¯ç©ºå¯¹è±¡ï¼Œä¼šè¿”å›io.EOFã€‚
         case errors.Is(err, io.EOF):
             return errors.New("body must not be empty")
          //å¦‚æœdecode()å‡½æ•°ä¼ å…¥ä¸€ä¸ªéç©ºçš„æŒ‡é’ˆï¼Œå°†è¿”å›json.InvalidUnmarshalErrorã€‚
          case errors.As(err, &invalidUnmarshalError):
              panic(err)
          default:
              return err
        }
    }
    return nil
}
```

æœ‰äº†è¿™ä¸ªæ–°çš„å¸®åŠ©å‡½æ•°ï¼Œè®©æˆ‘ä»¬å›åˆ°cmd/api/movies.goæ–‡ä»¶å¹¶æ›´æ–°createMovieHandleræ¥ä½¿ç”¨å®ƒã€‚åƒè¿™æ ·:

File: cmd/api/movies.go

---

```go
package main

import (
    "fmt"
    "net/http"
    "time"

    "greenlight.alexedwards.net/internal/data"
)

func (app *application) createMovieHandler(w http.ResponseWriter, r *http.Request) {
    var input struct {
        Title      string   `json:"title"`
        Year       int32    `json:"year"`
        Runtime    int32    `json:"runtime"`
        Genres     []string `json:"genres"`
    }
    //ä½¿ç”¨æ–°çš„readJSON()å¸®åŠ©å‡½æ•°è§£æè¯·æ±‚ä½“åˆ°inputç»“æ„ä½“å®ä¾‹ã€‚å¦‚æœè¿”å›é”™è¯¯ï¼Œæˆ‘ä»¬å°†é”™è¯¯ä¿¡æ¯æºå¸¦400é”™è¯¯ç è¿”å›å®¢æˆ·ç«¯
    err := app.readJSON(w, r, &input)
    if err != nil {
        app.errorResponse(w, r, http.StatusBadRequest, err.Error())
        return
    }
    fmt.Fprintf(w, "%+v\n", input)
}

...

```

é‡æ–°å¯åŠ¨APIï¼Œç„¶åé€šè¿‡é‡å¤æˆ‘ä»¬åœ¨æœ¬ç« å¼€å§‹æ—¶å‘å‡ºçš„ç›¸åŒçš„é”™è¯¯è¯·æ±‚ã€‚ç°åœ¨ï¼Œä½ åº”è¯¥çœ‹åˆ°æˆ‘ä»¬æ–°çš„ã€è‡ªå®šä¹‰çš„é”™è¯¯æ¶ˆæ¯ï¼Œç±»ä¼¼å¦‚ä¸‹:

```shell
# å‘é€ä¸€äº›XMLä½œä¸ºè¯·æ±‚ä½“
$ curl -d '<?xml version="1.0" encoding="UTF-8"?><note><to>Alice</to></note>' localhost:4000/v1/movies
{
    "error": "body contains badly-formed JSON (at character 1)"
}

# å‘é€ä¸€äº›æ ¼å¼é”™è¯¯çš„JSON(æ³¨æ„æœ«å°¾çš„é€—å·)
$ curl -d '{"title": "Moana", }' localhost:4000/v1/movies
{
    "error": "body contains badly-formed JSON (at character 20)"
}

# é€ä¸€ä¸ªJSONæ•°ç»„è€Œä¸æ˜¯ä¸€ä¸ªå¯¹è±¡
$ curl -d '["foo", "bar"]' localhost:4000/v1/movies
{
    "error": "body contains incorrect JSON type (at character 1)"
}

# å‘é€ä¸€ä¸ªæ•°å€¼'title'å€¼(è€Œä¸æ˜¯å­—ç¬¦ä¸²)
$ curl -d '{"title": 123}' localhost:4000/v1/movies
{
    "error": "body contains incorrect JSON type for \"title\""
}

# å‘é€ä¸€ä¸ªç©ºçš„è¯·æ±‚ä½“
$ curl -X POST localhost:4000/v1/movies
{
    "error": "body must not be empty"
}
```

å®ƒä»¬çœ‹èµ·æ¥çœŸä¸é”™ã€‚é”™è¯¯æ¶ˆæ¯ç°åœ¨åœ¨æ ¼å¼ä¸Šæ›´ç®€å•ã€æ›´æ¸…æ™°å’Œä¸€è‡´ï¼Œè€Œä¸”å®ƒä»¬ä¸ä¼šæš´éœ²ä»»ä½•æœ‰å…³åº•å±‚ç¨‹åºçš„ä¸å¿…è¦ä¿¡æ¯ã€‚

å¦‚æœæ‚¨æ„¿æ„ï¼Œå¯ä»¥éšæ„ä½¿ç”¨å®ƒï¼Œå¹¶å°è¯•å‘é€ä¸åŒçš„è¯·æ±‚ä¸»ä½“ï¼Œä»¥æŸ¥çœ‹å¤„ç†ç¨‹åºå¦‚ä½•å“åº”ã€‚

## åˆ›å»ºé”™è¯¯è¯·æ±‚å¤„ç†å‡½æ•°

åœ¨ä¸Šé¢çš„createMovieHandlerä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨é€šç”¨çš„app.errorResponse()å¸®åŠ©å‡½æ•°å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª400 Bad Requestå“åº”å’Œé”™è¯¯æ¶ˆæ¯ã€‚

æˆ‘ä»¬ç”¨ä¸€ä¸ªä¸“ä¸šçš„app.badRequestResponse()å¸®åŠ©å‡½æ•°ä»£æ›¿å®ƒ:

File: cmd/api/errors.go

---

```go
package main

...

func (app *application) bandRequestResponse(w http.ResponseWriter, r *http.Request) {
    app.errorResponse(w, r, http.StatusBadReqeust, err.Error())
}
```

File: cmd/api/movies.go

---

```go
package main

...

func(app *application) createMovieHandler(w http.ResponseWriter, r *http.Request) {
    var input struct {
        Title      string   `json:"title"`
        Year       int32    `json:"year"`
        Runtime    int32    `json:"runtime"`
        Genres     []string `json:"genres"`
    }

    err := app.readJSON(w, r, &input)
    if err != nil {
        //ä½¿ç”¨æ–°çš„badRequestResponse()å¸®åŠ©å‡½æ•°
        app.badRequestResponse(w, r, err)
        return 
    }
    fmt.Fprintf(w, "%+v\n", input)
}
```

è¿™æ˜¯ä¸€ä¸ªå¾ˆå°çš„ä¿®æ”¹ï¼Œä½†å¾ˆæœ‰ç”¨ã€‚éšç€æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œä½¿ç”¨åƒè¿™æ ·çš„ä¸“ä¸šå¸®åŠ©å‡½æ•°æ¥ç®¡ç†ä¸åŒç±»å‹çš„é”™è¯¯å°†æœ‰åŠ©äºç¡®ä¿æˆ‘ä»¬çš„é”™è¯¯å“åº”åœ¨æ‰€æœ‰æ¥å£ä¸Šä¿æŒä¸€è‡´ã€‚

## é™„åŠ å†…å®¹

#### panicå¯¹æ¯”è¿”å›é”™è¯¯

åœ¨ä¹‹å‰é”™è¯¯åˆ†ç±»ä¸­ï¼Œç¢°åˆ°json.InvalidUnmarshalErroré”™è¯¯æ—¶ï¼Œæˆ‘ä»¬åœ¨readJSONå‡½æ•°ä¸­ç›´æ¥panicã€‚ä½ å¯èƒ½è§‰å¾—åœ¨goä¸­é”™è¯¯ä¸€èˆ¬éƒ½å‘ä¸Šè¿”å›ç»™è°ƒç”¨è€…ã€‚ä½†æ˜¯åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹panicæ˜¯æ²¡é—®é¢˜éƒ½ã€‚æ‰€ä»¥åœ¨å¿…è¦éƒ½æ—¶å€™ä¸éœ€è¦åšæŒä¸panicçš„æ•™æ¡ã€‚å½“åº”ç”¨ç¨‹åºå‘ç”Ÿé”™è¯¯æ—¶ï¼Œè¿™é‡ŒåŒºåˆ†ä¸¤ç±»ä¸åŒçš„é”™è¯¯æ˜¯æœ‰ç”¨çš„ã€‚

ç¬¬ä¸€ç±»é”™è¯¯æ˜¯åœ¨æ­£å¸¸çš„æ“ä½œè¿‡ç¨‹ä¸­èƒ½é¢„æœŸåˆ°ä¼šå‘ç”Ÿçš„ã€‚é¢„æœŸé”™è¯¯çš„ä¸€äº›ä¾‹å­åŒ…æ‹¬ï¼šæ•°æ®åº“æŸ¥è¯¢è¶…æ—¶ã€ç½‘ç»œèµ„æºä¸å¯ç”¨æˆ–ç”¨æˆ·è¾“å…¥é”™è¯¯ã€‚è¿™äº›é”™è¯¯å¹¶ä¸ä¸€å®šæ„å‘³ç€æ‚¨çš„ç¨‹åºæœ¬èº«æœ‰é—®é¢˜â€”â€”äº‹å®ä¸Šï¼Œå®ƒä»¬é€šå¸¸æ˜¯ç”±ç¨‹åºæ§åˆ¶ä¹‹å¤–çš„äº‹æƒ…å¼•èµ·çš„ã€‚ä»»ä½•æ—¶å€™ï¼Œè¿”å›è¿™ç±»é”™è¯¯å¹¶ä¼˜é›…åœ°å¤„ç†å®ƒä»¬éƒ½æ˜¯ä¸€ç§è‰¯å¥½çš„å®è·µã€‚

å¦ä¸€ç±»é”™è¯¯æ˜¯éé¢„æœŸçš„é”™è¯¯ã€‚è¿™äº›é”™è¯¯åœ¨æ­£å¸¸æ“ä½œä¸­ä¸åº”è¯¥å‘ç”Ÿï¼Œå¦‚æœå®ƒä»¬å‘ç”Ÿäº†ï¼Œå¯èƒ½æ˜¯å¼€å‘äººå‘˜é”™è¯¯æˆ–ä»£ç åº“ä¸­çš„é€»è¾‘é”™è¯¯é€ æˆçš„ã€‚è¿™äº›é”™è¯¯ç¡®å®æ˜¯å¼‚å¸¸çš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨panicæ›´è¢«å¹¿æ³›æ¥å—ã€‚äº‹å®ä¸Šï¼ŒGoæ ‡å‡†åº“ç»å¸¸ä¼šè¿™ä¹ˆå¤„ç†ï¼Œå½“å‘ç”Ÿé€»è¾‘é”™è¯¯æˆ–è¯•å›¾ä»¥éé¢„æœŸçš„æ–¹å¼ä½¿ç”¨è¯­è¨€ç‰¹æ€§æ—¶â€”â€”æ¯”å¦‚è¯•å›¾è®¿é—®åˆ‡ç‰‡ä¸­çš„è¶Šç•Œç´¢å¼•ï¼Œæˆ–è¯•å›¾å…³é—­å·²ç»å…³é—­çš„é€šé“ã€‚

ä½†å³ä¾¿å¦‚æ­¤ï¼Œæˆ‘è¿˜æ˜¯å»ºè®®åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å°è¯•è¿”å›å¹¶ä¼˜é›…åœ°å¤„ç†æ„å¤–é”™è¯¯ã€‚ç‰¹æ®Šæƒ…å†µæ˜¯å½“è¿”å›é”™è¯¯æ—¶ï¼Œä¼šç»™ä»£ç åº“çš„å…¶ä½™éƒ¨åˆ†å¢åŠ ä¸å¯æ¥å—çš„é”™è¯¯å¤„ç†å·¥ä½œé‡ã€‚

å›åˆ°readJSON()å¸®åŠ©å‡½æ•°ï¼Œå¦‚æœè¿è¡Œæ—¶å‘ç”Ÿjson.InvalidUnmarshalErrorï¼Œå› ä¸ºå¼€å‘äººå‘˜ç»™Decode()å‡½æ•°ä¼ é€’é”™è¯¯çš„å€¼å¯¼è‡´ã€‚è¿™ç»å¯¹æ˜¯ä¸€ä¸ªåœ¨æ­£å¸¸æ“ä½œä¸‹ä¸åº”è¯¥çœ‹åˆ°çš„æ„å¤–é”™è¯¯ï¼Œè€Œä¸”åº”è¯¥åœ¨éƒ¨ç½²ä¹‹å‰åœ¨å¼€å‘å’Œæµ‹è¯•ä¸­å‘ç°ã€‚

å¦‚æœæˆ‘ä»¬è¿”å›é”™è¯¯è€Œä¸æ˜¯panicï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªapiå¤„ç†ç¨‹åºä¸­å¼•å…¥é¢å¤–çš„ä»£ç æ¥ç®¡ç†è¿™äº›é”™è¯¯ã€‚å¯¹äºä¸å¤ªå¯èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çœ‹åˆ°çš„é”™è¯¯ï¼Œè¿™ä¼¼ä¹ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æƒè¡¡ã€‚

[è¿™ç¯‡æ–‡ç« ](https://gobyexample.com/panic)å¾ˆå¥½çš„æ€»ç»“äº†panicã€‚

> panicé€šå¸¸æ˜¯æŒ‡å‘ç”Ÿäº†éå¯é¢„æœŸé”™è¯¯ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ­£å¸¸æ“ä½œä¸­ä¸åº”è¯¥å‘ç”Ÿçš„é”™è¯¯ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒæ¥å¿«é€Ÿå¤±è´¥ï¼Œå› ä¸ºæ²¡æœ‰å‡†å¤‡å¥½ä¼˜é›…åœ°å¤„ç†è¿™ç±»é”™è¯¯ã€‚
## é™åˆ¶HTPPè¯·æ±‚body

åœ¨å‰ä¸€ç« ä¸­ä¸ºå¤„ç†æ— æ•ˆJSONå’Œå…¶ä»–é”™è¯¯è¯·æ±‚æ‰€åšçš„æ›´æ”¹æ˜¯æœç€æ­£ç¡®æ–¹å‘è¿ˆå‡ºçš„ä¸€å¤§æ­¥ã€‚ä½†æˆ‘ä»¬ä»ç„¶å¯ä»¥åšä¸€äº›äº‹æƒ…æ¥ä½¿JSONå¤„ç†æ›´åŠ å¥å£®ã€‚

å…¶ä¸­å¯¹ä¸€ä»¶äº‹å°±æ˜¯å¤„ç†æœªçŸ¥å­—æ®µã€‚ä¾‹å¦‚ï¼Œä½ å‘ä¸‹é¢å¯¹ä»£ç ä¸€æ ·ï¼Œå‘createMovieHandleræ¥å£å‘é€ä¸€ä¸ªåŒ…å«æœªçŸ¥å­—æ®µratingçš„è¯·æ±‚ï¼š

```shell
$ curl -i -d '{"title": "Moana", "rating":"PG"}' localhost:4000/v1/movies
HTTP/1.1 200 OK
Date: Tue, 06 Apr 2021 18:51:50 GMT Content-Length: 41
Content-Type: text/plain; charset=utf-8

{Title:Moana Year:0 Runtime:0 Genres:[]}
```

è¯·æ³¨æ„è¿™ä¸ªè¯·æ±‚æ˜¯å¦‚ä½•æ­£å¸¸åœ°å·¥ä½œçš„â€”â€”æ²¡æœ‰é€šçŸ¥å®¢æˆ·ç«¯ï¼Œåº”ç”¨ç¨‹åºç¢°åˆ°æ— æ³•è¯†åˆ«çš„ratingå­—æ®µã€‚åœ¨æŸäº›åœºæ™¯ä¸­ï¼Œé»˜é»˜å¿½ç•¥æœªçŸ¥å­—æ®µå¯èƒ½æ­£æ˜¯æ‚¨æƒ³è¦çš„è¡Œä¸ºï¼Œä½†åœ¨è¿™é‡Œï¼Œæœ€å¥½èƒ½å¤Ÿæé†’å®¢æˆ·ç«¯æ³¨æ„è¿™ä¸ªé—®é¢˜ã€‚

å¹¸è¿çš„æ˜¯json.Decoderæä¾›äº†DisallowUnknownField()é…åˆ¶å¯ä»¥åœ¨ç¢°åˆ°æœªçŸ¥å­—æ®µæ—¶æŠ¥é”™ã€‚

å¦ä¸€ä¸ªé—®é¢˜æ˜¯json.Decoderæ”¯æŒJSONæ•°æ®æµã€‚å½“æˆ‘ä»¬åœ¨è¯·æ±‚ä½“ä¸Šè°ƒç”¨Decode()æ—¶ï¼Œå®ƒå®é™…ä¸Šåªä»è¯·æ±‚ä½“è¯»å–ç¬¬ä¸€ä¸ªJSONå€¼å¹¶è§£ç ã€‚å¦‚æœæˆ‘ä»¬å¯¹Decode()è¿›è¡Œç¬¬äºŒæ¬¡è°ƒç”¨ï¼Œå®ƒå°†è¯»å–å¹¶è§£ç ç¬¬äºŒä¸ªJSONå€¼ï¼Œä»¥æ­¤ç±»æ¨ã€‚

ä½†æ˜¯å› ä¸ºæˆ‘ä»¬åªåœ¨readJSON()ä¸­è°ƒç”¨äº†ä¸€æ¬¡Decode()ï¼Œå¹¶ä¸”åªè°ƒç”¨äº†ä¸€æ¬¡ï¼Œæ‰€ä»¥åœ¨è¯·æ±‚ä½“ä¸­ç¬¬ä¸€ä¸ªJSONå€¼ä¹‹åçš„ä»»ä½•å†…å®¹éƒ½ä¼šè¢«å¿½ç•¥ã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥å‘é€ä¸€ä¸ªåŒ…å«å¤šä¸ªJSONå€¼çš„è¯·æ±‚ä½“ï¼Œæˆ–è€…åœ¨ç¬¬ä¸€ä¸ªJSONå€¼ä¹‹åå‘é€åƒåœ¾å†…å®¹ï¼Œè€Œæˆ‘ä»¬çš„APIå¤„ç†ç¨‹åºä¸ä¼šå¼•å‘é”™è¯¯ã€‚ä¾‹å¦‚:

```shell
# BodyåŒ…å«å¤šä¸ªJSONå€¼
$ curl -i -d '{"title": "Moana"}{"title": "Top Gun"}' localhost:4000/v1/movies
HTTP/1.1 200 OK
Date: Tue, 06 Apr 2021 18:53:57 GMT Content-Length: 41
Content-Type: text/plain; charset=utf-8

{Title:Moana Year:0 Runtime:0 Genres:[]}

# Bodyåœ¨ç¬¬ä¸€ä¸ªJSONå€¼ä¹‹ååŒ…å«åƒåœ¾å†…å®¹
$ curl -i -d '{"title": "Moana"} :~()' localhost:4000/v1/movies
HTTP/1.1 200 OK
Date: Tue, 06 Apr 2021 18:54:15 GMT Content-Length: 41
Content-Type: text/plain; charset=utf-8

{Title:Moana Year:0 Runtime:0 Genres:[]}
```

åŒæ ·ï¼Œè¿™ç§è¡Œä¸ºå¯èƒ½éå¸¸æœ‰ç”¨ï¼Œä½†åœ¨è§£æapiè¯·æ±‚æ—¶å®ƒå¹¶ä¸é€‚åˆã€‚æˆ‘ä»¬å¸Œæœ›å¯¹createMovieHandlerå¤„ç†ç¨‹åºçš„è¯·æ±‚åœ¨è¯·æ±‚ä½“ä¸­åªåŒ…å«ä¸€ä¸ªJSONå¯¹è±¡ï¼Œå¹¶åªåŒ…å«å…³äºåˆ›å»ºçš„ç”µå½±çš„ä¿¡æ¯ã€‚

ä¸ºäº†ç¡®ä¿è¯·æ±‚ä½“ä¸­æ²¡æœ‰é¢å¤–çš„JSONå€¼(æˆ–ä»»ä½•å…¶ä»–å†…å®¹)ï¼Œæˆ‘ä»¬éœ€è¦åœ¨readJSON()å‡½æ•°ä¸­ç¬¬äºŒæ¬¡è°ƒç”¨Decode()ï¼Œå¹¶æ£€æŸ¥å®ƒæ˜¯å¦è¿”å›ä¸€ä¸ªio.EOF(æ–‡ä»¶ç»“æŸ)é”™è¯¯ã€‚

æœ€åï¼Œç›®å‰å¯¹æˆ‘ä»¬æ¥å—çš„è¯·æ±‚ä½“çš„æœ€å¤§å¤§å°æ²¡æœ‰ä¸Šé™ã€‚è¿™æ„å‘³ç€å¯¹äºä»»ä½•ä¼å›¾å¯¹æˆ‘ä»¬çš„APIæ‰§è¡ŒDosæ”»å‡»çš„æ¶æ„å®¢æˆ·ç«¯æ¥è¯´ï¼Œæˆ‘ä»¬çš„createMovieHandlerå°†æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç›®æ ‡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨http.MaxBytesReader()å‡½æ•°æ¥é™åˆ¶è¯·æ±‚ä½“çš„æœ€å¤§å¤§å°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

è®©æˆ‘ä»¬æ›´æ–°readJSON()å‡½æ•°æ¥ä¿®å¤ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜:

File: cmd/api/helper.go

---

```go

package main

...

func (app *application) readJSON(w http.ResponseWriter, r *http.Request, dst interface{}) error {
	maxBytes := 1_048_576
        //ä½¿ç”¨http.MaxBytesReaderå‡½æ•°é™åˆ¶åªè¯»å–1MBä»¥å†…çš„è¯·æ±‚å†…å®¹
	r.Body = http.MaxBytesReader(w, r.Body, int64(maxBytes))
	dec := json.NewDecoder(r.Body)
        //å¯ç”¨DisallowUnknownFields()å‡½æ•°ï¼Œè¿™æ„å‘³ç€åœ¨è§£æJSONçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰ä¸å¯åŒ¹é…çš„å­—æ®µå°±è¿”å›é”™è¯¯ã€‚
	dec.DisallowUnknownFields()

	err := dec.Decode(dst)
	if err != nil {
		var syntaxError *json.SyntaxError
		var unmarshalTypeError *json.UnmarshalTypeError
		var invalidUnmarshalError *json.InvalidUnmarshalError
		switch {
		case errors.As(err, &syntaxError):
			return fmt.Errorf("body contains badly-formed JSON (at character %d)", syntaxError.Offset)
		case errors.Is(err, io.ErrUnexpectedEOF):
			return errors.New("body contains badly-formed JSON")
		case errors.As(err, &unmarshalTypeError):
			if unmarshalTypeError.Field != "" {
				return fmt.Errorf("body contains incorrect JSON type for field %q", unmarshalTypeError.Field)
			}
			return fmt.Errorf("body contain incorrect JSON type (at character %d)", unmarshalTypeError.Offset)
		case errors.Is(err, io.EOF):
			return errors.New("body must not be empty")
                //å¦‚æœJSONä¸­åŒ…å«ä¸èƒ½è§£æçš„å­—æ®µï¼Œå°†è¿”å›â€œjson: unknown fieldâ€é”™è¯¯ï¼Œè¿™é‡Œä»é”™è¯¯å†…å®¹ä¸­æå–å‡ºå­—æ®µåç§°
                //è¿”å›ç»™å®¢æˆ·ç«¯
                case strings.HasPrefix(err.Error(), "json: unknown field "):
			fieldName := strings.TrimPrefix(err.Error(), "json: unknown field ")
			return fmt.Errorf("body contain unknown key %s", fieldName)
                //å¦‚æœè¯·æ±‚å†…å®¹è¶…è¿‡1MBå°†è¿”å›"http: request body too large"é”™è¯¯ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯
		case err.Error() == "http: request body too large":
			return fmt.Errorf("body must not be large than %d bytes", maxBytes)

		case errors.As(err, &invalidUnmarshalError):
			panic(err)
		default:
			return err
		}
	}
	err = dec.Decode(&struct{}{})
	if err != io.EOF {
		return errors.New("body must only contain a single JSON value")
	}
	return nil
}

```

ä¿®æ”¹å®Œä¹‹åï¼Œæˆ‘ä»¬å†æ¬¡å°è¯•æœ¬ç« å‰é¢çš„è¯·æ±‚:

```shell
$ curl -d '{"title": "Moana", "rating":"PG"}' localhost:4000/v1/movies
{
    "error": "body contains unknown key \"rating\""
}

$ curl -d '{"title": "Moana"}{"title": "Top Gun"}' localhost:4000/v1/movies
{
    "error": "body must only contain a single JSON value"
}

$ curl -d '{"title": "Moana"} :~()' localhost:4000/v1/movies
{
    "error": "body must only contain a single JSON value"
}
```

æ ¹æ®ä¸Šé¢çš„ç»“æœå‘ç°è¯·æ±‚å¤„ç†è¢«ç»ˆæ­¢ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°ä¸€ä¸ªæ˜ç¡®çš„é”™è¯¯æ¶ˆæ¯ï¼Œè§£é‡Šäº†é”™è¯¯åŸå› ã€‚

ä¸‹é¢å¯ä»¥å‘é€ä¸€ä¸ªåŒ…å«å¤§æ•°æ®é‡çš„è¯·æ±‚ï¼Œçœ‹çœ‹å“åº”ç»“æœã€‚

ä¸ºäº†æ¼”ç¤ºï¼Œä½œè€…åˆ›å»ºäº†ä¸€ä¸ª1.5MBçš„JSONæ–‡ä»¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†å…¶ä¸‹è½½åˆ°/tmpç›®å½•:

```shell
$ wget -O /tmp/largefile.json https://www.alexedwards.net/static/largefile.json
```

å¦‚æœä½ å°†è¿™ä¸ªæ–‡ä»¶å†…å®¹ä½œä¸ºè¯·æ±‚ä½“å‘é€åˆ°POST /v1/moviesæ¥å£ï¼Œhttp.MaxByteReader()ä¼šæ£€æŸ¥å¹¶æŠ¥é”™ï¼Œä½ å°†æ”¶åˆ°å¦‚ä¸‹å“åº”ä¿¡æ¯ï¼š

```shell
$ curl -d @/tmp/largefile.json localhost:4000/v1/movies
{
    "error": "body must not be larger than 1048576 bytes"
}
```

å®Œæˆä»¥ä¸Šä¿®æ”¹ï¼Œæˆ‘ä»¬æ€»ç®—å®Œæˆäº†readJSON()å‡½æ•°çš„ä¸šåŠ¡å¤„ç†ã€‚

æˆ‘å¿…é¡»æ‰¿è®¤readJSON()é‡Œé¢çš„ä»£ç å¹¶ä¸æ˜¯æœ€æ¼‚äº®çš„â€¦æˆ‘ä»¬å¼•å…¥äº†è®¸å¤šé”™è¯¯å¤„ç†å’Œé€»è¾‘ï¼Œç”¨äºå¯¹Decode()å‡½æ•°è¿”å›é”™è¯¯çš„å¤„ç†ã€‚ä½†ç°åœ¨å·²ç»å†™å¥½äº†ã€‚æ‚¨ä¸éœ€è¦å†å®ƒï¼Œè€Œä¸”æ‚¨å¯ä»¥è½»æ¾åœ°å°†å®ƒå¤åˆ¶å’Œç²˜è´´åˆ°å…¶ä»–é¡¹ç›®ä¸­ã€‚
## è‡ªå®šä¹‰JSONè§£ç 

åœ¨æœ¬ä¹¦çš„å‰é¢ï¼Œæˆ‘ä»¬åœ¨APIä¸­æ·»åŠ äº†ä¸€äº›è‡ªå®šä¹‰çš„JSONç¼–ç å¤„ç†ï¼Œä»¥ä¾¿åœ¨JSONå“åº”ä¸­ä»¥â€œ(runtime) minsâ€çš„æ ¼å¼æ˜¾ç¤ºç”µå½±æ—¶é•¿ä¿¡æ¯ã€‚

åœ¨æœ¬ç« ï¼Œæˆ‘ä»¬å°†ä»å¦ä¸€æ–¹é¢å‡ºå‘å¦‚ä½•å°†â€œ(runtime) minsâ€å­—æ®µè§£æåˆ°int32ç±»å‹çš„Goç»“æ„ä½“å­—æ®µä¸­ï¼Œä¹Ÿç§°ä¸ºååºåˆ—åŒ–è¿‡å¤„ç†ã€‚

å¦‚æœä½ ç°åœ¨å°è¯•ç”¨"(runtime) mins"è¿™ç§æ ¼å¼å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œä¼šå¾—åˆ°ä¸€ä¸ª400 Bad requestå“åº”(å› ä¸ºä¸å¯èƒ½å°†JSONå­—ç¬¦ä¸²è§£ç ä¸ºint32ç±»å‹)ã€‚åƒè¿™æ ·:

```shell
$ curl -d '{"title": "Moana", "runtime": "107 mins"}' localhost:4000/v1/movies
{
    "error": "body contains incorrect JSON type for \"runtime\""
}
```

ä¸ºäº†ä½¿å…¶æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦æ‹¦æˆªJSONè§£ç è¿‡ç¨‹ï¼Œå¹¶æ‰‹åŠ¨å°†â€œ<runtime> minsâ€JSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºint32ã€‚

å› æ­¤æˆ‘ä»¬è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ

## json.Unmarshaleræ¥å£

è¿™é‡Œçš„å…³é”®æ˜¯äº†è§£Goçš„json.Unmarshaleræ¥å£ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·:

```go
type Unmarshaler interface { 
    UnmarshalJSON([]byte) error
}
```

å½“Goè§£ç JSONæ—¶ï¼Œä¼šæ£€æŸ¥ç›®æ ‡å­—æ®µçš„ç±»å‹æ˜¯å¦å®ç°äº†json.Unmarshaleræ¥å£ã€‚å¦‚æœå®ç°äº†è¯¥æ¥å£ï¼ŒGoå°†è°ƒç”¨UnmarshalJSON()å‡½æ•°æ¥å†³å®šå¦‚ä½•å°†JSONè§£ç åˆ°ç›®æ ‡ç±»å‹ã€‚è¿™åˆšå¥½ä¸json.Marshaleræ¥å£ç›¸åï¼Œæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨å®ƒæ¥å®šåˆ¶JSONç¼–ç è¡Œä¸ºã€‚

æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å®ç°è¿™ä¸ªæ¥å£ã€‚

æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯æ›´æ–°createMovieHandlerï¼Œä»¥ä¾¿è¾“å…¥ç»“æ„ä½“ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„Runtimeç±»å‹ï¼Œè€Œä¸æ˜¯å¸¸è§„çš„int32ã€‚ä½ åº”è¯¥è®°å¾—ï¼Œæˆ‘ä»¬çš„runtimeç±»å‹ä»ç„¶æœ‰åŸºç¡€ç±»å‹int32ï¼Œä½†é€šè¿‡è‡ªå®šä¹‰ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªç”±åœ°è®©å®ƒä¸Šå®ç°UnmarshalJSON()æ–¹æ³•ã€‚

ä¸‹é¢æ›´æ–°æ¥å£å¤„ç†ç¨‹åºå¦‚ä¸‹ï¼š

Fileï¼šcmd/api/movies.go

---

```go
package main

...

func (app *application) createMovieHandler(w http.ResponseWriter, r *http.Request) {
	var input struct {
		Title   string       `json:"title"`
		Year    int32        `json:"year"`
		Runtime data.Runtime `json:"runtime"`
		Genres  []string     `json:"genres"`
	}
	err := app.readJSON(w, r, &input)
	if err != nil {
		app.badRequestResponse(w, r, err)
		return
	}

	fmt.Fprintf(w, "%+v\n", input)
}

```

ç„¶åæˆ‘ä»¬è½¬åˆ°internal/data/runtime.goæ–‡ä»¶ï¼Œä¸ºRuntimeç±»å‹æ·»åŠ UnmarshalJSONæ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢éœ€è¦è§£æâ€œ(runtime) minsâ€æ ¼å¼çš„JSONå­—ç¬¦ä¸²ï¼Œç„¶åå°†runtimeæ•°å€¼è§£æä¸ºint32ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™Runtimeæœ¬èº«ã€‚

è¿™å®é™…ä¸Šæœ‰ç‚¹å¤æ‚ï¼Œæœ‰ä¸€äº›é‡è¦çš„ç»†èŠ‚ï¼Œæœ€å¥½ç›´æ¥è¿›å…¥ä»£ç ï¼Œå¹¶åœ¨åé¢ç”¨æ³¨é‡Šè¿›è¡Œè§£é‡Šã€‚

Fileï¼šinternal/data/runtime.go

---

```go
package data

import (
	"errors"
	"fmt"
	"strconv"
	"strings"
)

//å¦‚æœUnmarshalJSONå‡½æ•°ä¸èƒ½å°†JSONå­—ç¬¦ä¸²è§£æä¸ºRuntimeç±»å‹ï¼Œå°±è¿”å›è¯¥é”™è¯¯
var ErrInvalidRuntimeFormat = errors.New("invalid runtime format")

type Runtime int32

//Runtimeç±»å‹å®ç°UnmarshalJSON()æ–¹æ³•ï¼Œè¿™æ ·å°±å®ç°æ¥json.Unmarshaleræ¥å£ã€‚æ³¨æ„ï¼Œå› ä¸ºUnmarshalJSON()ä¼šæ”¹å˜çŠ¶æ€
//å› æ­¤éœ€è¦ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…ã€‚å¦åˆ™å°±è¦è¿”å›ä¸€ä¸ªå®ä¾‹çš„æ‹·è´ã€‚
func (r *Runtime) UnmarshalJSON(jsonValue []byte) error {
        //å¸Œæœ›æ¥æ”¶åˆ°çš„å€¼æ˜¯ä¸€ä¸ªJSONå­—ç¬¦ä¸²"ï¼ˆruntimeï¼‰ mins"ï¼Œç¬¬ä¸€æ­¥éœ€è¦å»æ‰åŒå¼•å·ã€‚
	unquotedJSONValue, err := strconv.Unquote(string(jsonValue))
	if err != nil {
		return ErrInvalidRuntimeFormat
	}
        //åˆ†å‰²å­—ç¬¦ä¸²ä»¥åˆ†ç¦»åŒ…å«æ•°å­—çš„éƒ¨åˆ†
	parts := strings.Split(unquotedJSONValue, " ")
	if len(parts) != 2 || parts[1] != "mins" {
		return ErrInvalidRuntimeFormat
	}
        //å°†æ•°å­—å­—ç¬¦ä¸²è½¬ä¸ºint32ç±»å‹
	i, err := strconv.ParseInt(parts[0], 10, 32)
	if err != nil {
		return ErrInvalidRuntimeFormat
	}
        //å°†int32å¼ºåˆ¶è½¬ä¸ºRuntimeç±»å‹ï¼Œå¹¶èµ‹å€¼ç»™æ¥æ”¶è€…ï¼Œæ³¨æ„æ˜¯æŒ‡é’ˆç±»å‹çš„æ¥æ”¶è€…ã€‚
	*r = Runtime(i)
	return nil
}
```

å®Œæˆä»¥ä¸Šä»£ç åé‡å¯æœåŠ¡ï¼Œç„¶åä½¿ç”¨"(runtime) min"æ ¼å¼çš„å€¼ä½œä¸ºJSONå­—æ®µã€‚å¯ä»¥çœ‹åˆ°è¯·æ±‚ä¼šè¢«æ­£å¸¸å¤„ç†ã€‚æ•°å€¼ä¼šä»å­—ç¬¦ä¸²ä¸­æå–å‡ºæ¥èµ‹å€¼ç»™inputç»“æ„ä½“ä¸­çš„Runtimeç±»å‹å­—æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
 $ curl -d '{"title": "Moana", "runtime": "107 mins"}' localhost:4000/v1/movies
{Title:Moana Year:0 Runtime:107 Genres:[]}
```

ç„¶è€Œï¼Œå¦‚æœä½ ä½¿ç”¨JSONæ•°å­—æˆ–ä»»ä½•å…¶ä»–æ ¼å¼å‘è¯·æ±‚ï¼Œä½ åº”è¯¥ä¼šå¾—åˆ°ä¸€ä¸ªErrInvalidRuntimeFormaté”™è¯¯æ¶ˆæ¯çš„å“åº”ï¼Œç±»ä¼¼å¦‚ä¸‹:

```shell
$ curl -d '{"title": "Moana", "runtime": 107}' localhost:4000/v1/movies
{
    "error": "invalid runtime format"
}

$ curl -d '{"title": "Moana", "runtime": "107 minutes"}' localhost:4000/v1/movies
{
    "error": "invalid runtime format"
}
```
## æ ¡éªŒJSONè¾“å…¥

åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦å¯¹æ¥è‡ªå®¢æˆ·ç«¯çš„æ•°æ®æ‰§è¡Œé¢å¤–çš„éªŒè¯æ£€æŸ¥ï¼Œä»¥ç¡®ä¿å®ƒåœ¨å¤„ç†ä¹‹å‰æ»¡è¶³ç‰¹å®šçš„ä¸šåŠ¡è§„åˆ™ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡æ›´æ–°createMovieHandleræ¥æ¼”ç¤ºå¦‚ä½•åœ¨JSON APIçš„ä¸Šä¸‹æ–‡ä¸­åšåˆ°è¿™ä¸€ç‚¹:

* å®¢æˆ·ç«¯æä¾›çš„movieæ ‡é¢˜ä¸ä¸ºç©ºï¼Œé•¿åº¦ä¸è¶…è¿‡500å­—èŠ‚ã€‚
* movieçš„yearå­—æ®µä¸èƒ½æ˜¯ç©ºçš„ï¼Œè€Œä¸”æ˜¯åœ¨1888å¹´åˆ°ä»Šå¹´ä¹‹é—´ã€‚
* runtimeå­—æ®µä¸èƒ½ç©ºï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªæ­£æ•°ã€‚
* genreså­—æ®µåŒ…å«1-5ä¸ªä¸åŒçš„ç”µå½±ç±»å‹ã€‚

å¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªæ£€æŸ¥å¤±è´¥ï¼Œæˆ‘ä»¬å¸Œæœ›å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª422 Unprocessable Entityå“åº”ï¼Œä»¥åŠæ¸…æ¥šåœ°æè¿°éªŒè¯å¤±è´¥çš„é”™è¯¯æ¶ˆæ¯ã€‚

## åˆ›å»ºvalidatoråŒ…

ä¸ºäº†åœ¨æ•´ä¸ªé¡¹ç›®ä¸­å¸®åŠ©æˆ‘ä»¬è¿›è¡ŒéªŒè¯ï¼Œå°†åˆ›å»ºä¸€ä¸ªinternal/validatoråŒ…ï¼Œå…¶ä¸­åŒ…å«ä¸€äº›ç®€å•çš„å¯é‡ç”¨çš„å¸®åŠ©ç±»å‹å’Œå‡½æ•°ã€‚å¦‚æœæ‚¨æ­£åœ¨è·Ÿéšæœ¬çš„æ“ä½œï¼Œè¯·åœ¨æ‚¨çš„æœºå™¨ä¸Šåˆ›å»ºä»¥ä¸‹ç›®å½•å’Œæ–‡ä»¶:

```shell
$ mkdir internal/validator
$ touch internal/validator/validator.go
```

ç„¶ååœ¨æ–‡ä»¶internal/validator/validator.goä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```go
package validator

import "regexp"

var (
        //ç”³æ˜ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ç”¨äºæ£€æŸ¥emailçš„æ ¼å¼ï¼Œå¦‚æœä½ æœ‰å…´è¶£è¯¥æ­£åˆ™è¡¨è¾¾å¼æ¥è‡ªäºâ€œhttps://html.spec.whatwg.org/#valid-e-mail-addressâ€ç½‘ç«™ã€‚
	EmailRx = regexp.MustCompile("^[a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\. [a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$")
)

//å®šä¹‰ä¸€ä¸ªæ–°çš„Validatorç±»å‹ï¼Œå…¶ä¸­åŒ…å«éªŒè¯é”™è¯¯çš„mapã€‚
type Validator struct {
	Errors map[string]string
}

//Newæ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œç”¨äºåˆ›å»ºValidatorå®ä¾‹
func New() *Validator {
	return &Validator{Errors: make(map[string]string)}
}

//valid è¿”å›trueå¦‚æœmapä¸­æ²¡æœ‰é”™è¯¯
func (v *Validator) Valid() bool {
	return len(v.Errors) == 0
}

//AddError å‘mapä¸­æ·»åŠ é”™è¯¯(mapä¸­ä¸å­˜åœ¨å¯¹åº”keyçš„é”™è¯¯)
func (v *Validator) AddError(key, message string) {
	if _, exists := v.Errors[key]; !exists {
		v.Errors[key] = message
	}
}

//Check å‘mapä¸­æ·»åŠ é”™è¯¯æ¶ˆæ¯ï¼Œå¦‚æœæ ¡éªŒå¤±è´¥å³okä¸ºfalse
func (v *Validator) Check(ok bool, key, message string) {
	if !ok {
		v.AddError(key, message)
	}
}

//In å¦‚æœliståˆ‡ç‰‡ä¸­å­˜åœ¨valueå­—ç¬¦ä¸²è¿”å›true
func In(value string, list ...string) bool {
	for i := range list {
		if value == list[i] {
			return true
		}
	}
	return false
}

//Match å¦‚æœå­—ç¬¦ä¸²æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼å°±è¿”å›true
func Matches(value string, rx *regexp.Regexp) bool {
	return rx.MatchString(value)
}

//å¦‚æœåˆ‡ç‰‡ä¸­çš„å­—ç¬¦ä¸²éƒ½ä¸åŒè¿”å›true
func Unique(values []string) bool {
	uniqueValues := make(map[string]bool)
	for _, value := range values {
		uniqueValues[value] = true
	}
	return len(values) == len(uniqueValues)
}

```

æ€»ç»“ï¼š

åœ¨ä¸Šé¢çš„ä»£ç ä¸­å®šä¹‰äº†Validatorç±»å‹ï¼ŒåŒ…å«ä¸€ä¸ªé”™è¯¯ä¿¡æ¯mapå­—æ®µã€‚Validatoræä¾›äº†Check()æ–¹æ³•ï¼Œæ ¹æ®æ ¡éªŒç»“æœå‘mapä¸­æ·»åŠ é”™è¯¯ä¿¡æ¯ï¼Œè€ŒValid()æ–¹æ³•è¿”å›mapæ˜¯å¦åŒ…å«é”™è¯¯ä¿¡æ¯ã€‚è¿˜æ·»åŠ äº†In(), Matches()å’ŒUnique()æ–¹æ³•æ¥å¸®åŠ©æˆ‘ä»¬æ‰§è¡Œç‰¹å®šå­—æ®µçš„æ£€æŸ¥ã€‚

ä»æ¦‚å¿µä¸Šè®²ï¼Œè¿™ä¸ªValidatorç±»å‹æ˜¯éå¸¸åŸºæœ¬çš„ï¼Œä½†è¿™å¹¶ä¸æ˜¯ä¸€ä»¶åäº‹ã€‚æ­£å¦‚æˆ‘ä»¬å°†åœ¨æœ¬ä¹¦ä¸­çœ‹åˆ°çš„ï¼Œå®ƒåœ¨å¼€å‘ä¸­åŠŸèƒ½å¼ºå¤§ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†å¾ˆå¤šçµæ´»æ€§çš„å­—æ®µæ£€æŸ¥ã€‚

## æ‰§è¡Œå­—æ®µæ£€æŸ¥

ä¸‹é¢æˆ‘ä»¬æŠŠvalidatorç±»å‹ä½¿ç”¨èµ·æ¥ã€‚

æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯æ›´æ–°cmd/api/errors.goæ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„failedValidationResponse()å¸®ç»„å‡½æ•°ï¼Œå®ƒå°†å†™å…¥ä¸€ä¸ª422 Unprocessable Entityé”™è¯¯ç ï¼Œå¹¶å°†æ¥è‡ªæ–°Validatorç±»å‹çš„é”™è¯¯å†…å®¹æ˜ å°„ä¸ºJSONå“åº”ä½“ã€‚

File: cmd/api/errors.go

---

```go
package main

...

//æ³¨æ„errorså‚æ•°æ˜¯ä¸€ä¸ªmapç±»å‹ï¼Œå’Œvalidatorç±»å‹åŒ…å«mapä¸€è‡´
func (app *application) failedValidationResponse(w http.ResponseWriter, r *http.Request, errors map[string]string) {
	app.errorResponse(w, r, http.StatusUnprocessableEntity, errors)
}
```

å®Œæˆä¹‹åï¼Œè¿”å›åˆ°createMovieHandlerå¹¶æ›´æ–°å®ƒï¼Œä»¥å¯¹inputç»“æ„ä½“å„ä¸ªå­—æ®µè¿›è¡Œå¿…è¦çš„æ£€æŸ¥ã€‚åƒè¿™æ ·:

Fileï¼šcmd/api/movies.go

---

```go
package main

import (
	"fmt"
	"net/http"
	"time"

	"greenlight.alexedwards.net/internal/data"
	"greenlight.alexedwards.net/internal/validator"
)

func (app *application) createMovieHandler(w http.ResponseWriter, r *http.Request) {
	var input struct {
		Title   string       `json:"title"`
		Year    int32        `json:"year"`
		Runtime data.Runtime `json:"runtime"`
		Genres  []string     `json:"genres"`
	}
	err := app.readJSON(w, r, &input)
	if err != nil {
		app.badRequestResponse(w, r, err)
		return
	}
	movie := &data.Movie{
		Title:   input.Title,
		Year:    input.Year,
		Runtime: input.Runtime,
		Genres:  input.Genres,
	}
        //åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„Validatorå®ä¾‹
	v := validator.New()
  
        //ä½¿ç”¨Check()æ–¹æ³•æ‰§è¡Œå­—æ®µæ ¡éªŒã€‚å¦‚æœæ ¡éªŒå¤±è´¥å°±ä¼šå‘mapä¸­æ·»åŠ é”™è¯¯ä¿¡æ¯ã€‚ä¾‹å¦‚ä¸‹é¢ç¬¬ä¸€è¡Œæ£€æŸ¥titleä¸èƒ½ä¸ºç©ºï¼Œç„¶åå†æ£€æŸ¥é•¿åº¦ä¸èƒ½è¶…è¿‡500å­—èŠ‚ç­‰ç­‰ã€‚
        v.Check(movie.Title != "", "title", "must be provide")
	v.Check(len(movie.Title) <= 500, "title", "must not be more than 500 bytes long")

	v.Check(movie.Year != 0, "year", "must be provided")
	v.Check(movie.Year >= 1888, "year", "must be greater than 1888")
	v.Check(movie.Year <= int32(time.Now().Year()), "year", "must not be in the future")

	v.Check(movie.Runtime != 0, "runtime", "must be provided")
	v.Check(movie.Runtime > 0, "runtime", "must be a positive integer")

	v.Check(movie != nil, "genres", "must be provided")
	v.Check(len(movie.Genres) >= 1, "genres", "must contain at least 1 genres")
	v.Check(len(movie.Genres) <= 5, "genres", "must not contain more than 5 genres")
        //ä½¿ç”¨Unique()æ–¹æ³•ï¼Œæ£€æŸ¥input.Genresæ¯ä¸ªå­—æ®µæ˜¯å¦å”¯ä¸€ã€‚
	v.Check(validator.Unique(movie.Genres), "genres", "must not contain duplicate values")

        //ä½¿ç”¨Valid()æ–¹æ³•ç¡®è®¤æ£€æŸ¥æ˜¯å¦é€šè¿‡ã€‚å¦‚æœæœ‰é”™è¯¯å°±ä½¿ç”¨failedValidationResponse()å¸®åŠ©å‡½æ•°è¿”å›é”™è¯¯ä¿¡æ¯ç»™å®¢æˆ·ç«¯ã€‚
        if !v.Valid() {
		app.failedValidationResponse(w, r, v.Errors)
		return
	}
	fmt.Fprintf(w, "%+v\n", input)
}
```

åšå®Œè¿™ä¸ªä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯•ä¸€ä¸‹äº†ã€‚é‡æ–°å¯åŠ¨æœåŠ¡ï¼Œç„¶åå‘post /v1/movieæ¥å£å‘é€è¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«ä¸€äº›ä¸åˆæ³•çš„å­—æ®µä¿¡æ¯ï¼Œç±»ä¼¼ä¸‹é¢:

```shell
$ BODY='{"title":"","year":1000,"runtime":"-123 mins","genres":["sci-fi","sci-fi"]}' $ curl -i -d "$BODY" localhost:4000/v1/movies
HTTP/1.1 422 Unprocessable Entity
Content-Type: application/json
Date: Wed, 07 Apr 2021 10:33:57 GMT 
Content-Length: 180

{
    "error":
    {
        "genres": "must not contain duplicate values",
        "runtime": "must be a positive integer",
        "title": "must be provided",
        "year": "must be greater than 1888"
    }
}
```

çœ‹èµ·æ¥ä¸é”™ã€‚æˆ‘ä»¬çš„æ£€æŸ¥åŠŸèƒ½ç”Ÿæ•ˆäº†ï¼Œå¹¶é˜»æ­¢è¯·æ±‚è¢«æ‰§è¡Œâ€”ç”šè‡³æ›´å¥½çš„æ˜¯ï¼Œå‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªæ ¼å¼è‰¯å¥½çš„JSONå“åº”ï¼Œå…¶ä¸­åŒ…å«é’ˆå¯¹æ¯ä¸ªæ£€éªŒé”™è¯¯çš„è¯¦ç»†ä¿¡æ¯ã€‚

ä½ ä¹Ÿå¯ä»¥å‘é€æ­£å¸¸çš„è¯·æ±‚ä½“ï¼Œä½ ä¼šå‘ç°è¯·æ±‚è¢«æ­£å¸¸å¤„ç†ï¼Œinputå†…å®¹åœ¨å“åº”ä¸­è¿”å›ç»™å®¢æˆ·ç«¯ï¼š

```shell
$ BODY='{"title":"Moana","year":2016,"runtime":"107 mins","genres":["animation","adventure"]}'
$ curl -i -d "$BODY" localhost:4000/v1/movies
HTTP/1.1 200 OK
Date: Tue, 23 Nov 2021 12:33:45 GMT
Content-Length: 65
Content-Type: text/plain; charset=utf-8

{Title:Moana Year:2016 Runtime:107 Genres:[animation adventure]}

```

## ä½¿æ ¡éªŒè§„åˆ™å¯é‡ç”¨

åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œå¾ˆå¤šä¸ªæ¥å£éœ€è¦é‡å¤è¿™ç§æ ¡éªŒçš„è¿‡ç¨‹ï¼Œå› æ­¤å°†ä¸Šé¢çš„æ ¡éªŒè§„åˆ™æŠ½è±¡æˆæ–¹æ³•ä¾›å…¶ä»–åœ°æ–¹ä½¿ç”¨ã€‚æ¯”å¦‚å®¢æˆ·ç«¯è¦æ›´æ–°movieä¹Ÿä¼šä¼ ä¸€äº›æ–°çš„å­—æ®µå†…å®¹ï¼Œä¹Ÿéœ€è¦æ ¡éªŒã€‚

é¿å…é‡å¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†movieçš„æ ¡éªŒæ•´åˆåˆ°ä¸€ä¸ªå•ç‹¬çš„ValidateMovie()å‡½æ•°ä¸­å»ã€‚ç†è®ºä¸Šï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥æ”¾åœ¨ä»»æ„ä½ç½®ã€‚ä½†å°±ä¸ªäººè€Œè¨€ï¼Œæˆ‘å–œæ¬¢å°†éªŒè¯æ£€æŸ¥æ”¾åœ¨internal/dataåŒ…ä¸­çš„ç›¸å…³é¢†åŸŸç±»å‹é™„è¿‘ã€‚

å¦‚æœæŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤æ“ä½œï¼Œè¯·é‡æ–°æ‰“å¼€å†…éƒ¨/data/movies.goç„¶åæ·»åŠ ä¸€ä¸ªValidateMovie()å‡½æ•°ï¼Œå…¶ä¸­åŒ…å«å¦‚ä¸‹æ£€æŸ¥:

File: internal/data/movies.go

---

```go
package data

import (
	"encoding/json"
	"fmt"
	"greenlight.alexedwards.net/internal/validator"
	"time"
)

type Movie struct {
	ID       int64     `json:"id"`
	CreateAt time.Time `json:"-"`
	Title    string    `json:"title"`
	Year     int32     `json:"year,omitempty"`
	Runtime  Runtime   `json:"runtime,omitempty,string"`
	Genres   []string  `json:"genres,omitempty"`
	Version  int32     `json:"version"`
}

func ValidateMovie(v *validator.Validator, movie *Movie) {
	v.Check(movie.Title != "", "title", "must be provide")
	v.Check(len(movie.Title) <= 500, "title", "must not be more than 500 bytes long")

	v.Check(movie.Year != 0, "year", "must be provided")
	v.Check(movie.Year >= 1888, "year", "must be greater than 1888")
	v.Check(movie.Year <= int32(time.Now().Year()), "year", "must not be in the future")

	v.Check(movie.Runtime != 0, "runtime", "must be provided")
	v.Check(movie.Runtime > 0, "runtime", "must be a positive integer")

	v.Check(movie != nil, "genres", "must be provided")
	v.Check(len(movie.Genres) >= 1, "genres", "must contain at least 1 genres")
	v.Check(len(movie.Genres) <= 5, "genres", "must not contain more than 5 genres")
	v.Check(validator.Unique(movie.Genres), "genres", "must not contain duplicate values")
}
```

> é‡è¦æç¤º:ç°åœ¨æ£€æŸ¥æ˜¯å¯¹ä¸€ä¸ªmovieç»“æ„ä½“å®ä¾‹å„ä¸ªå­—æ®µè¿›è¡Œçš„ï¼Œè€Œä¸æ˜¯å¯¹inputç»“æ„ä½“ã€‚

å®Œæˆä¸Šé¢çš„æ”¹é€ ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦è¿”å›createMovieHandlerå¹¶æ›´æ–°ä»£ç ï¼Œé€šè¿‡åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„Movieç»“æ„ä½“ï¼Œä»inputç»“æ„ä½“å¤åˆ¶æ•°æ®åˆ°movieç»“æ„ä½“ä¸­ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªæ–°çš„éªŒè¯å‡½æ•°ã€‚åƒè¿™æ ·:

Fileï¼šcmd/api/movies.go

---

```go
package main

...

func (app *application) createMovieHandler(w http.ResponseWriter, r *http.Request) {
	var input struct {
		Title   string       `json:"title"`
		Year    int32        `json:"year"`
		Runtime data.Runtime `json:"runtime"`
		Genres  []string     `json:"genres"`
	}
	err := app.readJSON(w, r, &input)
	if err != nil {
		app.badRequestResponse(w, r, err)
		return
	}
	movie := &data.Movie{
		Title:   input.Title,
		Year:    input.Year,
		Runtime: input.Runtime,
		Genres:  input.Genres,
	}

        //åˆå§‹åŒ–Validatorå®ä¾‹
	v := validator.New()

        è°ƒç”¨ValidateMovie()å‡½æ•°ï¼Œå¦‚æœæœ‰é”™è¯¯å°±è¿”å›ç»™å®¢æˆ·ç«¯ã€‚
	if data.ValidateMovie(v, movie); !v.Valid() {
		app.failedValidationResponse(w, r, v.Errors)
		return
	}
	fmt.Fprintf(w, "%+v\n", input)
}
```

å½“æ‚¨æŸ¥çœ‹è¿™äº›ä»£ç æ—¶ï¼Œæ‚¨çš„è„‘æµ·ä¸­å¯èƒ½ä¼šæœ‰å‡ ä¸ªé—®é¢˜ã€‚

é¦–å…ˆï¼Œæ‚¨å¯èƒ½æƒ³çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨å¤„ç†ç¨‹åºä¸­åˆå§‹åŒ–Validatorå®ä¾‹å¹¶å°†å…¶ä¼ é€’ç»™ValidateMovie()å‡½æ•°â€”â€”è€Œä¸æ˜¯åœ¨ValidateMovie()ä¸­åˆå§‹åŒ–å®ƒå¹¶å°†å…¶ä½œä¸ºè¿”å›å€¼ä¼ é€’å›æ¥ã€‚

è¿™æ˜¯å› ä¸ºéšç€åº”ç”¨ç¨‹åºå˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œæˆ‘ä»¬å°†éœ€è¦ä»å¤„ç†ç¨‹åºè°ƒç”¨å¤šä¸ªæ ¡éªŒå¸®åŠ©å‡½æ•°ï¼Œè€Œä¸æ˜¯åƒä¸Šé¢æ‰€ç¤ºçš„ä¸€ä¸ªã€‚å› æ­¤ï¼Œåœ¨å¤„ç†ç¨‹åºä¸­åˆå§‹åŒ–Validatorï¼Œç„¶åä¼ é€’ç»™å¸®åŠ©å‡½æ•°ï¼Œè¿™ç»™äº†æˆ‘ä»¬æ›´å¤šçš„çµæ´»æ€§ã€‚

æ‚¨å¯èƒ½è¿˜æƒ³çŸ¥é“ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å°†JSONè¯·æ±‚è§£ç ä¸ºinputç»“æ„ä½“ç±»å‹ï¼Œç„¶åå¤åˆ¶æ•°æ®ï¼Œè€Œä¸æ˜¯ç›´æ¥è§£ç ä¸ºMovieç»“æ„ä½“å®ä¾‹ã€‚

å› ä¸ºmovieé‡Œé¢æœ‰äº›å­—æ®µä¾‹å¦‚IDå’ŒVersionæ˜¯ä¸éœ€è¦å®¢æˆ·ç«¯æä¾›çš„ï¼Œå¦‚æœä½¿ç”¨movieçš„è¯ï¼Œå®¢æˆ·ç«¯æä¾›IDå’ŒVerisonå­—æ®µä¹Ÿä¼šè¢«è§£ç åˆ°movieç»“æ„ä½“ä¸­ï¼Œè¿™å°±éœ€è¦å¤šä½™çš„æ£€æŸ¥å·¥ä½œã€‚

ä½†æ˜¯å°†å®¢æˆ·ç«¯çš„è¯·æ±‚å†…å®¹è§£æåˆ°ä¸€ä¸ªä¸´æ—¶çš„ç»“æ„ä½“ä¸­ï¼Œä¼šæ›´çµæ´»ï¼Œç®€æ´è€Œä¸”ä»£ç æ›´å¥å£®ã€‚

æœ‰äº†è¿™äº›è§£é‡Šï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿå†æ¬¡å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”ä»å®¢æˆ·ç«¯çš„è§’åº¦æ¥çœ‹ï¼Œæ•ˆæœåº”è¯¥ä¸ä¹‹å‰çš„ä¸€æ ·ã€‚å¦‚æœä½ å‘èµ·ä¸€ä¸ªæ— æ•ˆçš„è¯·æ±‚ï¼Œä½ åº”è¯¥ä¼šå¾—åˆ°ä¸€ä¸ªåŒ…å«ç±»ä¼¼è¿™æ ·çš„é”™è¯¯æ¶ˆæ¯çš„å“åº”:

```shell
$ BODY='{"title":"","year":1000,"runtime":"-123 mins","genres":["sci-fi","sci-fi"]}' 
$ curl -i -d "$BODY" localhost:4000/v1/movies
HTTP/1.1 422 Unprocessable Entity
Content-Type: application/json
Date: Wed, 07 Apr 2021 10:33:57 GMT 
Content-Length: 180

{
    "error":
    {
        "genres": "must not contain duplicate values",
        "runtime": "must be a positive integer",
        "title": "must be provided",
        "year": "must be greater than 1888"
    }
}
```

æ‚¨å¯ä»¥éšæ„æµ‹è¯•ï¼Œå¹¶å°è¯•åœ¨JSONä¸­å‘é€ä¸åŒçš„å€¼ï¼Œç›´åˆ°æ‰€æœ‰çš„æ ¡éªŒéƒ½æŒ‰é¢„æœŸå·¥ä½œä¸ºæ­¢ã€‚
## è§£æJSONè¯·æ±‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨ç ”ç©¶å¦‚ä½•ä»æˆ‘ä»¬çš„APIä¸­åˆ›å»ºå’Œå‘é€JSONå“åº”ï¼Œä½†åœ¨æœ¬ä¹¦çš„ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»å¦ä¸€æ–¹é¢æ¢ç´¢ï¼Œå¹¶è®¨è®ºå¦‚ä½•è¯»å–å’Œè§£ææ¥è‡ªå®¢æˆ·ç«¯çš„JSONè¯·æ±‚ã€‚

ä¸ºäº†å¸®åŠ©è¯´æ˜è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ä»POST /v1/moviesæ¥å£å’Œä¹‹å‰è®¾ç½®çš„createMovieHandlerä¸Šå¼€å§‹å·¥ä½œã€‚


| Method | URL             | Handler            | åŠ¨ä½œ               |
| -------- | ----------------- | -------------------- | -------------------- |
| GET    | /v1/healthcheck | healthcheckHanlder | æŸ¥è¯¢åº”ç”¨ç¨‹ç¨‹åºä¿¡æ¯ |
| POST   | /v1/movies      | createMovieHandler | åˆ›å»ºæ–°çš„ç”µå½±       |
| GET    | /v1/movies/:id  | showMovieHandler   | æŸ¥è¯¢ç‰¹å®šç”µå½±è¯¦æƒ…   |

å½“å®¢æˆ·ç«¯è°ƒç”¨è¿™ä¸ªæ¥å£æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒä»¬æä¾›ä¸€ä¸ªJSONè¯·æ±‚ä½“ï¼Œå…¶ä¸­åŒ…å«æƒ³è¦åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­åˆ›å»ºçš„ç”µå½±çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå®¢æˆ·ç«¯æƒ³è¦ä¸ºç”µå½±Moanaæ·»åŠ ä¸€æ¡è®°å½•åˆ°æˆ‘ä»¬çš„APIä¸­ï¼Œä¼šå‘é€ä¸€ä¸ªç±»ä¼¼äºè¿™æ ·çš„è¯·æ±‚ä½“:

```json
{
    "title": "Moana",
    "year": 2016,
    "runtime": 107,
    "genres":
    [
        "animation",
        "adventure"
    ]
}
```

ç°åœ¨ï¼Œæˆ‘ä»¬åªå…³æ³¨å¤„ç†è¿™ä¸ªJSONè¯·æ±‚ä½“çš„è¯»å–ã€è§£æå’ŒéªŒè¯ã€‚ä½ å°†å­¦ä¹ :

* å¦‚ä½•ä½¿ç”¨encoding/jsonåŒ…è¯»å–è¯·æ±‚ä½“å¹¶å°†å…¶ååºåˆ—åŒ–ä¸ºæœ¬åœ°Goå¯¹è±¡ã€‚
* å¦‚ä½•å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„é”™è¯¯è¯·æ±‚å’Œæ— æ•ˆçš„JSONï¼Œå¹¶è¿”å›æ¸…æ™°çš„ã€å¯æ“ä½œçš„é”™è¯¯æ¶ˆæ¯ã€‚
* å¦‚ä½•åˆ›å»ºå¯é‡ç”¨çš„å¸®åŠ©ç¨‹åºæ¥éªŒè¯æ•°æ®ï¼Œä»¥ç¡®ä¿æ•°æ®ç¬¦åˆä¸šåŠ¡è§„åˆ™ã€‚
* æ§åˆ¶å’Œå®šåˆ¶JSONè§£ç æ–¹å¼çš„ä¸åŒæŠ€æœ¯ã€‚
## é…ç½®PostgreSQLæ•°æ®åº“

#### å®‰è£…PostgreSQL

å¦‚æœæ‚¨è·Ÿéšæœ¬ä¹¦æ­¥éª¤æ“ä½œï¼Œé‚£ä¹ˆæ­¤æ—¶æ‚¨éœ€è¦åœ¨è®¡ç®—æœºä¸Šå®‰è£…PostgreSQLã€‚å®˜æ–¹çš„PostgreSQLæ–‡æ¡£åŒ…å«äº†æ‰€æœ‰ç±»å‹æ“ä½œç³»ç»Ÿçš„ä¸‹è½½å’Œå®‰è£…è¯´æ˜ï¼Œä½†å¦‚æœä½ ä½¿ç”¨çš„æ˜¯macOSï¼Œä½ åº”è¯¥èƒ½å¤Ÿä½¿ç”¨brewå®‰è£…:

```shell
$ brew install postgresql
```

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯Linuxå‘è¡Œç‰ˆï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿé€šè¿‡åŒ…ç®¡ç†å™¨æ¥å®‰è£…å®ƒã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„æ“ä½œç³»ç»Ÿæ”¯æŒaptåŒ…ç®¡ç†å™¨(åƒDebianå’ŒUbuntuä¸€æ ·)ï¼Œä½ å¯ä»¥è¿™æ ·å®‰è£…:

```shell
$ sudo apt install postgresql
```

åœ¨Windowsæœºå™¨ä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨ChocolateyåŒ…ç®¡ç†å™¨å®‰è£…PostgreSQL:

```shell
> choco install postgresql
```

#### å‘½ä»¤è¡Œè¿æ¥PostgreSQL

å½“PostgreSQLè¢«å®‰è£…çš„æ—¶å€™ï¼Œä½ çš„è®¡ç®—æœºä¸Šåº”è¯¥å·²ç»åˆ›å»ºäº†ä¸€ä¸ªpsqläºŒè¿›åˆ¶æ–‡ä»¶ã€‚å®ƒåŒ…å«ä¸€ä¸ªåŸºäºç»ˆç«¯çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºä½¿ç”¨PostgreSQLã€‚

ä½ å¯ä»¥é€šè¿‡åœ¨ä½ çš„ç»ˆç«¯ä¸Šè¿è¡Œpsql --versionå‘½ä»¤æ¥æ£€æŸ¥å®ƒæ˜¯å¦å¯ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```shell
$ psql --version
psql (PostgreSQL) 13.4
```

å¦‚æœæ‚¨è¿˜ä¸ç†Ÿæ‚‰PostgreSQLï¼Œé‚£ä¹ˆç¬¬ä¸€æ¬¡ä½¿ç”¨psqlè¿æ¥åˆ°å®ƒçš„è¿‡ç¨‹å¯èƒ½æœ‰ç‚¹ä¸ç›´è§‚ã€‚è®©æˆ‘ä»¬èŠ±ç‚¹æ—¶é—´æ¥è§£é‡Šä¸€ä¸‹ã€‚

å½“PostgreSQLåˆšå®‰è£…æ—¶ï¼Œå®ƒåªæœ‰ä¸€ä¸ªç”¨æˆ·ç”¨æˆ·ï¼šä¸€ä¸ªå«åšpostgresçš„è¶…çº§ç”¨æˆ·ã€‚åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä»¥è¯¥è¶…çº§ç”¨æˆ·èº«ä»½è¿æ¥åˆ°PostgreSQLæ¥åšä»»ä½•æ“ä½œ-æ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»»ä½•éœ€è¦çš„è®¾ç½®ï¼Œå¦‚åˆ›å»ºæ•°æ®åº“å’Œåˆ›å»ºå…¶ä»–ç”¨æˆ·ã€‚

åœ¨å®‰è£…æœŸé—´ï¼Œå·²ç»åœ¨æ‚¨çš„æœºå™¨ä¸Šåˆ›å»ºä¸€ä¸ªåä¸ºpostgresçš„æ“ä½œç³»ç»Ÿç”¨æˆ·ã€‚åœ¨åŸºäºunixçš„ç³»ç»Ÿä¸Šï¼Œä½ å¯ä»¥æ£€æŸ¥/etc/passwdæ–‡ä»¶æ¥ç¡®è®¤è¿™ä¸€ç‚¹ï¼Œåƒè¿™æ ·:

```shell
$ cat /etc/passwd|grep 'postgres'
_postgres:*:216:216:PostgreSQL Server:/var/empty:/usr/bin/false
```

è¿™å¾ˆé‡è¦ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼ŒPostgreSQLä½¿ç”¨å¯¹ç­‰è®¤è¯(peer authentication)çš„èº«ä»½éªŒè¯æ–¹æ¡ˆï¼Œå¯¹æ¥è‡ªæœ¬åœ°æœºå™¨çš„ä»»ä½•è¿æ¥è¿›è¡ŒéªŒè¯ã€‚å¯¹ç­‰è®¤è¯æ˜¯æŒ‡å¦‚æœå½“å‰æ“ä½œç³»ç»Ÿç”¨æˆ·çš„ç”¨æˆ·åä¸ä¸€ä¸ªæœ‰æ•ˆçš„PostgreSQLç”¨æˆ·ååŒ¹é…ï¼Œå¯ä»¥ä½œä¸ºè¯¥ç”¨æˆ·ç™»å½•PostgreSQLï¼Œè€Œæ— éœ€è¿›ä¸€æ­¥è®¤è¯ã€‚ä¸æ¶‰åŠå¯†ç ã€‚

å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬åˆ‡æ¢åˆ°åä¸ºpostgresçš„æ“ä½œç³»ç»Ÿç”¨æˆ·ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿä½¿ç”¨psqlè¿æ¥åˆ°PostgreSQLï¼Œè€Œä¸éœ€è¦ä»»ä½•è¿›ä¸€æ­¥çš„èº«ä»½éªŒè¯ã€‚äº‹å®ä¸Šï¼Œä½ å¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤ä¸€æ­¥å®Œæˆè¿™ä¸¤ä»¶äº‹:

```shell
$ sudo -u postgres psql
psql (13.4)
Type "help" for help.

postgres=# 
```

å› æ­¤ï¼Œä¸ºäº†ç¡®è®¤ä¸€ä¸‹ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨sudoå‘½ä»¤(superuser do)ä»¥æ“ä½œç³»ç»Ÿç”¨æˆ·postgresçš„èº«ä»½è¿è¡Œpsqlå‘½ä»¤ã€‚è¿™å°†åœ¨åœ¨ç»ˆç«¯æ‰“å¼€ä¸€ä¸ªä¼šè¯ï¼Œä»¥PostgreSQLè¶…çº§ç”¨æˆ·(ç§°ä¸ºpostgres)è¿›è¡Œèº«ä»½éªŒè¯ã€‚

ä½ å¯ä»¥é€šè¿‡è¿è¡Œâ€œSELECT current_userâ€æ¥ç¡®è®¤ä½ å½“å‰æ˜¯å“ªä¸ªPostgreSQLç”¨æˆ·:

```shell
postgres=# SELECT current_user;
current_user 
--------------
postgres 
(1 row)
```

#### åˆ›å»ºæ•°æ®åº“ï¼Œç”¨æˆ·å’Œæ‰©å±•

å½“æˆ‘ä»¬ä»¥postgresè¶…çº§ç”¨æˆ·çš„èº«ä»½è¿æ¥æ—¶ï¼Œå¯ä»¥ä¸ºæˆ‘ä»¬çš„é¡¹ç›®åˆ›å»ºä¸€ä¸ªåä¸ºgreenlightçš„æ–°æ•°æ®åº“ï¼Œç„¶åä½¿ç”¨\cå‘½ä»¤è¿æ¥åˆ°æ•°æ®åº“ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```shell
postgres=# create database greenlight;
CREATE DATABASE
postgres=# \c greenlight
You are now connected to database "greenlight" as user "postgres".
```

> åœ¨PostgreSQLä¸­ï¼Œ\å­—ç¬¦è¡¨ç¤ºå…ƒå‘½ä»¤ã€‚å…¶ä»–ä¸€äº›æœ‰ç”¨çš„å…ƒå‘½ä»¤æœ‰\lç”¨äºåˆ—å‡ºæ‰€æœ‰æ•°æ®åº“ï¼Œ\dtç”¨äºåˆ—å‡ºè¡¨ï¼Œä»¥åŠ\duç”¨äºåˆ—å‡ºç”¨æˆ·ã€‚ä½ è¿˜å¯ä»¥è¿è¡Œ\?æŸ¥çœ‹å¯ç”¨å…ƒå‘½ä»¤çš„å®Œæ•´åˆ—è¡¨ã€‚

ç°åœ¨æˆ‘ä»¬çš„greenlightæ•°æ®åº“å·²ç»å­˜åœ¨å¹¶è¿æ¥åˆ°å®ƒï¼Œæœ‰ä¸¤ä¸ªä»»åŠ¡éœ€è¦å®Œæˆã€‚

ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯åˆ›å»ºä¸€ä¸ªæ²¡æœ‰è¶…çº§ç”¨æˆ·æƒé™çš„æ–°ç”¨æˆ·greenlightï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥ç”¨æˆ·æ‰§è¡ŒSQLè¿ç§»å¹¶ä»Goåº”ç”¨ç¨‹åºè¿æ¥åˆ°æ•°æ®åº“ã€‚æˆ‘ä»¬å¸Œæœ›å°†è¿™ä¸ªæ–°ç”¨æˆ·è®¾ç½®ä¸ºä½¿ç”¨åŸºäºå¯†ç çš„èº«ä»½éªŒè¯ï¼Œè€Œä¸æ˜¯å¯¹ç­‰èº«ä»½éªŒè¯ã€‚

PostgreSQLä¹Ÿæœ‰æ‰©å±•çš„æ¦‚å¿µï¼Œå®ƒåœ¨æ ‡å‡†åŠŸèƒ½çš„åŸºç¡€ä¸Šå¢åŠ é¢å¤–çš„åŠŸèƒ½ã€‚PostgreSQLé™„å¸¦çš„æ‰©å±•åˆ—è¡¨å¯ä»¥åœ¨[è¿™é‡Œ](https://www.postgresql.org/docs/current/contrib.html)æ‰¾åˆ°ï¼Œè¿˜æœ‰ä¸€äº›[å…¶ä»–æ‰©å±•](https://www.postgresql.org/download/products/6-postgresql-extensions/)ä½ å¯ä»¥å•ç‹¬ä¸‹è½½ã€‚

åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨[citext](https://www.postgresql.org/docs/9.5/citext.html)æ‰©å±•ã€‚è¯¥æ‰©å±•ç»™PostgreSQLæ·»åŠ äº†åŒºåˆ†å¤§å°å†™çš„å­—ç¬¦ä¸²ç±»å‹ï¼Œæˆ‘ä»¬å°†åœ¨æœ¬ä¹¦åé¢ä½¿ç”¨å®ƒæ¥å­˜å‚¨ç”¨æˆ·ç”µå­é‚®ä»¶åœ°å€ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰©å±•åªèƒ½ç”±è¶…çº§ç”¨æˆ·æ·»åŠ åˆ°ç‰¹å®šçš„æ•°æ®åº“ä¸­ã€‚

ç»§ç»­ï¼Œå¹¶è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„greenlightç”¨æˆ·ä¸ç‰¹å®šçš„å¯†ç ï¼Œå¹¶æ·»åŠ citextæ‰©å±•åˆ°æˆ‘ä»¬çš„æ•°æ®åº“:

```shell
greenlight=# CREATE ROLE greenlight WITH LOGIN PASSWORD 'pa55word';
CREATE ROLE
greenlight=# CREATE EXTENSION IF NOT EXISTS citext;
CREATE EXTENSION
```

> é‡è¦æç¤º:å¦‚æœæ‚¨æŒ‰ç…§æ­¤æ–¹æ³•è¿›è¡Œæ“ä½œï¼Œè¯·åŠ¡å¿…è®°ä½æ‚¨ä¸ºgreenlightç”¨æˆ·è®¾ç½®çš„å¯†ç ã€‚åœ¨æ¥ä¸‹æ¥çš„æ­¥éª¤ä¸­æ‚¨å°†éœ€è¦å®ƒã€‚

ä¸€æ—¦æˆåŠŸå®Œæˆä»¥ä¸Šï¼Œæ‚¨å¯ä»¥é”®å…¥exitæˆ–\qæ¥å…³é—­ç»ˆç«¯ä¸æ•°æ®åº“è¿æ¥ï¼Œå¹¶æ¢å¤ä¸ºæ‚¨çš„æ­£å¸¸æ“ä½œç³»ç»Ÿç”¨æˆ·ã€‚

```shell
 greenlight=# exit
```

#### ä»¥æ–°ç”¨æˆ·è¿æ¥æ•°æ®åº“

åœ¨è¿›è¡Œè¿›ä¸€æ­¥æ“ä½œä¹‹å‰ï¼Œè®©æˆ‘ä»¬è¯æ˜ä¹‹å‰çš„æ“ä½œéƒ½è®¾ç½®æ­£ç¡®ï¼Œå¹¶å°è¯•ä»¥greenlightç”¨æˆ·è¿æ¥åˆ°greenlightæ•°æ®åº“ã€‚å‡ºç°æç¤ºæ—¶ï¼Œè¾“å…¥åœ¨ä¸Šé¢æ­¥éª¤ä¸­è®¾ç½®çš„å¯†ç ã€‚

```shell
$ psql --host=localhost --dbname=greenlight --username=greenlight
Password for user greenlight:
psql (13.4)
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off) Type "help" for help.
greenlight=> SELECT current_user;
current_user --------------
greenlight (1 row)
greenlight=> exit
```

å¾ˆå¥½ï¼è¿™ç¡®è®¤äº†æˆ‘ä»¬çš„æ•°æ®åº“å’Œå¸¦æœ‰å¯†ç éªŒè¯çš„æ–°greenlightç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œå¹¶ä¸”æˆ‘ä»¬èƒ½å¤Ÿä»¥è¯¥ç”¨æˆ·æ‰§è¡ŒSQLè¯­å¥ã€‚

## é™„åŠ å†…å®¹

#### ä¼˜åŒ–PostgreSQLè®¾ç½®

PostgreSQLçš„é»˜è®¤è®¾ç½®æ˜¯ç›¸å½“ä¿å®ˆçš„ï¼Œé€šå¸¸å¯ä»¥é€šè¿‡è°ƒæ•´PostgreSQL.confæ–‡ä»¶ä¸­çš„å€¼æ¥æé«˜æ•°æ®åº“çš„æ€§èƒ½ã€‚

ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„SQLæŸ¥è¯¢æ¥æ£€æŸ¥postgresql.confæ–‡ä»¶çš„ä½ç½®:

```shell
$ sudo -u postgres psql -c 'SHOW config_file;'
                config_file   
--------------------------------------------
 /opt/homebrew/var/postgres/postgresql.conf
(1 row)
```

[è¿™ç¯‡æ–‡ç« ](https://www.enterprisedb.com/postgres-tutorials/how-tune-postgresql-memory)åœ°ä»‹ç»äº†ä¸€äº›æœ€é‡è¦çš„PostgreSQLé…ç½®ï¼Œå¹¶æŒ‡å¯¼å“ªäº›å€¼å¯ä»¥ä½œä¸ºåˆç†çš„å…¶å®é…ç½®ã€‚å¦‚æœä½ å¯¹ä¼˜åŒ–PostgreSQLæ„Ÿå…´è¶£ï¼Œæˆ‘å»ºè®®ä½ è¯»ä¸€è¯»è¿™ç¯‡æ–‡ç« ã€‚

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªåŸºäºwebçš„[å·¥å…·](https://pgtune.leopard.in.ua)æ¥æ ¹æ®ä½ çš„ç³»ç»Ÿç¡¬ä»¶ç”Ÿæˆæ¨èé…ç½®ã€‚è¿™ä¸ªå·¥å…·çš„ç‰¹ç‚¹æ˜¯è¾“å‡º"ALTER SYSTEM" SQLè¯­å¥ï¼Œä½ å¯ä»¥è¿è¡Œå®ƒæ¥æ”¹å˜ä½ çš„æ•°æ®åº“è®¾ç½®ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ä¿®æ”¹postgresql.confæ–‡ä»¶ã€‚
## è¿æ¥PostgreSQLæ•°æ®åº“

å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬çš„æ–°greenlightæ•°æ®åº“å·²ç»åˆ›å»ºå¥½äº†ï¼Œæ¥çœ‹çœ‹å¦‚ä½•ä»Goåº”ç”¨ç¨‹åºè¿æ¥åˆ°å®ƒã€‚

è¦è¿æ¥SQLæ•°æ®åº“ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“é©±åŠ¨ç¨‹åºï¼Œä½œä¸ºGoå’Œæ•°æ®åº“ä¹‹é—´çš„â€œä¸­é—´äººâ€ã€‚ä½ å¯ä»¥åœ¨[Go wiki](https://github.com/golang/go/wiki/SQLDrivers)ä¸­æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„PostgreSQLé©±åŠ¨ç¨‹åºåˆ—è¡¨ï¼Œä½†å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œæˆ‘ä»¬å°†é€‰æ‹©pqåŒ…ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å¸¸ç”¨ã€å¯é çš„å’ŒåŠŸèƒ½å®Œå–„ã€‚

å¦‚æœä½ è·Ÿéšæœ¬ä¹¦æ“ä½œï¼Œé‚£ä¹ˆä½¿ç”¨go getä¸‹è½½pqçš„v1.10.0ç‰ˆæœ¬ï¼Œå°±åƒè¿™æ ·:

```shell
$ go get github.com/lib/pq@v1.10.0
go: downloading github.com/lib/pq v1.10.0
```

ä¸ºäº†è¿æ¥åˆ°æ•°æ®åº“ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªæ•°æ®æºåç§°(DSN)ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å«å¿…è¦è¿æ¥å‚æ•°çš„å­—ç¬¦ä¸²ã€‚DSNæ ¼å¼å°†å–å†³äºæ‚¨ä½¿ç”¨çš„æ•°æ®åº“é©±åŠ¨ç¨‹åº(åº”è¯¥åœ¨é©±åŠ¨ç¨‹åºæ–‡æ¡£ä¸­æœ‰æè¿°)ï¼Œä½†å½“ä½¿ç”¨pqæ—¶ï¼Œä»¥greenlightç”¨æˆ·ç»“åˆDSNï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿè¿æ¥åˆ°æ‚¨çš„æœ¬åœ°greenlightæ•°æ®åº“:

```shell
 postgres://greenlight:pa55word@localhost/greenlight
```

#### åˆ›å»ºæ•°æ®åº“è¿æ¥æ± 

æˆ‘ä»¬åœ¨Goåº”ç”¨ç¨‹åºè¿æ¥åˆ°greenlightæ•°æ®åº“çš„ä»£ç å‡ ä¹ä¸mysqlä¸­çš„ä»£ç å®Œå…¨ç›¸åŒã€‚æˆ‘å°±ä¸ç»†è®²äº†ï¼Œå¸Œæœ›å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ã€‚

åŒ…å«ä»¥ä¸‹å‡ ç‚¹ï¼š

* æˆ‘ä»¬å¸Œæœ›DSNåœ¨è¿è¡Œæ—¶å¯é…ç½®ï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°å°†å®ƒä¼ é€’ç»™åº”ç”¨ç¨‹åºï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç å®ƒã€‚åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸Šé¢çš„DSNä½œä¸ºå‚æ•°çš„é»˜è®¤å€¼ã€‚
* åœ¨cmd/api/main.goæ–‡ä»¶ä¸­æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„openDB()å‡½æ•°ã€‚åœ¨è¯¥å‡½æ•°ä¸­ï¼Œä½¿ç”¨sql.Open()æ¥å»ºç«‹sql.DBè¿æ¥æ± ï¼Œå› ä¸ºæ•°æ®åº“è¿æ¥æ˜¯åœ¨ç¬¬ä¸€æ¬¡éœ€è¦æ—¶æƒ°æ€§åœ°å»ºç«‹çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨db.PingContext()æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªå®é™…çš„è¿æ¥ï¼Œå¹¶éªŒè¯æ•°æ®åº“è®¾ç½®æ­£ç¡®ã€‚

æˆ‘ä»¬å›åˆ°cmd/api/main.goæ–‡ä»¶æ›´æ–°ä»£ç å¦‚ä¸‹ï¼š

File: cmd/api/main.go

---

```go
package main

import (
	"context" 
	"database/sql"
	"flag"
	"fmt"
	"log"
	"net/http"
	"os"
	"time"
        //å¯¼å…¥pqé©±åŠ¨ç¨‹åºï¼Œé€šè¿‡åŒ…database/sqlæ¥æ³¨å†Œæ•°æ®åº“é©±åŠ¨ç¨‹åº
	_ "github.com/lib/pq"
)

const version = "1.0.0"

//æ·»åŠ ä¸€ä¸ªdbç»“æ„å­—æ®µæ¥ä¿å­˜æ•°æ®åº“è¿æ¥çš„é…ç½®
type config struct {
	port int
	env  string
	db   struct {
		dsn string
	}
}
type application struct {
	config config
	logger *log.Logger
}

func main() {
	var cfg config
	flag.IntVar(&cfg.port, "port", 4000, "API server port")
	flag.StringVar(&cfg.env, "env", "development", "Environment (development|staging|production)")
	// å°†DSNå€¼ä»db-dsnå‘½ä»¤è¡Œå‚æ•°ä¸­è¯»å…¥é…ç½®ï¼Œè®¾ç½®é»˜è®¤å€¼
	flag.StringVar(&cfg.db.dsn, "db-dsn", "postgres://greenlight:pa55word@localhost/greenlight", "PostgreSQL DSN")
	flag.Parse()
	logger := log.New(os.Stdout, "", log.Ldate|log.Ltime)
  
	//è°ƒç”¨openDB()å¸®åŠ©å‡½æ•°(å‚è§ä¸‹é¢)æ¥åˆ›å»ºè¿æ¥æ± 
	db, err := openDB(cfg)
	if err != nil {
		logger.Fatal(err)
	}
  
	// deferè°ƒç”¨ï¼Œ ä»¥ä¾¿main()å‡½æ•°é€€å‡ºä¹‹å‰å…³é—­è¿æ¥æ± ã€‚
	defer db.Close()
  
	//æ‰“å°è¿æ¥æ•°æ®åº“æˆåŠŸæ—¥å¿—
	logger.Printf("database connection pool established")
	app := &application{config: cfg,
		logger: logger}
	srv := &http.Server{
		Addr: fmt.Sprintf(":%d", cfg.port), Handler: app.routes(),
		IdleTimeout: time.Minute,
		ReadTimeout: 10 * time.Second, WriteTimeout: 30 * time.Second,
	}
	logger.Printf("starting %s server on %s", cfg.env, srv.Addr)
	err = srv.ListenAndServe()
	logger.Fatal(err)
}

//openDB()å‡½æ•°è¿”å›ä¸€ä¸ªsql.DBè¿æ¥æ± ã€‚
func openDB(cfg config) (*sql.DB, error) {
	//ä½¿ç”¨sql.Open()åˆ›å»ºä¸€ä¸ªç©ºè¿æ¥æ± 
	db, err := sql.Open("postgres", cfg.db.dsn)
	if err != nil {
		return nil, err
	}
 
	//åˆ›å»ºä¸€ä¸ªå…·æœ‰5ç§’è¶…æ—¶æœŸé™çš„ä¸Šä¸‹æ–‡ã€‚
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()
 
	//ä½¿ç”¨PingContext()å»ºç«‹åˆ°æ•°æ®åº“çš„æ–°è¿æ¥ï¼Œå¹¶ä¼ å…¥ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè¿æ¥è¶…æ—¶å°±è¿”å›
	err = db.PingContext(ctx)
	if err != nil {
		return nil, err
	}
	// è¿”å›sql.DBè¿æ¥æ± 
	return db, nil
}
```

> é‡è¦æç¤ºï¼šæˆ‘ä»¬å°†åœ¨æœ¬ä¹¦çš„åé¢è®¨è®ºå¦‚ä½•ä½¿ç”¨ä¸Šä¸‹æ–‡æ¥æ­£ç¡®åœ°ç®¡ç†è¶…æ—¶ï¼Œæ‰€ä»¥ç°åœ¨ä¸è¦è¿‡å¤šåœ°æ‹…å¿ƒè¿™ä¸ªé—®é¢˜ã€‚ç°åœ¨ï¼Œåªéœ€è¦çŸ¥é“PingContext()è°ƒç”¨ä¸èƒ½åœ¨5ç§’å†…æˆåŠŸå®Œæˆï¼Œå°†è¿”å›ä¸€ä¸ªè¶…æ—¶é”™è¯¯ã€‚

æ¥ä¸‹æ¥å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œä½ å°†çœ‹åˆ°æ¡å…³äºè¿æ¥æ•°æ®åº“æˆåŠŸçš„æ—¥å¿—ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
$ go run ./cmd/api
2021/04/07 15:56:54 database connection pool established 
2021/04/07 15:56:54 starting development server on :4000
```

#### è§£è€¦DSN

ç›®å‰ï¼ŒDSNçš„å‘½ä»¤è¡Œå‚æ•°é»˜è®¤å€¼æ˜¯åœ¨cmd/api/main.goæ–‡ä»¶ä¸­å†™æ­»çš„ã€‚å°½ç®¡DSNä¸­çš„ç”¨æˆ·åå’Œå¯†ç åªæ˜¯ç”¨äºæ‚¨è‡ªå·±æœºå™¨ä¸Šçš„å¼€å‘æ•°æ®åº“ï¼Œä½†æœ€å¥½ä¸è¦å°†è¿™äº›æ•æ„Ÿä¿¡æ¯ç¡¬ç¼–ç åˆ°é¡¹ç›®æ–‡ä»¶ä¸­(è¿™äº›æ–‡ä»¶å¯èƒ½åœ¨æœªæ¥è¢«å…±äº«æˆ–åˆ†å‘)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬é‡‡å–ä¸€äº›æ­¥éª¤å°†DSNä»æˆ‘ä»¬çš„é¡¹ç›®ä»£ç ä¸­è§£è€¦ï¼Œå¹¶å°†å…¶å­˜å‚¨ä¸ºæœ¬åœ°æœºå™¨ä¸Šçš„ä¸€ä¸ªç¯å¢ƒå˜é‡ã€‚

å¦‚æœä½ æŒ‰ç…§æœ¬ä¹¦æ“ä½œï¼Œå…ˆåˆ›å»ºGREENLIGHT_DB_DSNç¯å¢ƒå˜é‡ï¼Œåœ¨$HOME/.profileæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

File: $HOME/.profile

```shell
...
export GREENLIGHT_DB_DSN='postgres://greenlight:pa55word@localhost/greenlight'
```

æˆ–è€…åœ¨$HOME/.bashrcæ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸Šå†…å®¹ä¹Ÿå¯ä»¥ã€‚

å®Œæˆè¿™äº›ä¹‹åï¼Œéœ€è¦é‡æ–°å¯åŠ¨æ‚¨çš„è®¡ç®—æœºï¼Œå¦‚æœç°åœ¨ä¸æ–¹ä¾¿é‡å¯çš„è¯ï¼Œå¯ä»¥åœ¨åˆšåˆšç¼–è¾‘çš„æ–‡ä»¶ä¸Šè¿è¡Œsourceå‘½ä»¤æ¥å®ç°ç¯å¢ƒå˜é‡ç”Ÿæ•ˆã€‚ä¾‹å¦‚:

```shell
$ source $HOME/.profile
```

> æ³¨æ„:è¿è¡Œsourceå‘½ä»¤åªä¼šåœ¨å½“å‰çš„ç»ˆç«¯çª—å£ç”Ÿæ•ˆã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨åˆ‡æ¢åˆ°å¦ä¸€ä¸ªç»ˆç«¯ï¼Œæ‚¨éœ€è¦å†æ¬¡è¿è¡Œsourceç”Ÿæ•ˆã€‚

ä¸ç®¡æ€æ ·ï¼Œä¸€æ—¦æ‚¨é‡å¯æœºå™¨æˆ–è¿è¡Œsourceï¼Œé€šè¿‡è¿è¡Œechoå‘½ä»¤å°±å¯ä»¥åœ¨ç»ˆç«¯ä¸­çœ‹åˆ°GREENLIGHT_DB_DSNç¯å¢ƒå˜é‡çš„å€¼ã€‚åƒè¿™æ ·:

```shell
 $ echo $GREENLIGHT_DB_DSN
postgres://greenlight:pa55word@localhost/greenlight
```

ä¸‹é¢æ›´æ–°cmd/api/main.goæ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡è®¿é—®ç¯å¢ƒå˜é‡æ¥è·å–DSNå€¼ã€‚Goä¸­è¯»å–ç¯å¢ƒå˜é‡å€¼å¯ä»¥è°ƒç”¨os.Getenv()å‡½æ•°ï¼Œç„¶åå°†DSNå‘½ä»¤è¡Œå‚æ•°é»˜è®¤å€¼è®¾ç½®ä¸ºç¯å¢ƒå˜é‡å€¼ã€‚

Fileï¼šcmd/api/main.go

---

```go
package main

...

func main() {
var cfg config

flag.IntVar(&cfg.port, "port", 4000, "API server port")
flag.StringVar(&cfg.env, "env", "development", "Environment (development|staging|production)")

// ä½¿ç”¨GREENLIGHT_DB_DSNç¯å¢ƒå˜é‡ï¼Œä½œä¸ºDSNå‘½ä»¤è¡Œå‚æ•°é»˜è®¤å€¼
flag.StringVar(&cfg.db.dsn, "db-dsn", os.Getenv("GREENLIGHT_DB_DSN"), "PostgreSQL DSN")
flag.Parse()
...
}
```

å¦‚æœæ‚¨ç°åœ¨å†æ¬¡é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œæ‚¨åº”è¯¥ä¼šå‘ç°å¯ä»¥æ­£å¸¸ç¼–è¯‘ï¼Œå¹¶åƒä¹‹å‰ä¸€æ ·å·¥ä½œã€‚

æ‚¨è¿˜å¯ä»¥å°è¯•åœ¨è¿è¡Œåº”ç”¨ç¨‹åºæ—¶æŒ‡å®š-helpæ ‡å¿—ã€‚åº”è¯¥ä¼šè¾“å‡ºä¸‰ä¸ªå‘½ä»¤è¡Œå‚æ•°çš„æè¿°å†…å®¹å’Œé»˜è®¤å€¼ï¼ŒåŒ…æ‹¬ä»ç¯å¢ƒå˜é‡ä¸­æå–çš„DSNå€¼ã€‚ç±»ä¼¼äº:

```go
$ go run ./cmd/api -help
Usage of /tmp/go-build417842398/b001/exe/api: 
  -db-dsn string
    PostgreSQL DSN (default "postgres://greenlight:pa55word@localhost/greenlight") 
  -env string
    Environment (development|staging|production) (default "development") 
  -port int
    API server port (default 4000)
```

## é™„åŠ å†…å®¹

#### psqlä½¿ç”¨DSNè¿æ¥æ•°æ®åº“

å°†DSNå­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­çš„ä¸€ä¸ªå¾ˆå¥½å¤„æ˜¯ï¼šèƒ½å¤Ÿä»¥greenlightç”¨æˆ·è½»æ¾åœ°è¿æ¥åˆ°greenlightæ•°æ®åº“ï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œpsqlæ—¶æ‰‹åŠ¨æŒ‡å®šæ‰€æœ‰è¿æ¥é…ç½®ã€‚åƒè¿™æ ·:

```shell
$ psql $GREENLIGHT_DB_DSN
psql (13.4)
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off) 
Type "help" for help.

greenlight=>
```
## é…ç½®æ•°æ®åº“è¿æ¥æ± 

æœ¬èŠ‚å†…å®¹æˆ‘ä»¬å°†è§£é‡Šè¿æ¥æ± èƒŒåæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå¹¶æ¢ç´¢å¦‚ä½•é…ç½®æ•°æ®åº“èƒ½æ”¹å˜æˆ–ä¼˜åŒ–å…¶æ€§èƒ½ã€‚

> æ³¨æ„ï¼šæœ¬ç« åŒ…å«äº†ç›¸å½“å¤šçš„ç†è®ºï¼Œè™½ç„¶å®ƒå¾ˆæœ‰è¶£ï¼Œä½†å¯¹åº”ç”¨ç¨‹åºçš„æ„å»ºå¹¶ä¸é‡è¦ã€‚å¦‚æœä½ è§‰å¾—å®ƒå¤ªéš¾äº†ï¼Œå¯ä»¥å…ˆæµè§ˆä¸€ä¸‹ï¼Œç„¶åå†å›å¤´çœ‹ã€‚

é‚£ä¹ˆsql.DBè¿æ¥æ± æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢?

éœ€è¦ç†è§£çš„æœ€é‡è¦ä¸€ç‚¹æ˜¯ï¼Œsql.DBæ± åŒ…å«ä¸¤ç§ç±»å‹çš„è¿æ¥â€”â€”â€œæ­£åœ¨ä½¿ç”¨â€è¿æ¥å’Œâ€œç©ºé—²â€è¿æ¥ã€‚å½“æ‚¨ä½¿ç”¨è¿æ¥æ‰§è¡Œæ•°æ®åº“ä»»åŠ¡(ä¾‹å¦‚æ‰§è¡ŒSQLè¯­å¥æˆ–æŸ¥è¯¢è¡Œ)æ—¶ï¼Œè¯¥è¿æ¥è¢«æ ‡è®°ä¸ºæ­£åœ¨ä½¿ç”¨ï¼Œä»»åŠ¡å®Œæˆåï¼Œè¯¥è¿æ¥è¢«æ ‡è®°ä¸ºç©ºé—²ã€‚

å½“æ‚¨ä½¿ç”¨Goæ‰§è¡Œæ•°æ®åº“æ“ä½œæ—¶ï¼Œå®ƒå°†é¦–å…ˆæ£€æŸ¥æ± ä¸­æ˜¯å¦æœ‰å¯ç”¨çš„ç©ºé—²è¿æ¥ã€‚å¦‚æœæœ‰å¯ç”¨çš„è¿æ¥ï¼Œé‚£ä¹ˆGoå°†é‡ç”¨è¿™ä¸ªç°æœ‰è¿æ¥ï¼Œå¹¶åœ¨ä»»åŠ¡æœŸé—´å°†å…¶æ ‡è®°ä¸ºæ­£åœ¨ä½¿ç”¨ã€‚å¦‚æœåœ¨æ‚¨éœ€è¦ç©ºé—²è¿æ¥æ—¶æ± ä¸­æ²¡æœ‰ç©ºé—²è¿æ¥ï¼Œé‚£ä¹ˆGoå°†åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥ã€‚

å½“Goé‡ç”¨æ± ä¸­çš„ç©ºé—²è¿æ¥æ—¶ï¼Œä¸è¯¥è¿æ¥æœ‰å…³çš„ä»»ä½•é—®é¢˜éƒ½ä¼šè¢«ä¼˜é›…åœ°å¤„ç†ã€‚å¼‚å¸¸è¿æ¥å°†åœ¨æ”¾å¼ƒä¹‹å‰è‡ªåŠ¨é‡è¯•ä¸¤æ¬¡ï¼Œè¿™æ—¶Goå°†ä»æ± ä¸­åˆ é™¤å¼‚å¸¸è¿æ¥å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥æ¥æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚

#### é…ç½®è¿æ¥æ± 

è¿æ¥æ± æœ‰å››ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥é…ç½®è¿æ¥æ± çš„è¡Œä¸ºã€‚è®©æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªåœ°æ¥è®¨è®ºã€‚

##### SetMaxOpenConnsæ–¹æ³•

SetMaxOpenConns()æ–¹æ³•å…è®¸æ‚¨è®¾ç½®æ± ä¸­â€œæ‰“å¼€â€è¿æ¥(ä½¿ç”¨ä¸­+ç©ºé—²è¿æ¥)æ•°é‡çš„ä¸Šé™ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰“å¼€çš„è¿æ¥æ•°æ˜¯æ— é™çš„ã€‚

> æ³¨æ„â€œæ‰“å¼€â€è¿æ¥ç­‰äºâ€œæ­£åœ¨ä½¿ç”¨â€åŠ ä¸Šâ€œç©ºé—²â€è¿æ¥ï¼Œä¸ä»…ä»…æ˜¯â€œæ­£åœ¨ä½¿ç”¨â€è¿æ¥ã€‚

ä¸€èˆ¬æ¥è¯´ï¼ŒMaxOpenConnsè®¾ç½®å¾—è¶Šå¤§ï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œçš„æ•°æ®åº“æŸ¥è¯¢å°±è¶Šå¤šï¼Œè¿æ¥æ± æœ¬èº«æˆä¸ºåº”ç”¨ç¨‹åºä¸­çš„ç“¶é¢ˆçš„é£é™©å°±è¶Šä½ã€‚

ä½†è®©å®ƒæ— é™å¹¶ä¸æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒPostgreSQLæœ€å¤š100ä¸ªæ‰“å¼€è¿æ¥çš„ç¡¬é™åˆ¶ï¼Œå¦‚æœè¾¾åˆ°è¿™ä¸ªé™åˆ¶çš„è¯ï¼Œå®ƒå°†å¯¼è‡´pqé©±åŠ¨è¿”å›"sorry, too many clients already"é”™è¯¯ã€‚

> æ³¨æ„ï¼šæœ€å¤§æ‰“å¼€è¿æ¥æ•°é™åˆ¶å¯ä»¥åœ¨postgresql.confæ–‡ä»¶ä¸­å¯¹max_connectionsè®¾ç½®æ¥æ›´æ”¹ã€‚

ä¸ºäº†é¿å…è¿™ä¸ªé”™è¯¯ï¼Œå°†æ± ä¸­æ‰“å¼€çš„è¿æ¥æ•°é‡é™åˆ¶åœ¨100ä»¥ä¸‹æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå¯ä»¥ä¸ºå…¶ä»–éœ€è¦ä½¿ç”¨PostgreSQLçš„åº”ç”¨ç¨‹åºæˆ–ä¼šè¯ç•™ä¸‹è¶³å¤Ÿçš„ç©ºé—´ã€‚

è®¾ç½®MaxOpenConnsé™åˆ¶çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå®ƒå……å½“ä¸€ä¸ªéå¸¸åŸºæœ¬çš„é™æµå™¨ï¼Œé˜²æ­¢æ•°æ®åº“åŒæ—¶è¢«å¤§é‡ä»»åŠ¡å‹å®ã€‚

ä½†è®¾å®šä¸Šé™æœ‰ä¸€ä¸ªé‡è¦çš„è­¦å‘Šã€‚å¦‚æœè¾¾åˆ°MaxOpenConnsé™åˆ¶ï¼Œå¹¶ä¸”æ‰€æœ‰è¿æ¥éƒ½åœ¨ä½¿ç”¨ä¸­ï¼Œé‚£ä¹ˆä»»ä½•æ–°çš„æ•°æ®åº“ä»»åŠ¡å°†è¢«è¿«ç­‰å¾…ï¼Œç›´åˆ°æœ‰è¿æ¥ç©ºé—²ã€‚åœ¨æˆ‘ä»¬çš„APIä¸Šä¸‹æ–‡ä¸­ï¼Œç”¨æˆ·çš„HTTPè¯·æ±‚å¯èƒ½åœ¨ç­‰å¾…ç©ºé—²è¿æ¥æ—¶æ— é™æœŸåœ°â€œæŒ‚èµ·â€ã€‚å› æ­¤ï¼Œä¸ºäº†ç¼“è§£è¿™ç§æƒ…å†µï¼Œä½¿ç”¨ä¸Šä¸‹æ–‡ä¸ºæ•°æ®åº“ä»»åŠ¡è®¾ç½®è¶…æ—¶æ˜¯å¾ˆé‡è¦çš„ã€‚æˆ‘ä»¬å°†åœ¨ä¹¦çš„åé¢è§£é‡Šå¦‚ä½•å¤„ç†ã€‚

##### SetMaxIdleConnsæ–¹æ³•

SetMaxIdleConns()æ–¹æ³•çš„ä½œç”¨æ˜¯ï¼šè®¾ç½®æ± ä¸­ç©ºé—²è¿æ¥æ•°çš„ä¸Šé™ã€‚ç¼ºçœæƒ…å†µä¸‹ï¼Œæœ€å¤§ç©ºé—²è¿æ¥æ•°ä¸º2ã€‚

ç†è®ºä¸Šï¼Œåœ¨æ± ä¸­å…è®¸æ›´å¤šçš„ç©ºé—²è¿æ¥å°†å¢åŠ æ€§èƒ½ã€‚å› ä¸ºå®ƒå‡å°‘äº†ä»å¤´å»ºç«‹æ–°è¿æ¥å‘ç”Ÿæ¦‚ç‡â€”ï¼Œå› æ­¤æœ‰åŠ©äºèŠ‚çœèµ„æºã€‚

ä½†è¦æ„è¯†åˆ°ä¿æŒç©ºé—²è¿æ¥æ˜¯æœ‰ä»£ä»·çš„ã€‚å®ƒå ç”¨äº†æœ¬æ¥å¯ä»¥ç”¨äºåº”ç”¨ç¨‹åºå’Œæ•°æ®åº“çš„å†…å­˜ï¼Œè€Œä¸”å¦‚æœä¸€ä¸ªè¿æ¥ç©ºé—²æ—¶é—´è¿‡é•¿ï¼Œå®ƒä¹Ÿå¯èƒ½å˜å¾—ä¸å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œé»˜è®¤æƒ…å†µä¸‹MySQLä¼šè‡ªåŠ¨å…³é—­ä»»ä½•8å°æ—¶æœªä½¿ç”¨çš„è¿æ¥ã€‚

å› æ­¤ï¼Œä¸ä½¿ç”¨æ›´å°çš„ç©ºé—²è¿æ¥æ± ç›¸æ¯”ï¼Œå°†MaxIdleConnsè®¾ç½®å¾—è¿‡é«˜å¯èƒ½ä¼šå¯¼è‡´æ›´å¤šçš„è¿æ¥å˜å¾—ä¸å¯ç”¨ï¼Œæµªè´¹èµ„æºã€‚å› æ­¤ä¿æŒé€‚é‡çš„ç©ºé—²è¿æ¥æ˜¯å¿…è¦çš„ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œä½ åªå¸Œæœ›ä¿æŒä¸€ä¸ªè¿æ¥ç©ºé—²ï¼Œå¯ä»¥å¿«é€Ÿä½¿ç”¨ã€‚

å¦ä¸€ä»¶è¦æŒ‡å‡ºçš„äº‹æƒ…æ˜¯MaxIdleConnså€¼åº”è¯¥æ€»æ˜¯å°äºæˆ–ç­‰äºMaxOpenConnsã€‚Goä¼šå¼ºåˆ¶ä¿è¯è¿™ç‚¹ï¼Œå¹¶åœ¨å¿…è¦æ—¶è‡ªåŠ¨å‡å°‘MaxIdleConnså€¼ã€‚

##### SetConnMaxLifetimeæ–¹æ³•

SetConnMaxLifetime()æ–¹æ³•ç”¨äºè®¾ç½®ConnMaxLifetimeçš„æé™å€¼ï¼Œè¡¨ç¤ºä¸€ä¸ªè¿æ¥ä¿æŒå¯ç”¨çš„æœ€é•¿æ—¶é—´ã€‚é»˜è®¤è¿æ¥çš„å­˜æ´»æ—¶é—´æ²¡æœ‰é™åˆ¶ï¼Œæ°¸ä¹…å¯ç”¨ã€‚

å¦‚æœè®¾ç½®ConnMaxLifetimeçš„å€¼ä¸º1å°æ—¶ï¼Œæ„å‘³ç€æ‰€æœ‰çš„è¿æ¥åœ¨åˆ›å»ºåï¼Œç»è¿‡ä¸€ä¸ªå°æ—¶å°±ä¼šè¢«æ ‡è®°ä¸ºå¤±æ•ˆè¿æ¥ï¼Œæ ‡å¿—åå°±ä¸å¯å¤ç”¨ã€‚ä½†éœ€è¦æ³¨æ„ï¼š

* è¿™å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªè¿æ¥å°†åœ¨æ± ä¸­å­˜åœ¨ä¸€æ•´ä¸ªå°æ—¶ï¼›æœ‰å¯èƒ½æŸä¸ªè¿æ¥ç”±äºæŸç§åŸå› å˜å¾—ä¸å¯ç”¨ï¼Œå¹¶åœ¨æ­¤ä¹‹å‰è‡ªåŠ¨å…³é—­ã€‚
* è¿æ¥åœ¨åˆ›å»ºåä¸€ä¸ªå¤šå°æ—¶å†…ä»ç„¶å¯ä»¥è¢«ä½¿ç”¨â€”åªæ˜¯åœ¨è¿™ä¸ªæ—¶é—´ä¹‹åå®ƒä¸èƒ½è¢«é‡ç”¨ã€‚
* è¿™ä¸æ˜¯ä¸€ä¸ªç©ºé—²è¶…æ—¶ã€‚è¿æ¥å°†åœ¨åˆ›å»ºåä¸€å°æ—¶è¿‡æœŸï¼Œè€Œä¸æ˜¯åœ¨ç©ºé—²åä¸€å°æ—¶è¿‡æœŸã€‚
* Goæ¯ç§’è¿è¡Œä¸€æ¬¡åå°æ¸…ç†æ“ä½œï¼Œä»æ± ä¸­åˆ é™¤è¿‡æœŸçš„è¿æ¥ã€‚

ç†è®ºä¸Šï¼ŒConnMaxLifetimeä¸ºæ— é™å¤§ï¼ˆæˆ–è®¾ç½®ä¸ºå¾ˆé•¿ç”Ÿå‘½å‘¨æœŸï¼‰å°†æå‡æ€§èƒ½ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥å‡å°‘æ–°å»ºè¿æ¥ã€‚ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè®¾ç½®çŸ­æœŸå­˜æ´»æ—¶é—´æœ‰ç”¨ã€‚æ¯”å¦‚ï¼š

* å¦‚æœSQLæ•°æ®åº“å¯¹è¿æ¥å¼ºåˆ¶è®¾ç½®æœ€å¤§å­˜æ´»æ—¶é—´ï¼Œè¿™æ—¶å°†ConnMaxLifetimeè®¾ç½®ç¨çŸ­æ—¶é—´æ›´åˆç†ã€‚
* æœ‰åŠ©äºæ•°æ®åº“æ›¿æ¢

å¦‚æœæ‚¨å†³å®šå¯¹è¿æ¥æ± è®¾ç½®ConnMaxLifetimeï¼Œé‚£ä¹ˆä¸€å®šè¦è®°ä½è¿æ¥è¿‡æœŸ(ç„¶åé‡æ–°åˆ›å»º)çš„é¢‘ç‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¿æ¥æ± ä¸­æœ‰100ä¸ªæ‰“å¼€çš„è¿æ¥ï¼Œè€ŒConnMaxLifetimeä¸º1åˆ†é’Ÿï¼Œé‚£ä¹ˆæ‚¨çš„åº”ç”¨ç¨‹åºå¹³å‡æ¯ç§’å¯ä»¥æ€æ­»å¹¶é‡æ–°åˆ›å»ºå¤šè¾¾1.67ä¸ªè¿æ¥ã€‚æ‚¨ä¸å¸Œæœ›é¢‘ç‡å¤ªå¤§è€Œæœ€ç»ˆå½±å“æ€§èƒ½å§ã€‚

##### SetConnMaxIdleTimeæ–¹æ³•

SetConnMaxIdleTime()æ–¹æ³•åœ¨Go 1.15ç‰ˆæœ¬å¼•å…¥å¯¹ConnMaxIdleTimeè¿›è¡Œé…ç½®ã€‚å…¶æ•ˆæœå’ŒConnMaxLifeTimeç±»ä¼¼ï¼Œä½†è¿™é‡Œè®¾ç½®çš„æ˜¯ï¼šåœ¨è¢«æ ‡è®°ä¸ºå¤±æ•ˆä¹‹å‰ä¸€ä¸ªè¿æ¥æœ€é•¿ç©ºé—²æ—¶é—´ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬å°†ConnMaxIdleTimeè®¾ç½®ä¸º1å°æ—¶ï¼Œé‚£ä¹ˆè‡ªä¸Šæ¬¡ä½¿ç”¨ä»¥ååœ¨æ± ä¸­ç©ºé—²äº†1å°æ—¶çš„ä»»ä½•è¿æ¥éƒ½å°†è¢«æ ‡è®°ä¸ºè¿‡æœŸå¹¶è¢«åå°æ¸…ç†æ“ä½œåˆ é™¤ã€‚

è¿™ä¸ªé…ç½®éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒæ„å‘³ç€æˆ‘ä»¬å¯ä»¥å¯¹æ± ä¸­ç©ºé—²è¿æ¥çš„æ•°é‡è®¾ç½®ç›¸å¯¹è¾ƒé«˜çš„é™åˆ¶ï¼Œä½†å¯ä»¥é€šè¿‡åˆ é™¤ä¸å†çœŸæ­£ä½¿ç”¨çš„ç©ºé—²è¿æ¥æ¥å‘¨æœŸæ€§åœ°é‡Šæ”¾èµ„æºã€‚

#### å®æ“ä¸€æ³¢

æ‰€ä»¥æœ‰å¾ˆå¤šä¿¡æ¯è¦å¸æ”¶ã€‚è¿™åœ¨å®è·µä¸­æ„å‘³ç€ä»€ä¹ˆï¼Ÿæˆ‘ä»¬æŠŠä»¥ä¸Šæ‰€æœ‰çš„å†…å®¹æ€»ç»“æˆä¸€äº›å¯è¡Œçš„è¦ç‚¹ã€‚

1ã€æ ¹æ®ç»éªŒï¼Œæ‚¨åº”è¯¥æ˜¾å¼åœ°è®¾ç½®MaxOpenConnså€¼ã€‚è¿™ä¸ªå€¼åº”è¯¥ä½äºæ•°æ®åº“å’Œæ“ä½œç³»ç»Ÿå¯¹è¿æ¥æ•°é‡çš„ç¡¬æ€§é™åˆ¶ï¼Œæ‚¨è¿˜å¯ä»¥è€ƒè™‘å°†å…¶ä¿æŒåœ¨ç›¸å½“ä½çš„æ°´å¹³ï¼Œä»¥å……å½“åŸºæœ¬çš„é™æµä½œç”¨ã€‚

å¯¹äºæœ¬ä¹¦ä¸­çš„é¡¹ç›®ï¼Œæˆ‘ä»¬å°†MaxOpenConnsé™åˆ¶ä¸º25ä¸ªè¿æ¥ã€‚æˆ‘å‘ç°è¿™å¯¹äºå°å‹åˆ°ä¸­å‹çš„webåº”ç”¨ç¨‹åºå’ŒAPIæ¥è¯´æ˜¯ä¸€ä¸ªåˆç†çš„åˆå§‹å€¼ï¼Œä½†ç†æƒ³æƒ…å†µä¸‹ï¼Œæ‚¨åº”è¯¥æ ¹æ®åŸºå‡†æµ‹è¯•å’Œå‹æµ‹ç»“æœè°ƒæ•´è¿™ä¸ªå€¼ã€‚

2ã€é€šå¸¸ï¼Œæ›´å¤§çš„MaxOpenConnså’ŒMaxIdleConnså€¼ä¼šå¸¦æ¥æ›´å¥½çš„æ€§èƒ½ã€‚ä½†æ˜¯ï¼Œæ•ˆæœæ˜¯é€æ¸é™ä½çš„ï¼Œè€Œä¸”æ‚¨åº”è¯¥æ³¨æ„ï¼Œå¤ªå¤šçš„ç©ºé—²è¿æ¥(è¿æ¥æ²¡æœ‰è¢«å¤ç”¨)å®é™…ä¸Šä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™å’Œä¸å¿…è¦çš„èµ„æºæ¶ˆè€—ã€‚

å› ä¸ºMaxIdleConnsåº”è¯¥æ€»æ˜¯å°äºæˆ–ç­‰äºMaxOpenConnsï¼Œæ‰€ä»¥å¯¹äºè¿™ä¸ªé¡¹ç›®ï¼Œæˆ‘ä»¬è¿˜å°†MaxIdleConnsé™åˆ¶ä¸º25ä¸ªè¿æ¥ã€‚

3ã€ä¸ºäº†é™ä½ä¸Šé¢ç¬¬2ç‚¹çš„é£é™©ï¼Œé€šå¸¸åº”è¯¥è®¾ç½®ConnMaxIdleTimeå€¼æ¥åˆ é™¤é•¿æ—¶é—´æœªä½¿ç”¨çš„ç©ºé—²è¿æ¥ã€‚åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†è®¾ç½®ConnMaxIdleTimeæŒç»­æ—¶é—´ä¸º15åˆ†é’Ÿã€‚

4ã€ConnMaxLifetimeé»˜è®¤è®¾ç½®ä¸ºæ— é™å¤§æ˜¯å¯ä»¥çš„ï¼Œé™¤éæ‚¨çš„æ•°æ®åº“å¯¹è¿æ¥ç”Ÿå‘½å‘¨æœŸæ–½åŠ äº†ç¡¬é™åˆ¶ï¼Œæˆ–è€…æ‚¨éœ€è¦å®ƒååŠ©ä¸€äº›æ“ä½œï¼Œæ¯”å¦‚ä¼˜é›…åœ°äº¤æ¢æ•°æ®åº“ã€‚è¿™äº›éƒ½ä¸é€‚ç”¨äºæœ¬é¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä¿ç•™è¿™ä¸ªé»˜è®¤çš„æ— é™åˆ¶é…ç½®ã€‚

#### é…ç½®è¿æ¥æ± 

ä¸å…¶ç¡¬ç¼–ç è¿™äº›é…ç½®ï¼Œä¸å¦‚æ›´æ–°cmd/api/main.goæ–‡ä»¶é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è¯»å–é…ç½®ã€‚

ConnMaxIdleTimeå€¼æ¯”è¾ƒæœ‰æ„æ€ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›å®ƒä¼ é€’ä¸€æ®µæ—¶é—´ï¼Œæœ€ç»ˆéœ€è¦å°†å…¶è½¬æ¢ä¸ºGoçš„time.Durationç±»å‹ã€‚è¿™é‡Œæœ‰å‡ ä¸ªé€‰æ‹©:

1ã€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ•´æ•°æ¥è¡¨ç¤ºç§’(æˆ–åˆ†é’Ÿ)çš„æ•°é‡ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºtime.Durationã€‚

2ã€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªè¡¨ç¤ºæŒç»­æ—¶é—´çš„å­—ç¬¦ä¸²â€”â€”æ¯”å¦‚â€œ5sâ€(5ç§’)æˆ–â€œ10mâ€(10åˆ†é’Ÿ)â€”â€”ç„¶åä½¿ç”¨time.ParseDuration()å‡½æ•°è§£æå®ƒã€‚

3ã€ä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥å¾ˆå¥½åœ°å·¥ä½œï¼Œä½†æ˜¯åœ¨è¿™ä¸ªé¡¹ç›®ä¸­æˆ‘ä»¬å°†ä½¿ç”¨é€‰é¡¹2ã€‚ç»§ç»­å¹¶æ›´æ–°cmd/api/main.goæ–‡ä»¶å¦‚ä¸‹:

File: cmd/api/main.go

---

```go
package main

import (
	"context"
	"database/sql"
	"flag"
	"fmt"
	_ "github.com/lib/pq"
	"log"
	"net/http"
	"os"
	"time"
)

const version = "1.0.0"

//æ·»åŠ maxOpenConns, maxIdleConnså’ŒmaxIdleTimeå­—æ®µæ¥å­˜æ”¾è¿æ¥æ± é…ç½®
type config struct {
	port int
	env  string
	db   struct {
		dsn          string
		maxOpenConns int
		maxIdleConns int
		maxIdleTime  int
	}
}
type application struct {
	config config
	logger *log.Logger
}

func main() {
	var cfg config
	flag.IntVar(&cfg.port, "port", 4000, "API server port")
	flag.StringVar(&cfg.env, "env", "development", "Environment (development|staging|production)")
	flag.StringVar(&cfg.db.dsn, "db-dsn", "postgres://greenlight:pa55word@localhost/greenlight", "PostgreSQL DSN")

	//ä»å‘½ä»¤å‚æ•°ä¸­è¯»å–è¿æ¥æ± é…ç½®åˆ°configç»“æ„ä½“ä¸­
	flag.IntVar(&cfg.db.maxOpenConns, "db-max-open-conns", 25, "PostgreSQL max open connections")
	flag.IntVar(&cfg.db.maxIdleConns, "db-max-idle-conns", 25, "PostgreSQL max idle connections")
	flag.StringVar(&cfg.db.maxIdleTime, "db-max-idle-time", "15m", "PostgreSQL max connection idle time")
	flag.Parse()
	logger := log.New(os.Stdout, "", log.Ldate|log.Ltime)

	//è°ƒç”¨openDB()å¸®åŠ©å‡½æ•°(å‚è§ä¸‹é¢)æ¥åˆ›å»ºè¿æ¥æ± 
	db, err := openDB(cfg)
	if err != nil {
		logger.Fatal(err)
	}

	// deferè°ƒç”¨ï¼Œ ä»¥ä¾¿main()å‡½æ•°é€€å‡ºä¹‹å‰å…³é—­è¿æ¥æ± ã€‚
	defer db.Close()

	//æ‰“å°è¿æ¥æ•°æ®åº“æˆåŠŸæ—¥å¿—
	logger.Printf("database connection pool established")
	app := &application{config: cfg,
		logger: logger}
	srv := &http.Server{
		Addr: fmt.Sprintf(":%d", cfg.port), Handler: app.routes(),
		IdleTimeout: time.Minute,
		ReadTimeout: 10 * time.Second, WriteTimeout: 30 * time.Second,
	}
	logger.Printf("starting %s server on %s", cfg.env, srv.Addr)
	err = srv.ListenAndServe()
	logger.Fatal(err)
}

func openDB(cfg config) (*sql.DB, error) {
	db, err := sql.Open("postgres", cfg.db.dsn)
	if err != nil {
		return nil, err
	}

	//è®¾ç½®æœ€å¤§å¼€æ”¾è¿æ¥æ•°ï¼Œæ³¨æ„è¯¥å€¼ä¸ºå°äº0æˆ–ç­‰äº0æŒ‡çš„æ˜¯æ— é™åˆ¶è¿æ¥æ•°
	db.SetMaxOpenConns(cfg.db.maxOpenConns)

	//è®¾ç½®ç©ºé—²è¿æ¥æ•°ï¼Œå°äºç­‰äº0è¡¨ç¤ºæ— é™åˆ¶
	db.SetMaxIdleConns(cfg.db.maxIdleConns)

	//å°†ç©ºé—²æ—¶é—´å­—ç¬¦ä¸²è§£æä¸ºtime.Durationç±»å‹
	duration, err := time.ParseDuration(cfg.db.maxIdleTime)
	if err != nil {
		return nil, err
	}

	//è®¾ç½®æœ€å¤§ç©ºé—²è¶…æ—¶
	db.SetConnMaxIdleTime(duration)
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()

	err = db.PingContext(ctx)
	if err != nil {
		return nil, err
	}
	return db, nil
}
```

å¦‚æœå†æ¬¡è¿è¡Œè¯¥åº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆä¸€åˆ‡åº”è¯¥éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚æ‚¨ä¸ä¼šå‘ç°æœ‰ä»»ä½•æ›´æ”¹ï¼Œè€Œä¸”æ­¤æ—¶æˆ‘ä»¬æ— æ³•æ¼”ç¤ºè¿™äº›é…ç½®çš„ä½œç”¨ã€‚ä½†æ˜¯åœ¨æœ¬ä¹¦çš„åé¢ï¼Œæˆ‘ä»¬å°†è¿›è¡Œä¸€äº›è´Ÿè½½æµ‹è¯•ï¼Œå¹¶è§£é‡Šå¦‚ä½•ä½¿ç”¨db.Stats()æ–¹æ³•å®æ—¶ç›‘è§†è¿æ¥æ± çš„çŠ¶æ€ã€‚åˆ°é‚£æ—¶ï¼Œä½ å°±èƒ½çœ‹åˆ°æˆ‘ä»¬åœ¨è¿™ä¸€ç« ä¸­è®¨è®ºçš„ä¸€äº›è®¾ç½®ã€‚
## æ•°æ®åº“å®‰è£…ä¸é…ç½®

åœ¨æœ¬ä¹¦çš„ä¸‹ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†ç»§ç»­æˆ‘ä»¬çš„é¡¹ç›®ï¼Œæ„å»ºå¹¶è®¾ç½®ä¸€ä¸ªSQLæ•°æ®åº“æ¥æŒä¹…å­˜å‚¨æˆ‘ä»¬çš„movieæ•°æ®ã€‚

è¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨PostgreSQLæ•°æ®åº“ã€‚å®ƒæ˜¯å¼€æºçš„ï¼Œéå¸¸å¯é ï¼Œå¹¶ä¸”å…·æœ‰ä¸€äº›æœ‰ç”¨çš„æ–°çš„ç‰¹æ€§â€”â€”åŒ…æ‹¬æ”¯æŒæ•°ç»„å’ŒJSONæ•°æ®ç±»å‹ã€å…¨æ–‡æœç´¢å’Œåœ°ç†ç©ºé—´æŸ¥è¯¢ã€‚åœ¨é¡¹ç›®æ„å»ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿™äº›æ–°çš„PostgreSQLç‰¹æ€§ã€‚

æœ¬ç« ä½ å°†å­¦ä¹ ï¼š

* å¦‚ä½•åœ¨è‡ªå·±æœºå™¨ä¸Šå®‰è£…å’Œè®¾ç½®PostgreSQLã€‚
* å¦‚ä½•ä½¿ç”¨psqläº¤äº’å¼å·¥å…·åˆ›å»ºæ•°æ®åº“ï¼ŒPostgreSQLæ‰©å±•å’Œç”¨æˆ·å¸æˆ·ã€‚
* å¦‚ä½•åœ¨Goä¸­åˆå§‹åŒ–æ•°æ®åº“è¿æ¥æ± å¹¶ä¿®æ”¹é…ç½®ä»¥æé«˜æ€§èƒ½å’Œç¨³å®šæ€§ã€‚
## SQLè¿ç§»æ¦‚è¿°

å¦‚æœä½ ä¸ç†Ÿæ‚‰SQLè¿ç§»çš„æ¦‚å¿µï¼Œä½œä¸ºä¸€ä¸ªéå¸¸é«˜çº§çš„æ¦‚å¿µå®ƒæ˜¯è¿™æ ·çš„å·¥ä½œçš„:

1ã€å¯¹æ•°æ®åº“æ¨¡å¼è¿›è¡Œçš„æ¯ä¸€æ¬¡æ›´æ”¹(å¦‚åˆ›å»ºè¡¨ã€æ·»åŠ åˆ—æˆ–åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•)ï¼Œéƒ½è¦åˆ›å»ºä¸€å¯¹è¿ç§»æ–‡ä»¶ã€‚ä¸€ä¸ªæ–‡ä»¶æ˜¯â€œupâ€è¿ç§»ï¼Œå…¶ä¸­åŒ…å«å®ç°æ›´æ”¹æ‰€éœ€çš„SQLè¯­å¥ï¼Œå¦ä¸€ä¸ªæ–‡ä»¶æ˜¯â€œdownâ€è¿ç§»ï¼Œå…¶ä¸­åŒ…å«é€†è½¬(æˆ–å›æ»š)æ›´æ”¹æ‰€éœ€çš„SQLè¯­å¥ã€‚

2ã€æ¯å¯¹è¿ç§»æ–‡ä»¶æŒ‰é¡ºåºç¼–å·ï¼Œé€šå¸¸æ˜¯0001ã€0002ã€0003â€¦æˆ–è€…ä½¿ç”¨Unixæ—¶é—´æˆ³ï¼Œè¡¨ç¤ºå°†è¿ç§»åº”ç”¨åˆ°æ•°æ®åº“çš„é¡ºåºã€‚

3ã€æ‚¨å¯ä»¥ä½¿ç”¨æŸç§å·¥å…·æˆ–è„šæœ¬ï¼Œæ ¹æ®è¿ç§»æ–‡ä»¶ä¸­çš„SQLè¯­å¥æ‰§è¡Œæˆ–å›æ»šæ•°æ®åº“ã€‚è¯¥å·¥å…·è·Ÿè¸ªå“ªäº›è¿ç§»å·²ç»ç”Ÿæ•ˆï¼Œä»¥ä¾¿æ‰§è¡Œå¿…è¦çš„SQLè¯­å¥ã€‚

ä½¿ç”¨è¿ç§»æ¥ç®¡ç†ä½ çš„æ•°æ®åº“æ¨¡å¼ï¼Œè€Œä¸æ˜¯è‡ªå·±æ‰‹åŠ¨æ‰§è¡ŒSQLè¯­å¥ï¼Œæœ‰å‡ ä¸ªå¥½å¤„:

* æ•°æ®åº“æ¨¡å¼(åŠå…¶æ¼”å˜å’Œæ›´æ”¹)å®Œå…¨ç”±â€œupâ€å’Œâ€œdownâ€SQLè¿ç§»æ–‡ä»¶æè¿°ã€‚ç”±äºè¿™äº›æ–‡ä»¶åªæ˜¯åŒ…å«ä¸€äº›SQLè¯­å¥ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­å°†å®ƒä»¬ä¸å…¶ä»–ä»£ç ä¸€èµ·è·Ÿè¸ªã€‚
* é€šè¿‡è¿è¡Œâ€œupâ€è¿ç§»ï¼Œå¯ä»¥åœ¨å¦ä¸€å°æœºå™¨ä¸Šç²¾ç¡®åœ°å¤åˆ¶å½“å‰æ•°æ®åº“æ¨¡å¼ã€‚å½“æ‚¨éœ€è¦åœ¨ä¸åŒçš„ç¯å¢ƒ(å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç­‰)ä¸­ç®¡ç†å’ŒåŒæ­¥æ•°æ®åº“æ¨¡å¼æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å¸®åŠ©ã€‚
* å¦‚æœæœ‰å¿…è¦ï¼Œå¯ä»¥é€šè¿‡åº”ç”¨é€‚å½“çš„â€œdownâ€è¿ç§»å›æ»šæ•°æ®åº“æ¨¡å¼æ›´æ”¹ã€‚

#### æŒ‰ç…§è¿ç§»å·¥å…·

ä¸ºäº†åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ç®¡ç†SQLè¿ç§»ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨migrateå‘½ä»¤è¡Œå·¥å…·(å®ƒæœ¬èº«æ˜¯ç”¨Goç¼–å†™çš„)ã€‚

ä¸åŒæ“ä½œç³»ç»Ÿçš„è¯¦ç»†å®‰è£…è¯´æ˜å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/golang-migrate/migrate/tree/master/cmd/migrate)æ‰¾åˆ°ï¼Œä½†åœ¨macOSä¸Šï¼Œä½ åº”è¯¥èƒ½å¤Ÿä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…:

```shell
brew install golang-migrate
```

åœ¨Linuxå’ŒWindowsä¸Šï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶å¹¶å°†å…¶æ‹·è´åˆ°ç³»ç»Ÿè·¯å¾„ä¸Šçš„æŸä¸ªä½ç½®ã€‚ä¾‹å¦‚ï¼Œåœ¨Linuxä¸Š:

```shell
$ curl -L https://github.com/golang-migrate/migrate/releases/download/v4.14.1/migrate.linux-amd64.tar.gz | tar xvz 
$ mv migrate.linux-amd64 $GOPATH/bin/migrate
```

åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·æ£€æŸ¥å®ƒæ˜¯å¦å¯ç”¨ï¼Œåœ¨æ‚¨çš„æœºå™¨ä¸Šè¿è¡Œï¼Œå°è¯•ä½¿ç”¨-versionå‘½ä»¤è¡Œå‚æ•°æ‰§è¡ŒmigrateäºŒè¿›åˆ¶æ–‡ä»¶ã€‚å®ƒè¾“å‡ºå½“å‰ç‰ˆæœ¬å·ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```shell
$ migrate -version
4.14.1
```
## ä½¿ç”¨SQLè¿ç§»

ç°åœ¨å·²ç»å®‰è£…äº†è¿ç§»å·¥å…·ï¼Œè®©æˆ‘ä»¬é€šè¿‡åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„moviesè¡¨æ¥æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨å®ƒã€‚

é¦–å…ˆä½¿ç”¨migrate createåˆ›å»ºä¸€å¯¹è¿ç§»æ–‡ä»¶ã€‚è·Ÿéšæœ¬ä¹¦åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```shell
$ migrate create -seq -ext=.sql -dir=./migrations create_movies_table
/Users/wangmingjun/Projects/greenlight/migrations/000001_create_movies_table.up.sql
/Users/wangmingjun/Projects/greenlight/migrations/000001_create_movies_table.down.sql
```

åœ¨è¿™ä¸ªå‘½ä»¤ä¸­ï¼š

* -seqå‘½ä»¤è¡Œå‚æ•°è¡¨ç¤ºï¼šæˆ‘ä»¬æƒ³è¦ä½¿ç”¨é¡ºåºç¼–å·ä¸ºè¿ç§»æ–‡ä»¶å‘½åï¼Œæ¯”å¦‚0001,0002...(è€Œä¸æ˜¯Unixæ—¶é—´æˆ³ï¼Œè¿™æ˜¯é»˜è®¤å€¼)ã€‚
* -extå‘½ä»¤è¡Œå‚æ•°è¡¨ç¤ºï¼šè¿ç§»æ–‡ä»¶ä½¿ç”¨.sqlæ‰©å±•åã€‚
* -dirè¡¨ç¤ºï¼šåˆ›å»ºçš„è¿ç§»æ–‡ä»¶å­˜æ”¾ç›®å½•ã€‚ï¼ˆå¦‚æœç›®å½•ä¸å­˜åœ¨å°±ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
* create_movies_tableæ˜¯ä¸€ä¸ªæè¿°æ€§çš„æ ‡ç­¾ï¼Œä¾¿äºè¯†åˆ«è¿ç§»æ–‡ä»¶çš„å†…å®¹ã€‚

ç°åœ¨è¿›å…¥migrationsç›®å½•ï¼Œä½ å°†çœ‹åˆ°ä¸€å¯¹æ–°å»ºå¯¹"up"å’Œâ€œdownâ€è¿ç§»æ–‡ä»¶ï¼š

```shell
./migrations/
â”œâ”€â”€ 000001_create_movies_table.down.sql 
â””â”€â”€ 000001_create_movies_table.up.sql
```

æ­¤æ—¶è¿™ä¸¤ä¸ªæ–‡ä»¶è¿˜æ˜¯ç©ºçš„ã€‚ä¸‹é¢æˆ‘ä»¬ç¼–è¾‘'up'è¿ç§»æ–‡ä»¶ï¼Œæ·»åŠ CREATE TABLEè¯­å¥æ¥åˆ›å»ºmoviesè¡¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

File: imgrations/000001_create_movies_table.up.sql

---

```sql
CREATE TABLE IF NOT EXISTS movies (
id bigserial PRIMARY KEY,
created_at timestamp(0) with time zone NOT NULL DEFAULT NOW(), title text NOT NULL,
year integer NOT NULL,
runtime integer NOT NULL,
genres text[] NOT NULL,
version integer NOT NULL DEFAULT 1
);
```

æ³¨æ„è¿™ä¸ªè¡¨ä¸­çš„å­—æ®µå’Œç±»å‹ä¸æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„Movieç»“æ„ä¸­çš„å­—æ®µå’Œç±»å‹ç›¸ä¼¼å—ï¼Ÿè¿™å¾ˆé‡è¦ï¼Œå› ä¸ºè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å°†moviesè¡¨ä¸­çš„æ¯ä¸€è¡Œæ•°æ®æ˜ å°„åˆ°Goä»£ç ä¸­çš„å•ä¸ªMovieç»“æ„ä½“ã€‚

å¦‚æœæ‚¨å¯¹ä¸Šé¢SQLè¯­å¥ä¸­çš„ä¸åŒPostgreSQLæ•°æ®ç±»å‹ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/current/datatype.html)ï¼Œä¸Šé¢æä¾›äº†å…¨é¢çš„æ¦‚è¿°ã€‚ä½†éœ€è¦æŒ‡å‡ºçš„æœ€é‡è¦çš„äº‹æƒ…æ˜¯:

* idåˆ—ç±»ä¼¼ä¸º[bigserial](https://www.postgresql.org/docs/12/datatype-numeric.html#DATATYPE-NUMERIC-TABLE)å®ƒæ˜¯ä¸€ä¸ª64ä½è‡ªå¢æ•´æ•°ï¼Œä»1å¼€å§‹æ˜¯è¡¨çš„ä¸»é”®ã€‚
* genresåˆ—ç±»å‹ä¸ºtext[]ï¼Œæ˜¯ä¸€ä¸ªåŒ…å«é›¶ä¸ªæˆ–å¤šä¸ªtextå€¼æ•°ç»„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPostgreSQLä¸­çš„æ•°ç»„æœ¬èº«æ˜¯å¯æŸ¥è¯¢å’Œå¯ç´¢å¼•çš„ï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬å°†åœ¨æœ¬ä¹¦çš„åé¢è¿›è¡Œæ¼”ç¤ºã€‚
* åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨æ¯ä¸ªåˆ—ä¸Šè®¾ç½®NOT NULLçº¦æŸå’Œé€‚å½“çš„é»˜è®¤å€¼æ˜¯æœ€ç®€å•çš„â€”â€”å°±åƒæˆ‘ä»¬ä¸Šé¢æ‰€åšçš„é‚£æ ·ã€‚
* å¯¹äºå­˜å‚¨å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬ä½¿ç”¨æ–‡æœ¬ç±»å‹ï¼Œè€Œä¸æ˜¯varcharæˆ–varchar(n)ç±»å‹ã€‚å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œè¿™ç¯‡[åšæ–‡](https://www.depesz.com/2010/03/02/charx-vs-varcharx-vs-varchar-vs-text/)è§£é‡Šäº†ä¸ºä»€ä¹ˆæ–‡æœ¬é€šå¸¸æ˜¯PostgreSQLä¸­ä½¿ç”¨çš„æœ€ä½³å­—ç¬¦ç±»å‹ã€‚

å¥½äº†ï¼Œè®©æˆ‘ä»¬ç»§ç»­â€œdownâ€è¿ç§»ï¼Œå¹¶æ·»åŠ å¯¹åº”çš„SQLè¯­å¥æ¥å›é€€æˆ‘ä»¬åˆšåˆšç¼–å†™çš„â€œupâ€è¿ç§»ã€‚

File: migrations/000001_create_movies_table.down.sql

---

```sql
DROP TABLE IF EXISTS movies;
```

åœ¨PostgreSQLä¸­ï¼ŒDROP TABLEå‘½ä»¤æ˜¯åˆ é™¤è¡¨ä¸­å­˜åœ¨çš„æ‰€æœ‰ç´¢å¼•å’Œçº¦æŸï¼Œæ‰€ä»¥è¿™ä¸€æ¡è¯­å¥å°±è¶³ä»¥é€†è½¬ä¸Šé¢å¯¹â€œupâ€æ“ä½œã€‚

okï¼Œå‰é¢æ˜¯æˆ‘ä»¬å‡†å¤‡å¥½çš„ç¬¬ä¸€å¯¹è¿ç§»æ–‡ä»¶!

åŒæ—¶ï¼Œè®©æˆ‘ä»¬åˆ›å»ºç¬¬äºŒä¸ªå¯¹å«[CHECK](https://www.postgresql.org/docs/9.4/ddl-constraints.html)çº¦æŸçš„è¿ç§»æ–‡ä»¶ï¼Œåœ¨æ•°æ®åº“çº§åˆ«ä¸Šå¼ºåˆ¶æ‰§è¡Œä¸€äº›ä¸šåŠ¡è§„åˆ™ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›ç¡®ä¿runtimeå€¼æ€»æ˜¯å¤§äºé›¶ï¼Œyearå€¼åœ¨1888å’Œå½“å‰å¹´ä»½ä¹‹é—´ï¼Œå¹¶ä¸”genresæ•°ç»„æ€»æ˜¯åŒ…å«1åˆ°5ä¸ªæ¡ç›®ã€‚

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºç¬¬äºŒå¯¹è¿ç§»æ–‡ä»¶ï¼š

```shell
$ migrate create -seq -ext=.sql -dir=./migrations add_movies_check_constrains

/Users/wangmingjun/Projects/greenlight/migrations/000002_add_movies_check_constrains.up.sql
/Users/wangmingjun/Projects/greenlight/migrations/000002_add_movies_check_constrains.down.sql

```

ç„¶åæ·»åŠ ä»¥ä¸‹SQLè¯­å¥ï¼Œåˆ†åˆ«æ·»åŠ å’Œåˆ é™¤CHECKçº¦æŸ:

File: migrations/000002_add_movies_check_constraints.up.sql

---

```sql
ALTER TABLE movies ADD CONSTRAINT movies_runtime_check CHECK (runtime >= 0);
ALTER TABLE movies ADD CONSTRAINT movies_year_check CHECK (year BETWEEN 1888 AND date_part('year', now()));
ALTER TABLE movies ADD CONSTRAINT genres_length_check CHECK (array_length(genres, 1) BETWEEN 1 AND 5);
```

File: File: migrations/000002_add_movies_check_constraints.down.sql

---

```sql
ALTER TABLE movies DROP CONSTRAINT IF EXISTS movies_runtime_check;
ALTER TABLE movies DROP CONSTRAINT IF EXISTS movies_year_check;
ALTER TABLE movies DROP CONSTRAINT IF EXISTS genres_check;
```

å½“æˆ‘ä»¬åœ¨moviesè¡¨ä¸­æ’å…¥æˆ–æ›´æ–°æ•°æ®æ—¶ï¼Œå¦‚æœè¿™äº›æ£€æŸ¥å¤±è´¥ï¼Œæˆ‘ä»¬çš„æ•°æ®åº“é©±åŠ¨ç¨‹åºå°†è¿”å›ç±»ä¼¼è¿™æ ·çš„é”™è¯¯:

```shell
pq: new row for relation "movies" violates check constraint "movies_year_check"
```

> æ³¨æ„:å•ä¸ªè¿ç§»æ–‡ä»¶åŒ…å«å¤šä¸ªSQLè¯­å¥æ˜¯å®Œå…¨å¯ä»¥çš„ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šé¢çš„ä¸¤ä¸ªæ–‡ä»¶ä¸­çœ‹åˆ°çš„é‚£æ ·ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬æœ¬å¯ä»¥åœ¨ç¬¬ä¸€å¯¹è¿ç§»æ–‡ä»¶ä¸­åŒ…å«CHECKçº¦æŸå’ŒCREATE TABLEè¯­å¥ï¼Œä½†æ˜¯å‡ºäºæœ¬ä¹¦çš„ç›®çš„ï¼Œå°†å®ƒä»¬æ”¾åœ¨å•ç‹¬çš„ç¬¬äºŒæ¬¡è¿ç§»ä¸­å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¯´æ˜è¿ç§»å·¥å…·æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

#### æ‰§è¡Œè¿ç§»

ç°åœ¨æˆ‘ä»¬å‡†å¤‡åœ¨greenlightæ•°æ®åº“ä¸Šè¿è¡Œä¸¤ä¸ªâ€œupâ€è¿ç§»ã€‚

å¦‚æœæ‚¨è·Ÿéšå‰é¢çš„æ­¥éª¤è¿›è¡Œæ“ä½œï¼Œé‚£ä¹ˆä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ‰§è¡Œè¿ç§»ï¼Œå¹¶ä»æ‚¨çš„ç¯å¢ƒå˜é‡ä¼ å…¥æ•°æ®åº“DSNã€‚å¦‚æœä¸€åˆ‡éƒ½é…ç½®æ­£ç¡®ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ä¸€äº›è¾“å‡ºï¼Œç¡®è®¤è¿ç§»å·²ç»æˆåŠŸæ‰§è¡Œã€‚ç±»ä¼¼äº:

```shell
$ migrate -path=./migrations -database=$GREENLIGHT_DB_DSN up
1/u create_movies_table (48.079834ms)
2/u add_movies_check_constrains (71.984417ms)
```

æ­¤æ—¶ï¼Œä½ ä½¿ç”¨psqlè¿æ¥åˆ°æ•°æ®åº“ï¼Œå¹¶ä½¿ç”¨\dtå‘½ä»¤åˆ—å‡ºåˆšåˆ›å»ºå¯¹è¡¨:

```shell
$ psql $GREENLIGHT_DB_DSN
psql (13.4)
Type "help" for help.

greenlight=> \dt
                 List of relations
 Schema |       Name        |   Type   |   Owner  
--------+-------------------+----------+------------
 public | movies            | table    | greenlight
 public | schema_migrations | table    | greenlight
(2 rows)
```

æ‚¨åº”è¯¥çœ‹åˆ°å·²ç»åˆ›å»ºäº†moviesè¡¨å’Œschema_migrationsè¡¨ï¼Œè¿™ä¸¤ä¸ªè¡¨éƒ½ç”±greenlightç”¨æˆ·æ‹¥æœ‰ã€‚

schema_migrationsè¡¨æ˜¯ç”±è¿ç§»å·¥å…·è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œç”¨äºè·Ÿè¸ªå“ªäº›è¿ç§»å·²ç»ç”Ÿæ•ˆã€‚è®©æˆ‘ä»¬å¿«é€Ÿæµè§ˆä¸€ä¸‹å®ƒçš„è¡¨å†…å®¹:

```shell
greenlight=> select * from schema_migrations;
 version | dirty 
---------+-------
       2 | f
(1 row)
```

è¿™é‡Œçš„versionåˆ—è¡¨æ˜å·²ç»åœ¨æ•°æ®åº“ä¸Šæ‰§è¡Œäº†(åŒ…æ‹¬)åºåˆ—æ–‡ä»¶ä¸­çš„ç¬¬2ä¸ªè¿ç§»æ–‡ä»¶ã€‚dirtyåˆ—çš„å€¼ä¸ºfalseï¼Œè¿™è¡¨æ˜è¿ç§»æ–‡ä»¶è¢«å¹²å‡€åœ°æ‰§è¡Œï¼Œæ²¡æœ‰ä»»ä½•é”™è¯¯ï¼Œå…¶ä¸­åŒ…å«çš„SQLè¯­å¥å…¨éƒ¨æˆåŠŸåœ°æ‰§è¡Œã€‚

å¦‚æœæ‚¨æ„¿æ„ï¼Œè¿˜å¯ä»¥åœ¨moviesè¡¨ä¸Šè¿è¡Œ\då‘½ä»¤æŸ¥çœ‹è¡¨ç»“æ„ï¼Œå¹¶ç¡®è®¤CHECKçº¦æŸå·²æ­£ç¡®åˆ›å»ºã€‚åƒè¿™æ ·:

```shell
greenlight=> \d movies;
                                        Table "public.movies"
  Column   |            Type             | Collation | Nullable |              Default       
-----------+-----------------------------+-----------+----------+------------------------------------
 id        | bigint                      |           | not null | nextval('movies_id_seq'::regclass)
 create_at | timestamp(0) with time zone |           | not null | now()
 title     | text                        |           | not null | 
 year      | integer                     |           | not null | 
 runtime   | integer                     |           | not null | 
 genres    | text[]                      |           | not null | 
 version   | integer                     |           | not null | 1
Indexes:
    "movies_pkey" PRIMARY KEY, btree (id)
Check constraints:
    "genres_length_check" CHECK (array_length(genres, 1) >= 1 AND array_length(genres, 1) <= 5)
    "movies_runtime_check" CHECK (runtime >= 0)
    "movies_year_check" CHECK (year >= 1888 AND year::double precision <= date_part('year'::text, now()))
```

#### é™„åŠ å†…å®¹

##### è¿ç§»åˆ°æŒ‡å®šç‰ˆæœ¬

æŸ¥çœ‹schema_migrationsè¡¨çš„å¦ä¸€ç§æ–¹æ³•ï¼šå¦‚æœæ‚¨æƒ³æŸ¥çœ‹æ‚¨çš„æ•°æ®åº“å½“å‰å¤„äºå“ªä¸ªè¿ç§»ç‰ˆæœ¬ï¼Œæ‚¨å¯ä»¥è¿è¡Œè¿ç§»å·¥å…·çš„versionå‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```shell
$ migrate -path=./migrations -database=$GREENLIGHT_DB_DSN version
2
```

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨gotoå‘½ä»¤å‘ä¸Šæˆ–å‘ä¸‹è¿ç§»åˆ°ä¸€ä¸ªç‰¹å®šçš„ç‰ˆæœ¬:

```shell
$ greenlight migrate -path=./migrations -database=$GREENLIGHT_DB_DSN goto 1 
2/d add_movies_check_constrains (41.570125ms)
$ greenlight migrate -path=./migrations -database=$GREENLIGHT_DB_DSN version
1
```

##### æ‰§è¡Œå›é€€

å¯ä»¥ä½¿ç”¨downå‘½ä»¤å›æ»šç‰¹å®šç‰ˆæœ¬çš„è¿ç§»ã€‚ä¾‹å¦‚ï¼Œè¦å›æ»šæœ€è¿‘çš„è¿ç§»ï¼Œä½ éœ€è¦è¿è¡Œ:

```shell
 $ migrate -path=./migrations -database =$EXAMPLE_DSN down 1
```

å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘é€šå¸¸æ›´å–œæ¬¢ä½¿ç”¨gotoå‘½ä»¤æ¥æ‰§è¡Œå›æ»š(å› ä¸ºå®ƒå¯¹ç›®æ ‡ç‰ˆæœ¬æ›´æ˜ç¡®)ï¼Œå¹¶ä¿ç•™ä½¿ç”¨downå‘½ä»¤æ¥å›æ»šæ‰€æœ‰è¿ç§»ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```shell
$ migrate -path=./migrations -database=$GREENLIGHT_DB_DSN down
Are you sure you want to apply all down migrations? [y/N]
y
Applying all down migrations
2/d add_movies_check_constrains (27.182625ms)
1/d create_movies_table (37.182834ms)
```

å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨dropå‘½ä»¤ï¼Œå®ƒå°†ä»æ•°æ®åº“ä¸­åˆ é™¤æ‰€æœ‰è¡¨ï¼ŒåŒ…æ‹¬schema_migrationsè¡¨â€”â€”ä½†æ˜¯æ•°æ®åº“æœ¬èº«ä»¥åŠå·²ç»åˆ›å»ºçš„åºåˆ—å’Œæšä¸¾ç­‰å…¶ä»–å†…å®¹å°†ä¿ç•™ä¸‹æ¥ã€‚å› æ­¤ï¼Œä½¿ç”¨dropå¯èƒ½ä¼šä½¿æ•°æ®åº“å¤„äºæ··ä¹±å’ŒæœªçŸ¥çš„çŠ¶æ€ï¼Œå¦‚æœæ‚¨æƒ³è¦å›æ»šæ‰€æœ‰å†…å®¹ï¼Œé€šå¸¸æœ€å¥½ä½¿ç”¨downå‘½ä»¤ã€‚

##### ä¿®æ”¹SQLè¿ç§»é”™è¯¯

ç†è§£åœ¨SQLè¿ç§»æ–‡ä»¶ä¸­å‡ºç°è¯­æ³•é”™è¯¯æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆæ˜¯å¾ˆé‡è¦çš„ï¼Œå› ä¸ºè¿ç§»å·¥å…·å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ä»¤äººè´¹è§£å¯¹ç»“æœã€‚

å½“è¿è¡Œæœ‰é”™è¯¯çš„è¿ç§»æ—¶ï¼Œè¯¥é”™è¯¯åç»­æ‰€æœ‰SQLè¯­å¥éƒ½ä¼šå½±å“ï¼Œç„¶åè¿ç§»å·¥å…·å°†é€€å‡ºå¹¶æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚ç±»ä¼¼äº:

```shell
$ migrate -path=./migrations -database=$EXAMPLE_DSN up
1/u create_foo_table (36.6328ms)
2/u create_bar_table (71.835442ms)
error: migration failed: syntax error at end of input in line 0: CREATE TABLE (details: pq: syntax error at end of input)
```

å¦‚æœè¿ç§»çš„å¤±è´¥æ–‡ä»¶åŒ…å«å¤šä¸ªSQLè¯­å¥ï¼Œé‚£ä¹ˆå¯èƒ½æ˜¯åœ¨é‡åˆ°é”™è¯¯ä¹‹å‰éƒ¨åˆ†SQLæ“ä½œå·²ç»ç”Ÿæ•ˆã€‚åè¿‡æ¥ï¼Œå°±è¿ç§»å·¥å…·è€Œè¨€ï¼Œè¿™æ„å‘³ç€æ•°æ®åº“å¤„äºæœªçŸ¥çŠ¶æ€ã€‚

å› æ­¤ï¼Œschema_migrationså­—æ®µä¸­çš„versionå­—æ®µå°†åŒ…å«å¤±è´¥è¿ç§»çš„ç¼–å·ï¼Œdirtyå­—æ®µå°†è¢«è®¾ç½®ä¸ºtrueã€‚æ­¤æ—¶ï¼Œå¦‚æœä½ è¿è¡Œå¦ä¸€ä¸ªè¿ç§»(å³ä½¿æ˜¯â€œå‘ä¸‹â€è¿ç§»)ï¼Œä½ å°†ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„é”™è¯¯æ¶ˆæ¯:

```shell
 Dirty database version {X}. Fix and force version.
```

æ‚¨éœ€è¦åšçš„æ˜¯æ£€æŸ¥é”™è¯¯åŸå› ï¼Œå¹¶ç¡®å®šå¤±è´¥çš„è¿ç§»æ–‡ä»¶æ˜¯å¦éƒ¨åˆ†å·²ç»ç”Ÿæ•ˆã€‚å¦‚æœæ˜¯ï¼Œé‚£ä¹ˆæ‚¨éœ€è¦æ‰‹åŠ¨å›æ»šéƒ¨åˆ†ç”Ÿæ•ˆçš„è¿ç§»ã€‚

å®Œæˆä¹‹åï¼Œè¿˜å¿…é¡»å°†schema_migrationsè¡¨ä¸­çš„ç‰ˆæœ¬å·â€œå¼ºåˆ¶â€è®¾ç½®ä¸ºæ­£ç¡®çš„å€¼ã€‚ä¾‹å¦‚ï¼Œè¦è®¾ç½®æ•°æ®åº“ç‰ˆæœ¬å·ä¸º1ï¼Œä½ åº”è¯¥åƒè¿™æ ·ä½¿ç”¨forceå‘½ä»¤:

```shell
 $ migrate -path=./migrations -database=$EXAMPLE_DSN force 1
```

ä¸€æ—¦æ‚¨å¼ºåˆ¶è®¾ç½®ç‰ˆæœ¬ï¼Œæ•°æ®åº“è¢«è®¤ä¸ºæ˜¯â€œå¹²å‡€çš„â€ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿå†æ¬¡è¿è¡Œè¿ç§»è€Œæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚

#### è¿œç¨‹è¿ç§»æ–‡ä»¶

migrateå·¥å…·è¿˜æ”¯æŒä»è¿œç¨‹æº(åŒ…æ‹¬Amazon S3å’ŒGitHubå­˜å‚¨åº“)è¯»å–è¿ç§»æ–‡ä»¶ã€‚ä¾‹å¦‚:

```shell
$ migrate -source="s3://<bucket>/<path>" -database=$EXAMPLE_DSN up
$ migrate -source="github://owner/repo/path#ref" -database=$EXAMPLE_DSN up
$ migrate -source="github://user:personal-access-token@owner/repo/path#ref" -database=$EXAMPLE_DSN up
```

å…³äºæ­¤åŠŸèƒ½çš„æ›´å¤šä¿¡æ¯å’Œæ”¯æŒçš„è¿œç¨‹sourcesçš„å®Œæ•´åˆ—è¡¨å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/golang-migrate/migrate#migration-sources)æ‰¾åˆ°ã€‚

#### åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œè¿ç§»

å¦‚æœæ‚¨æ„¿æ„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨[golang-migrate/migrate](https://github.com/golang-migrate/migrate) GoåŒ…(ä¸æ˜¯å‘½ä»¤è¡Œå·¥å…·)åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œæ•°æ®åº“è¿ç§»ã€‚

åœ¨æœ¬ä¹¦ä¸­æˆ‘ä»¬ä¸ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæ‰€ä»¥å¦‚æœæ‚¨éµå¾ªæœ¬æ–‡ï¼Œè¯·ä¸è¦æ›´æ”¹æ‚¨çš„ä»£ç ã€‚ä½†å¤§è‡´ä¸Šä»£ç æ˜¯è¿™æ ·çš„:

```go
package main

...

func main() {

   ...

    db, err := openDB(cfg)
    if err != nil {
        logger.Fatal(err, nil)
    }
    defer db.Close()

    logger.Info("database connection pool established", nil)

    migrationDriver, err := postgres.WithInstance(db, &postgres.Config{})
    if err != nil {
        logger.Fatal(err, nil)
    }

    migrator, err := migrate.NewWithDatabaseInstance("file:///path/to/your/migrations", "postgres", migrationDriver)
    if err != nil {
        logger.Fatal(err, nil)
    }

    err = migrator.up()
    if err != nil && err != migrator.ErrNoChange {
        logger.Fatal(err, nil)
    }

    logger.Printf("database migrations apply")
}
```

è™½ç„¶è¿™æ˜¯å¯è¡Œçš„(çœ‹èµ·æ¥å¾ˆæœ‰å¸å¼•åŠ›)ï¼Œä½†æ˜¯ä»é•¿è¿œæ¥çœ‹ï¼Œè¿ç§»çš„æ‰§è¡Œä¸åº”ç”¨ç¨‹åºæºä»£ç çš„ç´§å¯†è€¦åˆå¯èƒ½ä¼šäº§ç”Ÿé™åˆ¶å’Œé—®é¢˜ã€‚

[å°†æ•°æ®åº“è¿ç§»ä¸æœåŠ¡å™¨å¯åŠ¨åˆ†ç¦»](https://pythonspeed.com/articles/schema-migrations-server-startup/)è¿™ç¯‡æ–‡ç« å¯¹æ­¤è¿›è¡Œäº†å¾ˆå¥½çš„è®¨è®ºï¼Œå¦‚æœæ‚¨æ„Ÿå…´è¶£ï¼Œæˆ‘å»ºè®®æ‚¨é˜…è¯»è¿™ç¯‡æ–‡ç« ã€‚å®ƒä»¥Pythonä¸ºä¸­å¿ƒï¼Œä½†ä¸è¦å› æ­¤è€Œå´æ­¥â€”â€”åŒæ ·çš„åŸåˆ™ä¹Ÿé€‚ç”¨äºGoåº”ç”¨ç¨‹åºã€‚
## SQLè¿ç§»

æœ¬ä¹¦çš„ä¸‹ä¸€éƒ¨åˆ†æˆ‘ä»¬å°†å›åˆ°ä¸€äº›æ›´å…·ä½“çš„ä»£ç å®è·µä¸­ï¼Œå¹¶ä¸€æ­¥æ­¥åœ¨greenlightæ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªmovieè¡¨ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬åªéœ€ä½¿ç”¨psqlå·¥å…·ç„¶åæ‰§è¡Œå¿…è¦çš„CREATE TABLEè¯­å¥ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¦‚ä½•ä½¿ç”¨SQLè¿ç§»æ¥åˆ›å»ºè¡¨(æ›´ä¸€èˆ¬åœ°è¯´ï¼Œç®¡ç†æ•´ä¸ªé¡¹ç›®ä¸­æ•°æ®åº“æ¨¡å¼æ›´æ”¹)ã€‚

ä½ å°†å­¦ä¹ åˆ°ï¼š

* SQLè¿ç§»èƒŒåçš„åŸåˆ™ä»¥åŠå®ƒä»¬ä¸ºä»€ä¹ˆæœ‰ç”¨ã€‚
* å¦‚ä½•ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ä»¥ç¼–ç¨‹æ–¹å¼ç®¡ç†æ•°æ®åº“æ¨¡å¼çš„æ›´æ”¹ã€‚
## å»ºç«‹movieæ¨¡å‹

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä¸ºæˆ‘ä»¬çš„movieæ•°æ®åº“æ¨¡å‹è®¾ç½®ä»£ç æ¡†æ¶ã€‚

å¦‚æœæ‚¨ä¸å–œæ¬¢æ¨¡å‹è¿™ä¸ªæœ¯è¯­ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥å°†å…¶è§†ä¸ºæ•°æ®è®¿é—®æˆ–å­˜å‚¨å±‚ã€‚ä½†ä¸ç®¡ä½ å–œæ¬¢æ€ä¹ˆç§°å‘¼ï¼ŒåŸç†éƒ½æ˜¯ä¸€æ ·çš„â€”â€”å®ƒå°è£…äº†æ‰€æœ‰ä»PostgreSQLæ•°æ®åº“ä¸­è¯»å–å’Œå†™å…¥movieæ•°æ®çš„ä»£ç ã€‚

æˆ‘ä»¬å›åˆ°internal/data/movies.goæ–‡ä»¶ï¼Œåˆ›å»ºMovieModelç»“æ„ä½“ç±»å‹ä»¥åŠä¸€äº›å¯¹movieæ•°æ®åº“è¡¨æ‰§è¡ŒCURDï¼ˆcreateï¼Œreadï¼Œupdateå’Œdeleteï¼‰æ“ä½œã€‚

Fileï¼šinternal/data/movies.go

---

```go
package data

import (
	"database/sql"
	"encoding/json"
	"fmt"
	"time"

	"greenlight.alexedwards.net/internal/validator"
)

...

//å®šä¹‰MovieModelç»“æ„ä½“ï¼ŒåŒ…å«ä¸€ä¸ªsql.DBè¿æ¥æ± å­—æ®µ
type MovieModel struct {
	DB *sql.DB
}

//æ·»åŠ ä¸€ä¸ªå ä½ç¬¦æ–¹æ³•ï¼Œç”¨äºåœ¨moviesè¡¨ä¸­æ’å…¥ä¸€æ¡æ–°è®°å½•ã€‚
func (m MovieModel)Insert(movie *Movie) error {
	return nil
}

//Get æŸ¥è¯¢ç‰¹å®šmovieæ–¹æ³•
func (m MovieModel)Get(id int64) (*Movie, error) {
	return nil, nil
}

//Update æ›´æ–°æ•°æ®åº“ç‰¹å®šmovie
func (m MovieModel)Update(movie *Movie) error {
	return nil
}

//Delete åˆ é™¤æ•°æ®åº“ä¸­ç‰¹å®šmovie
func (m MovieModel)Delete(id int64) error {
	return nil
}
```

å¦å¤–ï¼Œæˆ‘ä»¬å°†MovieModelåŒ…è£…åœ¨ä¸€ä¸ªModelsç»“æ„ä¸­ã€‚è¿™ä¹ˆåšå®Œå…¨æ˜¯å¯é€‰çš„ï¼Œä½†å®ƒçš„å¥½å¤„æ˜¯å¯ä»¥ä¸ºé¡¹ç›®ä¸­æ‰€æœ‰éœ€è¦å­˜å‚¨æ•°æ®åº“çš„æ¨¡å‹é›†ä¸­ç®¡ç†ã€‚

åˆ›å»ºinternal/data/models.goæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```shell
$ touch internal/data/models.go
```

File: internal/data/models.go

---

```go
package data

import (
	"database/sql"
	"errors"
)

//è‡ªå®šä¹‰é”™è¯¯ErrRecordNotFoundå¸¸é‡ã€‚åœ¨Get()æ–¹æ³•ä¸­å¦‚æœæŸ¥è¯¢çš„moiveæ•°æ®åº“ä¸­ä¸å­˜åœ¨å°±è¿”å›è¯¥é”™è¯¯ã€‚
var (
	ErrRecordNotFound = errors.New("record not found")
)

// Modelsç»“æ„ä½“åŒ…è£…MovieModelã€‚åé¢ä¼šå°†æ‰€æœ‰å…¶ä»–modelséƒ½æ·»åŠ åˆ°è¿™ä¸ªç»“æ„ä½“ä¸­ã€‚
type Models struct {
	Movies MovieModel
}

//ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªNew()æ–¹æ³•ï¼Œå®ƒè¿”å›ä¸€ä¸ªModelsç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«åˆå§‹åŒ–çš„MovieModelã€‚
func NewModels(db *sql.DB) Models {
	return Models{
		Movies: MovieModel{DB: db},
	}
}
```

æ¥ä¸‹æ¥ï¼Œç¼–è¾‘cmd/api/main.goæ–‡ä»¶ï¼Œåœ¨mainå‡½æ•°ä¸­åˆå§‹åŒ–Modelsç»“æ„ä½“å®ä¾‹ï¼Œä½œä¸ºä¾èµ–é¡¹ä¼ é€’ç»™æˆ‘ä»¬çš„å¤„ç†ç¨‹åºã€‚åƒè¿™æ ·:

```go
package main

import (
	"context"
	"database/sql"
	"flag"
	"greenlight.alexedwards.net/internal/data"
	"os"
	"time"

	_ "github.com/lib/pq"
	"greenlight.alexedwards.net/internal/jsonlog"
)

...

//æ·»åŠ modelså­—æ®µ
type application struct {
	config config
	logger *jsonlog.Logger
	models data.Models
}

/ æ·»åŠ modelså­—æ®µï¼Œå¼•å…¥æ•°æ®åº“æ¨¡å‹ä¸ºæ¥å£å¤„ç†ç¨‹åºæ‰€ç”¨
app := &application {
	config: cfg,
	logger: logger,
	models: data.NewModels(db),
}

...
```

ç°åœ¨ä½ å¯ä»¥é‡å¯åº”ç”¨ç¨‹åºã€‚ä»¥ä¸Šä»£ç å¯ä»¥æ­£å¸¸ç¼–è¯‘å’Œè¿è¡Œã€‚

```shell
$ go run ./cmd/api
2021/11/28 21:01:22 database connection pool established 
2021/11/28 21:01:22 starting development server on :4000
```

è¿™ä¸ªæ¨¡å¼çš„ä¼˜ç‚¹ä¹‹ä¸€æ˜¯ï¼Œä»APIå¤„ç†ç¨‹åºçš„è§’åº¦æ¥çœ‹ï¼Œåœ¨movieè¡¨ä¸Šæ‰§è¡Œæ“ä½œçš„ä»£ç éå¸¸æ¸…æ™°ä¸”å¯è¯»ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°é€šè¿‡ä»¥ä¸‹ä»£ç æ¥æ‰§è¡ŒInsert()æ–¹æ³•:

```go
app.models.Movie.Insert(...)
```

é€šç”¨ç»“æ„ä½“ä¹Ÿå¾ˆå®¹æ˜“æ‰©å±•ã€‚ä»¥ååˆ›å»ºæ›´å¤šçš„æ•°æ®åº“æ¨¡å‹æ—¶ï¼Œæ‰€è¦åšçš„å°±æ˜¯å°†å®ƒä»¬æ·»åŠ åˆ°modelsç»“æ„ä½“ä¸­ï¼Œå°†è‡ªåŠ¨åœ¨APIå¤„ç†ç¨‹åºä¸­å¯ç”¨ã€‚

## é™„åŠ å†…å®¹

#### Mocking models

é€šè¿‡å¯¹è¯¥æ¨¡å¼è¿›è¡Œå°è°ƒæ•´ï¼Œè¿˜å¯ä»¥ä¸ºå•å…ƒæµ‹è¯•è€Œmockæ•°æ®åº“æ¨¡å‹ã€‚ä½†æ˜¯ä½œä¸ºä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªç±»ä¼¼äºä¸‹é¢è¿™æ ·çš„MockMovieModelç»“æ„æ:

File: internal/data/movies.go

---

```go
package main

...

type MockMovieModel struct {}

func (m MockMovieModel)Insert(movie *Movie) error {
	//Mockæ“ä½œ
	return nil
}

func (m MockMovieModel)Update(movie *Movie) error {
	//Mockæ“ä½œ
	return nil
}

func (m MockMovieModel)Delete(id int64) error {
	//Mockæ“ä½œ
	return nil
}

```

ç„¶åæ›´æ–°internal/data/models.goæ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

Fileï¼šinternal/data/models.go

---

```go
package data

import (
	"database/sql"
	"errors"
)

var (
	ErrRecordNotFound = errors.New("record not found")
)

type Models struct {
        //å°†Movieså­—æ®µè®¾ç½®ä¸ºæ¥å£ç±»å‹ï¼Œæ”¯æŒmodelå’Œmockmodelèµ‹å€¼
	Movies interface {
		Insert(movie *Movie) error
		Get(id int64) (*Movie, error)
		Update(movie *Movie) error
		Delete(id int64) error
	}
}

...

//åˆ›å»ºä¸€ä¸ªnewå‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«mock Modelså®ä¾‹
func NewMockModels() Models {
	return Models{Movies: MockMovieModel{}}
}
```

åªè¦åœ¨å•å…ƒæµ‹è¯•ä¸­ç”¨NewMockModels()æ¥ä»£æ›¿â€œçœŸæ­£çš„â€NewModels()å‡½æ•°ï¼Œå°±å¯ä»¥è°ƒç”¨å®ƒã€‚
## åˆ›å»ºæ–°çš„movieæ¥å£

ä»æ•°æ®åº“æ¨¡å‹çš„Insert()æ–¹æ³•å¼€å§‹ï¼Œæ›´æ–°è¯¥æ–¹æ³•ä¸ºåœ¨moviesè¡¨ä¸­åˆ›å»ºä¸€æ¡æ–°è®°å½•ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒæ‰§è¡Œä»¥ä¸‹SQLæŸ¥è¯¢:

```sql
INSERT INTO movies (title, year, runtime, genres) 
VALUES ($1, $2, $3, $4)
RETURNING id, created_at, version
```

å…³äºè¿™ä¸ªæŸ¥è¯¢ï¼Œæœ‰ä¸€äº›äº‹æƒ…å€¼å¾—è§£é‡Šä¸€ä¸‹ã€‚

* ä½¿ç”¨$Nç¬¦å·ä½œä¸ºå ä½ç¬¦ï¼Œè¡¨ç¤ºæˆ‘ä»¬æƒ³è¦æ’å…¥moviesè¡¨ä¸­çš„æ•°æ®å‚æ•°ã€‚æ¯æ¬¡å®¢æˆ·ç«¯å‘SQLæ•°æ®åº“ä¼ é€’ä¸å¯ä¿¡çš„è¾“å…¥æ•°æ®æ—¶ï¼Œä½¿ç”¨å ä½ç¬¦å‚æ•°æ¥å¸®åŠ©é˜²æ­¢SQLæ³¨å…¥æ”»å‡»ï¼Œè¿™éå¸¸é‡è¦ï¼Œé™¤éæ‚¨æœ‰éå¸¸æ˜ç¡®çš„ç†ç”±ä¸ä½¿ç”¨å®ƒä»¬ã€‚
* åªè¦æ’å…¥titleï¼Œyearï¼Œruntimeå’Œgenresçš„å€¼ã€‚moviesè¡¨ä¸­çš„å…¶ä½™åˆ—å°†åœ¨æ’å…¥æ—¶ç”¨ç³»ç»Ÿç”Ÿæˆçš„å€¼å¡«å……â€”â€”idå°†æ˜¯ä¸€ä¸ªè‡ªåŠ¨é€’å¢çš„æ•´æ•°ï¼Œcreated_atå’Œversionåˆ†åˆ«ä»¥å½“å‰æ—¶é—´å’Œ1æ¥æ’å…¥è¡¨ä¸­ã€‚
* åœ¨æŸ¥è¯¢çš„æœ«å°¾ï¼Œæœ‰ä¸€ä¸ªreturnså­å¥ã€‚è¿™æ˜¯ä¸€ä¸ªç‰¹å®šäºpostgresqlçš„å­å¥(å®ƒä¸æ˜¯SQLæ ‡å‡†)ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒä»INSERTã€UPDATEæˆ–DELETEè¯­å¥æ‰€æ“ä½œçš„ä»»ä½•è®°å½•ä¸­è¿”å›å¯¹åº”åˆ—çš„å€¼ã€‚åœ¨è¿™ä¸ªæŸ¥è¯¢ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒæ¥è¿”å›ç³»ç»Ÿç”Ÿæˆçš„idã€created_atå’Œversionå€¼ã€‚

#### æ‰§è¡ŒSQLæŸ¥è¯¢

åœ¨æ•´ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†åšæŒä½¿ç”¨Goçš„[database/sql](https://golang.org/pkg/database/sql/)åŒ…æ¥æ‰§è¡Œæˆ‘ä»¬çš„æ•°æ®åº“æŸ¥è¯¢ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç¬¬ä¸‰æ–¹ORMæˆ–å…¶ä»–å·¥å…·ã€‚

é€šå¸¸ä½¿ç”¨Goçš„Exec()æ–¹æ³•å¯¹æ•°æ®åº“è¡¨æ‰§è¡ŒINSERTè¯­å¥ã€‚ä½†æ˜¯ç”±äºæˆ‘ä»¬çš„SQLæŸ¥è¯¢è¿”å›å•è¡Œæ•°æ®(å¤šäºäº†returningå­å¥)ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦ä½¿ç”¨QueryRow()æ–¹æ³•ã€‚

å›åˆ°internal/data/movies.goæ–‡ä»¶ï¼Œæ›´æ–°ä»£ç å¦‚ä¸‹ï¼š

Fileï¼šinternal/data/movies.go

---

```go
package data

...

//æ·»åŠ ä¸€ä¸ªå ä½ç¬¦æ–¹æ³•ï¼Œç”¨äºåœ¨moviesè¡¨ä¸­æ’å…¥ä¸€æ¡æ–°è®°å½•ã€‚
func (m MovieModel) Insert(movie *Movie) error {
	//å®šä¹‰SQLæŸ¥è¯¢ï¼Œæ’å…¥ä¸€æ¡æ–°çš„movieæ•°æ®ï¼Œå¹¶è¿”å›ç³»ç»Ÿç”Ÿæˆæ•°æ®
	query := `
    	INSERT INTO movies (title, year, runtime, genres)
        VALUES ($1, $2, $3, $4)
		RETURNING id, create_at, version`

	//åˆ›å»ºargsåˆ‡ç‰‡åŒ…å«å ä½ç¬¦å‚æ•°å€¼ã€‚å£°æ˜åˆ‡ç‰‡ä½¿å¾—ä¼ å…¥SQLä¸­çš„å€¼çœ‹èµ·æ¥æ›´æ¸…æ™°
	args := []interface{}{movie.Title, movie.Year, movie.Runtime, pq.Array(movie.Genres)}

	//åœ¨è¿æ¥æ± ä¸­ä½¿ç”¨QueryRow()æ–¹æ³•æ‰§è¡ŒSQLæŸ¥è¯¢ï¼Œä¼ å…¥argsåˆ‡ç‰‡å¯å˜å‚æ•°ï¼Œå¹¶æ‰«æç”Ÿæˆçš„Idï¼Œcreate_atå’Œversionå€¼åˆ°movieç»“æ„ä½“ä¸­
	return m.DB.QueryRow(query, args...).Scan(&movie.ID, &movie.CreateAt, &movie.Version)
}
```

è¯¥ä»£ç éå¸¸ç®€æ´ï¼Œä½†æ˜¯æœ‰ä¸€äº›é‡è¦çš„åœ°æ–¹éœ€è¦è¯´æ˜ã€‚

å› ä¸ºInsert()æ–¹æ³•ç­¾åä»¥*MovieæŒ‡é’ˆä½œä¸ºå‚æ•°ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬è°ƒç”¨Scan()æ¥è¯»å–ç³»ç»Ÿç”Ÿæˆçš„æ•°æ®æ—¶ï¼Œæˆ‘ä»¬æ­£åœ¨æ›´æ–°å‚æ•°æ‰€æŒ‡å‘çš„ä½ç½®çš„å€¼ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬çš„Insert()æ–¹æ³•æ”¹å˜äº†ä¼ é€’ç»™å®ƒçš„Movieç»“æ„ä½“ï¼Œå¹¶å°†ç³»ç»Ÿç”Ÿæˆçš„å€¼æ·»åŠ åˆ°å¯¹åº”å­—æ®µã€‚

æ¥ä¸‹æ¥è¦è®¨è®ºçš„æ˜¯æˆ‘ä»¬åœ¨argsåˆ‡ç‰‡ä¸­å£°æ˜çš„å ä½ç¬¦å‚æ•°è¾“å…¥ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```go
 args := []interface{}{movie.Title, movie.Year, movie.Runtime, pq.Array(movie.Genres)}
```

å°†å‚æ•°å­˜æ”¾åœ¨åˆ‡ç‰‡ä¸­ä¸æ˜¯å¿…é¡»çš„ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨ä»£ç æ³¨é‡Šè¯´æ˜çš„ï¼Œèƒ½å¤Ÿä½¿ä»£ç æ›´ç®€æ´ã€‚å°±ä¸ªäººè€Œè¨€ï¼Œæˆ‘é€šå¸¸å¯¹å…·æœ‰ä¸‰ä¸ªä»¥ä¸Šå ä½ç¬¦å‚æ•°çš„SQLæŸ¥è¯¢éƒ½è¿™æ ·åšã€‚

å¦å¤–ï¼Œæ³¨æ„åˆ°åˆ‡ç‰‡ä¸­çš„æœ€ç»ˆå€¼äº†å—ï¼Ÿä¸ºäº†å­˜å‚¨movie.Genreså€¼(å®ƒæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ‡ç‰‡)ï¼Œåœ¨æ‰§è¡ŒSQLæŸ¥è¯¢ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒä¼ é€’ç»™pq.Array()é€‚é…å™¨å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä½œç”¨å°±æ˜¯å¯¹åˆ‡ç‰‡è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ä¸ºå¯ä»¥ç›´æ¥æ’å…¥æ•°æ®åº“ç±»å‹ã€‚

è¿™é‡Œpq.Array()å‡½æ•°å°†[]stringåˆ‡ç‰‡è½¬æ¢ä¸ºpq.StringArrayç±»å‹ã€‚å› ä¸ºpq.StringArrayç±»å‹å®ç°äº†driver.Valuerå’Œsql.Scanneræ¥å£ï¼Œå®ƒå¯ä»¥å°†åŸç”Ÿå­—ç¬¦ä¸²åˆ‡ç‰‡è½¬æ¢ä¸ºPostgreSQLæ•°æ®åº“å¯ä»¥ç†è§£çš„å€¼å¹¶å­˜å‚¨åœ¨text[]åˆ—ä¸­çš„å€¼ã€‚

> æç¤ºï¼šä½ ä¹Ÿå¯ä»¥åœ¨ä»£ç ä¸­ä½¿ç”¨pq.Array()å‡½æ•°å¯¹[]bool, []byte, []int32, []int64, []float32å’Œ[]float64è¿›è¡Œè½¬æ¢ã€‚

#### è¿æ¥åˆ°APIå¤„ç†ç¨‹åº

ä¸‹é¢æ¿€åŠ¨äººå¿ƒæ—¶åˆ»åˆ°äº†ï¼Œæˆ‘ä»¬æŠŠInsert()æ–¹æ³•è¿æ¥åˆ°createMovieHandleræ¥å£å¤„ç†ç¨‹åºä¸­ï¼Œå› æ­¤POST /v1/moviesæ¥å£å¯ä»¥å®ç°å‘æ•°æ®åº“æ·»åŠ movieæ•°æ®ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

File: cmd/api/movies.go

---

```go
package main

...

func (app *application) createMovieHandler(w http.ResponseWriter, r *http.Request) {
	var input struct {
		Title   string       `json:"title"`
		Year    int32        `json:"year"`
		Runtime data.Runtime `json:"runtime"`
		Genres  []string     `json:"genres"`
	}
	err := app.readJSON(w, r, &input)
	if err != nil {
		app.badRequestResponse(w, r, err)
		return
	}
	movie := &data.Movie{
		Title:   input.Title,
		Year:    input.Year,
		Runtime: input.Runtime,
		Genres:  input.Genres,
	}
	v := validator.New()
	if data.ValidateMovie(v, movie); !v.Valid() {
		app.failedValidationResponse(w, r, v.Errors)
		return
	}

	//è°ƒç”¨movieæ¨¡å‹çš„Insert()æ–¹æ³•ï¼Œä¼ å…¥æ ¡éªŒåçš„movieæŒ‡é’ˆç»“æ„ä½“ã€‚
	//å°†åœ¨æ•°æ®åº“ä¸­åˆ›å»ºmovieæ¡ç›®ï¼Œå¹¶ç”¨ç³»ç»Ÿç”Ÿæˆå¯¹ä¿¡æ¯æ›´æ–°ç»“æ„ä½“
	err = app.models.Movies.Insert(movie)
	if err != nil {
		app.serverErrorResponse(w, r, err)
		return
	}

	//å½“å‘é€HTTPå“åº”æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›åŒ…å«Locationå¤´ä¿¡æ¯ï¼Œä½¿å®¢æˆ·ç«¯çŸ¥é“å“ªä¸ªURLå¯ä»¥æŸ¥è¯¢æ–°å»ºå¯¹èµ„æºã€‚
	//å¯ä»¥åˆ›å»ºä¸€ä¸ªç©ºå¯¹http.header mapç„¶åç”¨Set()æ–¹æ³•æ·»åŠ Locationå¤´ã€‚
	//åœ¨URLä¸­æ’å…¥ç³»ç»Ÿä¸ºmovieç”Ÿæˆçš„IDã€‚
	headers := make(http.Header)
	headers.Set("Location", fmt.Sprintf("/v1/movies/%d", movie.ID))

	//ä½¿ç”¨201è¿”å›ç ä»¥åŠmovieæ•°æ®ä½œä¸ºå“åº”body
	err = app.writeJSON(w, http.StatusCreated, envelope{"movie": movie}, headers)
	if err != nil {
		app.serverErrorResponse(w, r, err)
	}
}
```

okï¼Œæˆ‘ä»¬æ¥è¯•è¯•ï¼

é‡å¯æœåŠ¡ï¼Œç„¶åæ‰“å¼€ç¬¬äºŒä¸ªç»ˆç«¯çª—å£ï¼Œå‘POST /v1/moviesç«¯ç‚¹å‘å‡ºå¦‚ä¸‹è¯·æ±‚:

```shell
$ BODY='{"title":"Moana","year":2016,"runtime":"107 mins", "genres":["animation","adventure"]}'
$ curl -i -d "$BODY" localhost:4000/v1/movies
HTTP/1.1 201 Created
Content-Type: application/json
Location: /v1/movies/1
Date: Sun, 28 Nov 2021 09:36:54 GMT
Content-Length: 140

{
        "movie": {
                "id": 1,
                "title": "Moana",
                "runtime": "107 mins",
                "genres": [
                        "animation",
                        "adventure"
                ],
                "Version": 1
        }
}
```

çœ‹èµ·æ¥å¾ˆå®Œç¾ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒJSONå“åº”åŒ…å«movieçš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç³»ç»Ÿç”Ÿæˆçš„IDå’Œç‰ˆæœ¬å·ã€‚å“åº”è¿˜åŒ…æ‹¬Location: /v1/movies/1å¤´ï¼ŒæŒ‡å‘URLå¯ä»¥æŸ¥è¯¢åˆ°æ–°æ·»åŠ åˆ°æ•°æ®åº“çš„movieã€‚

æˆ‘ä»¬å»æ•°æ®åº“æŸ¥çœ‹ä¸‹ï¼Œmovieæ•°æ®æ˜¯å¦æ’å…¥æˆåŠŸï¼š

```shell
$  psql $GREENLIGHT_DB_DSN                         

psql (13.4)
Type "help" for help.

greenlight=> select * from movies;
 id |       create_at        | title | year | runtime |        genres         | version 
----+------------------------+-------+------+---------+-----------------------+---------
  1 | 2021-11-28 17:36:54+08 | Moana | 2016 |     107 | {animation,adventure} |       1
(1 row)
```

#### åˆ›å»ºå…¶ä»–æ•°æ®åº“æ¡ç›®

è®©æˆ‘ä»¬åœ¨ç³»ç»Ÿä¸­åˆ›å»ºæ›´å¤šçš„è®°å½•ï¼Œä»¥å¸®åŠ©æˆ‘ä»¬åœ¨æ„å»ºè¿‡ç¨‹ä¸­æ¼”ç¤ºä¸åŒçš„åŠŸèƒ½ã€‚å¦‚æœä½ è·Ÿéšæœ¬ä¹¦æ“ä½œï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åœ¨æ•°æ®åº“ä¸­åˆ›å»ºæ›´å¤šçš„movieæ•°æ®ï¼š

```shell
$ BODY='{"title":"Black Panther","year":2018,"runtime":"134 mins","genres":["action","adventure"]}'
$ curl -d "$BODY" localhost:4000/v1/movies
{
        "movie": {
                "id": 2,
                "title": "Black Panther",
                "runtime": "134 mins",
                "genres": [
                        "action",
                        "adventure"
                ],
                "Version": 1
        }
}
```

```shell
$ BODY='{"title":"Deadpool","year":2016, "runtime":"108 mins","genres":["action","comedy"]}'
$ curl -d "$BODY" localhost:4000/v1/movies                                      
{
        "movie": {
                "id": 3,
                "title": "Deadpool",
                "runtime": "108 mins",
                "genres": [
                        "action",
                        "comedy"
                ],
                "Version": 1
        }
}
```

```shell
$ BODY='{"title":"The Breakfast Club","year":1986, "runtime":"96 mins","genres":["drama"]}'
$ curl -d "$BODY" localhost:4000/v1/movies                                           
{
        "movie": {
                "id": 4,
                "title": "The Breakfast Club",
                "runtime": "96 mins",
                "genres": [
                        "drama"
                ],
                "Version": 1
        }
}
```

æ­¤æ—¶ï¼Œæ‚¨å¯èƒ½è¿˜éœ€è¦æŸ¥çœ‹PostgreSQLï¼Œä»¥ç¡®è®¤è®°å½•æ˜¯å¦å·²æ­£ç¡®åˆ›å»ºã€‚æ‚¨åº”è¯¥çœ‹åˆ°moviesè¡¨çš„å†…å®¹ç°åœ¨çœ‹èµ·æ¥ä¸æ­¤ç±»ä¼¼(åœ¨æ•°ç»„ä¸­åŒ…æ‹¬é€‚å½“çš„ç”µå½±ç±»å‹)ã€‚

```shell
$ psql $GREENLIGHT_DB_DSN

psql (13.4)
Type "help" for help.

greenlight=> select * from movies;
 id |       create_at        |       title        | year | runtime |        genres         | version 
----+------------------------+--------------------+------+---------+-----------------------+---------
  1 | 2021-11-28 17:36:54+08 | Moana              | 2016 |     107 | {animation,adventure} |       1
  2 | 2021-11-28 18:34:07+08 | Black Panther      | 2018 |     134 | {action,adventure}    |       1
  3 | 2021-11-28 18:37:13+08 | Deadpool           | 2016 |     108 | {action,comedy}       |       1
  4 | 2021-11-28 18:38:42+08 | The Breakfast Club | 1986 |      96 | {drama}               |       1
(4 rows)
```

## é™„åŠ å†…å®¹

#### $Nç¬¦å·

PostgreSQLå ä½ç¬¦å‚æ•°$Nç¬¦å·çš„ä¸€ä¸ªå¾ˆå¥½çš„ç‰¹æ€§æ˜¯ï¼šæ‚¨å¯ä»¥åœ¨SQLè¯­å¥çš„å¤šä¸ªä½ç½®ä½¿ç”¨ç›¸åŒçš„å‚æ•°å€¼ã€‚ä¾‹å¦‚ï¼Œåƒè¿™æ ·å†™ä»£ç æ˜¯å®Œå…¨å¯ä»¥çš„:

```go
// è¿™ä¸ªSQLè¯­å¥ä¸¤æ¬¡ä½¿ç”¨$1å‚æ•°ï¼Œ`123`è¿™ä¸ªå€¼å°†åœ¨$1å ä½ç¬¦ä¸­ä½¿ç”¨ä¸¤æ¬¡ã€‚
stmt := "UPDATE foo SET bar = $1 + $2 WHERE bar = $1"
err := db.Exec(stmt, 123, 456)
if err != nil { ...
}
```

#### æ‰§è¡Œå¤šæ¡SQLè¯­å¥

å¶å°”ä½ å¯èƒ½ä¼šå‘ç°è‡ªå·±åœ¨ä¸€ä¸ªæ•°æ®åº“è°ƒç”¨ä¸­éœ€è¦æ‰§è¡Œå¤šä¸ªSQLè¯­å¥ï¼Œå°±åƒè¿™æ ·:

```go
stmt := `
    UPDATE foo SET bar = true; 
    UPDATE foo SET baz = false;`
err := db.Exec(stmt) if err != nil {
...
}
```

pqé©±åŠ¨æ”¯æŒåœ¨ä¸€ä¸ªè°ƒç”¨åŒ…å«å¤šæ¡SQLè¯­å¥ï¼Œåªè¦ä¸åŒ…å«ä»»ä½•å ä½ç¬¦å³å¯ã€‚å¦‚æœç¡®å®åŒ…å«å ä½ç¬¦å‚æ•°ï¼Œé‚£ä¹ˆä½ å°†åœ¨è¿è¡Œæ—¶æ”¶åˆ°ä»¥ä¸‹é”™è¯¯æ¶ˆæ¯:

```shell
pq: cannot insert multiple commands into a prepared statement
```

è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‚¨éœ€è¦å°†è¯­å¥æ‹†åˆ†ä¸ºå•ç‹¬çš„æ•°æ®åº“è°ƒç”¨ï¼Œæˆ–è€…å¦‚æœä¸å¯èƒ½ï¼Œæ‚¨å¯ä»¥åœ¨PostgreSQLä¸­åˆ›å»ºä¸€ä¸ª[è‡ªå®šä¹‰å‡½æ•°](https://www.postgresql.org/docs/current/xfunc-sql.html)ï¼Œä½œä¸ºè¦è¿è¡Œçš„å¤šä¸ªSQLè¯­å¥çš„åŒ…è£…å™¨ã€‚
## æŸ¥è¯¢Movieæ¥å£

ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ç”¨äºè·å–å’Œæ˜¾ç¤ºç‰¹å®šmovieæ•°æ®çš„ä»£ç ã€‚
åŒæ ·ï¼Œæˆ‘ä»¬å°†ä»æ•°æ®åº“æ¨¡å‹å¼€å§‹ï¼Œé¦–å…ˆå°†Get()æ–¹æ³•æ›´æ–°ä¸ºæ‰§è¡Œä»¥ä¸‹SQLæŸ¥è¯¢:

```sql
SELECT id, create_at, title, year, runtime, genres, version
FROM moives
where id = $1
```

å› ä¸ºmoviesè¡¨ä½¿ç”¨idåˆ—ä½œä¸ºå®ƒçš„ä¸»é”®ï¼Œæ‰€ä»¥è¿™ä¸ªæŸ¥è¯¢å°†åªè¿”å›ä¸€ä¸ªæ•°æ®åº“è¡Œ(æˆ–è€…æ ¹æœ¬ä¸è¿”å›ä»»ä½•è¡Œ)ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥å†æ¬¡ä½¿ç”¨Goçš„QueryRow()æ–¹æ³•æ¥æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢ã€‚
æ‰“å¼€internal/data/movies.goæ–‡ä»¶ï¼Œæ›´æ–°ä»¥ä¸‹ä»£ç ï¼š

```go
func (m MovieModel) Get(id int64) (*Movie, error) {
	//PostgreSQLçš„bigserialç±»å‹ç”¨äºmovieçš„IDï¼Œå°†è‡ªå¢1ï¼Œå› æ­¤æˆ‘ä»¬çŸ¥é“idä¸ä¼šå°äº1ã€‚
	//ä¸ºäº†é¿å…ä¸å¿…è¦çš„æŸ¥è¯¢ï¼Œè¿™é‡ŒåŠ ä¸ªåˆ¤æ–­ã€‚
	if id < 1 {
		return nil, ErrRecordNotFound
	}
	//å®šä¹‰SQLæŸ¥è¯¢è¯­å¥ç”¨äºæŸ¥è¯¢movie
	query := `
		SELECT id, create_at, title, year, runtime, genres, version
        FROM movies
        where id = $1`
	var movie Movie
	err := m.DB.QueryRow(query, id).Scan(
		&movie.ID,
		&movie.CreateAt,
		&movie.Title,
		&movie.Year,
		&movie.Runtime,
		pq.Array(&movie.Genres),
		&movie.Version,
		)
	//é”™è¯¯å¤„ç†ï¼Œå¦‚æœæ²¡æ‰¾åˆ°å¯¹åº”çš„movieï¼ŒScan()å°†è¿”å›sql.ErrNoRowsé”™è¯¯ã€‚
	//æ£€æŸ¥é”™è¯¯ç±»å‹å¹¶è¿”å›è‡ªå®šä¹‰ErrRecordNotFound
	if err != nil {
		switch {
		case errors.Is(err, sql.ErrNoRows):
			return nil, ErrRecordNotFound
		default:
			return nil, err

		}
	}
	//å¦åˆ™ï¼Œè¿”å›MovieæŒ‡é’ˆ
	return &movie, nil
}
```

ä¸Šé¢ä»£ç å”¯ä¸€å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“æ‰«ææ¥è‡ªPostgreSQL text[]æ•°ç»„çš„ç±»å‹æ•°æ®æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡ä½¿ç”¨pq.Array()å‡½æ•°ã€‚å¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨è¿™ä¸ªé€‚é…å™¨å‡½æ•°ï¼Œå°†åœ¨è¿è¡Œæ—¶å¾—åˆ°ä»¥ä¸‹é”™è¯¯:

```shell
sql: Scan error on column index 5, name "genres": unsupported Scan, storing driver.Value type []uint8 into type *[]string
```

#### æ›´æ–°å¯¹åº”çš„APIå¤„ç†ç¨‹åº

æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯æ›´æ–°showMovieHandlerå¯ä»¥è°ƒç”¨movieæ¨¡å‹çš„Get()æ–¹æ³•ã€‚å¤„ç†ç¨‹åºéœ€è¦æŸ¥çœ‹Get()å‡½æ•°æ˜¯å¦è¿”å›ErrRecordNotFoundé”™è¯¯ï¼Œå¦‚æœè¿”å›è¯¥é”™è¯¯ï¼Œå‘å®¢æˆ·ç«¯å‘é€404 Not Foundå“åº”ã€‚å¦åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­åœ¨JSONå“åº”ä¸­å‘ˆç°è¿”å›çš„Movieç»“æ„ä½“ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

Fileï¼šcmd/api/movies.go

---

```go
package main

...

func (app *application) showMovieHandler(w http.ResponseWriter, r *http.Request) {
	id, err := app.readIDParam(r)
	if err != nil {
		app.notFoundResponse(w, r)
		return
	}
	//è°ƒç”¨Get()æ–¹æ³•è·å–æ•°æ®åº“ä¸­å¯¹åº”idçš„movieä¿¡æ¯ã€‚å¹¶ä½¿ç”¨errors.Is()æ–¹æ³•æ£€æŸ¥è¿”å›é”™è¯¯ç±»å‹
	//å¦‚æœæ˜¯æœªæ‰¾åˆ°å¯¹åº”idçš„movieå°±è¿”å›404 Not Foundå“åº”
	movie, err := app.models.Movies.Get(id)
	if err != nil {
		switch {
		case errors.Is(err, data.ErrRecordNotFound):
			app.notFoundResponse(w, r)
		default:
			app.serverErrorResponse(w, r, err)
		}
		return
	}

	err = app.writeJSON(w, http.StatusOK, envelope{"movie": movie}, nil)
	if err != nil {
		app.serverErrorResponse(w, r, err)
	}
}
```

ä»£ç å¾ˆç®€æ´ï¼Œå¤šäºäº†å‰é¢å‡†å¤‡çš„å¸®åŠ©å‡½æ•°ã€‚æ‚¨å¯ä»¥é€šè¿‡é‡æ–°å¯åŠ¨APIæœåŠ¡ï¼Œå¹¶æŸ¥æ‰¾å·²ç»åœ¨æ•°æ®åº“ä¸­åˆ›å»ºçš„movieæ•°æ®ã€‚ä¾‹å¦‚:

```shell
$ curl -i localhost:4000/v1/movies/2
HTTP/1.1 200 OK
Content-Type: application/json
Date: Sun, 28 Nov 2021 12:44:06 GMT
Content-Length: 145

{
        "movie": {
                "id": 2,
                "title": "Black Panther",
                "runtime": "134 mins",
                "genres": [
                        "action",
                        "adventure"
                ],
                "Version": 1
        }
}

```

åŒæ ·åœ°ï¼Œä½ ä¹Ÿå¯ä»¥å°è¯•ç”¨ä¸€ä¸ªåœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„IDå‘å¯è¯·æ±‚ã€‚åœ¨é‚£ç§æƒ…å†µä¸‹ï¼Œä½ åº”è¯¥æ”¶åˆ°404 Not Foundå“åº”ï¼Œåƒè¿™æ ·:

```shell
$ curl -i localhost:4000/v1/movies/42
HTTP/1.1 404 Not Found
Content-Type: application/json
Date: Sun, 28 Nov 2021 12:45:35 GMT
Content-Length: 59

{
        "error": "the requested  resource could not be found"
}
```

## é™„åŠ å†…å®¹

#### ä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ— ç¬¦å·æ•´æ•°ä½œä¸ºç”µå½±ID?

åœ¨Get()æ–¹æ³•çš„å¼€å¤´ï¼Œæˆ‘ä»¬ç”¨ä»¥ä¸‹ä»£ç æ¥æ£€æŸ¥idå‚æ•°æ˜¯å¦å°äº1:

```go
func (m MovieModel) Get(id int64) (*Movie, error) { 
	if id < 1 {
		return nil, ErrRecordNotFound 
	}
    ...
}
```

è¿™å¯èƒ½æƒ³çŸ¥é“ï¼šå¦‚æœç”µå½±IDä¸ä¸ºè´Ÿï¼Œåœ¨Goä»£ç ä¸­ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ä½¿ç”¨unsigned uint64ç±»å‹æ¥å­˜å‚¨IDï¼Œè€Œä½¿ç”¨int64?

æœ‰ä¸¤ä¸ªåŸå› ï¼š

* ç¬¬ä¸€ä¸ªåŸå› æ˜¯PostgreSQLæ²¡æœ‰æ— ç¬¦å·æ•´æ•°ã€‚ä¸ºäº†é¿å…æº¢å‡ºæˆ–å…¶ä»–å…¼å®¹æ€§é—®é¢˜ï¼Œå°†Goå’Œæ•°æ®åº“æ•´æ•°ç±»å‹å¯¹é½æ˜¯æ˜æ™ºçš„ï¼Œå› ä¸ºPostgreSQLæ²¡æœ‰unsigned integerï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åº”è¯¥é¿å…åœ¨Goä»£ç ä¸­ä½¿ç”¨uint*ç±»å‹æ¥è¯»å–æˆ–å†™å…¥PostgreSQLçš„ä»»ä½•å€¼ã€‚

ç›¸åï¼Œæœ€å¥½æ ¹æ®ä¸‹è¡¨å¯¹é½æ•´å‹:


| PostgreSQL ç±»å‹       | Go ç±»å‹                                             |
| ----------------------- | ----------------------------------------------------- |
| smallint, smallserial | int16(-32768 åˆ° 32767)                              |
| integer, serial       | int32(-2147483648 åˆ° 2147483647)                    |
| bigint, bigserial     | int64 (-9223372036854775808 to 9223372036854775807) |

è¿˜æœ‰å¦ä¸€ä¸ªåŸå› ã€‚Goçš„database/sqlåŒ…å®é™…ä¸Šä¸æ”¯æŒä»»ä½•å¤§äº9223372036854775807 (int64çš„æœ€å¤§å€¼)çš„æ•´å‹å€¼ã€‚uint64å¯èƒ½å¤§äºè¿™ä¸ªå€¼ï¼Œè¿™ä¼šå¯¼è‡´Goäº§ç”Ÿç±»ä¼¼è¿™æ ·çš„è¿è¡Œæ—¶é”™è¯¯:

```shell
sql: converting argument $1 type: uint64 values with high bit set are not supported
```

é€šè¿‡åœ¨Goä»£ç ä¸­ä½¿ç”¨int64ï¼Œæˆ‘ä»¬æ¶ˆé™¤äº†é‡åˆ°è¿™ä¸ªé”™è¯¯çš„é£é™©ã€‚
## æ›´æ–°Movie

åœ¨æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†ç»§ç»­æ„å»ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œå¹¶æ·»åŠ ä¸€ä¸ªå…¨æ–°çš„APIæ¥å£ï¼Œå…è®¸å®¢æˆ·ç«¯æ›´æ–°ç‰¹å®šmvoieæ•°æ®ã€‚


| Method  | URL Pattern        | Handler                | æ“ä½œ                  |
| --------- | -------------------- | ------------------------ | ----------------------- |
| **PUT** | **/v1/movies/:id** | **updateMovieHandler** | **æ›´æ–°ç‰¹å®šmovieä¿¡æ¯** |

æ›´å‡†ç¡®åœ°è¯´ï¼Œæˆ‘ä»¬å°†æ·»åŠ æ¥å£ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯å¯ä»¥æ›´æ–°æ•°æ®åº“ä¸­movieçš„titleã€yearã€runtimeå’Œgenreså†…å®¹ã€‚åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œä¸€æ—¦åˆ›å»ºidå’Œcreated_atå€¼ï¼Œå®ƒä»¬å°±ä¸åº”è¯¥æ”¹å˜ï¼Œå¹¶ä¸”ç‰ˆæœ¬å€¼ä¸åº”è¯¥ç”±å®¢æˆ·ç«¯æ§åˆ¶ï¼Œæ‰€ä»¥ä¸å…è®¸ç¼–è¾‘è¿™äº›å­—æ®µã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°†é…ç½®è¿™ä¸ªæ¥å£ï¼Œä½¿å®ƒå¯¹movieçš„å€¼è¿›è¡Œæ›¿æ¢ã€‚è¿™æ„å‘³ç€å®¢æˆ·ç«¯éœ€è¦åœ¨å…¶JSONè¯·æ±‚ä½“ä¸­ä¸ºæ‰€æœ‰å¯ç¼–è¾‘å­—æ®µæä¾›å€¼â€¦â€¦å³ä½¿ä»–ä»¬åªæƒ³æ”¹å˜å…¶ä¸­ä¸€ä¸ªå­—æ®µã€‚

ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯æƒ³è¦åœ¨æˆ‘ä»¬çš„æ•°æ®åº“ä¸­æ·»åŠ ç§‘å¹»ç”µå½±ã€Šé»‘è±¹ã€‹ï¼Œéœ€è¦å‘é€ä¸€ä¸ªJSONè¯·æ±‚ä½“ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```json
{
    "title": "Black Panther", 
    "year": 2018,
    "runtime": "134 mins", 
    "genres": [
        "action",
        "adventure",
        "sci-fi"
    ] 
}
```

#### æ‰§è¡ŒSQLæŸ¥è¯¢

è®©æˆ‘ä»¬å†æ¬¡å¼€å§‹æ•°æ®åº“æ¨¡å‹å¤„ç†ï¼Œå¹¶ç¼–è¾‘Update()æ–¹æ³•æ¥æ‰§è¡Œä¸‹é¢SQLè¯­å¥ï¼š

```sql
UPDATE movies
SET title = $1, year = $2, runtime = $3, genres = $4, version = version + 1 
WHERE id = $5
RETURNING version
```

æ³¨æ„åˆ°è¿™é‡Œæˆ‘ä»¬å°†ç‰ˆæœ¬å€¼ä½œä¸ºæŸ¥è¯¢çš„ä¸€éƒ¨åˆ†è¿›è¡Œé€’å¢ï¼Ÿæœ€åæˆ‘ä»¬ç”¨returnå­å¥è¿”å›è¿™ä¸ªæ–°çš„åŠ 1çš„ç‰ˆæœ¬å€¼ã€‚

å’Œå‰é¢ä¸€æ ·è¿™ä¸ªqueryè¿”å›ä¸€æ¡æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨Goçš„QueryRow()æ–¹æ³•æ‰§è¡Œã€‚å¦‚æœä½ è·Ÿéšæœ¬ä¹¦æ“ä½œï¼Œè¿”å›åˆ°

internal/data/movies.goæ–‡ä»¶ï¼Œç„¶ååœ¨Updateæ–¹æ³•ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

File: internal/data/movies.go

---

```go
package data

...

func (m MovieModel) Update(movie *Movie) error {
	//å£°æ˜SQL queryæ›´æ–°è®°å½•å¹¶è¿”å›æœ€æ–°ç‰ˆæœ¬å·
	query := `
		UPDATE movies
		set title = $1, year = $2, runtime = $3, genres = $4, version = version + 1
		WHERE id = $5
		RETURNING version`
	//åˆ›å»ºargsåˆ‡ç‰‡åŒ…å«æ‰€æœ‰å ä½ç¬¦å‚æ•°å€¼
	args := []interface{}{
		movie.Title,
		movie.Year,
		movie.Runtime,
		pq.Array(movie.Genres),
		movie.ID,
	}
	//ä½¿ç”¨QueryRow()æ–¹æ³•æ‰§è¡Œï¼Œå¹¶ä»¥å¯å˜å‚æ•°ä¼ å…¥argsåˆ‡ç‰‡ï¼Œè¯»å–æœ€æ–°versionå€¼åˆ°movieç»“æ„ä½“
	return m.DB.QueryRow(query, args...).Scan(&movie.Version)
}
```

éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼šå°±åƒæˆ‘ä»¬çš„Insert()æ–¹æ³•ä¸€æ ·Update()æ–¹æ³•æ¥å—ä¸€ä¸ªæŒ‡å‘Movieç»“æ„ä½“çš„æŒ‡é’ˆä½œä¸ºå‚æ•°ï¼Œå¹¶å†æ¬¡åŸåœ°ä¿®æ”¹å®ƒâ€”â€”è¿™ä¸€æ¬¡åªä½¿ç”¨æ–°ç‰ˆæœ¬å·æ›´æ–°ã€‚

#### åˆ›å»ºAPIå¤„ç†ç¨‹åºï¼ˆhandlerï¼‰

ç°åœ¨ï¼Œæˆ‘ä»¬åœ¨cmd/api/movies.goæ–‡ä»¶ä¸­ï¼Œæ·»åŠ updateMovieHandleræ–¹æ³•ã€‚


| Method  | URL Pattern        | Handler                | æ“ä½œ                  |
| --------- | -------------------- | ------------------------ | ----------------------- |
| **PUT** | **/v1/movies/:id** | **updateMovieHandler** | **æ›´æ–°ç‰¹å®šmovieä¿¡æ¯** |

è¿™ä¸ªå¤„ç†ç¨‹åºçš„å¥½å¤„åœ¨äºï¼Œæˆ‘ä»¬å·²ç»ä¸ºå®ƒæ‰“äº†æ‰€æœ‰çš„åŸºç¡€ã€‚è¿™é‡Œçš„å·¥ä½œä¸»è¦æ˜¯å°†ä»£ç å’Œå·²ç»ç¼–å†™çš„å¸®åŠ©å‡½æ•°ä¸²èµ·æ¥ï¼Œä»¥å¤„ç†è¯·æ±‚ã€‚

å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦:

1ã€ ä½¿ç”¨app.readIDParam()å¸®åŠ©å‡½æ•°ä»URLä¸­æå–ç”µå½±IDã€‚

2ã€ä½¿ç”¨æˆ‘ä»¬åœ¨å‰ä¸€ç« ä¸­åˆ›å»ºçš„Get()æ–¹æ³•ä»æ•°æ®åº“ä¸­è·å–ç›¸åº”çš„movieè®°å½•ã€‚

3ã€å°†åŒ…å«æ›´æ–°movieæ•°æ®çš„JSONè¯·æ±‚ä½“è¯»å…¥ä¸€ä¸ªinputç»“æ„ã€‚

4ã€å°†æ•°æ®ä»inputç»“æ„ä½“å¤åˆ¶åˆ°movieè®°å½•ã€‚

5ã€ä½¿ç”¨data.ValidateMovie()å‡½æ•°æ£€æŸ¥æ›´æ–°çš„movieè®°å½•å„ä¸ªå­—æ®µæ˜¯å¦æœ‰æ•ˆã€‚

6ã€è°ƒç”¨Update()æ–¹æ³•å°†æ–°çš„movieä¿¡æ¯å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚

7ã€ä½¿ç”¨app.writeJSON()å¸®åŠ©å‡½æ•°å°†æ›´æ–°çš„movieæ•°æ®å†™å…¥JSONå“åº”ä¸­ã€‚

ä¸‹é¢å¼€å§‹å†™ä»£ç ï¼š
File: cmd/api/movies.go

---

```go
package main

...

func (app *application) updateMovieHandler(w http.ResponseWriter, r *http.Request) {
	//ä»URLä¸­è¯»å–è¦æ›´æ–°çš„movie ID
	id, err := app.readIDParam(r)
	if err != nil {
		app.notFoundResponse(w, r)
		return
	}
	//æ ¹æ®IDä»æ•°æ®åº“ä¸­è¯»å–æ—§movieä¿¡æ¯ï¼Œå¦‚æœä¸å­˜åœ¨å°±è¿”å›404 Not Found
	movie, err := app.models.Movies.Get(id)
	if err != nil {
		switch {
		case errors.Is(err, data.ErrRecordNotFound):
			app.notFoundResponse(w, r)
		default:
			app.serverErrorResponse(w, r, err)
		}
		return
	}
	//å£°æ˜inputç»“æ„ä½“å­˜æ”¾å®¢æˆ·ç«¯å‘é€æ¥çš„æ•°æ®
	var input struct {
		Title   string       `json:"title"`
		Year    int32        `json:"year"`
		Runtime data.Runtime `json:"runtime"`
		Genres  []string     `json:"genres"`
	}
	//è¯»å–JSONè¯·æ±‚ä½“åˆ°inputç»“æ„ä½“ä¸­
	err = app.readJSON(w, r, &input)
	if err != nil {
		app.badRequestResponse(w, r, err)
		return
	}
	//ä»è¯·æ±‚ä½“ä¸­å°†å€¼æ‹·è´åˆ°æ•°æ®åº“movieè®°å½•å¯¹åº”å­—æ®µ
	movie.Title = input.Title
	movie.Year = input.Year
	movie.Runtime = input.Runtime
	movie.Genres = input.Genres
	//æ ¡éªŒæ›´æ–°ååˆ°movieå­—æ®µï¼Œå¦‚æœæ ¡éªŒå¤±è´¥è¿”å›422 Unprocessable Entityå“åº”ç»™å®¢æˆ·ç«¯
	v := validator.New()
	if data.ValidateMovie(v, movie); !v.Valid() {
		app.failedValidationResponse(w, r, v.Errors)
		return
	}
	//å°†æ£€éªŒååˆ°movieä¼ ç»™Update()æ–¹æ³•
	err = app.models.Movies.Update(movie)
	if err != nil {
		app.serverErrorResponse(w, r, err)
		return
	}
	//å°†æ›´æ–°ååˆ°movieè¿”å›ç»™å®¢æˆ·ç«¯
	err = app.writeJSON(w, http.StatusOK, envelope{"movie": movie}, nil)
	if err != nil {
		app.serverErrorResponse(w, r, err)
	}
}
```

æœ€åï¼Œä¸ºäº†å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ›´æ–°åº”ç”¨ç¨‹åºè·¯ç”±ä»¥åŒ…å«æ›´æ–°movieåˆ°APIã€‚åƒè¿™æ ·:
Fileï¼šcmd/api/routers.goæœ€åï¼Œä¸ºäº†å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ›´æ–°åº”ç”¨ç¨‹åºè·¯ç”±ä»¥åŒ…å«æ›´æ–°movieåˆ°APIã€‚åƒè¿™æ ·:
Fileï¼šcmd/api/routers.go

---

```go
package main

...

func (app *application) routes() http.Handler {
	router := httprouter.New()

	router.NotFound = http.HandlerFunc(app.notFoundResponse)
	router.MethodNotAllowed = http.HandlerFunc(app.methodNotAllowedResponse)

	router.HandlerFunc(http.MethodGet, "/v1/healthcheck", app.healthcheckHandler)
	router.HandlerFunc(http.MethodPost, "/v1/movies", app.createMovieHandler)
	router.HandlerFunc(http.MethodGet, "/v1/movies/:id", app.showMovieHandler)
	//ä¸º"/v1/movies/:id"æ¥å£æ·»åŠ è·¯ç”±
	router.HandlerFunc(http.MethodPut, "/v1/movies/:id", app.updateMovieHandler)
	return app.recoverPanic(app.rateLimit(router))
}
```

#### ä½¿ç”¨æ–°çš„æ¥å£

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥è¯•è¯•æ›´æ–°movieæ¥å£ã€‚

ä¸ºäº†æ¼”ç¤ºï¼Œè®©æˆ‘ä»¬ç»§ç»­æœ¬ç« å¼€å§‹æ—¶ç»™å‡ºçš„ä¾‹å­ï¼Œå¹¶æ›´æ–°æˆ‘ä»¬çš„è®°å½•ï¼Œä½¿ã€Šé»‘è±¹ã€‹åŒ…å«ç§‘å¹»é¢˜æã€‚æé†’ä¸€ä¸‹ï¼Œç›®å‰çš„è®°å½•æ˜¯è¿™æ ·çš„:

```shell
$  curl -i localhost:4000/v1/movies/2 
HTTP/1.1 200 OK
Content-Type: application/json
Date: Sun, 28 Nov 2021 13:48:43 GMT
Content-Length: 145

{
        "movie": {
                "id": 2,
                "title": "Black Panther",
                "runtime": "134 mins",
                "genres": [
                        "action",
                        "adventure"
                ],
                "Version": 1
        }
}
```

ä¸ºäº†æ›´æ–°genreså­—æ®µï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹APIè°ƒç”¨:

```shell
$ BODY='{"title":"Black Panther","year":2018,"runtime":"134 mins","genres":["sci-fi","action","adventure"]}'
$ curl -X PUT -d "$BODY" localhost:4000/v1/movies/2
{
        "movie": {
                "id": 2,
                "title": "Black Panther",
                "runtime": "134 mins",
                "genres": [
                        "sci-fi",
                        "action",
                        "adventure"
                ],
                "Version": 2
        }
}
```

è¿™çœ‹èµ·æ¥å¾ˆæ£’ï¼Œæˆ‘ä»¬å¯ä»¥ä»å“åº”ä¸­çœ‹åˆ°ï¼Œç”µå½±genreså·²ç»æ›´æ–°åˆ°åŒ…æ‹¬â€œsci-fiâ€ï¼Œç‰ˆæœ¬å·å·²ç»åƒæˆ‘ä»¬é¢„æœŸçš„é‚£æ ·å¢åŠ åˆ°2ã€‚

ä½ ä¹Ÿèƒ½å¤Ÿé€šè¿‡GET /v1/movies/2è¯·æ±‚æ¥éªŒè¯æ›´æ”¹æ˜¯å¦è¢«æŒä¹…åŒ–ï¼Œå°±åƒè¿™æ ·:

```shell
curl -i localhost:4000/v1/movies/2                                                                      
HTTP/1.1 200 OK
Content-Type: application/json
Date: Sun, 28 Nov 2021 13:52:52 GMT
Content-Length: 158

{
        "movie": {
                "id": 2,
                "title": "Black Panther",
                "runtime": "134 mins",
                "genres": [
                        "sci-fi",
                        "action",
                        "adventure"
                ],
                "Version": 2
        }
}
```
## åˆ é™¤Movieæ¥å£

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ æœ€ç»ˆçš„CRUDæ¥å£ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯å¯ä»¥ä»ç³»ç»Ÿä¸­åˆ é™¤ç‰¹å®šçš„ç”µå½±ã€‚


| Method                                              | URL                | Handler                | åŠ¨ä½œ                           |
| ----------------------------------------------------- | -------------------- | ------------------------ | -------------------------------- |
| GET                                                 | /v1/healthcheck    | createMovieHandler     | æ˜¾ç¤ºåº”ç”¨ç¨‹åºè¿è¡ŒçŠ¶å†µå’Œç‰ˆæœ¬ä¿¡æ¯ |
| POST                                                | /v1/movies         | createMovieHandler     | æ·»åŠ æ–°çš„ç”µå½±                   |
| GET                                                 | /v1/movies/:id     | showMovieHandler       | æ ¹æ®idæŸ¥è¯¢ç‰¹å®šç”µå½±             |
| PUT                                                 | /v1/movies/:id     | updateMovieHandler     | æ›´æ–°ç‰¹å®šç”µå½±                   |
| **DELETE**                                          | **/v1/movies/:id** | **deleteMovieHandler** | **åˆ é™¤ç‰¹å®šç”µå½±**               |
| ä¸APIä¸­çš„å…¶ä»–æ¥å£ç›¸æ¯”ï¼ŒDeleteè¦å®ç°çš„æ“ä½œéå¸¸ç®€å•ã€‚ |                    |                        |                                |

* å¦‚æœæ•°æ®åº“ä¸­å­˜åœ¨ä¸€ä¸ªå…·æœ‰URLä¸­æä¾›çš„idçš„movieè®°å½•ï¼Œåˆ é™¤ç›¸åº”çš„è®°å½•å¹¶å‘å®¢æˆ·ç«¯è¿”å›ä¸€æ¡æˆåŠŸæ¶ˆæ¯ã€‚
* å¦‚æœmovie idä¸å­˜åœ¨ï¼Œå‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª404 Not Foundå“åº”ã€‚

åœ¨æ•°æ®åº“ä¸­åˆ é™¤è®°å½•çš„SQLæŸ¥è¯¢ä¹Ÿå¾ˆç®€å•:

```sql
DELETE FROM movies
WHERE id = $1
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒSQLæŸ¥è¯¢ä¸è¿”å›ä»»ä½•è¡Œï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Goçš„Exec()æ–¹æ³•æ¥æ‰§è¡Œå®ƒã€‚

Exec()çš„ä¸€ä¸ªå¥½å¤„æ˜¯å®ƒè¿”å›ä¸€ä¸ªsql.Resultå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«æŸ¥è¯¢å—å½±å“çš„è¡Œæ•°çš„ä¿¡æ¯ã€‚åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œè¿™æ˜¯éå¸¸æœ‰ç”¨çš„ä¿¡æ¯ã€‚

* å¦‚æœå—å½±å“çš„è¡Œæ•°æ˜¯1ï¼Œé‚£ä¹ˆæˆ‘ä»¬çŸ¥é“è¦åˆ é™¤çš„movieå­˜åœ¨äºè¡¨ä¸­ï¼Œå¹¶ä¸”ç°åœ¨å·²ç»è¢«åˆ é™¤äº†...æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å‘å®¢æˆ·ç«¯å‘é€æˆåŠŸæ¶ˆæ¯ã€‚
* ç›¸åï¼Œå¦‚æœå—å½±å“çš„è¡Œæ•°ä¸º0ï¼Œæˆ‘ä»¬çŸ¥é“å¯¹åº”idçš„movieä¸å­˜åœ¨ï¼Œå‘å®¢æˆ·ç«¯è¿”å›404 Not Foundå“åº”ã€‚

#### æ·»åŠ Deleteæ¥å£

è®©æˆ‘ä»¬ç»§ç»­æ›´æ–°æ•°æ®åº“æ¨¡å‹ä¸­çš„Delete()æ–¹æ³•ã€‚æœ¬è´¨ä¸Šï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒæ‰§è¡Œä¸Šé¢çš„SQLè¯­å¥ï¼Œå¹¶åœ¨å—å½±å“è¡Œæ•°ä¸º0æ—¶è¿”å›ErrRecordNotFoundé”™è¯¯ã€‚åƒè¿™æ ·:

Fileï¼šinternal/data/movies.go

---

```go
package data

...

func (m MovieModel) Delete(id int64) error {
	//å¦‚æœmovie IDå°äº1è¿”å›ErrRecordNotFound
	if id < 1 {
		return ErrRecordNotFound
	}
	//æ„é€ SQL queryåˆ é™¤movie
	query := `
		DELETE FROM movies
		WHERE id = $1`
	//ä½¿ç”¨Exec()æ–¹æ³•æ‰§è¡ŒSQLè¯­å¥ï¼Œä¼ å…¥idå˜é‡ä½œä¸ºå ä½ç¬¦å‚æ•°å€¼ã€‚Exec()æ–¹æ³•è¿”å›sql.Resultå¯¹è±¡
	result, err := m.DB.Exec(query, id)
	if err != nil {
		return err
	}
	//è°ƒç”¨sql.Resultå¯¹è±¡çš„RowsAffected()æ–¹æ³•ï¼Œè·å–æŸ¥è¯¢å½±å“è¡Œæ•°
	rowAffected, err := result.RowsAffected()
	if err != nil {
		return err
	}
	//å¦‚æœæ²¡æœ‰å½±å“è¡Œæ•°ï¼Œå¯ä»¥æ¨å‡ºæ•°æ®åº“ä¸å­˜åœ¨å¯¹åº”idçš„è®°å½•ï¼Œè¿”å›ErrRecordNotFound
	if rowAffected == 0 {
		return ErrRecordNotFound
	}
	return nil
}
```

å®Œæˆä¹‹åï¼Œæˆ‘ä»¬è½¬åˆ°cmd/api/movies.goæ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„deleteMovieHandleræ–¹æ³•ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä»è¯·æ±‚URLä¸­è¯»å–movie IDï¼Œè°ƒç”¨åˆšåˆšåˆ›å»ºçš„Delete()æ–¹æ³•ï¼Œç„¶åæ ¹æ®Delete()çš„è¿”å›å€¼å‘å®¢æˆ·æœºè¿”å›é€‚å½“çš„å“åº”ã€‚

File: cmd/api/movies.go

---

```go
package main

...

func (app *application) deleteMovieHandler(w http.ResponseWriter, r *http.Request)  {
	//ä»URLä¸­æå–movie ID
	id, err := app.readIDParam(r)
	if err != nil {
		app.notFoundResponse(w, r)
		return
	}
	//ä»æ•°æ®åº“ä¸­åˆ é™¤movieï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”idçš„movieå°±è¿”å›404
	err = app.models.Movies.Delete(id)
	if err != nil {
		switch {
		case errors.Is(err, data.ErrRecordNotFound):
			app.notFoundResponse(w, r)
		default:
			app.serverErrorResponse(w, r, err)
		}
		return
	}
	//è¿”å›200 Okä»¥åŠæˆåŠŸåˆ é™¤
	err = app.writeJSON(w, http.StatusOK, envelope{"message": "movie successfully deleted"}, nil)
	if err != nil {
		app.serverErrorResponse(w, r, err)
	}
}
```

> æ³¨æ„ï¼šåœ¨è¿™é‡Œæ‚¨å¯èƒ½æ›´å–œæ¬¢å‘é€ä¸€ä¸ªç©ºå“åº”ä½“å’Œä¸€ä¸ª204 No ContentçŠ¶æ€ç ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªâ€œç”µå½±å·²æˆåŠŸåˆ é™¤â€æ¶ˆæ¯ã€‚è¿™å–å†³äºä½ çš„å®¢æˆ·ç«¯æ˜¯è°â€”â€”å¦‚æœä»–ä»¬æ˜¯äººï¼Œé‚£ä¹ˆå‘é€ç±»ä¼¼äºä¸Šé¢çš„ä¿¡æ¯æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ï¼›å¦‚æœå®ƒä»¬æ˜¯æœºå™¨ï¼Œé‚£ä¹ˆä¸€ä¸ª204 No Contentå“åº”å¯èƒ½å°±è¶³å¤Ÿäº†ã€‚

æœ€åï¼Œéœ€è¦åœ¨cmd/api/routes.goæ–‡ä»¶ä¸­æ·»åŠ åˆ é™¤movieçš„è·¯ç”±ã€‚

Fileï¼šcmd/api/routes.go

---

```go
package main

import (
	"github.com/julienschmidt/httprouter"
	"net/http"
)

func (app *application) routes() http.Handler {
	router := httprouter.New()

	router.NotFound = http.HandlerFunc(app.notFoundResponse)
	router.MethodNotAllowed = http.HandlerFunc(app.methodNotAllowedResponse)

	router.HandlerFunc(http.MethodGet, "/v1/healthcheck", app.healthcheckHandler)
	router.HandlerFunc(http.MethodPost, "/v1/movies", app.createMovieHandler)
	router.HandlerFunc(http.MethodGet, "/v1/movies/:id", app.showMovieHandler)
	router.HandlerFunc(http.MethodPut, "/v1/movies/:id", app.updateMovieHandler)
	//æ·»åŠ Delete /v1/movies/:id æ¥å£è·¯ç”±
	router.HandlerFunc(http.MethodDelete, "/v1/movies/:id", app.deleteMovieHandler)
	return app.recoverPanic(app.rateLimit(router))
}
```

å¥½äº†ï¼Œé‡æ–°å¯åŠ¨APIæœåŠ¡ï¼Œé€šè¿‡ä»movieæ•°æ®åº“ä¸­åˆ é™¤Deadpoolæ¥å°è¯•ä¸‹åˆ é™¤æ¥å£(å¦‚æœæ‚¨ä¸€ç›´è·Ÿéšæœ¬ä¹¦æ“ä½œï¼Œå®ƒçš„IDåº”è¯¥æ˜¯3)ã€‚åˆ é™¤æ“ä½œåº”è¯¥æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ‚¨åº”è¯¥æ”¶åˆ°å¦‚ä¸‹çš„ç¡®è®¤æ¶ˆæ¯:

```shell
$  curl -X DELETE http://localhost:4000/v1/movies/3
{
        "message": "movie successfully deleted"
}
```

å¦‚æœæ‚¨é‡å¤ç›¸åŒçš„è¯·æ±‚æ¥åˆ é™¤å·²ç»ä¸å­˜åœ¨çš„movieï¼Œåº”è¯¥ä¼šå¾—åˆ°ä¸€ä¸ª404 Not Foundå“åº”å’Œé”™è¯¯æ¶ˆæ¯ã€‚ç±»ä¼¼äº:

```shell
$ curl -X DELETE http://localhost:4000/v1/movies/3
{
        "error": "the requested  resource could not be found"
}
```
## æ•°æ®åº“CRUDæ“ä½œ

æœ¬ç« èŠ‚æˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»å¦‚ä½•åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°å’Œåˆ é™¤moviesã€‚

æˆ‘ä»¬å°†åœ¨æ¥ä¸‹æ¥çš„å‡ èŠ‚ä¸­å–å¾—é‡å¤§è¿›å±•ï¼Œåœ¨æœ¬èŠ‚ç»“æŸæ—¶ï¼Œæˆ‘ä»¬å°†å®Œæˆä»¥ä¸‹APIæ¥å£å¹¶ä½¿å…¶ç”Ÿæ•ˆ:


| Method                 | URL             | åŠ¨ä½œ                           |
| ------------------------ | ----------------- | -------------------------------- |
| GET                    | /v1/healthcheck | æ˜¾ç¤ºåº”ç”¨ç¨‹åºè¿è¡ŒçŠ¶å†µå’Œç‰ˆæœ¬ä¿¡æ¯ |
| POST                   | /v1/movies      | æ·»åŠ æ–°çš„ç”µå½±                   |
| GET                    | /v1/movies/:id  | æ ¹æ®idæŸ¥è¯¢ç‰¹å®šç”µå½±             |
| PUT                    | /v1/movies/:id  | æ›´æ–°ç‰¹å®šç”µå½±                   |
| DELETE                 | /v1/movies/:id  | åˆ é™¤ç‰¹å®šç”µå½±                   |
| æœ¬ç« å°†å­¦ä¹ åˆ°ä»¥ä¸‹å†…å®¹ï¼š |                 |                                |

* å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ•°æ®åº“æ¨¡å‹ï¼Œå°†æ‰€æœ‰æ‰§è¡ŒSQLæŸ¥è¯¢çš„é€»è¾‘ä¸æ•°æ®åº“éš”ç¦»ã€‚
* å¦‚ä½•åœ¨APIä¸Šä¸‹æ–‡ä¸­å¯¹ç‰¹å®šèµ„æºå®ç°å››ä¸ªåŸºæœ¬CRUD(åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°å’Œåˆ é™¤)æ“ä½œã€‚
